<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Embedded System Advanced 3　日本語版: Training material for engineer Discover! How? (NGO TAMA)</title>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="/css/mainday.css" title="default">
<link rel="alternate stylesheet" href="/css/mainnight.css" title="alternate">
<script type="text/javascript" src="/js/styleswitcher.js"></script>
<script type="text/javascript" src="/js/global.js"></script>
</head>
<body>
<div class="novelpage">
<div class="novelbody">
<div id="tateyoko">
<div id="_top"></div>
<a href="/">🏠</a>&emsp;
<a href="#" onclick="setActiveStyleSheet('default'); return false;">日</a>&emsp;
<a href="#" onclick="setActiveStyleSheet('alternate'); return false;">月</a>&emsp;
<a href="#_top" onclick="myFunction()" style="cursor: pointer;">縦書き／横書き</a>
<div id="calibre_link-30">
<div>
<div>
<table class="noveltitle">
<tr>
<td colspan="2"><i><span><i>Embedded System Advanced 3　日本語版: Training material for engineer Discover! How? (NGO TAMA)</i></span></i></td>
</tr>
<tr>
                    
                    
      </tr>
<tr>
<td colspan="2">NGO TAMA</td>
</tr>
<tr>
<td colspan="2">ENUJIHOH TAMA (2017)</td>
</tr>
<tr>
<td colspan="2"></td>
</tr>
</table>
<div></div>
</div>
<div></div>
</div>
</div>



<div id="calibre_link-0">
<div>
<p>&nbsp;<span>目次</span>
 &nbsp;</p>
<p>&nbsp;<a id="calibre_link-31"></a>
<a href="#calibre_link-1">
<span><u>[1]&nbsp;運転制御</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-2">
<span><u>(1)&nbsp;運転オブジェクト作成</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-3">
<span><u>(2)&nbsp;動作表示</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-4">
<span><u>[2]&nbsp;待機ステージ</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-5">
<span><u>(1)&nbsp;プログラム</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-6">
<span><u>(2)&nbsp;動作確認</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-7">
<span><u>[3]&nbsp;始動ステージ</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-8">
<span><u>(1)&nbsp;プログラム</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-9">
<span><u>(2)&nbsp;動作確認</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-10">
<span><u>[4]&nbsp;運転ステージ</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-11">
<span><u>(1)&nbsp;プログラム</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-12">
<span><u>(2)&nbsp;動作確認</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-13">
<span><u>[5]&nbsp;停止ステージ</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-14">
<span><u>(1)&nbsp;プログラム</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-15">
<span><u>(2)&nbsp;動作確認</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-16">
<span><u>[6]&nbsp;エンジン制御部</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-17">
<span><u>(1)&nbsp;プログラム</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-18">
<span><u>(2)&nbsp;動作確認１</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-19">
<span><u>(3)&nbsp;電圧、回転数の確立</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-20">
<span><u>(4)&nbsp;停止検出</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-21">
<span><u>(5)&nbsp;動作確認２</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-22">
<span><u>[7]&nbsp;異常処理</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-23">
<span><u>(1)&nbsp;プログラム</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-24">
<span><u>(2)&nbsp;動作確認</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-25">
<span><u>[8]&nbsp;運転記録</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-26">
<span><u>(1)&nbsp;プログラム</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-27">
<span><u>(2)&nbsp;動作確認</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-28">
<span><u>[9]&nbsp;メッセージ</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-29">
<span><u>[10]&nbsp;サイクル時間</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<div></div>
<br />
&nbsp;<p>&nbsp;<span>[概要]</span>
 &nbsp;</p>
<p>&nbsp;<span>いよいよ、この本では制御の中心となる運転制御を扱います。</span>
 &nbsp;</p>
<h1>
<a id="calibre_link-1">
<span>[1]&nbsp;運転制御</span>
</a>
</h1>
<p>&nbsp;<span>運転制御では下記の入出力ポートを使用します。</span>
 &nbsp;</p>
<p>&nbsp;<span>これらのポートの機能は、すでに"hwsetup.cpp"ファイルで設定されています。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000003.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000008.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>運転制御は下図の4つのステージに大きく分けられます。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000011.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>各ステージでは、次の項目を実行します。</span>
 &nbsp;</p>
<p>&nbsp;<span>1)&nbsp;待機ステージ(Waiting)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;(1) 起動条件の判定</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;(2) 起動／再起動操作</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;(3) 異常回復</span>
 &nbsp;</p>
<p>&nbsp;<span>2)&nbsp;始動ステージ(Starting)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;(1)&nbsp;エンジン起動指示</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;(2) 異常検知</span>
 &nbsp;</p>
<p>&nbsp;<span>3) 運転ステージ(Running)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;(1)&nbsp;回転、電圧の安定検出</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;(2)&nbsp;負荷投入</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;(3) 異常検知</span>
 &nbsp;</p>
<p>&nbsp;<span>4) 停止ステージ(Stopping)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;(1) スロットル弁閉</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;(2)&nbsp;負荷切断</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;(3) 停止操作</span>
 &nbsp;</p>
<p>&nbsp;<span>また、各ステージとは独立に、エンジン制御部がエンジンの起動、停止などの操作を行っています。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000010.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>では徐々に組み立てて行きましょう。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;common.h&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//運転制御ステージ</span>
 &nbsp;</p>
<p>&nbsp;<span>enum {</span>
 &nbsp;</p>
<p>&nbsp;<span>M_WAIT,</span>
 &nbsp;</p>
<p>&nbsp;<span>M_START,</span>
 &nbsp;</p>
<p>&nbsp;<span>M_RUN,</span>
 &nbsp;</p>
<p>&nbsp;<span>M_STOP</span>
 &nbsp;</p>
<p>&nbsp;<span>};</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-2">
<span>(1) 運転オブジェクト作成</span>
</a>
</h2>
<p>&nbsp;<span>新規に運転オブジェクトのファイルを作成します。</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Operation.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//――――――――――――――――――――――――</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; FILE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : Operation.cpp</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; DESCRIPTION : Machine control</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; CPU TYPE&nbsp;&nbsp;&nbsp; : SH7286</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; DATE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : Nov 01, 2016</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; VERSION ：1.0&nbsp;&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//――――――――――――――――――――――――</span>
 &nbsp;</p>
<p>&nbsp;<span>#include &lt;string.h&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>#include &lt;machine.h&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "iodefine.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>extern "C" {</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "vect.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "common.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "proto.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>#define TEST</span>
<span>1</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>// ------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>// ------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>static short runStage ;</span>
<span>//運転ステージ</span>
 &nbsp;</p>
<p>&nbsp;<span>static short runSeq ;</span>
<span>//運転シーケンス</span>
 &nbsp;</p>
<p>&nbsp;<span>static short nowRpm ;</span>
<span>//現在回転数</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>// ------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private function</span>
 &nbsp;</p>
<p>&nbsp;<span>// ------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>static void Waiting(void);</span>
 &nbsp;</p>
<p>&nbsp;<span>static void Starting(void);</span>
 &nbsp;</p>
<p>&nbsp;<span>static void Running(void);</span>
 &nbsp;</p>
<p>&nbsp;<span>static void Stopping(void);</span>
 &nbsp;</p>
<p>&nbsp;<span>static void EngCtrl(void);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//--------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>// Functions</span>
 &nbsp;</p>
<p>&nbsp;<span>//--------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitOperation()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>runStage = M_WAIT ;</span>
 &nbsp;</p>
<p>&nbsp;<span>runSeq = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>nowRpm = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//運転制御部</span>
 &nbsp;</p>
<p>&nbsp;<span>void Operation()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>//</span>
<span>ErrorCheck();</span>
 &nbsp;</p>
<p>&nbsp;<span>nowRpm = GetRpm() ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//運転制御ステージ</span>
 &nbsp;</p>
<p>&nbsp;<span>switch ( runStage )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>case M_WAIT :</span>
<span>//待機ステージ</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>Waiting() ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case M_START :</span>
<span>//始動ステージ</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>Starting() ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case M_RUN :</span>
<span>//運転ステージ</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>Running() ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case M_STOP :</span>
<span>//停止ステージ</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>Stopping() ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>default :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runStage = M_WAIT ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>EngCtrl();</span>
<span>//エンジン制御部</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//待機ステージ</span>
 &nbsp;</p>
<p>&nbsp;<span>static void Waiting()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//始動ステージ</span>
 &nbsp;</p>
<p>&nbsp;<span>static void Starting()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//運転ステージ</span>
 &nbsp;</p>
<p>&nbsp;<span>static void Running()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//停止ステージ</span>
 &nbsp;</p>
<p>&nbsp;<span>static void Stopping()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//エンジン制御</span>
 &nbsp;</p>
<p>&nbsp;<span>static void EngCtrl()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-3">
<span>(2) 動作表示</span>
</a>
</h2>
<p>&nbsp;<span>動作チェックのために、運転制御に関する情報をLCD画面に表示しましょう。</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Display.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//LCD display</span>
 &nbsp;</p>
<p>&nbsp;<span>void DispLCD()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>switch ( nowPage ){</span>
 &nbsp;</p>
<p>&nbsp;<span>case D_Run :</span>
<span>//operating status</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>DispFunc( GetRunStage,&nbsp; GetOpeMsg );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>selectLED = L_ROT ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>LCD画面に表示するデータを準備します。</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Operation.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>static const char&nbsp;scRun[][21] = {</span>
 &nbsp;</p>
<p>&nbsp;<span>{"Sta&nbsp;00 Seq 00 Lod 00"},</span>
<span>//運転ステージ/運転シーケンス/投入負荷</span>
 &nbsp;</p>
<p>&nbsp;<span>{"seq 00 sta 00 rdy 0 "},</span>
<span>//エンジン制御シーケンス/エンジン状態/起動不可理由</span>
 &nbsp;</p>
<p>&nbsp;<span>{"Rot&nbsp;00 Vol&nbsp;00 Try 00"},</span>
<span>//回転数確立フラグ/電圧確立フラグ/リトライカウンタ</span>
 &nbsp;</p>
<p>&nbsp;<span>{"Rpm 0000&nbsp;&nbsp;Rs&nbsp;0 Er 00"}};</span>
<span>//現在回転数/再起動フラグ/異常コード</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp;For Display</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetRunStage( int data[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>data[0] = runStage ;</span>
<span>//運転ステージ</span>
 &nbsp;</p>
<p>&nbsp;<span>data[1] = runSeq ;</span>
<span>//運転シーケンス</span>
 &nbsp;</p>
<p>&nbsp;<span>data[2] =&nbsp;0&nbsp;;</span>
<span>//投入負荷</span>
 &nbsp;</p>
<p>&nbsp;<span>data[3] =&nbsp;0&nbsp;;</span>
<span>//エンジン制御シーケンス</span>
 &nbsp;</p>
<p>&nbsp;<span>data[4] =&nbsp;0&nbsp;;</span>
<span>//エンジン状態</span>
 &nbsp;</p>
<p>&nbsp;<span>data[5] =&nbsp;0&nbsp;;</span>
<span>//起動不可理由</span>
 &nbsp;</p>
<p>&nbsp;<span>data[6] =&nbsp;0&nbsp;;</span>
<span>//回転数確立フラグ</span>
 &nbsp;</p>
<p>&nbsp;<span>data[7] =&nbsp;0&nbsp;;</span>
<span>//電圧確立フラグ</span>
 &nbsp;</p>
<p>&nbsp;<span>data[8] =&nbsp;0&nbsp;;</span>
<span>//リトライカウンター</span>
 &nbsp;</p>
<p>&nbsp;<span>data[9] = nowRpm ;</span>
<span>//現在回転数</span>
 &nbsp;</p>
<p>&nbsp;<span>data[10] =&nbsp;0&nbsp;;</span>
<span>//再起動フラグ</span>
 &nbsp;</p>
<p>&nbsp;<span>data[11] =&nbsp;0&nbsp;;</span>
<span>//異常番号</span>
 &nbsp;</p>
<p>&nbsp;<span>return 12 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//LCD</span>
 &nbsp;</p>
<p>&nbsp;<span>void GetOpeMsg( int val[], char buff[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>char line[22], temp[8]&nbsp; ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[0] = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int m = 0 ; m &lt; 3 ; m++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strncpy( line, scRun[m], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( int n = 0 ; n &lt; 3 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>itoa2( val[m*3+n], temp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>adjust( temp, 2, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strncpy( &amp;line[4+n*7], temp, 2 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( line, scRun[3], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[9], temp );</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 4, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[4], temp, 4 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[10], temp );</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[13], temp, 1 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[11], temp );</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 2, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[18], temp, 2 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>メイン関数から運転オブジェクトを呼び出します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Main.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>void main(void)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>InitOperation();</span>
 &nbsp;</p>
<p>&nbsp;<span>set_imask(0);</span>
 &nbsp;</p>
<p>&nbsp;<span>while ( 1 )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>Analog();</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>Operation();//運転制御部</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ここまでをビルドしてエラーが無いことを確認して下さい。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>OKでしたら、デジタル入力部に運転操作から呼び出す関数を追加します。</span>
 &nbsp;</p>
<p>&nbsp;<span>下記のボタンは、モニターパソコンからも操作します。</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Input.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//起動ボタン</span>
 &nbsp;</p>
<p>&nbsp;<span>bool IsStart()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ChkInp( P_Di00 ) == ON || ChkInp( P_Di12&nbsp;) == ON )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return true ;</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//停止ボタン</span>
 &nbsp;</p>
<p>&nbsp;<span>bool IsStop()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ChkInp( P_Di01 ) == ON || ChkInp( P_Di13&nbsp;) == ON )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return true ;</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//リセットボタン</span>
 &nbsp;</p>
<p>&nbsp;<span>bool IsReset()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ChkInp( P_Di02 ) == ON || ChkInp( P_Di14&nbsp;) == ON )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return true ;</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//緊急停止ボタン</span>
 &nbsp;</p>
<p>&nbsp;<span>bool IsEmStop()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ChkInp( P_Di03 ) == ON || ChkInp( P_Di15&nbsp;) == ON )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return true ;</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>では、待機ステージの組み込みに進みます。</span>
 &nbsp;</p>
<p>&nbsp;</p>
<div></div>
<br />
&nbsp;<h1>
<a id="calibre_link-4">
<span>[2]&nbsp;待機ステージ</span>
</a>
</h1>
<p>&nbsp;<span>起動する前に、運転が可能な状態にあるかを調べます。</span>
 &nbsp;</p>
<p>&nbsp;<span>また、緊急停止ボタンが押された時の動作も組み込みます。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>待機ステージのフローチャート</span>
 &nbsp;</p>
<p>&nbsp;<span>（今回使用する実機では、放熱ファンはエンジン側で制御していますので、マイコン側では扱っていません。）</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000012.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-5">
<span>(1)&nbsp;プログラム</span>
</a>
</h2>
<p>&nbsp;<span>===== Operation.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>#define R_STOP</span>
<span>100</span>
<span>//停止と判断する回転数</span>
 &nbsp;</p>
<p>&nbsp;<span>//待機ステージ</span>
 &nbsp;</p>
<p>&nbsp;<span>enum { W_BEGIN,W_WAKEUP,W_START,W_ERROR,W_RESET,W_RELEASE };</span>
 &nbsp;</p>
<p>&nbsp;<span>//エンジン運転指示&nbsp; engCmd</span>
 &nbsp;</p>
<p>&nbsp;<span>enum { C_NULL,C_STOP,C_START,C_EMSTOP };</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>static short reason ;</span>
<span>//起動不可の理由</span>
 &nbsp;</p>
<p>&nbsp;<span>static short engCmd ;</span>
<span>//エンジン運転指示</span>
 &nbsp;</p>
<p>&nbsp;<span>static short loadIndex ;</span>
<span>//投入負荷</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitOperation()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>reason = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>engCmd = C_NULL ;</span>
 &nbsp;</p>
<p>&nbsp;<span>loadIndex = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//起動の準備が出来ているかを調べる</span>
 &nbsp;</p>
<p>&nbsp;<span>static int IsStartReady()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//緊急停止ボタン</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( IsEmStop() == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>reason = 1 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//サーマルトリップ</span>
 &nbsp;</p>
<p>&nbsp;<span>else if ( ChkInp( P_Di07&nbsp;) == ON&nbsp; )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>reason = 2 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//回転中？</span>
 &nbsp;</p>
<p>&nbsp;<span>else if ( nowRpm &gt;= R_STOP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>reason = 3 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//ステッピングモーター待機位置</span>
 &nbsp;</p>
<p>&nbsp;<span>else if (&nbsp;IsMotorReady&nbsp;() == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>reason = 4 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//自動スイッチOFF</span>
 &nbsp;</p>
<p>&nbsp;<span>else if ( ChkInp( P_Di04 ) == ON )</span>
<span>// 自動=OFF／手動=ON</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>reason = 5 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>reason = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>return reason ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//緊急停止</span>
 &nbsp;</p>
<p>&nbsp;<span>static void EmStop()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>engCmd = C_EMSTOP ;</span>
<span>//緊急停止指示を出す</span>
 &nbsp;</p>
<p>&nbsp;<span>OffOut( P_Do00 );</span>
<span>//ACC-SWITCH</span>
 &nbsp;</p>
<p>&nbsp;<span>OffOut( P_Do01 );</span>
<span>//ON-SWITCH</span>
 &nbsp;</p>
<p>&nbsp;<span>OffOut( P_Do02 );</span>
<span>//START-SWITCH</span>
 &nbsp;</p>
<p>&nbsp;<span>OffOut( P_Do04 );</span>
<span>//負荷１</span>
 &nbsp;</p>
<p>&nbsp;<span>OffOut( P_Do05 );</span>
<span>//負荷２</span>
 &nbsp;</p>
<p>&nbsp;<span>OffOut( P_Do06 );</span>
<span>//負荷３</span>
 &nbsp;</p>
<p>&nbsp;<span>OffOut( P_Do07 );</span>
<span>//負荷４</span>
 &nbsp;</p>
<p>&nbsp;<span>OffOut( P_Do08 );</span>
<span>//負荷５</span>
 &nbsp;</p>
<p>&nbsp;<span>OffOut( P_Do09 );</span>
<span>//負荷６</span>
 &nbsp;</p>
<p>&nbsp;<span>OffOut( P_Do10 );</span>
<span>//燃料遮断弁、運転中表示</span>
 &nbsp;</p>
<p>&nbsp;<span>StopMotor();</span>
<span>//ステッピングモーター停止</span>
 &nbsp;</p>
<p>&nbsp;<span>loadIndex = 0;</span>
<span>//投入負荷</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//待機ステージ</span>
 &nbsp;</p>
<p>&nbsp;<span>static void Waiting()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//緊急停止</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( runSeq &lt; W_ERROR &amp;&amp; IsEmergency() == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>EmStop();</span>
<span>//緊急停止</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runSeq = W_ERROR ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>switch ( runSeq ){</span>
 &nbsp;</p>
<p>&nbsp;<span>case W_BEGIN :</span>
<span>//起動可能かチェック</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkTimer(&nbsp;TM18&nbsp;) == OFF )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnTimer(&nbsp;TM18&nbsp;);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( ChkTimer(&nbsp;TM18&nbsp;) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engCmd = C_NULL ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsStartReady() == 0 )</span>
<span>//起動可能なら</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnOut( P_Do00&nbsp;);</span>
<span>//ACC-SWITCH</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnTimer(&nbsp;TM18&nbsp;);&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>runSeq++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case W_WAKEUP :</span>
<span>//起動待ち</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsStartReady() == 0 )</span>
<span>//起動可能なら</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsStart() == true )</span>
<span>//起動ボタン</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnOut( P_Do01&nbsp;);</span>
<span>//ON-SWITCH</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnOut( P_Do10 );</span>
<span>//燃料遮断弁ON,運転中表示</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnTimer(&nbsp;TM18&nbsp;);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>runSeq++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffOut( P_Do00&nbsp;);</span>
<span>//ACC-SWITCH</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runSeq = W_BEGIN ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case W_START :</span>
<span>//起動再確認</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkTimer(&nbsp;TM18&nbsp;) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffTimer(&nbsp;TM18&nbsp;);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsStartReady() == 0 )</span>
<span>//起動可能なら</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>runStage = M_START ;</span>
<span>//発電装置運転開始</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>runSeq = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OffOut( P_Do00&nbsp;);</span>
<span>//ACC-SWITCH</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OffOut( P_Do01&nbsp;);</span>
<span>//ON-SWITCH</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OffOut( P_Do10 );</span>
<span>//燃料遮断弁OFF</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>runSeq = W_BEGIN ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case W_ERROR :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>EmStop();</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runSeq++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case W_RESET :</span>
<span>//異常解除待ち</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsReset() == true&nbsp;&amp;&amp; IsMsgDisp() == false&nbsp;)</span>
<span>//リセットボタン</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>ResetError();</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runSeq++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case&nbsp;</span>
<span>W_RELEASE :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsReset() == false )</span>
<span>//リセットボタン</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runSeq = W_BEGIN ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>default :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runSeq =&nbsp;0&nbsp;;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//始動ステージ</span>
 &nbsp;</p>
<p>&nbsp;<span>static void Starting()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//緊急停止</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( IsEmergency() == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>EmStop();</span>
<span>//緊急停止</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runStage = M_WAIT ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runSeq = W_ERROR ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>bool IsEmergency()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>return IsEmStop();</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>void ResetError()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>OffOut( P_Do03 );</span>
<span>//異常ランプ</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ステッピングモーター側の情報取得と、モーターの停止を指示する関数を追加します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Stepping.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//ステッピングモーターは待機状態にあるか？</span>
 &nbsp;</p>
<p>&nbsp;<span>bool IsMotorReady()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( sequence == S_COMMAND )</span>
<span>//命令待機</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return true ;</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//ステッピングモーター停止</span>
 &nbsp;</p>
<p>&nbsp;<span>void&nbsp;StopMotor()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>MoveValve( 0 );</span>
 &nbsp;</p>
<p>&nbsp;<span>AutoControl( false );</span>
 &nbsp;</p>
<p>&nbsp;<span>sequence = S_ERROR2 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-6">
<span>(2) 動作確認</span>
</a>
</h2>
<p>&nbsp;<span>ビルド後、実行して、ここまでの動作を確認しましょう。</span>
 &nbsp;</p>
<p>&nbsp;<span>１）起動開始条件が成立している時は、AC</span>
<span>C</span>
<span>&nbsp;</span>
<span>-SWITCHがONしていますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>２）サーマルトリップを作動させると、AC</span>
<span>C</span>
<span>&nbsp;</span>
<span>-SWITCHはOFFになりますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>３）条件が成立している時に緊急停止ボタンを押すと、AC</span>
<span>C</span>
<span>&nbsp;</span>
<span>-SWITCHがOFFになり、シーケンスが異常解除待ちに行きますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>４）緊急停止を解除して、リセットボタンを押すと、再びAC</span>
<span>C</span>
<span>&nbsp;</span>
<span>-SWITCHはONになりますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>５）AC</span>
<span>C</span>
<span>&nbsp;</span>
<span>-SWITCHがONの時に、開始ボタンを押すと、ON-SWITCHと燃料遮断弁がONになりますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>６）そしてシーケンスは始動ステージに移りますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>７）始動ステージの状態で、緊急停止ボタンを押すとシーケンスは待機ステージに戻り、リセット待ちになりますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>すべてOKでしたら、始動ステージの組み込みに進みましょう。</span>
 &nbsp;</p>
<p>&nbsp;</p>
<div></div>
<br />
&nbsp;<h1>
<a id="calibre_link-7">
<span>[3]&nbsp;始動ステージ</span>
</a>
</h1>
<p>&nbsp;<span>プログラムのテスト中はエンジンを動かしません。しかし、この状態では変化がなく、シーケンスが進みません。</span>
 &nbsp;</p>
<p>&nbsp;<span>このため、エンジン制御部にテスト用のコードを準備する必要があります。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>始動ステージのフローチャート</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000000.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-8">
<span>(1)&nbsp;プログラム</span>
</a>
</h2>
<p>&nbsp;<span>===== Operation.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>//始動ステージ</span>
 &nbsp;</p>
<p>&nbsp;<span>enum { S_BEGIN</span>
<span>,</span>
<span>&nbsp;</span>
<span>S_MOST&nbsp;};</span>
 &nbsp;</p>
<p>&nbsp;<span>//停止ステージ</span>
 &nbsp;</p>
<p>&nbsp;<span>enum { T_STOP,T_DOWN,T_DOWN2,T_ZERO,T_WAIT };</span>
 &nbsp;</p>
<p>&nbsp;<span>//エンジン制御シーケンス&nbsp; engStep</span>
 &nbsp;</p>
<p>&nbsp;<span>enum { E_IDLE,E_MOVE,E_MOVE2,E_START,E_UP,E_RESTA,E_AUTO,E_STABLE,E_GENE,E_STOP,E_SLOW };</span>
 &nbsp;</p>
<p>&nbsp;<span>//エンジン状態&nbsp; engState</span>
 &nbsp;</p>
<p>&nbsp;<span>enum { A_IDLE,A_MOST,A_SUMMIT,A_FAIL };</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>static short engState ;</span>
<span>//エンジン状態</span>
 &nbsp;</p>
<p>&nbsp;<span>static short engStep ;</span>
<span>//エンジン制御シーケンス</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitOperation()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>engState = A_IDLE ;</span>
 &nbsp;</p>
<p>&nbsp;<span>engStep = E_IDLE ;</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//始動ステージ</span>
 &nbsp;</p>
<p>&nbsp;<span>static void Starting()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//緊急停止</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( IsEmergency() == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//通常停止</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( IsStop() == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runStage = M_STOP ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runSeq = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>switch ( runSeq ){</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_BEGIN :</span>
<span>//運転開始</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engCmd = C_START ;</span>
<span>//エンジン起動開始指示</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runSeq++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case&nbsp;S_MOST&nbsp;:</span>
<span>//エンジン始動チェック</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( engState == A_FAIL )</span>
<span>//始動失敗</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runStage = M_STOP ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runSeq = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( engState ==&nbsp;A_MOST )</span>
<span>//運転ステージへ</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runStage = M_RUN ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runSeq = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>default :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runSeq =&nbsp;0&nbsp;;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//運転ステージ</span>
 &nbsp;</p>
<p>&nbsp;<span>static void Running()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//緊急停止</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( IsEmergency() == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>EmStop();</span>
<span>//緊急停止</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runStage = M_WAIT ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runSeq = W_ERROR ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//停止ステージ</span>
 &nbsp;</p>
<p>&nbsp;<span>static void Stopping()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//緊急停止</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( IsEmergency() == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>EmStop();</span>
<span>//緊急停止</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runStage = M_WAIT ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runSeq = W_ERROR ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>switch ( runSeq )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>case T_STOP :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engCmd = C_STOP ;</span>
<span>//運転停止指示を出す</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffOut( P_Do10 );</span>
<span>//燃料遮断弁、運転中表示</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffOut( P_Do01 );</span>
<span>//ON-SWITCH=OFF</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runSeq++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>case T_DOWN :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//エンジン制御部（テスト用）</span>
 &nbsp;</p>
<p>&nbsp;<span>static void EngCtrl()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>switch ( engStep ){</span>
 &nbsp;</p>
<p>&nbsp;<span>case E_IDLE :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( nowRpm &gt;= GetCtrl( C06 )) //スターター停止回転数</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engStep++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case E_MOVE :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( nowRpm &gt;= GetCtrl( C07 ))</span>
<span>//エンスト判定回転数</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engState = A_MOST ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engStep++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( nowRpm &lt; GetCtrl( C06 ))</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engState = A_FAIL ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engStep = E_UP ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case E_MOVE2 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( nowRpm &gt;= GetCtrl( C08 ))</span>
<span>//目標回転数</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engState = A_SUMMIT ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engStep++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( nowRpm &lt; GetCtrl( C07 ))&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engState = A_FAIL ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engStep = E_UP ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case E_START :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( nowRpm &lt; GetCtrl( C07 ))&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engState = A_FAIL ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engStep = E_UP ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case&nbsp;</span>
<span>E_UP :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( nowRpm &lt; R_STOP )</span>
<span>//停止判定回転数</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engState = A_IDLE ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engStep = E_IDLE ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetRunStage( int data[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>data[3] = engStep ;</span>
<span>//エンジン制御シーケンス</span>
 &nbsp;</p>
<p>&nbsp;<span>data[4] = engState ;</span>
<span>//エンジン状態</span>
 &nbsp;</p>
<p>&nbsp;<span>data[5] = reason ;</span>
<span>//起動不可理由</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>回転数値を定義します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;common.h&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//制御定数</span>
 &nbsp;</p>
<p>&nbsp;<span>enum {</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>C06,</span>
<span>//スターター停止回転数</span>
 &nbsp;</p>
<p>&nbsp;<span>C07,</span>
<span>//エンスト判定回転数</span>
 &nbsp;</p>
<p>&nbsp;<span>C08,</span>
<span>//目標回転数</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>};</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>制御定数に回転数値をセットします。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;ctrl.h&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>const short ctrlBase[CTRLNUM] = {</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>400,</span>
<span>//C06</span>
 &nbsp;</p>
<p>&nbsp;<span>1100,</span>
<span>//C07</span>
 &nbsp;</p>
<p>&nbsp;<span>1500,</span>
<span>//C08</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>};</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-9">
<span>(2) 動作確認</span>
</a>
</h2>
<p>&nbsp;<span>では実行して、始動までのシーケンスを確認しましょう。</span>
 &nbsp;</p>
<p>&nbsp;<span>１）開始ボタンを押すと、始動ステージに入ったのが、LCDで確認出来ますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>２）その時に、エンジン起動開始指示も表示されていますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>３）停止ボタンを押すと、停止ステージに移りますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>４）停止ステージで緊急停止ボタンを押して、待機に戻し、再び始動ステージに入れて下さい。</span>
 &nbsp;</p>
<p>&nbsp;<span>５）始動ステージでテスト用の回転数変更VRを回して、回転数を410rpm以上に設定します。</span>
 &nbsp;</p>
<p>&nbsp;<span>６）その後、回転数を400rpm以下にすると、エンジン状態は始動失敗になり、停止ステージに移りますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>７）回転数を0rpmにして、再び始動ステージに入れて下さい。</span>
 &nbsp;</p>
<p>&nbsp;<span>８）VRを回して、回転数が1500rpmを超えると、シーケンスが運転ステージに移りますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>９）運転ステージで緊急停止ボタンを押すと、待機に戻りますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>如何ですか？</span>
 &nbsp;</p>
<p>&nbsp;<span>すべてOKでしたら、次の運転ステージの組み込みに進みます。</span>
 &nbsp;</p>
<p>&nbsp;</p>
<div></div>
<br />
&nbsp;<h1>
<a id="calibre_link-10">
<span>[4]&nbsp;運転ステージ</span>
</a>
</h1>
<p>&nbsp;<span>運転ステージのフローチャート</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000006.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-11">
<span>(1)&nbsp;プログラム</span>
</a>
</h2>
<p>&nbsp;<span>===== Operation.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>//運転ステージ</span>
 &nbsp;</p>
<p>&nbsp;<span>enum { R_MOST,R_LOAD,R_RUNNING };</span>
 &nbsp;</p>
<p>&nbsp;<span>#define LOADCOUNT</span>
<span>6</span>
<span>//投入負荷数</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//運転ステージ</span>
 &nbsp;</p>
<p>&nbsp;<span>static void Running()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//緊急停止</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( IsEmergency() == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//通常停止</span>
 &nbsp;</p>
<p>&nbsp;<span>if (&nbsp;IsStop() == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runStage = M_STOP ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runSeq = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( engState == A_FAIL )&nbsp;</span>
<span>//不具合発生</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runStage = M_STOP ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runSeq = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>loadIndex = 0;&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>switch ( runSeq )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>case&nbsp;R_MOST ://回転、電圧確立待ち</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( engState == A_SUMMIT )</span>
<span>//回転、電圧共に確立</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnTimer( TM05 );</span>
<span>//負荷投入間隔</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>loadIndex = 1;</span>
<span>//投入負荷</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnOut( P_Do04 );</span>
<span>//負荷１</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runSeq++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case&nbsp;R_LOAD&nbsp;:</span>
<span>//負荷投入</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkTimer( TM05 ) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>switch ( loadIndex ){</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 1 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnOut( P_Do05 );</span>
<span>//負荷２</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 2 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnOut( P_Do06 );</span>
<span>//負荷３</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 3 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnOut( P_Do07 );</span>
<span>//負荷４</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 4 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnOut( P_Do08 );</span>
<span>//負荷５</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 5 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnOut( P_Do09 );</span>
<span>//負荷６</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>//全部投入したら</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ++loadIndex &gt;= LOADCOUNT )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OffTimer( TM05 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>runSeq++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnTimer( TM05 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case R_RUNNING :</span>
<span>//定常運転中</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>default :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runSeq = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>int&nbsp;GetRunStage( int data[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>data[2] = loadIndex ;</span>
<span>//投入負荷</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;common.h&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//タイマー</span>
 &nbsp;</p>
<p>&nbsp;<span>enum {</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>TM05,</span>
<span>//負荷投入間隔</span>
 &nbsp;</p>
<p>&nbsp;<span>TM06,</span>
<span>//負荷切断間隔;</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>};</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;timer.h&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>const unsigned short timeBase[TMRNUM] = {</span>
<span>//100ms</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>50,</span>
<span>//TM05</span>
 &nbsp;</p>
<p>&nbsp;<span>10,</span>
<span>//TM06</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>};</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-12">
<span>(2) 動作確認</span>
</a>
</h2>
<p>&nbsp;<span>では実行して、運転ステージまでのシーケンスを確認しましょう。</span>
 &nbsp;</p>
<p>&nbsp;<span>１）始動ステージで、回転数を1500rpm以上にして運転ステージに入れて下さい。</span>
 &nbsp;</p>
<p>&nbsp;<span>２）負荷投入が5秒位の間隔で実行されますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>３）全部の負荷が投入されたら、シーケンスが定常運転になりますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>４）ここで回転数を1100rpmより下げると、エンジン状態はエンストとなり、停止ステージに移りますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>５）停止ステージで緊急停止ボタンを押して、待機に戻します。</span>
 &nbsp;</p>
<p>&nbsp;<span>６）回転数を0rpmにしてから、再び運転ステージに入れて下さい。</span>
 &nbsp;</p>
<p>&nbsp;<span>７）負荷投入中でも、停止ボタンを押すと、エンジン制御部に運転停止指示が出され、停止ステージに移りますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>８）運転ステージで緊急停止ボタンを押すと、エンジン制御部に緊急停止指示が出され、待機ステージに戻りますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>これもすべてOKでしたら、次の停止ステージの組み込みに移りましょう。</span>
 &nbsp;</p>
<p>&nbsp;</p>
<div></div>
<br />
&nbsp;<h1>
<a id="calibre_link-13">
<span>[5]&nbsp;停止ステージ</span>
</a>
</h1>
<p>&nbsp;<span>エンジンは種々の要因で不調になり止まってしまうことがあります。しかし重大ではない原因で停止した場合は、自動的に再起動を試みることが望まれます。</span>
 &nbsp;</p>
<p>&nbsp;<span>１）停止ボタンや緊急停止ボタンを押して停止させたのか</span>
 &nbsp;</p>
<p>&nbsp;<span>２）重大な異常を検出して停止したのか</span>
 &nbsp;</p>
<p>&nbsp;<span>３）エンジンの始動に失敗したとか、燃料の関係でエンストしたのか</span>
 &nbsp;</p>
<p>&nbsp;<span>を判断して、再起動を行うか否かを決めます。</span>
 &nbsp;</p>
<p>&nbsp;<span>そのために、停止原因を示す変数(cause)を使います。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>停止ステージのフローチャート</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000001.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-14">
<span>(1)&nbsp;プログラム</span>
</a>
</h2>
<p>&nbsp;<span>===== Operation.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>//運転停止原因 cause</span>
 &nbsp;</p>
<p>&nbsp;<span>enum { U_NONE,U_STOP,U_ERROR,U_FAIL };</span>
<span>//停止ボタン、エラー、失敗</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>static bool&nbsp;restart&nbsp;;</span>
<span>//再起動フラグ</span>
 &nbsp;</p>
<p>&nbsp;<span>static short cause ;</span>
<span>//停止原因</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitOperation()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>restart&nbsp; = false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>cause = U_NONE ;&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//待機ステージ</span>
 &nbsp;</p>
<p>&nbsp;<span>static void Waiting()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>case W_WAKEUP :</span>
<span>//起動待ち</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsStartReady() == 0 )</span>
<span>//起動可能なら</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; modify &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsStart() == true || (( ChkTimer(&nbsp;TM18&nbsp;) == UP ) &amp;&amp; (&nbsp;restart&nbsp;== true )))&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//起動ボタン</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>case W_START :</span>
<span>//起動再確認</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsStartReady(true) == 0 )</span>
<span>//起動可能なら</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>runSeq = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>cause = U_NONE;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>case&nbsp;</span>
<span>W_RELEASE :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsReset() == false )</span>
<span>//リセットボタン</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runSeq = W_BEGIN ;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>restart&nbsp;= false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//始動ステージ</span>
 &nbsp;</p>
<p>&nbsp;<span>static void Starting()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//通常停止</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( IsStop() == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runSeq = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>cause = U_STOP ;</span>
<span>//停止原因</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//運転ステージ</span>
 &nbsp;</p>
<p>&nbsp;<span>static void Running()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//通常停止</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( IsStop() == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runSeq = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>cause = U_STOP ;</span>
<span>//停止原因</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//停止ステージ</span>
 &nbsp;</p>
<p>&nbsp;<span>static void Stopping()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//緊急停止</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( IsEmergency() == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( IsStop() == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>cause = U_STOP ;</span>
<span>//停止原因</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>switch ( runSeq )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>case T_STOP :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>case T_DOWN :</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( nowRpm &lt; R_STOP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnTimer( TM06 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>loadIndex = 1;</span>
<span>//切断負荷</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffOut( P_Do04 );</span>
<span>//負荷１</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runSeq++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>case T_DOWN2 :</span>
<span>//負荷切断</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkTimer( TM06 ) == UP )</span>
<span>//負荷切断間隔</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>switch ( loadIndex ){</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 1 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OffOut( P_Do05 );</span>
<span>//負荷２</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 2 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OffOut( P_Do06 );</span>
<span>//負荷３</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 3 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OffOut( P_Do07 );</span>
<span>//負荷４</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 4 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OffOut( P_Do08 );</span>
<span>//負荷５</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 5 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OffOut( P_Do09 );</span>
<span>//負荷６</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>//全部切断したら</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ++loadIndex &gt;= LOADCOUNT )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OffTimer( TM06 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnTimer(&nbsp;TM20&nbsp;);</span>
<span>//原点復帰待ち時間</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>runSeq++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnTimer( TM06 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case T_ZERO :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//ステッピングモーター待機状態検知</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if (IsMotorReady() == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffTimer(&nbsp;TM20&nbsp;);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( Severity() == HIGH_ERR )</span>
<span>//重大な異常</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>runStage = M_WAIT ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>runSeq = W_ERROR ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnTimer(&nbsp;TM17&nbsp;);&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>runSeq++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( ChkTimer(&nbsp;TM20&nbsp;) == UP )</span>
<span>//原点復帰待ち時間</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffTimer(&nbsp;TM20&nbsp;);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>SetError(ERR_4);</span>
<span>//原点復帰失敗</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runStage = M_WAIT ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runSeq = W_ERROR ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>case T_WAIT :</span>
<span>//再起動の休止時間</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkTimer(&nbsp;TM17&nbsp;) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffTimer(&nbsp;TM17&nbsp;);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>loadIndex = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( cause == U_STOP || cause == U_ERROR )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>restart&nbsp;= false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>restart&nbsp;= true;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runStage = M_WAIT ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runSeq = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>default :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runSeq = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//エンジン制御</span>
 &nbsp;</p>
<p>&nbsp;<span>static void EngCtrl()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>switch ( engStep ){</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>case E_MOVE :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//始動失敗検出用</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( nowRpm &lt; GetCtrl( C06 )) //スターター停止回転数</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engState = A_FAIL ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engStep = E_UP ;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>cause = U_FAIL&nbsp;;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case E_MOVE2 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//エンスト検出用</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( nowRpm &lt; GetCtrl( C07 ))</span>
<span>//エンスト回転数</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engState = A_FAIL ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engStep = E_UP ;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>cause = U_FAIL ;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case E_START :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( nowRpm &lt; GetCtrl( C07 ))</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engState = A_FAIL ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engStep = E_UP ;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>cause = U_FAIL ;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>void SetError(int n)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>int Severity()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>return&nbsp;LOW_ERR&nbsp;;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;common.h&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//エラーの重大さ</span>
 &nbsp;</p>
<p>&nbsp;<span>enum { NONE_ERR,LOW_ERR,HIGH_ERR };</span>
 &nbsp;</p>
<p>&nbsp;<span>//エラーコード</span>
 &nbsp;</p>
<p>&nbsp;<span>enum {</span>
 &nbsp;</p>
<p>&nbsp;<span>ERR_1 = 1,</span>
<span>//緊急停止</span>
 &nbsp;</p>
<p>&nbsp;<span>ERR_2,</span>
<span>//スロットル位置逸脱</span>
 &nbsp;</p>
<p>&nbsp;<span>ERR_3,</span>
<span>//再起動失敗</span>
 &nbsp;</p>
<p>&nbsp;<span>ERR_4,</span>
<span>//原点復帰失敗</span>
 &nbsp;</p>
<p>&nbsp;<span>ERR_5,</span>
<span>//ステッピングモーター異常</span>
 &nbsp;</p>
<p>&nbsp;<span>ERR_6,</span>
<span>//サーマルトリップ</span>
 &nbsp;</p>
<p>&nbsp;<span>ERR_7,</span>
<span>//高回転</span>
 &nbsp;</p>
<p>&nbsp;<span>ERR_8,</span>
<span>//油圧スイッチ作動</span>
 &nbsp;</p>
<p>&nbsp;<span>ERR_9,</span>
<span>//冷却水高温</span>
 &nbsp;</p>
<p>&nbsp;<span>ERR_10,</span>
<span>//周波数範囲外</span>
 &nbsp;</p>
<p>&nbsp;<span>ERR_11,</span>
<span>//発電電圧範囲外</span>
 &nbsp;</p>
<p>&nbsp;<span>ERR_12,</span>
<span>//起動失敗</span>
 &nbsp;</p>
<p>&nbsp;<span>ERR_13,</span>
<span>//エンスト</span>
 &nbsp;</p>
<p>&nbsp;<span>ERR_14,</span>
<span>//確立失敗</span>
 &nbsp;</p>
<p>&nbsp;<span>ERR_15,</span>
<span>//冷却水レベル&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ERR_16,</span>
<span>//予備</span>
 &nbsp;</p>
<p>&nbsp;<span>};</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-15">
<span>(2) 動作確認</span>
</a>
</h2>
<p>&nbsp;<span>では実行して、停止までのシーケンスを確認しましょう。</span>
 &nbsp;</p>
<p>&nbsp;<span>１）開始ボタンを押して、始動ステージにして下さい。</span>
 &nbsp;</p>
<p>&nbsp;<span>２）回転数を410rpmまで上げた後に、400rpm以下にします。</span>
 &nbsp;</p>
<p>&nbsp;<span>３）すると始動失敗になり、停止ステージに移りますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>４）エンジン制御部に停止指示が出され、燃料遮断弁とON-SWITCHがOFFになりましたか？</span>
 &nbsp;</p>
<p>&nbsp;<span>５）しばらく待っていると、待機ステージになり、自動的に再起動しますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>６）今度は運転ステージまでシーケンスを進めて下さい。</span>
 &nbsp;</p>
<p>&nbsp;<span>７）負荷投入の最中に、回転数を1000rpm以下に下げるとエンストになり、停止ステージに移りますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>８）そこで回転数を100rpm以下にすると負荷の切断が開始されますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>９）全部の負荷が切断されると、ステッピングモーターに原点復帰指示が出されましたか？</span>
 &nbsp;</p>
<p>&nbsp;<span>１０）そしてステッピングモーターがコマンド待ち状態になりましたか？</span>
 &nbsp;</p>
<p>&nbsp;<span>１１）その後、待機ステージに戻り、自動的に再起動しますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>１２）再び、運転ステージに進めて下さい。</span>
 &nbsp;</p>
<p>&nbsp;<span>１３）全部の負荷が投入された後に、停止ボタンを押します。</span>
 &nbsp;</p>
<p>&nbsp;<span>１４）エンジン制御部に停止指示が出され、燃料遮断弁とON-SWITCHがOFFになりましたか？</span>
 &nbsp;</p>
<p>&nbsp;<span>１５）そして回転数を100rpm以下にすると負荷の切断が行われ、待機ステージに戻りました？</span>
 &nbsp;</p>
<p>&nbsp;<span>１６）停止ボタンで停止させたので、再起動はしないことを確認して下さい。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>すべてOKでしたら、最後のエンジン制御部の組み込みに移ります。</span>
 &nbsp;</p>
<p>&nbsp;</p>
<div></div>
<br />
&nbsp;<h1>
<a id="calibre_link-16">
<span>[6]&nbsp;エンジン制御部</span>
</a>
</h1>
<p>&nbsp;<span>スターターはエンジン制御部で操作しています。</span>
 &nbsp;</p>
<p>&nbsp;<span>シーケンステストではスターターがONしないように回路を切断して、LED やLCDで動作の確認を行います。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>エンジン制御部のフローチャート</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000009.gif" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000002.gif" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000004.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-17">
<span>(1)&nbsp;プログラム</span>
</a>
</h2>
<p>&nbsp;<span>===== Operation.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>#define RETRY 5</span>
<span>//最大リトライ回数</span>
 &nbsp;</p>
<p>&nbsp;<span>static short tryCtr ;</span>
<span>//リトライカウンター</span>
 &nbsp;</p>
<p>&nbsp;<span>static bool rotZone ;</span>
<span>//回転数確立フラグ</span>
 &nbsp;</p>
<p>&nbsp;<span>static bool volZone ;</span>
<span>//電圧確立フラグ</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitOperation()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>tryCtr = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>rotZone = false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>volZone = false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//エンジン制御</span>
 &nbsp;</p>
<p>&nbsp;<span>static void EngCtrl()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//緊急停止</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( engCmd == C_EMSTOP )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engCmd = C_NULL ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( engStep &gt;= E_MOVE &amp;&amp; engStep &lt;= E_GENE )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engStep = E_STOP ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engState = A_FAIL ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//停止</span>
 &nbsp;</p>
<p>&nbsp;<span>else if ( engCmd == C_STOP )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engCmd = C_NULL ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( engStep &gt;= E_MOVE &amp;&amp; engStep &lt;= E_GENE )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engStep = E_STOP ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//開始</span>
 &nbsp;</p>
<p>&nbsp;<span>else if ( engCmd == C_START )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engCmd = C_NULL ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( engStep == E_IDLE )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engStep = E_MOVE ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; modify &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>switch ( engStep ){</span>
 &nbsp;</p>
<p>&nbsp;<span>case E_IDLE :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>tryCtr = 0 ;&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engState = A_IDLE ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case E_MOVE :</span>
<span>//スターター起動のためスロットルを開く</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>StepSetting( V_FIX, GetCtrl( C00 ));</span>
<span>//起動時のスロットル開度</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnTimer( TM08 );</span>
<span>//スロットル起動位置待ち時間</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engStep++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case E_MOVE2 :</span>
<span>//&nbsp;スロットル始動位置</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsGiveOff() == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffTimer( TM08 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engStep++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( ChkTimer( TM08 ) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffTimer( TM08 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>SetError(ERR_12);</span>
<span>//&nbsp;始動失敗</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>cause = U_FAIL ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engStep = E_STOP ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case E_START :</span>
<span>//スターター起動</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnOut( P_Do02 );</span>
<span>//スターター&nbsp;(START)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnTimer( TM03 );</span>
<span>//回転数上昇待ち時間</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>StartInputCapture();</span>
 &nbsp;</p>
<p>&nbsp;<span>#ifdef TEST</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>StartCrankPulse();</span>
<span>//クランクパルス出力開始</span>
 &nbsp;</p>
<p>&nbsp;<span>#endif</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engStep++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case E_UP :</span>
<span>//&nbsp;回転数上昇待ち</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if&nbsp;( nowRpm &gt;= GetCtrl( C06 ))</span>
<span>//スターター停止回転数</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffOut( P_Do02 );</span>
<span>//スターター&nbsp;(START)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffTimer( TM03 );&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>//&nbsp;条件変更</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>StepSetting( V_FIX, GetCtrl( C01 ));</span>
<span>//運転時のスロットル開度</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnTimer( TM10 );</span>
<span>//自動制御開始待ち時間</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnTimer( TM11 );</span>
<span>//電圧確立時間</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffTimer( TM12 );</span>
<span>//回転確立時間</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffTimer( TM13 );</span>
<span>//投入確認時間</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>volZone = false ;</span>
<span>//電圧確立フラグ</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>rotZone = false ;</span>
<span>//回転数確立フラグ</span>
 &nbsp;</p>
<p>&nbsp;<span>#ifdef TEST</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>StartDAC();</span>
<span>// DAC出力開始</span>
 &nbsp;</p>
<p>&nbsp;<span>#endif</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engStep = E_AUTO ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( ChkTimer( TM03 ) == UP )</span>
<span>//回転数上昇待ち時間</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffTimer( TM03 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffOut( P_Do02 );</span>
<span>//スターター&nbsp;(START)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ++tryCtr &lt; RETRY )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnTimer( TM16 );</span>
<span>//再起動待ち時間</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>engStep = E_RESTA ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>engState = A_FAIL ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>SetError(ERR_12);</span>
<span>//始動失敗</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>cause = U_FAIL ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>engStep = E_STOP ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case E_RESTA :</span>
<span>//&nbsp;再起動待ち</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkTimer( TM16 ) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffTimer( TM16 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engStep = E_START ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case E_AUTO :</span>
<span>//自動制御開始</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case E_STOP :</span>
<span>//停止開始</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffOut( P_Do02 );</span>
<span>//スターター(START)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>rotZone = false ;</span>
<span>//回転数確立フラグ</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>volZone = false ;</span>
<span>//電圧確立フラグ</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>StepSetting( V_FIX, 0 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnTimer( TM04 );</span>
<span>//回転数低下待ち時間</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engStep++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case E_SLOW :</span>
<span>//回転数低下待ち</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( nowRpm == 0 &amp;&amp; ChkTimer( TM04 ) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffTimer( TM04 );</span>
<span>//回転数低下待ち時間</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>StopInputCapture();</span>
 &nbsp;</p>
<p>&nbsp;<span>#ifdef TEST</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>StopCrankPulse();</span>
<span>//テスト用クランクパルス出力を停止する</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>StopDAC();</span>
<span>//テスト用DAC出力を停止する</span>
 &nbsp;</p>
<p>&nbsp;<span>#endif</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engState = A_IDLE ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engStep = E_IDLE ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>default :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engStep = E_IDLE ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetRunStage( int data[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>data[0] = runStage ;</span>
<span>//運転ステージ</span>
 &nbsp;</p>
<p>&nbsp;<span>data[1] = runSeq ;</span>
<span>//運転シーケンス</span>
 &nbsp;</p>
<p>&nbsp;<span>data[2] = loadIndex ;</span>
<span>//投入負荷</span>
 &nbsp;</p>
<p>&nbsp;<span>data[3] = engStep ;</span>
<span>//エンジン制御シーケンス</span>
 &nbsp;</p>
<p>&nbsp;<span>data[4] = engState ;</span>
<span>//エンジン状態</span>
 &nbsp;</p>
<p>&nbsp;<span>data[5] = reason ;</span>
<span>//起動不可理由</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; modify &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>data[6] = rotZone ;</span>
<span>//回転数確立フラグ</span>
 &nbsp;</p>
<p>&nbsp;<span>data[7] = volZone ;</span>
<span>//電圧確立フラグ</span>
 &nbsp;</p>
<p>&nbsp;<span>data[8] = tryCtr ;</span>
<span>//リトライカウンター</span>
 &nbsp;</p>
<p>&nbsp;<span>data[9] = nowRpm ;</span>
<span>//現在回転数</span>
 &nbsp;</p>
<p>&nbsp;<span>data[10] =&nbsp;restart&nbsp;;</span>
<span>//再起動フラグ</span>
 &nbsp;</p>
<p>&nbsp;<span>data[11] =&nbsp;GetErrorCode()&nbsp;;</span>
<span>//異常番号</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>return 12 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetErrorCode()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>return 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>void StartCrankPulse()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>void StopCrankPulse()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>void StartInputCapture()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>void StopInputCapture()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>void StartDAC()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>void StopDAC()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>確立時間やスロットル開度を定義します。</span>
 &nbsp;</p>
<p>&nbsp;<span>===== common.h ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//タイマー</span>
 &nbsp;</p>
<p>&nbsp;<span>enum {</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>TM03,</span>
<span>//回転数上昇待ち時間</span>
 &nbsp;</p>
<p>&nbsp;<span>TM04,</span>
<span>//回転数低下待ち時間</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>TM07,</span>
<span>//LCD表示周期</span>
 &nbsp;</p>
<p>&nbsp;<span>TM08,</span>
<span>//スロットル起動位置待ち時間</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>TM10,</span>
<span>//自動制御開始待ち時間</span>
 &nbsp;</p>
<p>&nbsp;<span>TM11,</span>
<span>//電圧確立時間</span>
 &nbsp;</p>
<p>&nbsp;<span>TM12,</span>
<span>//回転確立時間</span>
 &nbsp;</p>
<p>&nbsp;<span>TM13,</span>
<span>//投入確認時間</span>
 &nbsp;</p>
<p>&nbsp;<span>TM14,</span>
<span>//確立監視時間</span>
 &nbsp;</p>
<p>&nbsp;<span>TM15,</span>
<span>//エンスト確認時間</span>
 &nbsp;</p>
<p>&nbsp;<span>TM16,</span>
<span>//再起動待ち時間</span>
 &nbsp;</p>
<p>&nbsp;<span>TM17,</span>
<span>//再起動の休止時間</span>
 &nbsp;</p>
<p>&nbsp;<span>TM18,</span>
<span>//起動可能チェック時間</span>
 &nbsp;</p>
<p>&nbsp;<span>TM19,</span>
<span>//回転監視時間</span>
 &nbsp;</p>
<p>&nbsp;<span>TM20,</span>
<span>//原点復帰待ち時間</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//制御定数</span>
 &nbsp;</p>
<p>&nbsp;<span>enum {</span>
 &nbsp;</p>
<p>&nbsp;<span>C00,</span>
<span>//起動時のスロットル開度（パルス値）</span>
 &nbsp;</p>
<p>&nbsp;<span>C01,</span>
<span>//運転時のスロットル開度（パルス値）</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>};</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>確立時間を設定します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;timer.h ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>const unsigned short timeBase[TMRNUM] = {</span>
<span>//100ms</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>30,</span>
<span>//TM03</span>
 &nbsp;</p>
<p>&nbsp;<span>10,</span>
<span>//TM04</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>5,</span>
<span>//TM07</span>
 &nbsp;</p>
<p>&nbsp;<span>10,</span>
<span>//TM08</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>5,</span>
<span>//TM10</span>
 &nbsp;</p>
<p>&nbsp;<span>10,</span>
<span>//TM11</span>
 &nbsp;</p>
<p>&nbsp;<span>10,</span>
<span>//TM12</span>
 &nbsp;</p>
<p>&nbsp;<span>10,</span>
<span>//TM13</span>
 &nbsp;</p>
<p>&nbsp;<span>200,</span>
<span>//TM14</span>
 &nbsp;</p>
<p>&nbsp;<span>10,</span>
<span>//TM15</span>
 &nbsp;</p>
<p>&nbsp;<span>30,</span>
<span>//TM16</span>
 &nbsp;</p>
<p>&nbsp;<span>50,</span>
<span>//TM17</span>
 &nbsp;</p>
<p>&nbsp;<span>10,</span>
<span>//TM18</span>
 &nbsp;</p>
<p>&nbsp;<span>2,</span>
<span>//TM19</span>
 &nbsp;</p>
<p>&nbsp;<span>50,</span>
<span>//TM20</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>};</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>制御定数をセットします。これはテスト用の仮の値です。実際には実機で測定して決めます。</span>
 &nbsp;</p>
<p>&nbsp;<span>また、タイマーや制御定数を変更したので、EEPROMのROMバージョン値を変更して下さい。</span>
 &nbsp;</p>
<p>&nbsp;<span>===== ctrl.h ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>const short ctrlBase[CTRLNUM] = {</span>
 &nbsp;</p>
<p>&nbsp;<span>150,</span>
<span>//C00</span>
 &nbsp;</p>
<p>&nbsp;<span>300,</span>
<span>//C01</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>};</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-18">
<span>(2) 動作確認１</span>
</a>
</h2>
<p>&nbsp;<span>先ず、スターターを起動し、エンジンがかかるところまでを確認します。</span>
 &nbsp;</p>
<p>&nbsp;<span>１）回転数VRを一番下まで下げて置きます。</span>
 &nbsp;</p>
<p>&nbsp;<span>２）開始ボタンを押して、始動ステージに入れると、スロットルが起動時の開度まで開きますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>３）スロットルが開くと、スターターがONになりますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>４）回転数VRを操作していないので、3秒位でスターターはOFFになりますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>５）スターターのON/OFFを５回繰り返すと、始動失敗となり、停止ステージに移りますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>６）そして燃料遮断弁とON-SWITCHはOFFになり、スロットルは閉じましたか？</span>
 &nbsp;</p>
<p>&nbsp;<span>７）始動失敗は、再起動が可能なので、停止ステージから、待機ステージに戻り、自動的に始動ステージに入りましたか？</span>
 &nbsp;</p>
<p>&nbsp;<span>８）今度は、スターターが回ったら、回転数VRで410rpm以上にします。</span>
 &nbsp;</p>
<p>&nbsp;<span>９）するとスターターがOFFになり、スロットルがさらに運転時の開度まで開きますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>１０）OKでしたら、停止ボタンを押して、スロットルが閉じるのを確認して下さい。</span>
 &nbsp;</p>
<p>&nbsp;<span>１１）回転数VRで100rpm以下にすると、待機ステージに戻ります。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>次の段階のコードを組み込みましょう。</span>
 &nbsp;</p>
<p>&nbsp;</p>
<div></div>
<br />
&nbsp;<h2>
<a id="calibre_link-19">
<span>(3)&nbsp;電圧、回転数の確立</span>
</a>
</h2>
<p>&nbsp;<span>電圧の確立を調べていますが、まだ電圧は測定していないので、trueを返すようにしています。</span>
 &nbsp;</p>
<p>&nbsp;<span>回転数の確立は、2段階になっています。</span>
 &nbsp;</p>
<p>&nbsp;<span>１）目標回転数の+/-7%以内に一定の時間入った時を、回転数確立とします。</span>
 &nbsp;</p>
<p>&nbsp;<span>そして出力が目標範囲内に収まるように回転数制御値を変更します。</span>
 &nbsp;</p>
<p>&nbsp;<span>２）回転数確立後、目標回転数の+/-2%以内に一定の時間入った後に、負荷の投入を開始します。</span>
 &nbsp;</p>
<p>&nbsp;<span>また、既定の時間内にこれらが確立しなかった時は、確立失敗として、再起動するようにしています。</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Operation.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>static short middle[2] ;</span>
<span>//R_MID1,2</span>
 &nbsp;</p>
<p>&nbsp;<span>static short center[2] ;&nbsp;</span>
<span>//R_CENT1,2</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitOperation()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>int m = GetCtrl( C08 );</span>
<span>//目標回転数</span>
 &nbsp;</p>
<p>&nbsp;<span>int n = ( m * 7 ) / 100 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>middle[0] = m - n ;</span>
<span>//R_MID1</span>
 &nbsp;</p>
<p>&nbsp;<span>middle[1] = m + n ;</span>
<span>//R_MID2</span>
 &nbsp;</p>
<p>&nbsp;<span>n = ( m * 2 ) / 100 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>center[0] = m - n ;&nbsp;</span>
<span>//R_CENT1</span>
 &nbsp;</p>
<p>&nbsp;<span>center[1] = m + n ;&nbsp;</span>
<span>//R_CENT2</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>static void EngCtrl()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>case E_AUTO :</span>
<span>//自動制御開始</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//運転時のスロットル開度到達確認</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsGiveOff() == true &amp;&amp;&nbsp;IsMotorReady() == true &amp;&amp; ChkTimer( TM10 ) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffTimer(&nbsp;TM10&nbsp;);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>FuzzyBase( C04 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>StepSetting(&nbsp;V_AUTO, 0 );//&nbsp;スロットル自動制御開始</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engState = A_MOST ;</span>
<span>//自動制御開始</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnTimer(&nbsp;TM14&nbsp;);</span>
<span>//確立監視時間</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engStep++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case E_STABLE :</span>
<span>//確立待ち</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkTimer(&nbsp;TM14&nbsp;) == UP )</span>
<span>//確立監視時間</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffTimer(&nbsp;TM14&nbsp;);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>SetError(ERR_14);</span>
<span>//確立失敗</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engState = A_FAIL ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>cause = U_FAIL;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>engStep = E_STOP ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsAutoSequence() == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>StepSetting( V_AUTO, 0 );//自動制御開始</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//電圧確立確認</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsGeneVolt() == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkTimer(&nbsp;TM11&nbsp;) == OFF )&nbsp;</span>
<span>//電圧確立時間</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnTimer(&nbsp;TM11&nbsp;);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( ChkTimer(&nbsp;TM11&nbsp;) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>if ( volZone == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>volZone = true ;</span>
<span>//電圧確立フラグ</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>volZone = false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffTimer(&nbsp;TM11&nbsp;);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//回転数確立確認</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( nowRpm &gt;= middle[0] &amp;&amp; nowRpm &lt;= middle[1] )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkTimer(&nbsp;TM12&nbsp;) == OFF )</span>
<span>//回転確立時間</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnTimer(&nbsp;TM12&nbsp;);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( ChkTimer(&nbsp;TM12&nbsp;) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>if ( rotZone == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>rotZone = true ;</span>
<span>//回転数確立フラグ</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>FuzzyBase( C05 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( rotZone == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>rotZone = false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>FuzzyBase( C04 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffTimer(&nbsp;TM12&nbsp;);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//一定の時間、同期投入回転数範囲に入っていたら</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( volZone == true &amp;&amp; rotZone == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( nowRpm &gt;= center[0] &amp;&amp; nowRpm &lt;= center[1] )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>if ( ChkTimer(&nbsp;TM13&nbsp;) == OFF )</span>
<span>//同期投入回転確認時間</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnTimer(&nbsp;TM13&nbsp;);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>else if ( ChkTimer(&nbsp;TM13&nbsp;) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OffTimer(&nbsp;TM13&nbsp;);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>engState = A_SUMMIT ;</span>
<span>//運転制御は負荷投入に入る</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>engStep = E_GENE ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OffTimer(&nbsp;TM13&nbsp;);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case E_GENE :</span>
<span>//発電中</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( nowRpm &lt; GetCtrl( C07&nbsp;))</span>
<span>//回転数が低下した</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkTimer( TM15 ) == OFF )</span>
<span>//エンスト確認時間</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnTimer( TM15 ) ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( ChkTimer( TM15 ) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OffTimer( TM15 ) ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>SetError(ERR_13);</span>
<span>//エンスト</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>engState = A_FAIL ;</span>
<span>//失敗</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>cause = U_FAIL;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>engStep = E_STOP ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffTimer( TM15 ) ;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case E_STOP :</span>
<span>//停止開始</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Analog.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>bool IsGeneVolt()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>return true;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Stepping.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>static short oldBase ;</span>
<span>//旧Fuzzy出力値</span>
 &nbsp;</p>
<p>&nbsp;<span>static short newBase ;</span>
<span>//新Fuzzy出力値</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitStepping()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>oldBase = newBase = C04 ;</span>
<span>//Fuzzy出力値</span>
 &nbsp;</p>
<p>&nbsp;<span>int n = GetCtrl( newBase );</span>
 &nbsp;</p>
<p>&nbsp;<span>ChangeBase( n );</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>void INT_MTU2S_MTU3S_TGIA3(void)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>nowRpm = GetRpm() ;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( oldBase != newBase )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>oldBase = newBase ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>int n = GetCtrl( newBase );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>ChangeBase( n );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>fuzValue = Fuzzy( nowRpm, oldRpm );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>void FuzzyBase( int n )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>newBase = n ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//自動制御にあるか？</span>
 &nbsp;</p>
<p>&nbsp;<span>bool IsAutoSequence()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( sequence ==&nbsp;S_AUTO)</span>
<span>//自動制御</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return true ;</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ファジー計算値を変更出来るようにします。</span>
 &nbsp;</p>
<p>&nbsp;<span>===== common.h ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//制御定数</span>
 &nbsp;</p>
<p>&nbsp;<span>enum {</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>C04,</span>
<span>//Fuzzy出力値A</span>
 &nbsp;</p>
<p>&nbsp;<span>C05,</span>
<span>//Fuzzy出力値B</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>};</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>該当する制御定数を変更します。</span>
 &nbsp;</p>
<p>&nbsp;<span>また、制御定数を変更したので、EEPROMのROMバージョン値を変更して下さい。</span>
 &nbsp;</p>
<p>&nbsp;<span>===== ctrl.h ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>const short ctrlBase[CTRLNUM] = {</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>60,</span>
<span>//C04</span>
 &nbsp;</p>
<p>&nbsp;<span>80,</span>
<span>//C05</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>};</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-20">
<span>(4) 停止検出</span>
</a>
</h2>
<p>&nbsp;<span>実機では、エンジンが止まるとクランクパルスが入らず、インプットキャプチャが呼び出されないので、タイマーがオーバーフローします。</span>
 &nbsp;</p>
<p>&nbsp;<span>下図のように、オーバーフローした次のデータは正しくありません。キャプチャーした値は少ないため高速と計算される可能性があります。</span>
 &nbsp;</p>
<p>&nbsp;<span>つまり、低回転で回っている場合、時々オーバーフローし、カウンター値は正しいとは限りません。ですからオーバーフローなしで1回転してからのデータで計算するようにします。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000005.gif" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>インプットキャプチャタイマーのオーバーフローを検出するようにします。</span>
 &nbsp;</p>
<p>&nbsp;<span>===== hwsetup.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//Interrupt priority</span>
 &nbsp;</p>
<p>&nbsp;<span>INTC.IPR10.BIT._MTU22C = 14 ;</span>
<span>//MTU22.TIER.BIT.TCIEV テスト用クランクポジションセンサー</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//マルチファンクションタイマー</span>
 &nbsp;</p>
<p>&nbsp;<span>//MTU2 チャネル2をテスト用クランクポジションセンサーに使用 PE6/TIOC2A</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU22.TIER.BIT.TGIEA = 1 ;</span>
<span>//1：TGFAビットによる割り込み要求（TGIA）を許可</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU22.TIER.BIT.TCIEV = 1 ;</span>
<span>//1：TCFVビットによる割り込み要求（TGIV）を許可</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>関数内を一部変更します。</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Rotation.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// 172 MTU2 MTU2 TGIA2</span>
 &nbsp;</p>
<p>&nbsp;<span>void INT_MTU2_MTU2_TGIA2(void)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( MTU22.TSR.BIT.TGFA )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU22.TSR.BIT.TGFA = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( newCtr &lt; 36 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>newCtr++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU22.TCNT = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>newCount = MTU22.TGRA ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//欠歯を判定する＝前回の値の３倍近い＝２倍を越えているなら欠歯</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; modify &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if (( ctrBuf[0] &gt; 0 ) &amp;&amp; ( newCount &gt;= ( ctrBuf[1] + ctrBuf[2] )))</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; delete &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>//</span>
<span>&nbsp;</span>
<span>if ( newCtr &lt; 36 )</span>
 &nbsp;</p>
<p>&nbsp;<span>//</span>
<span>&nbsp;</span>
<span>newCtr++;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//84msでoverflowする</span>
 &nbsp;</p>
<p>&nbsp;<span>// 176 MTU2 MTU2 TCIV2</span>
 &nbsp;</p>
<p>&nbsp;<span>void INT_MTU2_MTU2_TCIV2(void)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( MTU22.TSR.BIT.TCFV )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU22.TSR.BIT.TCFV = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>newCtr = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>また、停止しても回転数の数値が残ったままになります。</span>
 &nbsp;</p>
<p>&nbsp;<span>これを避けるために、エンジンの回転を監視する関数を追加します。</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Operation.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>void Operation()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>EngCtrl();</span>
<span>//エンジン制御部</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>WatchRotation();</span>
<span>//回転監視</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>回転数検出部を下記のように変更します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Rotation.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>#define HIGHCTR</span>
<span>650</span>
<span>//newCount &lt;= HIGHCTRで高速と判断 2000rpm</span>
 &nbsp;</p>
<p>&nbsp;<span>#define LOWCTR</span>
<span>10000</span>
<span>//newCount &gt;= LOWCTRで停止と判断 130rpm</span>
 &nbsp;</p>
<p>&nbsp;<span>#define MAXSURE</span>
<span>5</span>
 &nbsp;</p>
<p>&nbsp;<span>static short sure ;</span>
<span>//停止判断カウンター</span>
 &nbsp;</p>
<p>&nbsp;<span>static unsigned short oldPtr ;</span>
<span>//データ入力確認カウンター</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitRotate()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>rpmPtr = oldPtr = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>sure = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; modify &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>//</span>
<span>MTU2.TSTR.BIT.CST2 = 1 ;</span>
<span>//MTU2チャネル2タイマースタート</span>
 &nbsp;</p>
<p>&nbsp;<span>//</span>
<span>MTU2.TSTR.BIT.CST4 = 1 ;</span>
<span>//MTU2チャネル４タイマースタート</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//200ms毎に回転を監視する</span>
 &nbsp;</p>
<p>&nbsp;<span>void WatchRotation()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ChkTimer(&nbsp;TM19&nbsp;) == OFF )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnTimer(TM19);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else if ( ChkTimer(&nbsp;TM19&nbsp;) == ON )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return ;</span>
 &nbsp;</p>
<p>&nbsp;<span>OnTimer(TM19);</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( rpmPtr == oldPtr )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( sure &gt;= MAXSURE )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>InitRotate();</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sure = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sure++;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>oldPtr = rpmPtr ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( newCount &lt;&nbsp; HIGHCTR )</span>
<span>//2000rpm</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>SetError( ERR_7&nbsp;);</span>
<span>//高回転</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sure = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>今まで空だった関数の一部をここで補います。他のファイルの該当する空の関数の削除を忘れないで下さい。</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Rotation.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//クランクパルス出力を開始する</span>
 &nbsp;</p>
<p>&nbsp;<span>void StartCrankPulse()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>crankOut = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2.TSTR.BIT.CST4 = 1 ;</span>
<span>//テスト用クランクパルス出力タイマースタート</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//クランクパルス出力を停止する</span>
 &nbsp;</p>
<p>&nbsp;<span>void StopCrankPulse()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2.TSTR.BIT.CST4 = 0 ;</span>
<span>//テスト用クランクパルス出力タイマー停止</span>
 &nbsp;</p>
<p>&nbsp;<span>newCount =&nbsp; NUMERATOR2;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>void StartInputCapture()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2.TSTR.BIT.CST2 = 1 ;</span>
<span>//MTU2チャネル2 テスト用クランクポジションセンサータイマースタート</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>void StopInputCapture()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2.TSTR.BIT.CST2 = 0 ;</span>
<span>//MTU2チャネル2 テスト用クランクポジションセンサータイマー停止</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-21">
<span>(5) 動作確認２</span>
</a>
</h2>
<p>&nbsp;<span>では、ここまでの動作を調べてみましょう。</span>
 &nbsp;</p>
<p>&nbsp;<span>１）回転数を0rpmにして、スターターが回ったら、回転数を1000rpm程度にします。</span>
 &nbsp;</p>
<p>&nbsp;<span>２）この状態で、電圧確立フラグは１で、回転数確立フラグは０になっていますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>３）また、エンジン状態フラグは１になっていますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>４）回転数を徐々に上げて、1400rpmを越えると回転数確立フラグは１になりますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>５）さらに回転数を上げて、1470rpmを越えるとエンジン状態フラグは２になりますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>６）そして、シーケンスが運転ステージに移り、負荷投入が開始されましたか？</span>
 &nbsp;</p>
<p>&nbsp;<span>７）この状態から回転数を1100rpmより下げると、エンストになり、スロットルは閉じましたか？</span>
 &nbsp;</p>
<p>&nbsp;<span>８）停止シーケンスに移り、回転数を100rpm以下にすると、負荷の切断が行われ、待機状態に戻りましたか？</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>OKでしたら、次は実用化に向けて、必須の異常処理部を追加します。</span>
 &nbsp;</p>
<p>&nbsp;</p>
<div></div>
<br />
&nbsp;<h1>
<a id="calibre_link-22">
<span>[7]&nbsp;異常処理</span>
</a>
</h1>
<p>&nbsp;<span>さて、実際に機械が動作する段階に入りますので、異常を検知して停止する機能が必要になります。</span>
 &nbsp;</p>
<p>&nbsp;<span>異常を扱うオブジェクトファイルを新規に作成します。</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-23">
<span>(1)&nbsp;プログラム</span>
</a>
</h2>
<p>&nbsp;<span>=====&nbsp;Error.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//――――――――――――――――――――――――</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; FILE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : Error.cpp</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; DESCRIPTION : Error Check</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; CPU TYPE&nbsp;&nbsp;&nbsp; : SH7286</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; DATE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : Nov 01, 2016</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; VERSION ：1.0&nbsp;&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//――――――――――――――――――――――――</span>
 &nbsp;</p>
<p>&nbsp;<span>#include &lt;string.h&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>#include &lt;stdlib.h&gt;</span>
<span>//abs</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "iodefine.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>extern "C" {</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "vect.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "common.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "proto.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>// ------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>// ------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>static short errCode ;</span>
<span>//エラーコード</span>
 &nbsp;</p>
<p>&nbsp;<span>static int errBit ;</span>
<span>//エラービット</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//エラービット Hex&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//01 緊急停止ボタン</span>
 &nbsp;</p>
<p>&nbsp;<span>//02 スロットル位置範囲外</span>
 &nbsp;</p>
<p>&nbsp;<span>//04再起動失敗＝再起動3回でも正常にならない</span>
 &nbsp;</p>
<p>&nbsp;<span>//08 原点復帰失敗</span>
 &nbsp;</p>
<p>&nbsp;<span>//10 ステッピングモーター異常</span>
 &nbsp;</p>
<p>&nbsp;<span>//20 サーマルトリップ</span>
 &nbsp;</p>
<p>&nbsp;<span>//40高回転</span>
 &nbsp;</p>
<p>&nbsp;<span>//80 油圧スイッチ作動</span>
 &nbsp;</p>
<p>&nbsp;<span>//100 冷却水高温</span>
 &nbsp;</p>
<p>&nbsp;<span>//200周波数範囲外</span>
 &nbsp;</p>
<p>&nbsp;<span>//400発電電圧範囲外</span>
 &nbsp;</p>
<p>&nbsp;<span>//800 起動失敗＝＞致命的なエラーではない 再起動可能</span>
 &nbsp;</p>
<p>&nbsp;<span>//1000 エンスト＝＞致命的なエラーではない 再起動可能</span>
 &nbsp;</p>
<p>&nbsp;<span>//2000 確立失敗 ＝＞致命的なエラーではない 再起動可能</span>
 &nbsp;</p>
<p>&nbsp;<span>//4000 冷却水レベル</span>
 &nbsp;</p>
<p>&nbsp;<span>//8000&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>#define MSGSIZE</span>
<span>16</span>
 &nbsp;</p>
<p>&nbsp;<span>static const char *error[MSGSIZE] ={</span>
 &nbsp;</p>
<p>&nbsp;<span>"01:Emergency stop",</span>
 &nbsp;</p>
<p>&nbsp;<span>"02:Throttle range",</span>
 &nbsp;</p>
<p>&nbsp;<span>"04:Fail to&nbsp;restart",</span>
 &nbsp;</p>
<p>&nbsp;<span>"08:Fail to return",</span>
 &nbsp;</p>
<p>&nbsp;<span>"10:Step Motor Fail",</span>
 &nbsp;</p>
<p>&nbsp;<span>"20:Thermal trip",</span>
 &nbsp;</p>
<p>&nbsp;<span>"40:High rotation",</span>
 &nbsp;</p>
<p>&nbsp;<span>"80:Oil pressure",</span>
 &nbsp;</p>
<p>&nbsp;<span>"100:Water temp",</span>
 &nbsp;</p>
<p>&nbsp;<span>"200:Frequency range",</span>
 &nbsp;</p>
<p>&nbsp;<span>"400:Voltage range",</span>
 &nbsp;</p>
<p>&nbsp;<span>"800:Fail to start up",</span>
 &nbsp;</p>
<p>&nbsp;<span>"1000:Engine stall",</span>
 &nbsp;</p>
<p>&nbsp;<span>"2000:Fail establish",</span>
 &nbsp;</p>
<p>&nbsp;<span>"4000:Water level",</span>
 &nbsp;</p>
<p>&nbsp;<span>"8000:",</span>
 &nbsp;</p>
<p>&nbsp;<span>};</span>
 &nbsp;</p>
<p>&nbsp;<span>//再起動</span>
 &nbsp;</p>
<p>&nbsp;<span>enum {</span>
 &nbsp;</p>
<p>&nbsp;<span>T_StartUp,</span>
<span>//起動失敗</span>
 &nbsp;</p>
<p>&nbsp;<span>T_EngStop,</span>
<span>//エンジンストップ</span>
 &nbsp;</p>
<p>&nbsp;<span>T_Unstable,</span>
<span>//電圧、回転不確立</span>
 &nbsp;</p>
<p>&nbsp;<span>T_NotFix,</span>
<span>//予備</span>
 &nbsp;</p>
<p>&nbsp;<span>TRYNUM</span>
 &nbsp;</p>
<p>&nbsp;<span>};</span>
 &nbsp;</p>
<p>&nbsp;<span>#define SERIOUS</span>
<span>0x07FF</span>
 &nbsp;</p>
<p>&nbsp;<span>#define BOOTABLE</span>
<span>0xF800</span>
 &nbsp;</p>
<p>&nbsp;<span>static unsigned short tryCtr[TRYNUM];</span>
<span>//再起動カウンター</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>// ---------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private function</span>
 &nbsp;</p>
<p>&nbsp;<span>// ---------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>static void SetErrBit( int errCode );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//--------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>// Functions</span>
 &nbsp;</p>
<p>&nbsp;<span>//--------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitError()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>errCode = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>errBit = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt; TRYNUM ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>tryCtr[n] = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//緊急に停止する必要があるか？</span>
 &nbsp;</p>
<p>&nbsp;<span>bool IsEmergency()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( IsEmStop() == true )</span>
<span>// 3 緊急停止ボタン&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>SetError( ERR_1 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return true;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else if (( errBit &amp; SERIOUS ) != 0 )</span>
<span>//重大エラー</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return true;</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//異常チェック</span>
 &nbsp;</p>
<p>&nbsp;<span>void ErrorCheck()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( IsRunning() == true )&nbsp;</span>
<span>//運転中に</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( GetStage() == M_RUN )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//スロットルポジションを監視する</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>int val = GetAdcVal(P_Ai02);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>int max = GetCtrl( C03 );</span>
<span>//スロットルポジション最大値</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( val &gt; max )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>SetError( ERR_2 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>int min = GetCtrl( C02 );</span>
<span>//スロットルポジション最小値（AD値）</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( val &lt; min )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>SetError( ERR_2 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//サーマルトリップ</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkInp( P_Di07 ) == ON )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>SetError( ERR_6 );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//負荷投入後</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( IsNormalRun() == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>int range = GetCtrl( C12 ) * 10;</span>
<span>//周波数許容値&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>int val = GetHelz();</span>
<span>//0.1Hz</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( abs( val - 500 ) &gt; range )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkTimer( TM24 ) == OFF )</span>
<span>//周波数監視時間</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnTimer( TM24 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( ChkTimer( TM24 ) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>SetError( ERR_10 );</span>
<span>//周波数範囲外</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffTimer( TM24 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>range = GetCtrl( C13 ) * 10;</span>
<span>//発電電圧許容値 0.1V&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>int volt = GetCtrl( C14 ) * 10 ;</span>
<span>//中心電圧 0.1V</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>val = GetVoltage();</span>
<span>//0.1V</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( abs( val - volt ) &gt; range )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkTimer( TM25 ) == OFF )</span>
<span>//発電電圧監視時間</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnTimer( TM25 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( ChkTimer( TM25 ) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>SetError( ERR_11 );</span>
<span>//発電電圧範囲外</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffTimer( TM25 );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffTimer( TM24 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffTimer( TM25 );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>/*</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ChkInp( P_Di05 ) == ON )</span>
<span>// 油圧スイッチ</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>SetError( ERR_8 );</span>
 &nbsp;</p>
<p>&nbsp;<span>*/</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ChkInp( P_Di08 ) == ON )</span>
<span>// 冷却水レベル</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>SetError( ERR_15 );</span>
 &nbsp;</p>
<p>&nbsp;<span>/*</span>
 &nbsp;</p>
<p>&nbsp;<span>val = GetAdcVal(P_Ai03);</span>
<span>//冷却水温</span>
 &nbsp;</p>
<p>&nbsp;<span>max = GetCtrl( C10 );</span>
<span>//冷却水温異常値</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( val &gt; max )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>SetError( ERR_9 );</span>
 &nbsp;</p>
<p>&nbsp;<span>*/</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ChkInp( P_Di04 ) == OFF )</span>
<span>// 4 自動=OFF／手動=ON</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if (( errBit &amp; SERIOUS ) != 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkOut( P_Do03 ) == OFF )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnOut( P_Do03 );</span>
<span>//異常ランプ</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkOut( P_Do03 ) == ON )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OffOut( P_Do03 );</span>
<span>//異常ランプ</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//エラーの重大さ</span>
 &nbsp;</p>
<p>&nbsp;<span>int Severity()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if (( errBit &amp; SERIOUS ) != 0 )</span>
<span>//重大エラー</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return HIGH_ERR;</span>
 &nbsp;</p>
<p>&nbsp;<span>else if (( errBit &amp; BOOTABLE ) != 0 )</span>
<span>//再起動可能エラー</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return LOW_ERR;</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return NONE_ERR;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//エラーコードを返す</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetErrorCode()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>return errCode ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//エラービットを返す</span>
 &nbsp;</p>
<p>&nbsp;<span>void GetErrorBit( int val[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>val[0] = errBit ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//エラーをリセットする</span>
 &nbsp;</p>
<p>&nbsp;<span>void ResetError()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>InitError();</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//エラーコードからエラービットをセットする</span>
 &nbsp;</p>
<p>&nbsp;<span>static void SetErrBit( int code )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( code &gt; 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>unsigned int mask = 0x0001 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>mask &lt;&lt;= ( code - 1 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if (( errBit &amp; mask ) == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>errBit |= mask ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//再起動エラーをチェックする</span>
 &nbsp;</p>
<p>&nbsp;<span>//異常検出回数に達した時はtrueを返す</span>
 &nbsp;</p>
<p>&nbsp;<span>static bool ChkRetryErr( int code )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>int index = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>switch ( code ){</span>
 &nbsp;</p>
<p>&nbsp;<span>case ERR_12 :</span>
<span>//起動失敗（再起動エラー）</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>index = T_StartUp ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case ERR_13 :</span>
<span>//エンジンストップ（再起動エラー）</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>index = T_EngStop ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case ERR_14 :</span>
<span>//確立失敗（再起動エラー）</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>index = T_Unstable ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case ERR_16 :</span>
<span>//予備（再起動エラー）</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>index = T_NotFix ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>default :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>unsigned int mask = 0x0001 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( code &gt; 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>mask &lt;&lt;= ( code - 1 );</span>
 &nbsp;</p>
<p>&nbsp;<span>int noMore = GetCtrl( C09 );</span>
<span>//再起動異常検出回数</span>
 &nbsp;</p>
<p>&nbsp;<span>tryCtr[index] += 1 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( tryCtr[index] &gt;= noMore )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return true ;</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//エラーコードをセットする</span>
 &nbsp;</p>
<p>&nbsp;<span>void SetError( int code )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>errCode = code ;</span>
 &nbsp;</p>
<p>&nbsp;<span>switch ( code ){</span>
 &nbsp;</p>
<p>&nbsp;<span>case ERR_1 :</span>
<span>//緊急停止</span>
 &nbsp;</p>
<p>&nbsp;<span>case ERR_2 :</span>
<span>//スロットル位置逸脱</span>
 &nbsp;</p>
<p>&nbsp;<span>case ERR_3 :</span>
<span>//再起動失敗</span>
 &nbsp;</p>
<p>&nbsp;<span>case ERR_4 :</span>
<span>//原点復帰失敗</span>
 &nbsp;</p>
<p>&nbsp;<span>case ERR_5 :</span>
<span>//ステッピングモーター異常</span>
 &nbsp;</p>
<p>&nbsp;<span>case ERR_6 :</span>
<span>//サーマルトリップ</span>
 &nbsp;</p>
<p>&nbsp;<span>case ERR_7 :</span>
<span>//高回転</span>
 &nbsp;</p>
<p>&nbsp;<span>case ERR_8 :</span>
<span>//油圧スイッチ作動</span>
 &nbsp;</p>
<p>&nbsp;<span>case ERR_9 :</span>
<span>//冷却水高温</span>
 &nbsp;</p>
<p>&nbsp;<span>case ERR_10 :</span>
<span>//周波数範囲外</span>
 &nbsp;</p>
<p>&nbsp;<span>case ERR_11 :</span>
<span>//発電電圧範囲外</span>
 &nbsp;</p>
<p>&nbsp;<span>case ERR_15 :</span>
<span>//冷却水レベル&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>SetErrBit( code );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case ERR_12 :</span>
<span>//起動失敗（再起動エラー）</span>
 &nbsp;</p>
<p>&nbsp;<span>case ERR_13 :</span>
<span>//エンスト（再起動エラー）</span>
 &nbsp;</p>
<p>&nbsp;<span>case ERR_14 :</span>
<span>//確立失敗（再起動エラー）</span>
 &nbsp;</p>
<p>&nbsp;<span>case ERR_16 :</span>
<span>//予備（再起動エラー）</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>SetErrBit( code );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkRetryErr( code ) == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>SetErrBit( ERR_3&nbsp;);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>===== common.h ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//タイマー</span>
 &nbsp;</p>
<p>&nbsp;<span>enum {</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>TM24,</span>
<span>//周波数監視時間</span>
 &nbsp;</p>
<p>&nbsp;<span>TM25,</span>
<span>//発電電圧監視時間</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>};</span>
 &nbsp;</p>
<p>&nbsp;<span>//制御定数</span>
 &nbsp;</p>
<p>&nbsp;<span>enum {</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>C03,</span>
<span>//スロットルポジション最大値（AD値）</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>C09,</span>
<span>//再起動異常検出回数</span>
 &nbsp;</p>
<p>&nbsp;<span>C10,</span>
<span>//冷却水温異常値</span>
 &nbsp;</p>
<p>&nbsp;<span>C11,</span>
<span>//可動範囲の最大パルス数</span>
 &nbsp;</p>
<p>&nbsp;<span>C12,</span>
<span>//周波数許容値</span>
 &nbsp;</p>
<p>&nbsp;<span>C13,</span>
<span>//発電電圧許容値</span>
 &nbsp;</p>
<p>&nbsp;<span>C14,</span>
<span>//中心電圧</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>};</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>===== timer.h ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>const unsigned short timeBase[TMRNUM] = {</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>30,</span>
<span>//TM24</span>
 &nbsp;</p>
<p>&nbsp;<span>30,</span>
<span>//TM25</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>};</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>===== cntl.h ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>const short ctrlBase[CTRLNUM] = {</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>1300,</span>
<span>//C03</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>3,</span>
<span>//C09&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>1000,</span>
<span>//C10</span>
 &nbsp;</p>
<p>&nbsp;<span>1000,</span>
<span>//C11</span>
 &nbsp;</p>
<p>&nbsp;<span>5,</span>
<span>//C12</span>
 &nbsp;</p>
<p>&nbsp;<span>20,</span>
<span>//C13</span>
 &nbsp;</p>
<p>&nbsp;<span>230,</span>
<span>//C14</span>
 &nbsp;</p>
<p>&nbsp;<span>};</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Main.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>void main(void)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>InitError();</span>
 &nbsp;</p>
<p>&nbsp;<span>set_imask(0);</span>
<span>//割り込みマスクレベル変更</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Operation.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>void Operation()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>ErrorCheck();</span>
 &nbsp;</p>
<p>&nbsp;<span>nowRpm = GetRpm() ;</span>
<span>//回転数</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//運転中(TRUE)か否(FALSE)か</span>
 &nbsp;</p>
<p>&nbsp;<span>bool IsRunning()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( runStage &gt;= M_START &amp;&amp; runStage &lt;= M_RUN )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return true;</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetStage()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>return runStage ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>bool IsNormalRun()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( runStage == M_RUN &amp;&amp; runSeq == R_RUNNING )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return true;</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>下記のファンクションは第4巻で式を設定しますが、ここでは一時的に値を設定しています。</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Analog.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetVoltage()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>return 2300; //0.1V</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetCurrent()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>return 600;&nbsp;</span>
<span>//0.1A</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetHelz()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>return 500;&nbsp;</span>
<span>//0.1Hz</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>エラービット情報と、エラーの内容一覧を表示します。</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Display.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>void DispLCD()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>switch ( nowPage ){</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>case D_ErrInfo :</span>
<span>//Error information</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>DispFunc( GetErrInfo,&nbsp; GetInfoMsg );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>LCD画面に表示するデータを準備します。</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Error.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>static const char&nbsp;scErrInfo[][21] = {</span>
<span>//異常情報</span>
 &nbsp;</p>
<p>&nbsp;<span>{"Error&nbsp; 00&nbsp;&nbsp;&nbsp; 0000&nbsp;&nbsp; "},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"Try&nbsp; 00 00&nbsp;00 00&nbsp;&nbsp;&nbsp; "}};</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetErrInfo(int val[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>val[0] = errCode ;</span>
 &nbsp;</p>
<p>&nbsp;<span>val[1] = errBit ;</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt; TRYNUM ; n++ )</span>
<span>//TRYNUM=4</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>val[n+2] = tryCtr[n] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>int n1 = TRYNUM + 2 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>int data[2];</span>
 &nbsp;</p>
<p>&nbsp;<span>int n2 = GetOffset( data );</span>
<span>//Record offset</span>
 &nbsp;</p>
<p>&nbsp;<span>val[n1] = data[0];</span>
 &nbsp;</p>
<p>&nbsp;<span>val[n1+1] = data[1];</span>
 &nbsp;</p>
<p>&nbsp;<span>return n1 + n2 ;</span>
<span>//=8</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>void GetInfoMsg( int val[], char buff[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>char line[42], temp[8] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[0] = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>//1st line</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( line, scErrInfo[0], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[0], temp );</span>
<span>//Error code</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 2, ' ' );</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[7], temp, 2 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoh4( val[1], temp );</span>
<span>//Error bits</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[13], temp, 4 );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>//2nd line</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( line, scErrInfo[1], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt; 4 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>itoa2( val[n+2], temp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>adjust( temp, 2, ' ' );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strncpy( &amp;line[5+n*3], temp, 2 );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>//Record offset</span>
 &nbsp;</p>
<p>&nbsp;<span>GetOffsetMsg( &amp;val[6], line );</span>
<span>//Two rows of data</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<span>&nbsp;</span>
<a id="calibre_link-24">
<span>(2) 動作確認</span>
</a>
</h2>
<p>&nbsp;<span>では、エラー処理の動作を確認しましょう。スターターを無駄に動作させないために、ここで再起動の動作をしっかり確認しておきます。</span>
 &nbsp;</p>
<p>&nbsp;<span>１）回転数VRを0rpmにして、スタートボタンを押します。</span>
 &nbsp;</p>
<p>&nbsp;<span>２）始動ステージでスターターがON/OFFをリトライ回数繰り返し、起動失敗で停止ステージに移りますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>３）停止ステージから、待機に移り、再びスターターが起動しますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>４）これを再起動回数繰り返したら、再起動異常で停止しますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>５）リセットボタンを押しても、スタートボタンを押さない限り、起動はしませんか？</span>
 &nbsp;</p>
<p>&nbsp;<span>６）では再びスタートボタンを押して、スターターがON/OFFし、起動を試みている時に停止ボタンを押して下さい。</span>
 &nbsp;</p>
<p>&nbsp;<span>７）待機ステージに戻ってから、自動的に再起動することはありませんか？</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>OKでしたら、次は確立段階の再起動をテストします。</span>
 &nbsp;</p>
<p>&nbsp;<span>８）スタートボタンを押し、スターターがONしたら、回転数を400rpm以上にすると</span>
 &nbsp;</p>
<p>&nbsp;<span>スターターがOFFになります。それから回転数を1200rpm位に上げます。</span>
 &nbsp;</p>
<p>&nbsp;<span>９）スロットルの自動制御が開始されましたが、スロットルをもっと開いても目標回転数に達しないので、やがて制限開度に達し、スロットル位置の異常で停止しますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>１０）再び起動して、今度は回転数を1450rpmにすると、回転数確立にはなりますが、負荷の投入には回転数が不足しています。このまま確立監視時間切れになると、確立失敗になり停止しますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>１１）これを再起動回数繰り返したら、再起動異常で停止しますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>１２）この場合もスタートボタンを押さない限り、起動はしませんか？</span>
 &nbsp;</p>
<p>&nbsp;<span>１３）では、再び起動して、運転ステージに進め、回転数を徐々に上げ2000rpmを越えると、高回転異常で停止しますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>１４）運転中にサーマルトリップを動作させると、緊急停止しますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>さらに、不測の事態に備えるために、種々の想定で試験を行って下さい。</span>
 &nbsp;</p>
<p>&nbsp;</p>
<div></div>
<br />
&nbsp;<h1>
<a id="calibre_link-25">
<span>[8]&nbsp;運転記録</span>
</a>
</h1>
<p>&nbsp;<span>運転の開始や停止時刻、異常の発生理由とその時の状態をEEPROMに記録します。</span>
 &nbsp;</p>
<p>&nbsp;<span>記録データは一時的に記憶して、EEPROMへの書き込みは、多量の割り込みが発生していない時に行います。</span>
 &nbsp;</p>
<p>&nbsp;<span>図示すると、下図の「S」が一時記憶で、「E」EEPROMへの書き込みです。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000007.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>上図に従って、コードを記述します。</span>
 &nbsp;</p>
<p>&nbsp;<a id="calibre_link-26">
<span>(1)&nbsp;プログラム</span>
</a>
 &nbsp;</p>
<p>&nbsp;<span>一時的に記憶する場所を設定します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Operation.cpp&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>#define RECBUFSZ</span>
<span>3</span>
 &nbsp;</p>
<p>&nbsp;<span>static RECORD runRecord[RECBUFSZ] ;</span>
<span>//運転記録一時バッファ</span>
 &nbsp;</p>
<p>&nbsp;<span>#define B_START</span>
<span>0x0100</span>
 &nbsp;</p>
<p>&nbsp;<span>#define B_STOP</span>
<span>0x0200</span>
 &nbsp;</p>
<p>&nbsp;<span>#define B_ERROR</span>
<span>0x0400</span>
 &nbsp;</p>
<p>&nbsp;<span>#define B_EMSTOP</span>
<span>0x0800</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private function</span>
 &nbsp;</p>
<p>&nbsp;<span>static void ClearRunRecord(void);</span>
 &nbsp;</p>
<p>&nbsp;<span>static bool SetRecordEEPROM(void);</span>
 &nbsp;</p>
<p>&nbsp;<span>static void WriteRunRecord( int state );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitOperation()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>ClearRunRecord();</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>１）スタートボタンを押した時に、記録し書き込みします。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Operation.cpp&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>static void Waiting()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>case W_START :</span>
<span>//起動再確認</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkTimer(&nbsp;TM18&nbsp;) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsStartReady() == 0 )</span>
<span>//起動可能なら</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>WriteRunRecord(&nbsp;B_START );</span>
<span>//運転記録</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>SetRecordEEPROM();</span>
<span>//運転記録書き込み</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>runStage = M_START ;</span>
<span>//発電装置運転開始</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>２）重大な異常が発生した時に記録します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Operation.cpp&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>static void Starting()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//緊急停止</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( IsEmergency() == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>EmStop();</span>
<span>//緊急停止</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>WriteRunRecord(&nbsp;B_EMSTOP );</span>
<span>//運転記録</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runStage = M_WAIT ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>static void Running()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//緊急停止</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( IsEmergency() == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>EmStop();</span>
<span>//緊急停止</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>WriteRunRecord(&nbsp;B_EMSTOP );</span>
<span>//運転記録</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runStage = M_WAIT ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>static void Stopping()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//緊急停止</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( IsEmergency() == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>EmStop();</span>
<span>//緊急停止</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>WriteRunRecord(&nbsp;B_EMSTOP );</span>
<span>//運転記録</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runStage = M_WAIT ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>3)運転に失敗した時に、記録します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Operation.cpp&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>static void Starting()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>case&nbsp;S_MOST :</span>
<span>//回転上昇待ち</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( engState == A_FAIL )</span>
<span>//起動渋滞</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>WriteRunRecord(&nbsp;B_ERROR );</span>
<span>//運転記録</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runStage = M_STOP ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>static void Running()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( engState == A_FAIL )</span>
<span>//不具合発生</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>WriteRunRecord(&nbsp;B_ERROR );</span>
<span>//運転記録</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runStage = M_STOP ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>4)停止ステージで原点復帰が失敗した時に、記録します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Operation.cpp&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>static void Stopping()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>case T_ZERO :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( ChkTimer(&nbsp;TM20&nbsp;) == UP )</span>
<span>//原点復帰待ち時間</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffTimer(&nbsp;TM20&nbsp;);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>SetError(ERR_4);</span>
<span>//原点復帰失敗</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>WriteRunRecord(&nbsp;B_ERROR );</span>
<span>//運転記録</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runStage = M_WAIT ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>5)異常ではなくて、停止ボタンで運転を停止した時に、記録し書き込みます。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Operation.cpp&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>static void Stopping()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>case T_WAIT :</span>
<span>//再起動の休止時間</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>restart&nbsp;= true;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>WriteRunRecord(&nbsp;B_STOP );</span>
<span>//運転記録</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>SetRecordEEPROM();</span>
<span>//運転記録書き込み</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runStage = M_WAIT ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>6)異常の書き込みを行います。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Operation.cpp&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>static void Waiting()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>case W_ERROR :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>EmStop();</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>SetRecordEEPROM();</span>
<span>//運転記録書き込み</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>runSeq++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>記録に必要な関数を定義します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Operation.cpp&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//一時保存する</span>
 &nbsp;</p>
<p>&nbsp;<span>static void WriteRunRecord( int state )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>RECORD *sp ;</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int p = 0 ; p &lt; RECBUFSZ ; p++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp = &amp;runRecord[p] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( sp-&gt;state&nbsp;!= 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>continue;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;state = state + GetErrorCode() ;</span>
<span>//4) 装置状態（上位）＋異常番号（下位）</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;value1 = nowRpm ;</span>
<span>//5) 回転数</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;stage = ( runStage &lt;&lt; 8 ) + runSeq ;</span>
<span>//6)運転ステージ（上位）＋運転シーケンス番号（下位）</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;engine = ( engState &lt;&lt; 8 ) + engStep ;</span>
<span>//7) エンジン状態（上位）＋エンジン制御シーケンス番号（下位）</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;step = ( GetStepSeq() &lt;&lt; 8 ) +&nbsp;restart&nbsp;;</span>
<span>//8)ステップモーターシーケンス番号（上位）＋再起動フラグ（下位）</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;value2 = ( GetVoltage() &lt;&lt; 8 ) + GetCurrent() ;</span>
<span>//9) 実効電圧値（上位）＋実効電流値（下位）</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>static void ClearRunRecord()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>RECORD *sp ;</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt; RECBUFSZ ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp = &amp;runRecord[n] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;yearMonth = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;dayHour = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;minSec = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;state =&nbsp; 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;value1 = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;stage= 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;engine= 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;step= 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;value2 = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//一時保存された記録を全て書き込む</span>
 &nbsp;</p>
<p>&nbsp;<span>static bool SetRecordEEPROM()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>bool flag = false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>unsigned char caleTbl[7] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>set_imask(15);</span>
<span>//割り込みマスクレベル変更</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ReadTimeRTC( caleTbl ) == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>RECORD *sp ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( int p = 0 ; p &lt; RECBUFSZ ; p++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp = &amp;runRecord[p] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( sp-&gt;state&nbsp;== 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>continue;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>int m = caleTbl[6] ;</span>
<span>//year</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>m &lt;&lt;= 8 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>int n = caleTbl[5] ;</span>
<span>//month</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;yearMonth = m + n ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//caleTbl[4]は週</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>m = caleTbl[3] ;</span>
<span>//day</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>m &lt;&lt;= 8 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n = caleTbl[2] ;</span>
<span>//hour</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;dayHour = m + n ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>m = caleTbl[1] ;</span>
<span>//min</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>m &lt;&lt;= 8 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n = caleTbl[0] ;</span>
<span>//sec</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;minSec = m + n ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>flag = WriteRecordEEPROM( sp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( flag == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>flag = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>set_imask(0);</span>
<span>//割り込みマスクレベル変更</span>
 &nbsp;</p>
<p>&nbsp;<span>ClearRunRecord();</span>
 &nbsp;</p>
<p>&nbsp;<span>return flag;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Stepping.cpp&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetStepSeq()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>return sequence;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-27">
<span>(2)&nbsp;動作確認</span>
</a>
</h2>
<p>&nbsp;<span>では、運転を開始して、運転中に停止させる、運転中に異常を発生させる、等々を行い記録してみましょう。</span>
 &nbsp;</p>
<p>&nbsp;<span>そして、シリアル通信で読み出して、正しく記録されたか確認しましょう。</span>
 &nbsp;</p>
<p>&nbsp;</p>
<div></div>
<br />
&nbsp;<h1>
<a id="calibre_link-28">
<span>[9]&nbsp;メッセージ</span>
</a>
</h1>
<p>&nbsp;<span>運転状態をLCD画面で確認できましたが、数字で表示されるので、その意味を文字で画面に表示したら便利です。下記の４種のメッセージを準備します。</span>
 &nbsp;</p>
<p>&nbsp;<span>１）異常番号の内容</span>
 &nbsp;</p>
<p>&nbsp;<span>２）エンジン制御シーケンス</span>
 &nbsp;</p>
<p>&nbsp;<span>３）起動不可の理由</span>
 &nbsp;</p>
<p>&nbsp;<span>４）ステップモーター制御シーケンス</span>
 &nbsp;</p>
<p>&nbsp;<span>画面のスクロールはリセットボタンで行います。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Error.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>static const char scError[][21] = {</span>
<span>// Error Message</span>
 &nbsp;</p>
<p>&nbsp;<span>{"Error Message&nbsp;&nbsp; 0&nbsp;&nbsp; "},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "}};</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp;mから3行の文字列を返します</span>
 &nbsp;</p>
<p>&nbsp;<span>void GetErrMsg( int m, int val, char buff[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>char line[22], temp[8] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>int j, k ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[0] = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>//1st line</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( line, scError[0], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoh4( val, temp );</span>
<span>//Error bits</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[16], temp, 4 );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//After 2nd line</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( m &gt;= MSGSIZE )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>j = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>j = m ;</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt; 3 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strncpy( line, scError[1], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>k = strlen( error[j] );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strncpy( line, error[j], k );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ++j &gt;= MSGSIZE )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>j = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetErrMsgSize()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>return MSGSIZE ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Operation.cpp&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>//エンジン制御シーケンスのメッセージ</span>
 &nbsp;</p>
<p>&nbsp;<span>#define ENGMSG</span>
<span>11</span>
 &nbsp;</p>
<p>&nbsp;<span>static const char *engineMsg[ENGMSG] ={</span>
<span>//engStep</span>
 &nbsp;</p>
<p>&nbsp;<span>"0:Stanby",</span>
 &nbsp;</p>
<p>&nbsp;<span>"1:Throttle start",</span>
 &nbsp;</p>
<p>&nbsp;<span>"2:Start position",</span>
 &nbsp;</p>
<p>&nbsp;<span>"3:Starter ON",</span>
 &nbsp;</p>
<p>&nbsp;<span>"4:Wait Rotation up",</span>
 &nbsp;</p>
<p>&nbsp;<span>"5:Retry",</span>
 &nbsp;</p>
<p>&nbsp;<span>"6:Auto Control",</span>
 &nbsp;</p>
<p>&nbsp;<span>"7:Wait Stable state",</span>
 &nbsp;</p>
<p>&nbsp;<span>"8:Generating",</span>
 &nbsp;</p>
<p>&nbsp;<span>"9:Stop",</span>
 &nbsp;</p>
<p>&nbsp;<span>"10:Wait Slowdown"</span>
 &nbsp;</p>
<p>&nbsp;<span>};</span>
 &nbsp;</p>
<p>&nbsp;<span>//起動不可の理由のメッセージ</span>
 &nbsp;</p>
<p>&nbsp;<span>#define STARTMSG</span>
<span>5</span>
 &nbsp;</p>
<p>&nbsp;<span>static const char *startMsg[STARTMSG] ={</span>
 &nbsp;</p>
<p>&nbsp;<span>"1:Emergency button",</span>
 &nbsp;</p>
<p>&nbsp;<span>"2:Thermal trip",</span>
 &nbsp;</p>
<p>&nbsp;<span>"3:Rotation high",</span>
 &nbsp;</p>
<p>&nbsp;<span>"4:Step position",</span>
 &nbsp;</p>
<p>&nbsp;<span>"5:Manual mode",</span>
 &nbsp;</p>
<p>&nbsp;<span>};</span>
 &nbsp;</p>
<p>&nbsp;<span>static const char scEngStep[][21] = {</span>
 &nbsp;</p>
<p>&nbsp;<span>{"Engine Step&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp; "},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "}};</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>static const char scStartup[][21] = {</span>
 &nbsp;</p>
<p>&nbsp;<span>{"StartUp&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "}};</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>void GetEngStep( int val[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>val[0] = engStep ;</span>
<span>//エンジン制御シーケンス</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>// mから3行の文字列を返します</span>
 &nbsp;</p>
<p>&nbsp;<span>void GetEngineMsg( int m, int val, char buff[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>char line[22], temp[8] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>int j, k ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[0] = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>//1行目</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( line, scEngStep[0], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val, temp );</span>
<span>//&nbsp;エンジン制御シーケンス</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 2, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[14], temp, 2 );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//2行目以降</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( m &gt;= ENGMSG )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>j = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>j = m ;</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt; 3 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strncpy( line, scEngStep[1], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>k = strlen( engineMsg[j] );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strncpy( line, engineMsg[j], k );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ++j &gt;= ENGMSG )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>j = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetEngMsgSize()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>return ENGMSG ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>void GetReason( int val[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>val[0] = reason ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>// mから3行の文字列を返します</span>
 &nbsp;</p>
<p>&nbsp;<span>void GetReasonMsg( int m, int val, char buff[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>char line[22], temp[8] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>int j, k ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[0] = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>//1行目</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( line, scStartup[0], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val, temp );</span>
<span>//</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 2, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[12], temp, 2 );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//2行目以降</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( m &gt;= STARTMSG )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>j = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>j = m ;</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt; 3 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strncpy( line, scStartup[1], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>k = strlen( startMsg[j] );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strncpy( line, startMsg[j], k );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ++j &gt;= STARTMSG )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>j = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetReasonSize()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>return STARTMSG ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ステップモーター制御シーケンスのメッセージ</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Stepping.cpp&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>#define MSGSIZE</span>
<span>10</span>
 &nbsp;</p>
<p>&nbsp;<span>static const char *motor[MSGSIZE] ={</span>
 &nbsp;</p>
<p>&nbsp;<span>"0:Begin sequence",</span>
 &nbsp;</p>
<p>&nbsp;<span>"1:Confirm stable",</span>
 &nbsp;</p>
<p>&nbsp;<span>"2:Move away",</span>
 &nbsp;</p>
<p>&nbsp;<span>"3:Back to Home",</span>
 &nbsp;</p>
<p>&nbsp;<span>"4:Confirm arrival",</span>
 &nbsp;</p>
<p>&nbsp;<span>"5:Stand by",</span>
 &nbsp;</p>
<p>&nbsp;<span>"6:Fix position",</span>
 &nbsp;</p>
<p>&nbsp;<span>"7:Auto control",</span>
 &nbsp;</p>
<p>&nbsp;<span>"8:Error",</span>
 &nbsp;</p>
<p>&nbsp;<span>"9:Error2"</span>
 &nbsp;</p>
<p>&nbsp;<span>};</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>static const char scMtrStep[][21] = {</span>
 &nbsp;</p>
<p>&nbsp;<span>{"Motor Step&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp; "},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "}};</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>void GetMotStep( int val[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>val[0] = sequence;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>// mから3行の文字列を返します</span>
 &nbsp;</p>
<p>&nbsp;<span>void GetStepMsg( int m, int val, char buff[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>char line[22], temp[8] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>int j, k ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[0] = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>//1行目</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( line, scMtrStep[0], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val, temp );</span>
<span>//</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 2, ' ' );</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[14], temp, 2 );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//2行目以降</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( m &gt;= MSGSIZE )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>j = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>j = m ;</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt; 3 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strncpy( line, scMtrStep[1], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>k = strlen( motor[j] );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strncpy( line, motor[j], k );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ++j &gt;= MSGSIZE )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>j = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetStepMsgSize()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>return MSGSIZE ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>表示用の関数を用意します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Display.cpp&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>static bool swState ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitLCD()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>swState = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>static void DispFunc2( void (*func1)(int []),&nbsp; int (*func2)(void), void (*func3)(int, int, char []))</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>int val[8] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>func1( val );</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( val[0] != term[0] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>term[0] = val[0] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>term[1] = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>func3( term[1], val[0], lcdBuff );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>ShowLcdBuff( 4, 1 );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( swState == false)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsReset() == true )&nbsp;&nbsp;&nbsp; // SW3 =&gt; reset</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>swState = true;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>term[1] += 1 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( term[1] &gt;= func2())</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>term[1] = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>func3( term[1], val[0], lcdBuff );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>ShowLcdBuff( 4, 1 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;if ( IsReset() == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>swState = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>void DispLCD()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>case D_ErrorMsg :</span>
<span>//Error contents</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>DispFunc2( GetErrorBit,&nbsp; GetErrMsgSize, GetErrMsg );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case D_EngineMsg :</span>
<span>//Engine Steps</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>DispFunc2( GetEngStep,&nbsp; GetEngMsgSize, GetEngineMsg );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case D_StartMsg :</span>
<span>//OPeration Start up</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>DispFunc2( GetReason,&nbsp; GetReasonSize, GetReasonMsg );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case D_MotorMsg :</span>
<span>//Stepping Motor</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>DispFunc2( GetMotStep,&nbsp; GetStepMsgSize, GetStepMsg );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>では、メッセージを確認して下さい。</span>
 &nbsp;</p>
<p>&nbsp;</p>
<div></div>
<br />
&nbsp;<h1>
<a id="calibre_link-29">
<span>[10]&nbsp;サイクル時間</span>
</a>
</h1>
<p>&nbsp;<span>ここでメインループのサイクル時間を計測しておきましょう。</span>
 &nbsp;</p>
<p>&nbsp;<span>コンペアマッチタイマー１を使って計り、LCD画面に表示します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;hwsetup.cpp&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//Interrupt priority</span>
 &nbsp;</p>
<p>&nbsp;<span>INTC.IPR08.BIT._CMT1 =&nbsp;6&nbsp;;</span>
<span>//CMT1 コンペアマッチ</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//-----------------------------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>//メインサイクル時間計測に使用</span>
 &nbsp;</p>
<p>&nbsp;<span>CMT1.CMCSR.BIT.CMIE = 0 ;</span>
<span>//0：コンペアマッチ割り込み（CMI）を禁止</span>
 &nbsp;</p>
<p>&nbsp;<span>CMT1.CMCSR.BIT.CKS = 3 ;</span>
<span>//11：Pφ/512 = 10.24us</span>
 &nbsp;</p>
<p>&nbsp;<span>CMT1.CMCNT = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>CMT1.CMCOR = 0xFFFF ;</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Main.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>//メインサイクルの時間計測</span>
 &nbsp;</p>
<p>&nbsp;<span>#define COUNTMAX</span>
<span>24</span>
<span>//移動平均数</span>
 &nbsp;</p>
<p>&nbsp;<span>static unsigned short countAve[COUNTMAX] ;</span>
<span>//移動平均バッファ</span>
 &nbsp;</p>
<p>&nbsp;<span>static short countPtr ;</span>
<span>//移動平均ポインタ</span>
 &nbsp;</p>
<p>&nbsp;<span>static unsigned long countBuf ;</span>
<span>//カウンタ積算バッファ</span>
 &nbsp;</p>
<p>&nbsp;<span>static unsigned short countMin ;</span>
<span>//最小値</span>
 &nbsp;</p>
<p>&nbsp;<span>static unsigned short countMax ;</span>
<span>//最大値</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private function</span>
 &nbsp;</p>
<p>&nbsp;<span>static void CheckCycle (void);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>void main(void)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>set_imask(0);</span>
<span>//割り込みマスクレベル変更</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>CMT1.CMCNT = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>CMT.CMSTR.BIT.STR1 = 1 ;</span>
<span>//CMT1 コンペアマッチタイマースタート</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>while ( 1 )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>Twinkle();</span>
<span>//動作表示部</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>CheckCycle&nbsp;();</span>
<span>//メインサイクルの時間計測</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>void&nbsp;ClearCycle&nbsp;()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt; COUNTMAX ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>countAve[n] = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>countPtr&nbsp; = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>countBuf = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>countMin = 0xFFFF ;</span>
 &nbsp;</p>
<p>&nbsp;<span>countMax = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>static void InitMain()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>ClearCycle&nbsp;();</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>selectLED = L_NONE ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//メインサイクルの時間計測</span>
 &nbsp;</p>
<p>&nbsp;<span>static void CheckCycle()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>int tcnt = CMT1.CMCNT ;</span>
 &nbsp;</p>
<p>&nbsp;<span>countBuf -= countAve[countPtr] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>countAve[countPtr] = tcnt ;</span>
 &nbsp;</p>
<p>&nbsp;<span>countBuf += tcnt ;</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ++countPtr &gt;= COUNTMAX )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>countPtr = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( tcnt &gt; countMax )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>countMax = tcnt ;</span>
 &nbsp;</p>
<p>&nbsp;<span>else if ( tcnt &lt; countMin )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>countMin = tcnt ;</span>
 &nbsp;</p>
<p>&nbsp;<span>CMT1.CMCNT = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>LCD画面に表示するデータを準備します。</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Main.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>#include &lt;string.h&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>static const char scCycle[][21] = {</span>
 &nbsp;</p>
<p>&nbsp;<span>{"AVE&nbsp; 0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"MAX&nbsp; 0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"MIN&nbsp; 0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"ONE&nbsp; 0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "}};</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//時間計測を返す</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetCycle(int val[])</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>val[0] = countBuf / COUNTMAX ;</span>
 &nbsp;</p>
<p>&nbsp;<span>val[1] = countMax ;</span>
 &nbsp;</p>
<p>&nbsp;<span>val[2] = countMin ;</span>
 &nbsp;</p>
<p>&nbsp;<span>val[3] = 0;</span>
<span>//GetOneTime();</span>
 &nbsp;</p>
<p>&nbsp;<span>return 4 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//LCD</span>
 &nbsp;</p>
<p>&nbsp;<span>void GetCycleMsg( int val[], char buff[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>char line[22], temp[8] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[0] = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt; 4 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strncpy( line, scCycle[n], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>itoh4( val[n], temp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strncpy( &amp;line[5], temp, 4 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>LCD画面に表示します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Display.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private function</span>
 &nbsp;</p>
<p>&nbsp;<span>static void DispCycle(void);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>void DispLCD()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>switch ( nowPage ){</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>case&nbsp;D_Cycle&nbsp;://Cycle</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>DispCycle();</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>selectLED = L_MAIN ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//サイクルの時間の表示</span>
 &nbsp;</p>
<p>&nbsp;<span>static void DispCycle()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>DispFunc( GetCycle,&nbsp; GetCycleMsg );</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( swState == false)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkInp( P_Di10 ) == ON )&nbsp;&nbsp;&nbsp; // SW3</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>swState = true;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>ClearCycle();</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkInp( P_Di10 ) == OFF )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>swState = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>計測の結果は如何ですか？</span>
 &nbsp;</p>
<p>&nbsp;<span>運転ステージでの、全負荷投入後の計測では、</span>
 &nbsp;</p>
<p>&nbsp;<span>１）通常動作時</span>
 &nbsp;</p>
<p>&nbsp;<span>最大&nbsp;3.3ms</span>
 &nbsp;</p>
<p>&nbsp;<span>最小 10us</span>
 &nbsp;</p>
<p>&nbsp;<span>平均&nbsp;24.5us</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>２）始動や停止などの状態遷移時</span>
 &nbsp;</p>
<p>&nbsp;<span>最大 110.5ms</span>
 &nbsp;</p>
<p>&nbsp;<span>最小 10us</span>
 &nbsp;</p>
<p>&nbsp;<span>平均 24.5us</span>
 &nbsp;</p>
<p>&nbsp;<span>でした。</span>
 &nbsp;</p>
<p>&nbsp;<span>これはEEPROMへの書き込み時間の影響を受けています。</span>
 &nbsp;</p>
<p>&nbsp;<span>EEPROMへの書き込みを省略すると、サイクル時間は通常動作時と同じになります。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>後記の効率化のところでも、これらを扱います。</span>
 &nbsp;</p>
<p>&nbsp;</p>
<div></div>
<br />
&nbsp;<p>&nbsp;<span>第４巻では次のテーマを扱います。</span>
 &nbsp;</p>
<p>&nbsp;<span>１）発電周波数、電圧、電流と電力の計算</span>
 &nbsp;</p>
<p>&nbsp;<span>２）効率化</span>
 &nbsp;</p>
<p>&nbsp;<span>さらに、実用的なシステムにするためにチューニングを行います。</span>
 &nbsp;</p>
<p>&nbsp;<span>もう少しの努力で、あなたは目標に達します。頑張りましょう！</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>------------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>「筆者のエピソード」</span>
 &nbsp;</p>
<p>&nbsp;<span>まだ駆け出しの頃、精密電子機器メーカーを押し退けて、ある装置のマイコン側の製作を依頼された。</span>
 &nbsp;</p>
<p>&nbsp;<span>機械側は地元の専門メーカーが担当することになった。そのメーカーから呼び出されて、素人が出来る分野ではないから、手を引くように要求された。</span>
 &nbsp;</p>
<p>&nbsp;<span>しかし、当方の製作したマイコン装置は、その後EPROMの記憶保持期間が過ぎたら新しいのに書き直す事を繰り返して長期間使われた。</span>
 &nbsp;</p>
<p>&nbsp;<span>そんな素人に発注したのは、費用以上に、ただ担当者の当方の技術に対する信頼であり、これが今日の私たちの原動力となったと感謝している。</span>
</p>
</div>
</div>


<script>function myFunction(){document.getElementById("tateyoko").classList.toggle("tateread")}</script></body></html>