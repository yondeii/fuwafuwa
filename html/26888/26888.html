<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Embedded System Advanced 2　日本語版: Training material for engineer Discover! How? (NGO TAMA)</title>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="/css/mainday.css" title="default">
<link rel="alternate stylesheet" href="/css/mainnight.css" title="alternate">
<script type="text/javascript" src="/js/styleswitcher.js"></script>
<script type="text/javascript" src="/js/global.js"></script>
</head>
<body>
<div class="novelpage">
<div class="novelbody">
<div id="tateyoko">
<div id="_top"></div>
<a href="/">🏠</a>&emsp;
<a href="#" onclick="setActiveStyleSheet('default'); return false;">日</a>&emsp;
<a href="#" onclick="setActiveStyleSheet('alternate'); return false;">月</a>&emsp;
<a href="#_top" onclick="myFunction()" style="cursor: pointer;">縦書き／横書き</a>
<div id="calibre_link-32">
<div>
<div>
<table class="noveltitle">
<tr>
<td colspan="2"><i><span><i>Embedded System Advanced 2　日本語版: Training material for engineer Discover! How? (NGO TAMA)</i></span></i></td>
</tr>
<tr>
                    
                    
      </tr>
<tr>
<td colspan="2">NGO TAMA</td>
</tr>
<tr>
<td colspan="2">ENUJIHOH TAMA (2017)</td>
</tr>
<tr>
<td colspan="2"></td>
</tr>
</table>
<div></div>
</div>
<div></div>
</div>
</div>



<div id="calibre_link-0">
<div>
<p>&nbsp;<span>目次</span>
 &nbsp;</p>
<p>&nbsp;<a id="calibre_link-33"></a>
<a href="#calibre_link-1">
<span><u>[1]&nbsp;時刻の設定</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-2">
<span><u>(1) RTCの設定</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-3">
<span><u>(2) EEPROMの読み書き</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-4">
<span><u>[2]&nbsp;運転状態の記録</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-5">
<span><u>(1)&nbsp;記録内容の定義</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-6">
<span><u>(2)&nbsp;コマンドの受信</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-7">
<span><u>(3)&nbsp;記録書き込み</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-8">
<span><u>(4)&nbsp;記録読み出し</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-9">
<span><u>(5)&nbsp;運転状態の記録</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-10">
<span><u>(6) EEPROM側</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-11">
<span><u>[3]&nbsp;スロットル制御</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-12">
<span><u>(1)&nbsp;ステッピングモーター</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-13">
<span><u>(2)&nbsp;テストプログラム</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-14">
<span><u>(3) LCD表示</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-15">
<span><u>(4)&nbsp;制御シーケンス</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-16">
<span><u>(5)&nbsp;シリアル通信</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-17">
<span><u>(6)&nbsp;自動制御</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-18">
<span><u>(7)&nbsp;ファジー計算</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-19">
<span><u>[4]&nbsp;クランクパルス出力</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-20">
<span><u>(1) PWM&nbsp;モード</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-21">
<span><u>(2) Rotate.cpp</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-22">
<span><u>(3)&nbsp;パルス出力チェック</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-23">
<span><u>(4)&nbsp;回転数変更</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-24">
<span><u>(5)&nbsp;回転数の確認</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-25">
<span><u>[5]&nbsp;回転数の計測</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-26">
<span><u>(1)&nbsp;インプットキャプチャ</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-27">
<span><u>(2)&nbsp;回転数の計算</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-28">
<span><u>(3) LCD表示</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-29">
<span><u>[6]&nbsp;内部設定値表示</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-30">
<span><u>(1)&nbsp;時間設定値</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-31">
<span><u>(2)&nbsp;制御定数設定値</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<div></div>
<br />
&nbsp;<p>&nbsp;<a id="calibre_link-34">
<span>「概要」</span>
</a>
 &nbsp;</p>
<p>&nbsp;<span>これからBook_1のソフトウェアに、各種の機能を追加して行きます。この本では、主にエンジン回転数の測定と制御を扱います。</span>
 &nbsp;</p>
<p>&nbsp;<span>簡単なものから作成して行きましょう。</span>
 &nbsp;</p>
<h1>
<a id="calibre_link-1">
<span>[1]&nbsp;時刻の設定</span>
</a>
</h1>
<p>&nbsp;<span>最初は装置の運転記録、異常や故障などの発生時刻の記録に必要なリアルタイムクロック(RTC)です。</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-2">
<span>(1)&nbsp;RTCの設定</span>
</a>
</h2>
<p>&nbsp;<span>基礎編では、外部のボタンを使って、時刻の設定をしました。実機では、そのようなボタンは無いので、シリアル通信を使い、パソコンから設定します。</span>
 &nbsp;</p>
<p>&nbsp;<span>下記のコマンドをパソコンから送り込み、時刻の設定をしましょう。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;[ヘッダ]RTC[年],[月],[週],[日],[時],[分],[秒][ターミネター][改行コード]</span>
 &nbsp;</p>
<p>&nbsp;<span>例　@RTC16,11,0,18,07,54,06*¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Sci_2.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private function</span>
 &nbsp;</p>
<p>&nbsp;<span>static void SetRTC(char *s );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//パソコンとの通信インターフェイス</span>
 &nbsp;</p>
<p>&nbsp;<span>void CommPaso2()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_WAIT :</span>
<span>//命令受信待ち</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( Receive() == R_OK ) //正常ブロックを受信したら</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//[@LCDabc12345*¥r],[@RTC16,11,0,18,07,54,06*¥r]</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>s = &amp;rxBuf[1] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( strncmp( s, "LCD", 3 ) == 0 )</span>
<span>// LCD表示命令なら</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( strncmp( s, "RTC", 3 ) == 0 )&nbsp;</span>
<span>// RTC書き込み命令なら</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>n = rxPtr - rxBuf ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>n&nbsp; -= 4&nbsp; ;</span>
<span>//except @RTC</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>if ( n &gt;= LCDBF )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>n = LCDBF - 1 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>strncpy( lcdBuf, s+3, n );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>lcdBuf[n] = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>dspOK = true ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>SetRTC( s+3 ) ;</span>
<span>//16,11,18,07,54,06</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>cStep++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if (( strncmp( s, "PWT", 3 ) == 0 ) || ( strncmp( s, "PWC", 3 ) == 0 ))</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//RTC時刻設定</span>
 &nbsp;</p>
<p>&nbsp;<span>// caleTbl[0] Seconds, VL=b7</span>
 &nbsp;</p>
<p>&nbsp;<span>// caleTbl[1] Minutes</span>
 &nbsp;</p>
<p>&nbsp;<span>// caleTbl[2] Hours</span>
 &nbsp;</p>
<p>&nbsp;<span>// caleTbl[3] Days</span>
 &nbsp;</p>
<p>&nbsp;<span>// caleTbl[4]&nbsp;Day of week</span>
 &nbsp;</p>
<p>&nbsp;<span>// caleTbl[5] Months</span>
 &nbsp;</p>
<p>&nbsp;<span>// caleTbl[6] Years</span>
 &nbsp;</p>
<p>&nbsp;<span>static void SetRTC(char *s )</span>
<span>//16,11,0,18,07,54,06</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>bool flag = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>char *tp = strtok( s, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( tp != NULL )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>caleTbl[6] = atoi( tp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>int n ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( n = 0 ; n &lt; 6; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>tp = strtok( NULL, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( tp == NULL )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>caleTbl[5-n] = atoi( tp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( n &gt;= 6 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( WriteTimeRTC( caleTbl ) == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>flag = true;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( flag == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcpy( txBuf, "WriteTimeRTC=OK¥r" );</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcpy( txBuf, "SetRTC=ERROR¥r" );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>パソコンから現在時刻を送り込んでみましょう。正しく時刻が設定されたかは、LCD表示で確認して下さい。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-3">
<span>(2) EEPROMの読み書き</span>
</a>
</h2>
<p>&nbsp;<span>パソコンからのEEPROMの読出しと書き込みをここに記載しました。</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Sci_2.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//EEPROMデータをパソコンに送る</span>
 &nbsp;</p>
<p>&nbsp;<span>//kind+adrs,size&nbsp;&nbsp;</span>
<span>//T8,1&nbsp; //C5,10</span>
 &nbsp;</p>
<p>&nbsp;<span>static void ReadProm( char *s )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>strcpy( txBuf,"R" );</span>
 &nbsp;</p>
<p>&nbsp;<span>int kind = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>int addr = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>if (*s == 'T' )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>kind = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, "T" );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>addr = EETIME ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>kind = 1 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, "C" );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>addr = EECTRL ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>s++;</span>
 &nbsp;</p>
<p>&nbsp;<span>char *tp = strtok( s, "," );</span>
<span>//addr</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( tp != NULL )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>int n = atoi( tp ) ;</span>
<span>//offset</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( kind == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( n &gt;= TMRNUM )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>strcat( txBuf, "Range over!¥r"&nbsp; );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>return;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( n &gt;= CTRLNUM )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>strcat( txBuf, "Range over!¥r"&nbsp; );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>return;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>addr += n * 2 ;</span>
<span>//short size</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>char buff[8];</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>itoa2( n, buff );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, buff );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>tp = strtok( NULL, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( tp != NULL )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>int size = atoi( tp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n = addr + size * 2 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( kind == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>if ( n &gt;= EECTRL )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>size = ( EECTRL - addr ) / 2 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>if ( n &gt;= EEID )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>size = ( EEID - addr ) / 2 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>unsigned char val[40];</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>ReadEEPROM( addr, val, size*2 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>short temp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( int k = 0 ; k &lt; size ; k++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>temp = val[k*2] &lt;&lt; 8 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>temp |= val[k*2+1];</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>itoa2( temp, buff );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>strcat( txBuf, buff );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>strcat( txBuf, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, " OK!"&nbsp; );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n = strlen( txBuf );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( n &gt;= LCDBF )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>n = LCDBF - 1 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strncpy( lcdBuf, txBuf, n );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>lcdBuf[n] = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>dspOK = true ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, " No size!¥r"&nbsp; );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, " No address!¥r"&nbsp; );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//パソコンからEEPROMにデータを書く</span>
 &nbsp;</p>
<p>&nbsp;<span>//kind+adrs,data1,data2,..,data10 = all integer</span>
 &nbsp;</p>
<p>&nbsp;<span>static void WriteProm( char *s )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>strcpy( txBuf,"W" );</span>
 &nbsp;</p>
<p>&nbsp;<span>int kind = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>int addr = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>int size = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>if (*s == 'T' )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>kind = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, "T" );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>addr = EETIME ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>size = TMRNUM;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>kind = 1 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, "C" );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>addr = EECTRL ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>size = CTRLNUM;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>s++;</span>
 &nbsp;</p>
<p>&nbsp;<span>char *tp = strtok( s, "," );</span>
<span>//addr</span>
 &nbsp;</p>
<p>&nbsp;<span>unsigned char val[40];</span>
 &nbsp;</p>
<p>&nbsp;<span>short temp;</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( tp != NULL )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>int k, offset;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>offset = atoi( tp ) ;</span>
<span>//offset</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( kind == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( offset &gt;= TMRNUM )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>strcat( txBuf, " Range over!¥r"&nbsp; );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>return;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( offset &gt;= CTRLNUM )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>strcat( txBuf, " Range over!¥r"&nbsp; );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>return;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>addr +=&nbsp; offset * 2;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>char buff[8];</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>itoa2( offset, buff );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, buff );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( k = 0 ; k &lt; size ; )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>tp = strtok( NULL, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( tp == NULL )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>temp = atoi( tp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>val[k*2] = temp &gt;&gt; 8 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>val[k*2+1] = temp &amp; 0x00FF ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>itoa2( temp, buff );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, buff );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>k++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( kind == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>if ( ++offset &gt;= TMRNUM )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>if ( ++offset &gt;= CTRLNUM )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( k &gt; 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( WriteValueEEPROM( addr, val, k*2 ) == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>strcat( txBuf, " OK!"&nbsp; );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>strcat( txBuf, " Error!"&nbsp; );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>int n = strlen( txBuf );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( n &gt;= LCDBF )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>n = LCDBF - 1 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strncpy( lcdBuf, txBuf, n );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>lcdBuf[n] = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>dspOK = true ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, " No data!¥r"&nbsp; );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, " No address!¥r"&nbsp; );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>では、EEPROMに対する読み書き機能の確認をしましょう。</span>
 &nbsp;</p>
<p>&nbsp;<span>1)&nbsp;例えば、タイマー値を読み出して、紙などに書き記します。</span>
 &nbsp;</p>
<p>&nbsp;<span>@PRT23,3*¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>2)&nbsp;別の値を同じアドレスに書き込みます。</span>
 &nbsp;</p>
<p>&nbsp;<span>@PWT23,10,20,30*¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>3)&nbsp;それから、MPU基板の電源を切り、30秒後に再び電源を入れます。</span>
 &nbsp;</p>
<p>&nbsp;<span>4)&nbsp;同じアドレスから読み出します。</span>
 &nbsp;</p>
<p>&nbsp;<span>@PRT23,3*¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>5)&nbsp;読み出した値が、書き込んだ値と同一なら、EEPROMの読み書き機能は正しく機能しています。</span>
 &nbsp;</p>
<p>&nbsp;<span>6)&nbsp;忘れずに、最初に読み出した値で書き戻して下さい。</span>
 &nbsp;</p>
<p>&nbsp;<span>7) 制御定数にについても同様に確認して下さい。</span>
 &nbsp;</p>
<p>&nbsp;</p>
<div></div>
<br />
&nbsp;<h1><a id="calibre_link-35"></a>
<a id="calibre_link-4">
<span>[2]&nbsp;運転状態の記録</span>
</a>
</h1>
<p>&nbsp;<span>次は、運転状態や、異常の記録をEEPROMに保存し、シリアル通信で読み出します。</span>
 &nbsp;</p>
<p>&nbsp;<span>これは開発中の装置では必須の機能です。</span>
 &nbsp;</p>
<p>&nbsp;<span>下記のような構造体にデータを保存します。</span>
 &nbsp;</p>
<p>&nbsp;<span>1</span>
<span>)</span>
<span>&nbsp;</span>
<span>年、月（上位、下位）</span>
 &nbsp;</p>
<p>&nbsp;<span>2</span>
<span>)</span>
<span>&nbsp;</span>
<span>日、時（上位、下位）</span>
 &nbsp;</p>
<p>&nbsp;<span>3</span>
<span>)</span>
<span>&nbsp;</span>
<span>分、秒（上位、下位）</span>
 &nbsp;</p>
<p>&nbsp;<span>4)&nbsp;装置状態、異常番号（上位、下位）</span>
 &nbsp;</p>
<p>&nbsp;<span>5</span>
<span>)</span>
<span>&nbsp;</span>
<span>回転数</span>
 &nbsp;</p>
<p>&nbsp;<span>6</span>
<span>)</span>
<span>&nbsp;</span>
<span>運転ステージ、運転シーケンス番号（上位、下位）</span>
 &nbsp;</p>
<p>&nbsp;<span>7</span>
<span>)</span>
<span>&nbsp;</span>
<span>エンジン状態、エンジン制御シーケンス番号（上位、下位）</span>
 &nbsp;</p>
<p>&nbsp;<span>8)&nbsp;ステップモーターシーケンス番号、再起動フラグ（上位、下位）</span>
 &nbsp;</p>
<p>&nbsp;<span>9)&nbsp;実効電圧値（上位）＋実効電流値（下位）</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>下図のように、この構造体をEEPROMの中に30個配置し、リングバッファのように扱います。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000017.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>テスト用に、シリアル通信から書き込む時は、下記のフォーマットにします。</span>
 &nbsp;</p>
<p>&nbsp;<span>[ヘッダ]ERW[装置状態],[異常番号],[回転数],[運転ステージ],[運転シーケンス],</span>
 &nbsp;</p>
<p>&nbsp;<span>[エンジン状態],[エンジン制御シーケンス],[ステップモーターシーケンス],</span>
 &nbsp;</p>
<p>&nbsp;<span>[再起動フラグ],[電圧],[電流][ターミネター][改行コード]</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>例　@ERW1,0,1500,1,2,2,5,5,1,220,50*¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>時刻はRTCから取得します。</span>
 &nbsp;</p>
<p>&nbsp;<span>また、読出しのフォーマットは</span>
 &nbsp;</p>
<p>&nbsp;<span>[ヘッダ]ERR[ターミネター][改行コード]</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>例　@ERR*¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>で、記録されている内容を最大30個、古い順にシリアル回線に送り出します。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000019.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-5">
<span>(1) 記録内容の定義</span>
</a>
</h2>
<p>&nbsp;<span>=====&nbsp;common.h&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp;異常の記録</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>struct RECORD {</span>
 &nbsp;</p>
<p>&nbsp;<span>unsigned short yearMonth ;</span>
<span>//1) year(upper)+month(lower)</span>
 &nbsp;</p>
<p>&nbsp;<span>unsigned short dayHour ;</span>
<span>//2) day(upper)+hour(lower)</span>
 &nbsp;</p>
<p>&nbsp;<span>unsigned short minSec ;</span>
<span>//3) minute(upper)+second(lower)</span>
 &nbsp;</p>
<p>&nbsp;<span>short state ;</span>
<span>//4) state of equipment(upper)+error code(lower)</span>
 &nbsp;</p>
<p>&nbsp;<span>short value1 ;</span>
<span>//5) rotational speed</span>
 &nbsp;</p>
<p>&nbsp;<span>short stage ;</span>
<span>//6) run stage(upper)+run sequence(lower)</span>
 &nbsp;</p>
<p>&nbsp;<span>short engine ;</span>
<span>//7) state of engine(upper)+sequence of engine(lower)</span>
 &nbsp;</p>
<p>&nbsp;<span>short step ;</span>
<span>//8) sequence of motor(upper)+restart flag(lower)</span>
 &nbsp;</p>
<p>&nbsp;<span>short value2 ;</span>
<span>//9) effective voltage(upper)+ effective current(lower)</span>
 &nbsp;</p>
<p>&nbsp;<span>};</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>#define RECNUM</span>
<span>30</span>
<span>//異常の記録数</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2><a id="calibre_link-36"></a>
<a id="calibre_link-6">
<span>(2) コマンドの受信</span>
</a>
</h2>
<p>&nbsp;<span>シリアル通信部に、記録の書き込み、読出しの指示を受け取る部分を追加します。</span>
 &nbsp;</p>
<p>&nbsp;<span>さらに記録データを連続して送り出すために、一つの項目を送り終えたら、次の項目を取り出す機能を付け加えています。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Sci_2.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>//EEPROMから記録読み出し</span>
 &nbsp;</p>
<p>&nbsp;<span>static bool followed ;&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private function</span>
 &nbsp;</p>
<p>&nbsp;<span>static void WriteErrRec( char *s );</span>
 &nbsp;</p>
<p>&nbsp;<span>static void ReadErrRec(void);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitSci_2()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>followed = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>void CommPaso2()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_WAIT :</span>
<span>//命令受信待ち</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( Receive() == R_OK ) //正常ブロックを受信したら</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if (( strncmp( s, "PRT", 3 ) == 0 ) || ( strncmp( s, "PRC", 3 ) == 0 ))&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// EEPROM読み出し命令なら</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( strncmp( s, "ERW", 3 ) == 0 )&nbsp;</span>
<span>// 異常記録書き込み命令なら</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>if ( ChkInp( P_Di04 ) == ON )</span>
<span>//手動=ON</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>WriteErrRec( s+3 ) ;</span>
<span>//1,10,20,30*</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>cStep++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( strncmp( s, "ERR", 3 ) == 0 )&nbsp;</span>
<span>// 異常記録読み出し命令なら</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>ReadErrRec() ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>cStep++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_REPLY2 :</span>
<span>//送信終了待ち</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; modify &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( txBusy == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//送信終了したら</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( followed == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnTimer( TM02 );</span>
<span>//監視タイマー</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>cStep = S_NEXT ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>cStep = S_BEGIN ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( ChkTimer( TM02 ) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>cStep = S_BEGIN ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_NEXT :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkTimer( TM02 ) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( SendNext(txBuf) == false)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>followed = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>cStep = S_REPLY;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>default :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>cStep = S_BEGIN ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2><a id="calibre_link-37"></a>
<a id="calibre_link-7">
<span>(3)&nbsp;記録書き込み</span>
</a>
</h2>
<p>&nbsp;<span>===== Sci_2.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// 異常記録書き込み命令</span>
 &nbsp;</p>
<p>&nbsp;<span>//日付はRTCから読み出す</span>
 &nbsp;</p>
<p>&nbsp;<span>static void WriteErrRec( char *s )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ReadTimeRTC( caleTbl ) == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcpy( txBuf, "ReadTimeRTC()==ERROR¥r" );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>RECORD record ;</span>
 &nbsp;</p>
<p>&nbsp;<span>RECORD *sp = &amp;record ;</span>
 &nbsp;</p>
<p>&nbsp;<span>int m = caleTbl[6] ;</span>
<span>//year</span>
 &nbsp;</p>
<p>&nbsp;<span>m &lt;&lt;= 8 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>int n = caleTbl[5] ;</span>
<span>//month</span>
 &nbsp;</p>
<p>&nbsp;<span>sp-&gt;yearMonth = m + n ;//1)&nbsp;year+month</span>
 &nbsp;</p>
<p>&nbsp;<span>//caleTbl[4]&nbsp;=Day of the week</span>
 &nbsp;</p>
<p>&nbsp;<span>m = caleTbl[3] ;</span>
<span>//day</span>
 &nbsp;</p>
<p>&nbsp;<span>m &lt;&lt;= 8 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>n = caleTbl[2] ;</span>
<span>//hour</span>
 &nbsp;</p>
<p>&nbsp;<span>sp-&gt;dayHour = m + n ;</span>
<span>//2)&nbsp;day+hour</span>
 &nbsp;</p>
<p>&nbsp;<span>m = caleTbl[1] ;</span>
<span>//min</span>
 &nbsp;</p>
<p>&nbsp;<span>m &lt;&lt;= 8 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>n = caleTbl[0] ;</span>
<span>//sec</span>
 &nbsp;</p>
<p>&nbsp;<span>sp-&gt;minSec = m + n ;</span>
<span>//3</span>
<span>)</span>
<span>&nbsp;</span>
<span>minute+second</span>
 &nbsp;</p>
<p>&nbsp;&nbsp;</p>
<p>&nbsp;<span>char *tp = strtok( s, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>int ptr = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>while ( tp != NULL &amp;&amp; ptr &lt; 11 )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>switch ( ptr )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 0:</span>
<span>//4) state</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>m = atoi( tp );</span>
<span>//状態</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>m &lt;&lt;= 8 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>ptr++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 1:</span>
<span>//4) state</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>n = atoi( tp );</span>
<span>//異常番号</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sp-&gt;state = m + n ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>ptr++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 2:</span>
<span>//5) value1</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>m = atoi( tp );</span>
<span>//回転数</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sp-&gt;value1 = m ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>ptr++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 3:</span>
<span>//6) stage</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>m = atoi( tp );</span>
<span>//運転ステージ</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>m &lt;&lt;= 8 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>ptr++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 4:</span>
<span>//6) stage</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>n = atoi( tp );</span>
<span>//運転シーケンス番号</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sp-&gt;stage = m + n ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>ptr++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 5:</span>
<span>//7) engine</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>m = atoi( tp );</span>
<span>//エンジン状態</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>m &lt;&lt;= 8 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>ptr++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 6:</span>
<span>//7) engine</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>n = atoi( tp );</span>
<span>//エンジン制御シーケンス番号</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sp-&gt;engine = m + n ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>ptr++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 7:</span>
<span>//8) step</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>m = atoi( tp );</span>
<span>//ステップモーターシーケンス番号</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>m &lt;&lt;= 8 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>ptr++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 8:</span>
<span>//8) step</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>n = atoi( tp );</span>
<span>//再起動フラグ</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sp-&gt;step = m + n ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>ptr++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 9:</span>
<span>//9) value2</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>m = atoi( tp );</span>
<span>//電圧</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>m &lt;&lt;= 8 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>ptr++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 10:</span>
<span>//9) value2</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>n = atoi( tp );</span>
<span>//電流</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sp-&gt;value2 = m + n ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>ptr++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>tp = strtok( NULL, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ptr &gt;= 11 )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//EEPROMに書き込む</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>bool flag = WriteRecordEEPROM(&amp;record);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( flag == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcpy( txBuf, "WriteErrRec()==OK¥r" );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcpy( txBuf, "WriteErrRec()==ERROR¥r" );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>char buff[8];</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>itoa2( ptr, buff );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcpy( txBuf, "WriteErrRec()==" );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, buff );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, "¥r" );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2><a id="calibre_link-38"></a>
<a id="calibre_link-8">
<span>(4)&nbsp;記録読み出し</span>
</a>
</h2>
<p>&nbsp;<span>===== Sci_2.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// 異常記録読み出し命令、全部を古い順に送る</span>
 &nbsp;</p>
<p>&nbsp;<span>static void ReadErrRec()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>int next ;</span>
 &nbsp;</p>
<p>&nbsp;<span>char buff[8];</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( BeginRecSend(&amp;next) == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>followed = true;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>itoa2( next, buff );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcpy( txBuf, "ReadErrRec()=" );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, buff );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, "¥r" );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>followed = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcpy( txBuf, "ReadErrRec()=ERROR¥r" );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-9">
<span>(5)&nbsp;運転状態の記録</span>
</a>
</h2>
<p>&nbsp;<span>運転状態の記録用に新規にオブジェクトファイルを作成します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Record.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//――――――――――――――――――――――――</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; FILE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : Record.cpp</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; DESCRIPTION : Record of the operation state&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; CPU TYPE&nbsp;&nbsp;&nbsp; : SH7286</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; DATE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : Nov 01, 2016</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; VERSION ：1.0&nbsp;&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//――――――――――――――――――――――――</span>
 &nbsp;</p>
<p>&nbsp;<span>#include &lt;string.h&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>//#include &lt;machine.h&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "iodefine.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>extern "C" {</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "vect.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "common.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "proto.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>// ------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>// ------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>//異常の記録</span>
 &nbsp;</p>
<p>&nbsp;<span>static short offset ;</span>
 &nbsp;</p>
<p>&nbsp;<span>static short next ;</span>
 &nbsp;</p>
<p>&nbsp;<span>static const char scRecInfo[][21] = {</span>
<span>// information of record</span>
 &nbsp;</p>
<p>&nbsp;<span>{"offset 000&nbsp;&nbsp; next 00"},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "}};</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//--------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private function</span>
 &nbsp;</p>
<p>&nbsp;<span>//--------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>static void SetRecData( int nx, RECORD *sp, char buff[] );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//--------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>// Functions</span>
 &nbsp;</p>
<p>&nbsp;<span>//--------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>//初期化</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitRecord()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>offset = -1;</span>
 &nbsp;</p>
<p>&nbsp;<span>next = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//異常の記録をEEPROMに書き込む（offset位置を読み出してから）</span>
 &nbsp;</p>
<p>&nbsp;<span>bool WriteRecordEEPROM(RECORD *sp)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>unsigned short buff[RECWIDE];</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ReadEEPROM(EEOFS, (unsigned char*)&amp;offset, 2) == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>#ifdef TEST</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>SendBuffSci_2( "WriteRecordEEPROM:Can't read EEOFS" );</span>
 &nbsp;</p>
<p>&nbsp;<span>#endif</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//書き込み位置</span>
 &nbsp;</p>
<p>&nbsp;<span>unsigned short adrs = EERECD + RECWIDE * offset * 2 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>int m = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[m++] = sp-&gt;yearMonth;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[m++] = sp-&gt;dayHour;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[m++] = sp-&gt;minSec;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[m++] = sp-&gt;state;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[m++] = sp-&gt;value1;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[m++] = sp-&gt;stage;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[m++] = sp-&gt;engine;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[m++] = sp-&gt;step;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[m++] = sp-&gt;value2 ;&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>bool flag = WriteEEPROM(adrs, (unsigned char*)&amp;buff, RECWIDE*2);</span>
 &nbsp;</p>
<p>&nbsp;<span>//EEPROMの書き込み時間だけ待つ</span>
 &nbsp;</p>
<p>&nbsp;<span>Wait( 10000 );</span>
<span>//10ms</span>
 &nbsp;</p>
<p>&nbsp;<span>//</span>
<span>DebugPrint( adrs, buff, RECWIDE, flag );</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( flag == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>#ifdef TEST</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>SendBuffSci_2( "WriteEEPROM:error" );</span>
 &nbsp;</p>
<p>&nbsp;<span>#endif</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ++offset &gt;= RECNUM )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>offset = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>flag = WriteEEPROM(EEOFS, (unsigned char*)&amp;offset, 2);</span>
 &nbsp;</p>
<p>&nbsp;<span>//EEPROMの書き込み時間だけ待つ</span>
 &nbsp;</p>
<p>&nbsp;<span>Wait( 10000 );</span>
<span>//10ms</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( flag == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>#ifdef TEST</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>SendBuffSci_2( "WriteEEPROM:EEOFS error" );</span>
 &nbsp;</p>
<p>&nbsp;<span>#endif</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//識別コードを計算して書き込む</span>
 &nbsp;</p>
<p>&nbsp;<span>return CalcEEPROM();</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//指定の位置の異常の記録を返す</span>
 &nbsp;</p>
<p>&nbsp;<span>bool ReadRecordEEPROM(int offs, RECORD *sp)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>unsigned short buff[RECWIDE];</span>
 &nbsp;</p>
<p>&nbsp;<span>unsigned short adrs = EERECD + RECWIDE * offs * 2 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ReadEEPROM(adrs, (unsigned char*)&amp;buff, RECWIDE*2) == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>int m = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>sp-&gt;yearMonth = buff[m++];</span>
 &nbsp;</p>
<p>&nbsp;<span>sp-&gt;dayHour = buff[m++];</span>
 &nbsp;</p>
<p>&nbsp;<span>sp-&gt;minSec = buff[m++];</span>
 &nbsp;</p>
<p>&nbsp;<span>sp-&gt;state = buff[m++];</span>
 &nbsp;</p>
<p>&nbsp;<span>sp-&gt;value1 = buff[m++];</span>
 &nbsp;</p>
<p>&nbsp;<span>sp-&gt;stage = buff[m++];</span>
 &nbsp;</p>
<p>&nbsp;<span>sp-&gt;engine = buff[m++];</span>
 &nbsp;</p>
<p>&nbsp;<span>sp-&gt;step = buff[m++];</span>
 &nbsp;</p>
<p>&nbsp;<span>sp-&gt;value2 = buff[m++];</span>
 &nbsp;</p>
<p>&nbsp;<span>return true;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//パソコンに異常の記録を全て送る</span>
 &nbsp;</p>
<p>&nbsp;<span>bool BeginRecSend( int *p)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>//offset位置を読み出す</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ReadEEPROM(EEOFS, (unsigned char*)&amp;offset, 2) == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>offset = -1;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>*p = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>next = offset;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>*p = next;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return true;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//ひとつひとつ送り出す</span>
 &nbsp;</p>
<p>&nbsp;<span>bool SendNext(char buff[])</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>//offsetの次の項目をポイントする</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt;&nbsp; RECNUM ; n++)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ++next &gt;= RECNUM )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>next = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( next == offset )</span>
<span>//終了</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcpy(buff, "Finish!!!");</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//データを読み出す</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>RECORD record ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ReadRecordEEPROM(next, &amp;record) == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( record.yearMonth == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>continue ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>//送信する</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>SetRecData( next, &amp;record, buff );</span>
<span>//buff[]に入れる</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>return true;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>char buff2[8];</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcpy(buff, "ReadRecordEEPROM fail=");</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>itoa2(next,buff2 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat(buff, buff2);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>return false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//送信テキストにする</span>
 &nbsp;</p>
<p>&nbsp;<span>static void SetRecData( int nx, RECORD *sp, char buff[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>char temp[10];</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( nx, temp );</span>
<span>//next</span>
 &nbsp;</p>
<p>&nbsp;<span>strcpy((char*)buff, temp );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat((char*)buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>int n ;</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int m = 0 ; m &lt; 6 ; m++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>switch ( m )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 0 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n = sp-&gt;yearMonth &gt;&gt; 8;</span>
<span>//year</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n += 2000 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 1 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n = sp-&gt;yearMonth &amp; 0xFF;</span>
<span>//month</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 2 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n = sp-&gt;dayHour &gt;&gt; 8;</span>
<span>//day</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 3 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n = sp-&gt;dayHour &amp; 0xFF;</span>
<span>//Hour</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 4 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n = sp-&gt;minSec&nbsp; &gt;&gt; 8;</span>
<span>//min</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 5 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n = sp-&gt;minSec&nbsp; &amp; 0xFF;</span>
<span>//sec</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>itoa2( n, temp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat((char*)buff, temp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat((char*)buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int m = 0 ; m &lt; 6 ; m++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>switch ( m )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 0 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n = sp-&gt;state ;</span>
<span>//4)装置状態＋異常番号</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 1 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n = sp-&gt;value1 ;</span>
<span>//5) 回転数</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 2 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n = sp-&gt;stage ;</span>
<span>// 6)運転ステージ＋運転シーケンス番号</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 3 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n = sp-&gt;engine ;</span>
<span>// 7) エンジン状態＋エンジン制御シーケンス番号</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 4 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n = sp-&gt;step ;</span>
<span>// 8) ステップモーターシーケンス番号＋再起動フラグ</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 5 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n = sp-&gt;value2 ;</span>
<span>// 9) 実効電圧値（上位）＋実効電流値（下位）</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( m == 1 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>itoa2( n, temp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat((char*)buff, temp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>itoa2( n &gt;&gt; 8, temp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat((char*)buff, temp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat((char*)buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>itoa2( n &amp; 0x00FF, temp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat((char*)buff, temp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( m &gt;= 0 &amp;&amp; m &lt;= 4 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat((char*)buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//履歴保存数</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetRecCount()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>//offset位置を読み出す</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ReadEEPROM(EEOFS, (unsigned char*)&amp;offset, 2) == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return -1;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//offset位置のデータを読み出す</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>RECORD record ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ReadRecordEEPROM(offset, &amp;record) == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( record.yearMonth == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>return offset ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>return RECNUM ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return -1;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//履歴読出し番号をセットする</span>
 &nbsp;</p>
<p>&nbsp;<span>void SetHistory( int n )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( n &gt;= 1 &amp;&amp; n &lt;= RECNUM )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>next = n - 1 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//履歴詳細=指定位置の記録を返す</span>
 &nbsp;</p>
<p>&nbsp;<span>bool GetRecord( int data[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>//指定位置のデータを読み出す</span>
 &nbsp;</p>
<p>&nbsp;<span>RECORD record ;</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ReadRecordEEPROM(next, &amp;record) == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( record.yearMonth == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>RECORD *sp = &amp;record ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>data[0] = sp-&gt;yearMonth ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>data[1] = sp-&gt;dayHour ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>data[2] = sp-&gt;minSec ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>data[3] = sp-&gt;state ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>data[4] = sp-&gt;value1 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>data[5] = sp-&gt;stage ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>data[6] = sp-&gt;engine ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>data[7] = sp-&gt;step ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>data[8] = sp-&gt;value2 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return true ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetOffset(int data[])</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>data[0] = offset ;</span>
 &nbsp;</p>
<p>&nbsp;<span>data[1] = next ;</span>
 &nbsp;</p>
<p>&nbsp;<span>return 2 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//LCD</span>
 &nbsp;</p>
<p>&nbsp;<span>void GetOffsetMsg( int val[], char buff[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>char line[22], temp[8] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[0] = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>//1st line</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( line, scRecInfo[0], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[0], temp );</span>
<span>//offset</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 3, ' ' );</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[7], temp, 3 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[1], temp );</span>
<span>//next</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 2, ' ' );</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[18], temp, 2 );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//2nd line</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( line, scRecInfo[1], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2><a id="calibre_link-39"></a>
<a id="calibre_link-10">
<span>(6) EEPROM側</span>
</a>
</h2>
<p>&nbsp;<span>EEPROMの初期化時に異常の記録部のクリアを追加します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Eeprom.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitEEPROM()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>//識別コードが一致しない</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( WriteEEPROM( EECTRL, (unsigned char*)buff, CTRLNUM * 2 ) == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>alive = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//EEPROMの書き込み時間だけ待つ</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>Wait( 10000 );</span>
<span>//10ms</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//異常の記録部をクリアする、オフセット部を含む</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( int n = 0 ; n &lt; RECSIZE+1 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>buff[n] = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( WriteEEPROM( EERECD, (unsigned char*)buff, (RECSIZE+1) * 2 ) == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>alive = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//EEPROMの書き込み時間だけ待つ</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>Wait( 10000 );</span>
<span>//10ms</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//識別コードを計算して書き込む</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>CRC16の計算部に、異常記録部を追加します。</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Eeprom.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//識別コードを計算する</span>
 &nbsp;</p>
<p>&nbsp;<span>static bool CalcAllCRC16( short *result, bool flag )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>crc = CalcCRC16( crc, (unsigned char*)buff, CTRLNUM * 2 );</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>//オフセット部を含める</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ReadEEPROM(EERECD, (unsigned char*)buff, (RECSIZE+1) * 2) == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>crc = CalcCRC16( crc, (unsigned char*)buff, (RECSIZE+1) * 2);</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>outcome[1] = crc ;</span>
 &nbsp;</p>
<p>&nbsp;<span>//CRC結果部まで含めて計算する</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Main.cpp&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>void main(void)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>InitEEPROM();</span>
 &nbsp;</p>
<p>&nbsp;<span>InitRecord();</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>では、実行して確認しましょう。</span>
 &nbsp;</p>
<p>&nbsp;<span>1)&nbsp;先ずは、書き込みです。</span>
 &nbsp;</p>
<p>&nbsp;<span>@ERW0,1,2,3,4,5,6,7,8,9,10*¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>@ERW10,20,30,40,50,60,70,80,90,100,110*¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>等と次々に書き込みます。</span>
 &nbsp;</p>
<p>&nbsp;<span>2)&nbsp;次に、</span>
 &nbsp;</p>
<p>&nbsp;<span>@ERR*¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>このコマンドで、全部のデータが読み出されましたか？</span>
 &nbsp;</p>
<p>&nbsp;<span>マイコンからは上位と下位が合成されたデータを分離して、個別にPCに送り出されます。</span>
 &nbsp;</p>
<p>&nbsp;<span>例えば、シリアル通信モニターでは、下記のように表示されます。</span>
 &nbsp;</p>
<p>&nbsp;<span>---------------</span>
 &nbsp;</p>
<p>&nbsp;<span>Tx-&gt; @ERR*¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>-&gt;Rx:&nbsp;ReadErrRec()=0&lt;CR&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>-&gt;Rx:&nbsp;Finish!!!</span>
 &nbsp;</p>
<p>&nbsp;<span>Tx&nbsp;-&gt; @ERW0,1,2,3,4,5,6,7,8,9,10*¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>-&gt;Rx:&nbsp;WriteErrRec()==OK&lt;CR&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>Tx&nbsp;-&gt; @ERW10,20,30,40,50,60,70,80,90,100,110*¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>-&gt;Rx:&nbsp;WriteErrRec()==OK&lt;CR&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>Tx&nbsp;-&gt; @ERR*¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>-&gt;Rx:&nbsp;ReadErrRec()=2&lt;CR&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>-&gt;Rx:&nbsp;0,2016,12,18,10,39,24,0,1,2,3,4,5,6,7, 8,9,10</span>
 &nbsp;</p>
<p>&nbsp;<span>-&gt;Rx:&nbsp;1,2016,12,18,10,39,45,10,20,30,40,50,60,70,80,90,100,110</span>
 &nbsp;</p>
<p>&nbsp;<span>-&gt;Rx:&nbsp;Finish!!!</span>
 &nbsp;</p>
<p>&nbsp;<span>---------------</span>
 &nbsp;</p>
<p>&nbsp;</p>
<div></div>
<br />
&nbsp;<p>&nbsp;<span>(5) バージョン管理</span>
 &nbsp;</p>
<p>&nbsp;<span>ソースコードのタイマー値や制御定数を変更して基板に書き込んでも、そのままでは動作に反映されません。EEPROMの初期化では、チェックコードが一致すれば、読み出した値が使われるからです。</span>
 &nbsp;</p>
<p>&nbsp;<span>もちろん、シリアル通信で値を変更すればOKですが、ボードに書き込んだ直後から反映したい時は、その変更を検知する部分が必要になります。</span>
 &nbsp;</p>
<p>&nbsp;<span>一つの方法として、ソースコードのバージョンと、EEPROMのバージョンの違いを判断する事です。</span>
 &nbsp;</p>
<p>&nbsp;<span>この方針で一部を変更しましょう。</span>
 &nbsp;</p>
<p>&nbsp;<span>EEPROMのデータ部にバージョン番号を追加します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;common.h&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>enum {</span>
<span>//short</span>
 &nbsp;</p>
<p>&nbsp;<span>EEVER=0,</span>
<span>//ROMバージョン</span>
 &nbsp;</p>
<p>&nbsp;<span>EETIME=EEVER+2,</span>
<span>//タイマー値先頭アドレス</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>EEPROMの初期化部を書き換えます。</span>
 &nbsp;</p>
<p>&nbsp;<span>さらに、内部動作を確認するために、変数"history"を追加します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Eeprom.cpp&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>//ROMバージョン</span>
 &nbsp;</p>
<p>&nbsp;<span>const&nbsp;short&nbsp;RomVer = 125;</span>
<span>//タイマー値や制御定数を変更したら書き換えること！！</span>
 &nbsp;</p>
<p>&nbsp;<span>static short history ;</span>
<span>// Initialization status</span>
 &nbsp;</p>
<p>&nbsp;<span>static short romver ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitEEPROM()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt; 4 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>outcome[n] = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>unsigned short buff[RECSIZE+2] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>alive = true ;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>history = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>romver = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>//ROMバージョンを読み出す</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ReadEEPROM(EEVER, (unsigned char*)buff, 2) == false )</span>
<span>//EEPROMが読めない</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>alive = false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>history = 0x01;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>romver = buff[0];</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>//識別コードを計算する</span>
 &nbsp;</p>
<p>&nbsp;<span>short result = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( CalcAllCRC16( &amp;result, true ) == false )</span>
<span>//EEPROMが読めない</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>alive = false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>history = 0x02;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>outcome[0] = result;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; modify &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>//ROMバージョンが一致、かつ識別コードも一致の場合は、読出し可能</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( romver == RomVer &amp;&amp; result == 0)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>history |= 0x10;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//タイマー値を読み出す</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if (ReadEEPROM&nbsp;(EETIME, (unsigned char*)buff, TMRNUM&nbsp;*&nbsp;2) == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( int n = 0 ; n &lt; TMRNUM ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>PutTime( n, buff[n] );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; modify &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>alive = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>history |= 0x20;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//制御定数を読み出す</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ReadEEPROM(EECTRL, (unsigned char*)buff, CTRLNUM&nbsp;*&nbsp;2) == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( int n = 0 ; n &lt; CTRLNUM ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>ctrlTbl[n] = buff[n] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; modify &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>alive = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>history |= 0x40;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//一つでも一致しなければ、再書き込みする</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; modify &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>history |= 0x100;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//ROMバージョンとタイマー値を書き込む</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>buff[0] = RomVer ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( int n = 0 ; n &lt; TMRNUM ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>buff[n+1] = GetTime( n );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( WriteEEPROM( EEVER, (unsigned char*)buff, (TMRNUM+1) * 2 ) == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>alive = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>history |= 0x200;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//EEPROMの書き込み時間だけ待つ</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>Wait( 10000 );</span>
<span>//10ms</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//制御定数を書き込む</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( int n = 0 ; n &lt; CTRLNUM ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>buff[n] = ctrlTbl[n];</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if (WriteEEPROM&nbsp;( EECTRL, (unsigned char*)buff, CTRLNUM&nbsp;*&nbsp;2 ) == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; modify &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>alive = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>history |= 0x400;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//EEPROMの書き込み時間だけ待つ</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>Wait( 10000 );</span>
<span>//10ms</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//異常の記録と書き込み位置をクリアする</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( int n = 0 ; n &lt; RECSIZE+2 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>buff[n] = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if (WriteEEPROM&nbsp;( EERECD, (unsigned char*)buff, (RECSIZE+1)&nbsp;*&nbsp;2 ) == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>alive = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>history |= 0x800;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//EEPROMの書き込み時間だけ待つ</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>Wait( 10000 );</span>
<span>//10ms</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//識別コードを計算して書き込む</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; modify &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( CalcEEPROM() == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>alive = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>history |= 0x1000;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetEepResult( int val[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt; 4 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>val[n] = outcome[n];</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>val[4] = history ;</span>
 &nbsp;</p>
<p>&nbsp;<span>val[5] = romver ;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>val[6] = alive ;</span>
 &nbsp;</p>
<p>&nbsp;<span>return 7 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;</p>
<div></div>
<br />
&nbsp;<h1><a id="calibre_link-40"></a>
<a id="calibre_link-11">
<span>[3]&nbsp;スロットル制御</span>
</a>
</h1>
<p>&nbsp;<span>実機ではエンジンの回転数は、スロットル弁で調整します。アクセルペダルを踏む代わりに、スロットル弁に直結したステッピングモーターを制御します。</span>
 &nbsp;</p>
<p>&nbsp;<span>ステッピングモータードライバー基板には、回転指示のパルスを出力します。速度は200PPSにしています。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000006.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000010.gif" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>所定のパルス信号を定周期で出力するために、マルチファンクションタイマーMTU2のチャネル３を使用します。</span>
 &nbsp;</p>
<p>&nbsp;<span>先ず、hwsetupで設定をします。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;hwsetup.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//Interrupt priority</span>
 &nbsp;</p>
<p>&nbsp;<span>INTC.IPR10.BIT._MTU23G = 12&nbsp;;</span>
<span>//MTU23.TIER.BIT.TGIEA ステッピングモーター</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//マルチファンクションタイマー</span>
 &nbsp;</p>
<p>&nbsp;<span>//-----------------------------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>//MTU2 チャネル3をステッピングモーターパルス出力に使用</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU23.TCR.BIT.CCLR = 1 ;</span>
<span>//TGRA のコンペアマッチ／インプットキャプチャで TCNT クリア&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU23.TCR.BIT.CKEG = 1 ;</span>
<span>//01：立ち下がりエッジでカウント</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU23.TCR.BIT.TPSC = 3 ;</span>
<span>//内部クロック：Pφ／64 でカウント 64/50MHz = 1.28us</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU23.TMDR.BYTE = 0 ;</span>
<span>//通常動作</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU23.TIOR.WORD = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU23.TGRA = 1953 ;</span>
<span>// 1.28us * 1953 = 2.5ms&nbsp; 200pps</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU23.TIER.BIT.TGIEA = 1 ;</span>
<span>//1：TGFA ビットによる割り込み要求を許可</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//ポート機能設定</span>
 &nbsp;</p>
<p>&nbsp;<span>//C port --------------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>//Stepping Motor</span>
 &nbsp;</p>
<p>&nbsp;<span>PC.DR.BIT.B11 = 0;</span>
<span>//PC11 スロットル CCW</span>
 &nbsp;</p>
<p>&nbsp;<span>PC.DR.BIT.B12 = 0;</span>
<span>//PC12 スロットル CW</span>
 &nbsp;</p>
<p>&nbsp;<span>PFC.PCCRL3.BIT.PC11MD = 0;</span>
<span>//入出力（ポート）</span>
 &nbsp;</p>
<p>&nbsp;<span>PFC.PCCRL4.BIT.PC12MD = 0;</span>
<span>//入出力（ポート）</span>
 &nbsp;</p>
<p>&nbsp;<span>PFC.PCIORL.BIT.B11 = 1;</span>
<span>//PC11　出力</span>
 &nbsp;</p>
<p>&nbsp;<span>PFC.PCIORL.BIT.B12 = 1;</span>
<span>//PC12　出力</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2><a id="calibre_link-41"></a>
<a id="calibre_link-12">
<span>(1) ステッピングモーター</span>
</a>
</h2>
<p>&nbsp;<span>新規にオブジェクトファイル Stepping.cpp を作成します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Stepping.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//――――――――――――――――――――――――</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; FILE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : Stepping.cpp</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; DESCRIPTION : Stepping Motor Control</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; CPU TYPE&nbsp;&nbsp;&nbsp; : SH7286</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; DATE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : Nov 01, 2016</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; VERSION ：1.0&nbsp;&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//――――――――――――――――――――――――</span>
 &nbsp;</p>
<p>&nbsp;<span>#include &lt;string.h&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>#include &lt;machine.h&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "iodefine.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>extern "C" {</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "vect.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "common.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "proto.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>#define TEST</span>
<span>1</span>
 &nbsp;</p>
<p>&nbsp;<span>// ------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>// ------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>//ステッピングモーター</span>
 &nbsp;</p>
<p>&nbsp;<span>//パルス出力部分</span>
 &nbsp;</p>
<p>&nbsp;<span>enum { CW, CCW };</span>
<span>//回転方向</span>
 &nbsp;</p>
<p>&nbsp;<span>enum { S_LOW, S_HIGH };</span>
<span>//ステッピングモーター論理</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>#define</span>
<span>P_SMCCW</span>
<span>PC.DR.BIT.B11</span>
<span>//スロットル CCW</span>
 &nbsp;</p>
<p>&nbsp;<span>#define</span>
<span>P_SMCW</span>
<span>PC.DR.BIT.B12</span>
<span>//スロットル CW</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>typedef struct {</span>
 &nbsp;</p>
<p>&nbsp;<span>short pulse ;</span>
<span>// 回転指示パルス数（回転方向を含む）</span>
 &nbsp;</p>
<p>&nbsp;<span>short pos ;</span>
<span>// 現在位置</span>
 &nbsp;</p>
<p>&nbsp;<span>bool onoff ;// true=励磁ON中,false=励磁OFF中</span>
 &nbsp;</p>
<p>&nbsp;<span>} STEPPING ;</span>
 &nbsp;</p>
<p>&nbsp;<span>static STEPPING stepValve ;</span>
 &nbsp;</p>
<p>&nbsp;<span>static short sequence ;</span>
<span>//制御シーケンス</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//-------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private function</span>
 &nbsp;</p>
<p>&nbsp;<span>//-------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>static void MoveValve( int pulse );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//--------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>// Functions</span>
 &nbsp;</p>
<p>&nbsp;<span>//--------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>//初期化</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitStepping()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>//ステッピングモーター</span>
 &nbsp;</p>
<p>&nbsp;<span>//パルス出力部分</span>
 &nbsp;</p>
<p>&nbsp;<span>STEPPING *sq = &amp;stepValve ;</span>
 &nbsp;</p>
<p>&nbsp;<span>sq-&gt;pulse = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>sq-&gt;pos = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>sq-&gt;onoff = false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>sequence =&nbsp;0&nbsp;;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2.TSTR.BIT.CST3 = 1 ;</span>
<span>//ステッピングモーターパルス出力タイマースタート</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//回転指示（単にパルス数で）</span>
 &nbsp;</p>
<p>&nbsp;<span>static void MoveValve( int pulse )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2.TSTR.BIT.CST3 = 0 ;</span>
<span>//ステッピングモーターパルス出力タイマーストップ</span>
 &nbsp;</p>
<p>&nbsp;<span>stepValve.pulse = pulse ;</span>
<span>// 回転パルス数（回転方向を含む）</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2.TSTR.BIT.CST3 = 1 ;</span>
<span>//ステッピングモーターパルス出力タイマースタート</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//パルス出力終了かを返す</span>
 &nbsp;</p>
<p>&nbsp;<span>bool IsGiveOff()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( stepValve.pulse == 0 &amp;&amp; stepValve.onoff == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return true ;</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//ステッピングモーターパルス出力&nbsp;2.5ms(200pps)</span>
 &nbsp;</p>
<p>&nbsp;<span>// 180 MTU2 MTU3 TGIA3</span>
 &nbsp;</p>
<p>&nbsp;<span>void INT_MTU2_MTU3_TGIA3(void)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( MTU23.TSR.BIT.TGFA == 1 )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU23.TSR.BIT.TGFA = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>STEPPING *sp = &amp;stepValve ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//スロットルはＯＮ中か？</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( sp-&gt;onoff == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;onoff = false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>P_SMCW = S_LOW ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>P_SMCCW = S_LOW ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//スロットルに動作指示パルスがあるか？</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( sp-&gt;pulse &gt; 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>P_SMCW = S_HIGH ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;pulse-- ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;pos++ ;&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;onoff = true ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( sp-&gt;pulse &lt; 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>P_SMCCW = S_HIGH ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;pulse++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;pos-- ;&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;onoff = true ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Main.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>void main(void)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>InitRTC();</span>
 &nbsp;</p>
<p>&nbsp;<span>InitStepping();</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>while ( 1 )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>下図のように5ms毎の割り込みで、パルスを出力しています。(100ppsの場合)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000007.gif" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2><a id="calibre_link-42"></a>
<a id="calibre_link-13">
<span>(2) テストプログラム</span>
</a>
</h2>
<p>&nbsp;<span>ステッピングモーターの動作を確認するために、テストプログラムを用意します。</span>
 &nbsp;</p>
<p>&nbsp;<span>パネルの起動／停止ボタンで往復動作をするようにします。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Stepping.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//ステッピングモーターテスト</span>
 &nbsp;</p>
<p>&nbsp;<span>void TestStepping()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>switch ( sequence )</span>
<span>//制御シーケンス</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>case 0 :</span>
<span>//</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkInp(P_Di00) == ON )</span>
<span>//起動ボタン</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>case&nbsp;1&nbsp;:</span>
<span>//</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MoveValve( 500 );</span>
<span>// CW方向に移動</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case&nbsp;2&nbsp;:</span>
<span>//パルス出力終了待ち</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsGiveOff() == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnTimer( TM09 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case&nbsp;3&nbsp;:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkTimer( TM09 ) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MoveValve( -500 );</span>
<span>// CCW方向に移動</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case&nbsp;4&nbsp;:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsGiveOff() == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnTimer( TM09 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case&nbsp;5&nbsp;:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkTimer( TM09 ) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence =&nbsp;1&nbsp;;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>default :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ChkInp( P_Di01 ) == ON )</span>
<span>//停止ボタン</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MoveValve( 0 );</span>
<span>//停止</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffTimer( TM09 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>このテストプログラムをメイン関数から呼び出します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Main.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>void main(void)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>InitStepping();</span>
 &nbsp;</p>
<p>&nbsp;<span>set_imask(0);</span>
 &nbsp;</p>
<p>&nbsp;<span>while ( 1 )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>TestStepping();</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>では、実行してみましょう！</span>
 &nbsp;</p>
<p>&nbsp;<span>期待した通りに動作しましたか？</span>
 &nbsp;</p>
<p>&nbsp;<span>下図はパルス数を５にして、時間を短縮したものです。CWとCCWを交互に出力しています。(100ppsの場合)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000012.gif" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2><a id="calibre_link-43"></a>
<a id="calibre_link-14">
<span>(3)&nbsp;LCD表示</span>
</a>
</h2>
<p>&nbsp;<span>ステッピングモーターの位置をLCDに表示しましょう。</span>
 &nbsp;</p>
<p>&nbsp;<span>また、動作を確認するのに、LEDも使いましょう。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Display.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//ＬＣＤ表示</span>
 &nbsp;</p>
<p>&nbsp;<span>void DispLCD()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>case D_Throttle :</span>
<span>//Throttle pulse</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>DispFunc( GetThrottle,&nbsp; GetThrotMsg );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>selectLED = L_STEP ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( oldSelect != selectLED )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>oldSelect = selectLED ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>ChangeSelectLED(selectLED);</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//メッセージをスクロールする画面では、SW3の代わりにリセットボタンを使うようにします。</span>
 &nbsp;</p>
<p>&nbsp;<span>bool IsMsgDisp()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>bool flag = false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>switch ( nowPage )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>case D_ErrorMsg :</span>
<span>//Error contents</span>
 &nbsp;</p>
<p>&nbsp;<span>case D_EngineMsg :</span>
<span>//Engine Steps</span>
 &nbsp;</p>
<p>&nbsp;<span>case D_StartMsg :</span>
<span>//OPeration Start up</span>
 &nbsp;</p>
<p>&nbsp;<span>case D_MotorMsg :</span>
<span>//Stepping Motor</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>flag = true ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>return flag ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>LCD画面に表示するデータをStepping.cppで準備します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Stepping.cpp&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>static short throttle ;</span>
<span>//throttle position (AD value)</span>
 &nbsp;</p>
<p>&nbsp;<span>static short oldThrot ;</span>
<span>//For returning the origin point</span>
 &nbsp;</p>
<p>&nbsp;<span>static short fuzValue ;</span>
<span>//Result value of Fuzzy calculation</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>static const char scThrottle[][21] = {</span>
<span>//Stepping Motor</span>
 &nbsp;</p>
<p>&nbsp;<span>{"seq&nbsp; 00&nbsp;&nbsp; rpm 0000&nbsp; "},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"pul&nbsp; 0000&nbsp; pos&nbsp; 0000"},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"throttle&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"fuzzy&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "}};</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitStepping()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>throttle = oldThrot = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>fuzValue = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetThrottle( int ctr[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>ctr[0] = sequence;</span>
 &nbsp;</p>
<p>&nbsp;<span>ctr[1] = GetRpm();</span>
 &nbsp;</p>
<p>&nbsp;<span>ctr[2] = stepValve.pulse;</span>
 &nbsp;</p>
<p>&nbsp;<span>ctr[3] = stepValve.pos;</span>
 &nbsp;</p>
<p>&nbsp;<span>ctr[4] = throttle;</span>
 &nbsp;</p>
<p>&nbsp;<span>ctr[5] = fuzValue;</span>
 &nbsp;</p>
<p>&nbsp;<span>return 6 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//LCD</span>
 &nbsp;</p>
<p>&nbsp;<span>void GetThrotMsg( int val[], char buff[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>char line[22], temp[8] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[0] = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>//1st line</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( line, scThrottle[0], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[0], temp );</span>
<span>//sequence</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 2, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[5], temp, 2 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[1], temp );</span>
<span>//nowRpm</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 4, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[14], temp, 4 );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>//2nd line</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( line, scThrottle[1], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[2], temp );</span>
<span>//stepValve.pulse</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 4, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[5], temp, 4 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[3], temp );</span>
<span>//stepValve.pos</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 4, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[16], temp, 4 );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>//3rd line</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( line, scThrottle[2], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[4], temp );</span>
<span>//throttle</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 4, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[10], temp, 4 );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>//4th line</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( line, scThrottle[3], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[5], temp );</span>
<span>//fuzzy</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 4, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[10], temp, 4 );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetRpm()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>return 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2><a id="calibre_link-44"></a>
<a id="calibre_link-15">
<span>(4)&nbsp;制御シーケンス</span>
</a>
</h2>
<p>&nbsp;<span>電源投入時は、スロットルの位置が不明確なので、一般的にステッピングモーターの原点復帰を行い、原点位置を確定します。</span>
 &nbsp;</p>
<p>&nbsp;<span>その後、各種の命令を受け付ける状態にします。</span>
 &nbsp;</p>
<p>&nbsp;<span>スロットルの値０が原点位置とは限らないので、実機で測定したスロットルの可動範囲を制御定数で指定します。</span>
 &nbsp;</p>
<p>&nbsp;<span>制御シーケンスとしては</span>
 &nbsp;</p>
<p>&nbsp;<span>１）原点位置の確定</span>
 &nbsp;</p>
<p>&nbsp;<span>２）命令待機</span>
 &nbsp;</p>
<p>&nbsp;<span>　（１）指定位置移動動作</span>
 &nbsp;</p>
<p>&nbsp;<span>　（２）自動制御動作</span>
 &nbsp;</p>
<p>&nbsp;<span>　（３）原点復帰動作</span>
 &nbsp;</p>
<p>&nbsp;<span>とします。</span>
 &nbsp;</p>
<p>&nbsp;<span>まず、この制御シーケンスを作成しましょう。</span>
 &nbsp;</p>
<p>&nbsp;<span>フローチャートでは、下図のような流れにします。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000003.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>手順として、ステッピングモーターテストを拡張して、原点復帰の動作を確立しましょう。</span>
 &nbsp;</p>
<p>&nbsp;<span>制御定数にスロットルポジションの最小値を仮にセットします。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;common.h&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//タイマー</span>
 &nbsp;</p>
<p>&nbsp;<span>enum {</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>TM09,</span>
<span>//ステッピングモーター移動監視</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>};</span>
 &nbsp;</p>
<p>&nbsp;<span>//制御定数</span>
 &nbsp;</p>
<p>&nbsp;<span>enum {</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>C02,</span>
<span>//スロットルポジション最小値（AD値）</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>};</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;timer.h&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>const unsigned short timeBase[TMRNUM] = {</span>
<span>/* 100ms */</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>20,</span>
<span>//TM09</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>};</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;ctrl.h&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>const short ctrlBase[CTRLNUM] = {</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>100,</span>
<span>//C02&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>};</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>下記のように、TestStepping()を変更します。</span>
 &nbsp;</p>
<p>&nbsp;<span>ステッピングモーターのスピードも変えられるようにします。</span>
 &nbsp;</p>
<p>&nbsp;<span>低速で原点位置を見つけた後は高速で移動するようにしています。</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Stepping.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>#define FLUCTUATION</span>
<span>&nbsp;20</span>
<span>//値のバラツキ</span>
 &nbsp;</p>
<p>&nbsp;<span>static bool first ;</span>
 &nbsp;</p>
<p>&nbsp;<span>static short point ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitStepping()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>first = true ;</span>
 &nbsp;</p>
<p>&nbsp;<span>point = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//ステッピングモーターのスピードを変える</span>
 &nbsp;</p>
<p>&nbsp;<span>static void MotorSpeed( int speed )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2.TSTR.BIT.CST3 = 0 ;</span>
<span>//ステッピングモーターパルス出力タイマーストップ</span>
 &nbsp;</p>
<p>&nbsp;<span>switch ( speed )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 0 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU23.TGRA = 7813 ;</span>
<span>// 1.28us * 7813 = 10ms&nbsp; 50pps</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 1 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU23.TGRA = 3906 ;</span>
<span>// 1.28us * 3906 = 5ms&nbsp; 100pps</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 2 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU23.TGRA = 1953 ;</span>
<span>// 1.28us * 1953 = 2.5ms&nbsp; 200pps</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>default :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU23.TGRA = 7813 ;</span>
<span>// 1.28us * 7813 = 10ms&nbsp; 50pps</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2.TSTR.BIT.CST3 = 1 ;</span>
<span>//ステッピングモーターパルス出力タイマースタート</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>void TestStepping()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; modify &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>throttle = GetAdcVal( P_Ai02 );</span>
 &nbsp;</p>
<p>&nbsp;<span>int min = GetCtrl(C02);</span>
<span>//スロットルポジション最小値（AD値）</span>
 &nbsp;</p>
<p>&nbsp;<span>int max = GetCtrl( C11 );</span>
<span>//可動範囲の最大パルス数</span>
 &nbsp;</p>
<p>&nbsp;<span>switch ( sequence )</span>
<span>//制御シーケンス</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>case 0 :</span>
<span>//開始</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkInp(P_Di00) == ON )</span>
<span>//起動ボタン</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnOut( P_Do10 );</span>
<span>//運転中表示</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>first = true ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>point = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MotorSpeed( 0 );</span>
<span>//50pps</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>case 1 :</span>
<span>//方向判別</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( first == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( throttle &lt;= min || ChkInp(P_Di06) == ON )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>MoveValve( max );</span>
<span>// CW方向</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do24);</span>
<span>//LED1</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sequence = 2 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>MoveValve( -max );</span>
<span>// CCW方向</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do25);</span>
<span>//LED2</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sequence = 6 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( throttle &lt;= min || ChkInp(P_Di06) == ON )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>MoveValve( point - stepValve.pos );</span>
<span>// CW方向</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do24);</span>
<span>//LED1</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sequence = 2 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>MoveValve( -stepValve.pos );</span>
<span>// CCW方向</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do25);</span>
<span>//LED2</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sequence = 6 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case 2 :</span>
<span>// CW方向</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( first == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( throttle &gt; ( min + FLUCTUATION ))</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do25);</span>
<span>//LED2</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>MoveValve( 0 );</span>
<span>//一旦停止</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnTimer( TM09 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>point = stepValve.pos ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsGiveOff() == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do25);</span>
<span>//LED2</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnTimer( TM09 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case 3 :</span>
<span>// CW方向</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkTimer( TM09 ) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do26);</span>
<span>//LED3</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MoveValve( 500 );</span>
<span>// さらにCW方向に移動</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case 4 :</span>
<span>//パルス出力終了待ち</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsGiveOff() == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do27);</span>
<span>//LED4</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnTimer( TM09 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case 5 :</span>
<span>// 戻る</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkTimer( TM09 ) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do24);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do25);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do26);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do27);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence = 1 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case 6 :</span>
<span>// CCW方向、原点へ&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( first == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( throttle &lt;= min ||&nbsp; ChkInp(P_Di06) == ON )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>MoveValve( 0 );</span>
<span>//パルス出力停止</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>stepValve.pos = 0;</span>
<span>// 原点位置を記憶</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>first = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>MotorSpeed( 2 );</span>
<span>//200pps</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do26);</span>
<span>//LED3</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnTimer( TM09 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sequence = 5 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsGiveOff() == true&nbsp; ||&nbsp; ChkInp(P_Di06) == ON )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>MoveValve( 0 );</span>
<span>//パルス出力停止</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>stepValve.pos = 0;</span>
<span>// 原点位置を記憶</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do26);</span>
<span>//LED3</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnTimer( TM09 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sequence = 5 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>default :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ChkInp( P_Di01 ) == ON )</span>
<span>//停止ボタン</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MoveValve( 0 );</span>
<span>//停止</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffTimer( TM09 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffOut( P_Do10 );</span>
<span>//運転中表示</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do24);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do25);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do26);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do27);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>これで動作させると、</span>
 &nbsp;</p>
<p>&nbsp;<span>（１）スロットルポジションが最小値より小さい時は、シーケンスが1-&gt;2-&gt;3-&gt;4-&gt;5-&gt;1と進み、</span>
 &nbsp;</p>
<p>&nbsp;<span>(2)最小値より大きい時は、1-&gt;6-&gt;5-&gt;1</span>
 &nbsp;</p>
<p>&nbsp;<span>のようになるのが、LCD表示で確認出来ると思います。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>では、原点復帰を含めたコードを記述しましょう。</span>
 &nbsp;</p>
<p>&nbsp;<span>自動制御は、現段階では中身のない関数として、原点復帰、指定位置移動の動作を先に確認します。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;common.h&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//外部からのスロットル命令種類</span>
 &nbsp;</p>
<p>&nbsp;<span>enum {&nbsp;V_NONE,V_HOME,V_FIX,V_AUTO&nbsp;};</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>繰り返して原点復帰がチェック出来るように、テストコードを挿入します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Stepping.cpp&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>#include &lt;stdlib.h&gt;</span>
<span>//abs</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>typedef struct {</span>
 &nbsp;</p>
<p>&nbsp;<span>short kind;</span>
<span>//命令種類</span>
 &nbsp;</p>
<p>&nbsp;<span>short value ;&nbsp; // 指示値（スロットル位置）</span>
 &nbsp;</p>
<p>&nbsp;<span>bool flag ;&nbsp; // true=指示あり,false=指示なし</span>
 &nbsp;</p>
<p>&nbsp;<span>} COMMAND ;</span>
 &nbsp;</p>
<p>&nbsp;<span>static COMMAND stepCommand ;</span>
 &nbsp;</p>
<p>&nbsp;<span>#define FLUCTUATION2</span>
<span>5</span>
 &nbsp;</p>
<p>&nbsp;<span>enum { S_BEGIN, S_STABLE, S_AWAY, S_HOME, S_REACH, S_COMMAND, S_FIX, S_AUTO, S_ERROR, S_ERROR2, S_TEST, S_TEST2&nbsp;};</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private function</span>
 &nbsp;</p>
<p>&nbsp;<span>static void AutoControl( bool flag );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitStepping()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>//外部からの命令</span>
 &nbsp;</p>
<p>&nbsp;<span>COMMAND *sp = &amp;stepCommand ;</span>
 &nbsp;</p>
<p>&nbsp;<span>sp-&gt;kind =&nbsp;V_NONE;</span>
 &nbsp;</p>
<p>&nbsp;<span>sp-&gt;value = 0;&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>sp-&gt;flag = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>throttle = oldThrot = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//指定位置移動指示（パルス位置で）</span>
 &nbsp;</p>
<p>&nbsp;<span>void GoPosition( int position )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>int max = GetCtrl( C11 );</span>
<span>//可動範囲の最大パルス数</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( position &lt; 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>position = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>else if ( position &gt; max )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>position = max ;</span>
 &nbsp;</p>
<p>&nbsp;<span>int pulse =&nbsp; position - stepValve.pos ;</span>
 &nbsp;</p>
<p>&nbsp;<span>MoveValve( pulse );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//ステッピングモーター制御</span>
 &nbsp;</p>
<p>&nbsp;<span>void StepCtrl()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>COMMAND *sp ;</span>
 &nbsp;</p>
<p>&nbsp;<span>throttle = GetAdcVal( P_Ai02 );</span>
 &nbsp;</p>
<p>&nbsp;<span>int min = GetCtrl(C02);</span>
<span>//スロットルポジション最小値（AD値）</span>
 &nbsp;</p>
<p>&nbsp;<span>int max = GetCtrl( C11 );</span>
<span>//可動範囲の最大パルス数</span>
 &nbsp;</p>
<p>&nbsp;<span>switch ( sequence )&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_BEGIN :</span>
<span>//原点復帰</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>PutTime( TM09, 10 );</span>
<span>//1sec</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnTimer( TM09 );</span>
<span>// 移動監視タイマー</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>oldThrot = throttle ;</span>
<span>// 現在値を記憶</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MotorSpeed( 0 );</span>
<span>//50pps</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_STABLE :</span>
<span>//値の安定を確認する</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkTimer( TM09 ) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( abs( oldThrot - throttle ) &gt;= FLUCTUATION2 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>oldThrot = throttle ;&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnTimer( TM09 );&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>//値の安定を確認</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>if ( throttle &lt;= min || ChkInp(P_Di06) == ON )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>MoveValve( max );</span>
<span>// 原点から離れる方向に移動</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>PutTime( TM09, 100 );</span>
<span>//10sec</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnTimer( TM09 );&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>MoveValve( -max );</span>
<span>// 原点に向かう方向に移動</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>PutTime( TM09, 200 );</span>
<span>//20sec</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnTimer( TM09 );&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sequence = S_REACH ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_AWAY :</span>
<span>//原点から離れる方向に移動を確認する</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( throttle &gt; ( min + FLUCTUATION ))</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//離れたのを確認、少し停止</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MoveValve( 0 );</span>
<span>//パルス出力停止</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>PutTime( TM09, 10 );</span>
<span>//1sec</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnTimer( TM09 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( ChkTimer( TM09 ) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//移動を確認出来ない、何かの異常あり、停止する</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MoveValve( 0 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence = S_ERROR ;</span>
<span>//異常停止へ</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_HOME :</span>
<span>//原点に向かう方向に動かす</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkTimer( TM09 ) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MoveValve( -max );</span>
<span>// 原点に向かう方向に移動</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>PutTime( TM09, 200 );</span>
<span>//20sec</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnTimer( TM09 );&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_REACH :</span>
<span>//スロットルポジション最小値を確認する</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( throttle &lt;= min || ChkInp(P_Di06) == ON )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MoveValve( 0 );</span>
<span>//パルス出力停止</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffTimer( TM09 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>stepValve.pos = 0;</span>
<span>// 原点位置を記憶</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MotorSpeed( 2 );</span>
<span>//200pps</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do15);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( ChkTimer( TM09 ) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//移動を確認出来ない、何かの異常あり</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MoveValve( 0 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence = S_ERROR ;&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_COMMAND:</span>
<span>//命令待機</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp = &amp;stepCommand ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( sp-&gt;flag == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//原点復帰指示なら</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( sp-&gt;kind == V_HOME)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sp-&gt;flag = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do15);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do16);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sequence = S_BEGIN ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//指定位置移動指示なら</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if&nbsp; ( sp-&gt;kind == V_FIX )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sp-&gt;flag = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do15);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do17);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>GoPosition( sp-&gt;value );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sequence = S_FIX ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//自動制御指示なら</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if&nbsp; ( sp-&gt;kind == V_AUTO )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sp-&gt;flag = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>AutoControl( true );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do15);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do18);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sequence = S_AUTO ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sp-&gt;flag = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_FIX :</span>
<span>//パルス出力終了待ち</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsGiveOff() == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do17);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do15);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence&nbsp; = S_COMMAND ;&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_AUTO :</span>
<span>//自動制御</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp = &amp;stepCommand ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//他の命令があれば</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( sp-&gt;flag == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//指定位置移動指示なら</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( sp-&gt;kind == V_FIX )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sp-&gt;flag = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>AutoControl( false );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do18);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do17);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>GoPosition( sp-&gt;value );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sequence = S_FIX ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sp-&gt;flag = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_ERROR :</span>
<span>//異常停止</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffTimer( TM09 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do19);</span>
 &nbsp;</p>
<p>&nbsp;<span>//</span>
<span>&nbsp;</span>
<span>SetError(0x40);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_ERROR2 :</span>
<span>//リセット待ち</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsReset() == true&nbsp;&amp;&amp; IsMsgDisp() == false&nbsp;)</span>
<span>// Reset button</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do15);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do16);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do17);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do18);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do19);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>fuzValue = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence = S_BEGIN ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>#ifdef TEST</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_TEST :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkInp( P_Di00 ) == ON )</span>
<span>//Start button</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MotorSpeed( 2 );</span>
<span>//200pps</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MoveValve( max/4 );</span>
<span>//Move away from the origin</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do15);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do16);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do17);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_TEST2 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsGiveOff() == true &amp;&amp; ChkInp( P_Di00 ) == OFF)</span>
<span>//Start button</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do18);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do19);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence = S_ERROR ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>#endif</span>
 &nbsp;</p>
<p>&nbsp;<span>default:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence = S_BEGIN ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>#ifdef TEST</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ChkInp( P_Di01 ) == ON )</span>
<span>//Stop button</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MoveValve( 0 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do15);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do16);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do17);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence = S_TEST ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>#endif</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//ステッピングモーター自動制御</span>
 &nbsp;</p>
<p>&nbsp;<span>static void AutoControl( bool flag )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>繰り返しの手順は、</span>
 &nbsp;</p>
<p>&nbsp;<span>1)&nbsp;動作中に停止ボタンを押します。モーターが停止するとLEDが点灯します。</span>
 &nbsp;</p>
<p>&nbsp;<span>2)&nbsp;それから開始ボタンを押すと、原点から離れる方向に移動します。モーターが停止すると、他のLEDが点灯します。</span>
 &nbsp;</p>
<p>&nbsp;<span>3)&nbsp;リセットボタンを押すと、原点復帰を行った後に、コマンド待ち状態になります。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>メイン関数から、ステッピングモーターの制御を呼び出します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Main.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>void main(void)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>while ( 1 )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>//</span>
<span>&nbsp;</span>
<span>TestStepping();</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>StepCtrl();</span>
<span>//ステッピングモーター制御部</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>リセットボタンの状態を返す関数を追加します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Input.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//リセットボタン</span>
 &nbsp;</p>
<p>&nbsp;<span>bool IsReset()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ChkInp( P_Di02 ) == ON || ChkInp( P_Di14 ) == ON )</span>
<span>// 3 リセットボタン</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return true ;</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>では、この状態で動作させてみましょう。</span>
 &nbsp;</p>
<p>&nbsp;<span>ステッピングモーターが原点復帰の動きをしますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>テストが終わったら、下記のようにして通常に戻しておいて下さい。</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Stepping.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//#define TEST</span>
<span>1</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2><a id="calibre_link-45"></a>
<a id="calibre_link-16">
<span>(5) シリアル通信</span>
</a>
</h2>
<p>&nbsp;<span>次に、シリアル通信で指定の位置に移動させましょう。</span>
 &nbsp;</p>
<p>&nbsp;<span>次のようなコマンドを発行します。</span>
 &nbsp;</p>
<p>&nbsp;<span>例：</span>
 &nbsp;</p>
<p>&nbsp;<span>(1) @STM,FIX100*¥r&nbsp; (2) @STM,HOME*¥r&nbsp; (3) @STM,AUTO*¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>[ヘッダ]STM,[種類][ターミネター][改行コード]</span>
 &nbsp;</p>
<p>&nbsp;<span>[種類]については</span>
 &nbsp;</p>
<p>&nbsp;<span>（１）指定位置移動&nbsp;=&nbsp;FIX+position</span>
 &nbsp;</p>
<p>&nbsp;<span>（２）原点復帰&nbsp;=&nbsp;HOME</span>
 &nbsp;</p>
<p>&nbsp;<span>（３）自動制御開始&nbsp;=&nbsp;AUTO</span>
 &nbsp;</p>
<p>&nbsp;<span>とします。</span>
 &nbsp;</p>
<p>&nbsp;<span>シリアル通信部にコマンド受信のコードを追加します。</span>
 &nbsp;</p>
<p>&nbsp;<span>これは、自動／手動選択スイッチ(P_Di04)が手動側になっている時だけ動作します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Sci_2.cpp&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private function</span>
 &nbsp;</p>
<p>&nbsp;<span>static void StepCommand( char *s );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>void CommPaso2()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_WAIT :</span>
<span>//命令受信待ち</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( Receive() == R_OK ) //正常ブロックを受信したら</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( strncmp( s, "ERR", 3 ) == 0 )&nbsp;</span>
<span>// 異常記録読み出し命令なら</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( strncmp( s, "STM", 3 ) == 0 )</span>
<span>// ステッピングモーター指示命令なら</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>if ( ChkInp( P_Di04 ) == ON )</span>
<span>//手動=ON</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>StepCommand( s ) ;</span>
<span>//STM,</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>cStep++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//ステッピングモーター指示命令</span>
 &nbsp;</p>
<p>&nbsp;<span>//(STM,FIX100)(STM,HOME)(STM,AUTO)</span>
 &nbsp;</p>
<p>&nbsp;<span>static void StepCommand( char *s )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>char *tp = strtok( s, "," );</span>
<span>//STM</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( tp == NULL )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcpy( txBuf, "NO STM" );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>bool flag = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>char buff[20];</span>
 &nbsp;</p>
<p>&nbsp;<span>tp = strtok( NULL, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( tp != NULL )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//原点復帰指示なら</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( strncmp( tp, "HOME", 4 ) == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( StepSetting(&nbsp;V_HOME, 0 ) == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>strcpy( buff, tp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>flag = true;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//指定位置移動指示なら</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( strncmp( tp, "FIX", 3 ) == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>int n = atoi( tp+3 ) ;</span>
<span>//position</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( StepSetting(&nbsp;V_FIX, n ) == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>strcpy( buff, tp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>flag = true;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//自動制御指示なら</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( strncmp( tp, "AUTO", 4 ) == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( StepSetting(&nbsp;V_AUTO, 0 ) == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>strcpy( buff, tp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>flag = true;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( flag == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcpy( txBuf, buff );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, "=OK" );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcpy( txBuf, "StepSetting=ERROR " );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, s );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, " " );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, tp );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ステッピングモーター側に、指示の受け取り部を追加します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Stepping.cpp&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//PCからの指示を受け取る</span>
 &nbsp;</p>
<p>&nbsp;<span>bool StepSetting( int kind, int value )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>COMMAND *sq = &amp;stepCommand ;</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( sequence&nbsp; == S_COMMAND )</span>
<span>//命令待機</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//原点復帰指示なら</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( kind ==&nbsp;V_HOME&nbsp;)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sq-&gt;kind =&nbsp;V_HOME&nbsp;;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sq-&gt;value = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sq-&gt;flag = true;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//指定位置移動指示なら</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( kind ==&nbsp;V_FIX&nbsp;)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sq-&gt;kind =&nbsp;V_FIX&nbsp;;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sq-&gt;value = value ;</span>
<span>//position</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sq-&gt;flag = true;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//自動制御指示なら</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( kind ==&nbsp;V_AUTO&nbsp;)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sq-&gt;kind =&nbsp;V_AUTO&nbsp;;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sq-&gt;value = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sq-&gt;flag = true;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else if ( sequence == S_AUTO )</span>
<span>//自動制御</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//指定位置移動指示なら</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( kind ==&nbsp;V_FIX&nbsp;)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sq-&gt;kind =&nbsp;V_FIX&nbsp;;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sq-&gt;value = value ;</span>
<span>//position</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sq-&gt;flag = true;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>return sq-&gt;flag ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>では、動作させて見ましょう。</span>
 &nbsp;</p>
<p>&nbsp;<span>指定位置移動コマンドを送って下さい。</span>
 &nbsp;</p>
<p>&nbsp;<span>例</span>
 &nbsp;</p>
<p>&nbsp;<span>　@STM,FIX100*¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>　@STM,FIX350*¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>原点復帰コマンドでは、如何ですか？</span>
 &nbsp;</p>
<p>&nbsp;<span>例　@STM,HOME*¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>思ったように動きましたか？</span>
 &nbsp;</p>
<p>&nbsp;</p>
<div></div>
<br />
&nbsp;<h2><a id="calibre_link-46"></a>
<a id="calibre_link-17">
<span>(6)&nbsp;自動制御</span>
</a>
</h2>
<p>&nbsp;<span>回転数を得ることが出来れば、自動制御の動作を確認出来ます。</span>
 &nbsp;</p>
<p>&nbsp;<span>実機の発電機は、1500rpmで50Helzの交流を出力しますから、1500rpmが自動制御の目標回転数です。</span>
 &nbsp;</p>
<p>&nbsp;<span>回転数は、後述するエンジンのクランクパルスから得ますが、ここでは疑似的に外付けのVRから回転数を入力しましょう。</span>
 &nbsp;</p>
<p>&nbsp;<span>アナログ入力の回転数変更VR&nbsp;(P_Ai11）を使います。</span>
 &nbsp;</p>
<p>&nbsp;<span>回転数変更VRは3.3Vを使っているので、アナログ入力値は0から約2700です。</span>
 &nbsp;</p>
<p>&nbsp;<span>この値を50rpmから2750rpmに対応させましょう。</span>
 &nbsp;</p>
<p>&nbsp;<span>また、自動制御には、ここではファジー制御を使います。ファジー制御の計算方法は、この「Discover! How?」シリーズの「Fuzzy+PID+Visual C#」に詳しく掲載しています。</span>
 &nbsp;</p>
<p>&nbsp;<span>ここでは、なるべく高速で計算したいので、実数ではなく、整数を使った計算方法で記述しています。100msのタイマー割り込みでファジー計算を行っています。</span>
 &nbsp;</p>
<p>&nbsp;<span>先ず、マルチファンクションタイマーの設定をします。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;hwsetup.cpp&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//Interrupt priority</span>
 &nbsp;</p>
<p>&nbsp;<span>INTC.IPR12.BIT._MTU2S3G = 10 ;</span>
<span>//MTU2S3.TIER.BIT.TGIEA ステッピングモーター</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//マルチファンクションタイマー</span>
 &nbsp;</p>
<p>&nbsp;<span>//-----------------------------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>//MTU2S チャネル3をステッピングモーター自動制御周期に使用</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2S3.TCR.BIT.CCLR = 1 ;</span>
<span>//TGRA のコンペアマッチ／インプットキャプチャで TCNT クリア</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2S3.TCR.BIT.CKEG = 0 ;</span>
<span>//00：立ち上がりエッジでカウント</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2S3.TCR.BIT.TPSC = 5 ;</span>
<span>//MTU2S3クロック：Pφ／1024 でカウント 1024/50MHz = 20.48us</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2S3.TMDR.BYTE = 0 ;</span>
<span>//通常動作&nbsp;&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2S3.TIOR.WORD = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2S3.TGRA = 4883 ;</span>
<span>//4883 * 20.48us = 100ms</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2S3.TIER.BIT.TGIEA = 1 ;</span>
<span>//1：TGFA ビットによる割り込み要求（TGIA）を許可</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>100msのタイマー割り込みをStepping.cpp内に記述します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Stepping.cpp&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>static short oldRpm ;</span>
<span>//Fuzzy計算用旧回転数</span>
 &nbsp;</p>
<p>&nbsp;<span>static short nowRpm ;</span>
<span>//Fuzzy計算用現在回転数</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitStepping()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>oldRpm = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>nowRpm = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//ステッピングモーター自動制御</span>
 &nbsp;</p>
<p>&nbsp;<span>static void AutoControl( bool flag )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( flag == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>oldRpm = GetRpm() ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU2S.TSTR.BIT.CST3 = 1 ;</span>
<span>//ステッピングモーター自動制御周期タイマースタート</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU2S.TSTR.BIT.CST3 = 0 ;</span>
<span>//ステッピングモーター自動制御周期タイマーストップ</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//ステッピングモーター自動制御周期 100ms</span>
 &nbsp;</p>
<p>&nbsp;<span>// 204 MTU2S MTU3S TGIA3</span>
 &nbsp;</p>
<p>&nbsp;<span>void INT_MTU2S_MTU3S_TGIA3(void)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( MTU2S3.TSR.BIT.TGFA == 1 )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU2S3.TSR.BIT.TGFA = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( sequence == S_AUTO )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>nowRpm = GetRpm() ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>fuzValue = Fuzzy( nowRpm, oldRpm );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>int position = stepValve.pos + fuzValue ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>int max = GetCtrl( C11 );</span>
<span>//可動範囲の最大パルス数</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( position &lt; 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>position = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( position &gt; max )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>position = max ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>int pulse =&nbsp; position - stepValve.pos ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>stepValve.pulse = pulse ;</span>
<span>// 回転パルス数</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>oldRpm = nowRpm ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>FlashLED(L_STEP, P_Do19);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>fuzValue = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//クランクパルス入力が出来るまでの仮の関数</span>
 &nbsp;</p>
<p>&nbsp;<span>int&nbsp;GetRpm()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; modify &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>return GetAdcVal( P_Ai11 ) + 50 ;</span>
<span>// 50...2750 rpm</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2><a id="calibre_link-47"></a>
<a id="calibre_link-18">
<span>(7) ファジー計算</span>
</a>
</h2>
<p>&nbsp;<span>ファジー計算のオブジェクトファイルを新たに作成します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Fuzzy.cpp&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//――――――――――――――――――――――――</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; FILE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : Fuzzy.cpp</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; DESCRIPTION : Fuzzy Calculation</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; CPU TYPE&nbsp;&nbsp;&nbsp; : SH7286</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; DATE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : Nov 01, 2016</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; VERSION ：1.0&nbsp;&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//――――――――――――――――――――――――</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "iodefine.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>extern "C" {</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "vect.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "common.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "proto.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>// ------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>// ------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>#define VMAX</span>
<span>100</span>
 &nbsp;</p>
<p>&nbsp;<span>//ファジー制御で行う</span>
 &nbsp;</p>
<p>&nbsp;<span>//浮動小数点は使わず、100倍して整数で計算する</span>
 &nbsp;</p>
<p>&nbsp;<span>static const long terget[] = { 1400, 1450, 1500, 1550, 1600 };</span>
 &nbsp;</p>
<p>&nbsp;<span>static const long differ[] = { -30, -15, 0, 15, 30 };</span>
 &nbsp;</p>
<p>&nbsp;<span>static const long fuzBase[] = { -60, -30, 0, 30, 60 };</span>
 &nbsp;</p>
<p>&nbsp;<span>static const short areaPB[6][2] = {{0,0},{0,1},{0,2},{1,0},{1,1},{2,0}};&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>static const short areaPS[4][2] = {{0,3},{1,2},{2,1},{3,0}};&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>static const short areaZO[5][2] = {{0,4},{1,3},{2,2},{3,1},{4,0}};&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>static const short areaNS[4][2] = {{1,4},{2,3},{3,2},{4,1}};&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>static const short areaNB[6][2] = {{2,4},{3,3},{3,4},{4,2},{4,3},{4,4}};&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>static long output[5] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//初期設定</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitFuzzy()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt; 5 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>output[n] = fuzBase[n];</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//出力値テーブルを変える</span>
 &nbsp;</p>
<p>&nbsp;<span>void ChangeBase( int val )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>output[0] = -val ;</span>
 &nbsp;</p>
<p>&nbsp;<span>output[1] = -val/ 2 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>output[2] = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>output[3] = val / 2 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>output[4] = val ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//Fuzzy calculation</span>
 &nbsp;</p>
<p>&nbsp;<span>int Fuzzy( int newVal, int oldVal )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>long value = newVal ;</span>
 &nbsp;</p>
<p>&nbsp;<span>long diff = newVal - oldVal ;</span>
<span>//rotational speed difference</span>
 &nbsp;</p>
<p>&nbsp;<span>long nume = 0;</span>
<span>//numerator</span>
 &nbsp;</p>
<p>&nbsp;<span>long deno = 0;</span>
<span>//denominator</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//The antecedent part 1</span>
 &nbsp;</p>
<p>&nbsp;<span>long data1[5] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt; 5 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>data1[n] = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>if (value &lt; terget[0])</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>data1[0]= VMAX ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else if (value &gt;= terget[4])</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>data1[4] = VMAX ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( int n = 0 ; n &lt; 4 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if (value &gt;= terget[n] &amp;&amp; value &lt; terget[n + 1])</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>nume = ( value - terget[n] ) * VMAX;</span>
<span>//Don't forget multiplay with VMAX</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>deno = terget[n + 1] - terget[n];</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>if ( deno &gt; 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>data1[n+1] = nume / deno ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>data1[n] = VMAX - data1[n+1] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//The antecedent part 2</span>
 &nbsp;</p>
<p>&nbsp;<span>long data2[5] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt; 5 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>data2[n] = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>if (diff &lt; differ[0])</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
<span>//-40</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>data2[0]= VMAX ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else if (diff &gt;= differ[4])</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
<span>//40</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>data2[4] = VMAX ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( int n = 0 ; n &lt; 4 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if (diff &gt;= differ[n] &amp;&amp; diff &lt; differ[n + 1])</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>nume = ( diff - differ[n] ) * VMAX;</span>
<span>//Don't forget multiplay with VMAX</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>deno = differ[n + 1] - differ[n];</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>if ( deno &gt; 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>data2[n+1] = nume / deno ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>data2[n] = VMAX - data2[n+1] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//AND operation</span>
 &nbsp;</p>
<p>&nbsp;<span>long result[5][5] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int m = 0 ; m &lt; 5 ; m++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( int n = 0 ; n &lt; 5 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>result[m][n] = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>long dA = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>long dB = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int m = 0 ; m &lt; 5 ; m++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>dA = data1[m] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( int n = 0 ; n &lt; 5 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>dB = data2[n] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( dA &lt;= dB )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>result[m][n] = dA ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>result[m][n] = dB ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//OR operation</span>
 &nbsp;</p>
<p>&nbsp;<span>long pNB = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>long pNS = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>long pZO = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>long pPS = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>long pPB = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>int j, k ;</span>
 &nbsp;</p>
<p>&nbsp;<span>//Max of pPB</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt; 6 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>j = areaPB[n][0] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>k = areaPB[n][1];</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( n == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>pPB = result[j][k] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( pPB &lt; result[j][k] )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>pPB = result[j][k] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//Max of pPS</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt; 4 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>j = areaPS[n][0] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>k = areaPS[n][1];</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( n == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>pPS = result[j][k] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( pPS &lt; result[j][k] )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>pPS = result[j][k] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//Max of pZO</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt; 5 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>j = areaZO[n][0] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>k = areaZO[n][1];</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( n == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>pZO = result[j][k] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( pZO &lt; result[j][k] )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>pZO = result[j][k] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//Max of pNS</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt; 4 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>j = areaNS[n][0] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>k = areaNS[n][1];</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( n == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>pNS = result[j][k] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( pNS &lt; result[j][k] )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>pNS = result[j][k] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//Max of pNB</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt; 6 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>j = areaNB[n][0] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>k = areaNB[n][1];</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( n == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>pNB = result[j][k] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( pNB &lt; result[j][k] )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>pNB = result[j][k] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//Gravity</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>long gravity = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>deno = pNB + pNS + pZO + pPS + pPB;</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( deno &gt; 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>gravity = pNB * output[0] + pNS * output[1] + pZO * output[2] + pPS * output[3] + pPB * output[4] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>gravity /= deno;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>return&nbsp; (int)( gravity / 10 );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>Main関数からファジーの初期化を呼び出します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Main.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>void main(void)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>InitStepping();</span>
 &nbsp;</p>
<p>&nbsp;<span>InitFuzzy();</span>
 &nbsp;</p>
<p>&nbsp;<span>set_imask(0);</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>では、動作させて見ましょう。</span>
 &nbsp;</p>
<p>&nbsp;<span>確認の手順は</span>
 &nbsp;</p>
<p>&nbsp;<span>１）LCD画面で回転数変更VR(P_Ai11)をほぼ中間の1350rpm位に合わせておきます。</span>
 &nbsp;</p>
<p>&nbsp;<span>２）シリアル通信でFIXコマンドを送って原点から離れた位置にセットします。</span>
 &nbsp;</p>
<p>&nbsp;<span>３）シリアル通信でAUTOコマンドを送ります。</span>
 &nbsp;</p>
<p>&nbsp;<span>４）VRを前後に動かすと、目標の1500rpmに合わせようと、ステッピングモーターが動作する筈です。</span>
 &nbsp;</p>
<p>&nbsp;<span>目標から大きく外れている時は、早く動作し、目標の近傍では小刻みに動く筈です。</span>
 &nbsp;</p>
<p>&nbsp;<span>如何ですか？　思ったように動作していますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>内部のタイマーを使って、ファジー計算時間を計測すると、約12.8usでした。</span>
 &nbsp;</p>
<p>&nbsp;</p>
<div></div>
<br />
&nbsp;<h1><a id="calibre_link-48"></a>
<a id="calibre_link-19">
<span>[4]&nbsp;クランクパルス出力</span>
</a>
</h1>
<p>&nbsp;<span>発電機の出力は、そのまま負荷の電源になりますので、発電機に直結したエンジンの回転数を規定値に維持することが大切です。</span>
 &nbsp;</p>
<p>&nbsp;<span>エンジンからは下図のようにクランクパルスとカムパルスが出ていますが、回転数はクランクパルスから取得します。</span>
 &nbsp;</p>
<p>&nbsp;<span>現在の段階ではエンジンは動かせないので、クランクパルスを模擬して出力する必要があります。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000002.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000014.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000018.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>(From Toyota service manual)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ここで使用する発電機のエンジンは4サイクルエンジンですから、カムが１回転する間にクランクは2回転します。</span>
 &nbsp;</p>
<p>&nbsp;<span>また、図のように、クランクパルスは連続したパルスではなくて、ピストン位置を検出するために２歯が欠歯したパルスになっています。</span>
 &nbsp;</p>
<p>&nbsp;<span>欠歯が無いとすれば、1回転で36パルスです。</span>
 &nbsp;</p>
<p>&nbsp;<span>先ずは、空きポートを使って、模擬クランクパルスを出力しましょう。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-20">
<span>(1)&nbsp;PWM モード</span>
</a>
</h2>
<p>&nbsp;<span>MTU24をPWM モードでテスト用クランクパルス出力に使用します。</span>
 &nbsp;</p>
<p>&nbsp;<span>最初は50rpmのパルスをTIOC4C端子から出力しましょう。</span>
 &nbsp;</p>
<p>&nbsp;<span>50rpmの時のパルス幅は、33.3msです。1.28usのクロックを使うので、PWMのレジスタには33.3ms/1.28us=26040をセットします。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000016.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;hwsetup.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//Interrupt priority</span>
 &nbsp;</p>
<p>&nbsp;<span>//-----------------------------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>INTC.IPR11.BIT._MTU24G =&nbsp;9&nbsp;;</span>
<span>//MTU24.TIER.BIT.TGIEA テスト用クランクパルス出力</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//マルチファンクションタイマー</span>
 &nbsp;</p>
<p>&nbsp;<span>//-----------------------------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>//MTU2 チャネル4をテスト用クランクパルス出力に使用 PE14/TIOC4C</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU24.TCR.BIT.CCLR = 5 ;</span>
<span>//TGRC のコンペアマッチ／インプットキャプチャでTCNT クリア</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU24.TCR.BIT.CKEG = 0 ;</span>
<span>//00：立ち上がりエッジでカウント</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU24.TCR.BIT.TPSC = 3 ;</span>
<span>//MTU24クロック：Pφ／64 でカウント 64/50MHz = 1.28us</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU24.TIOR.BIT.IOC = 6 ;</span>
<span>//TIOC4C 初期出力は1 出力 コンペアマッチで1 出力&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU24.TIOR.BIT.IOD = 5 ;</span>
<span>//TIOC4D 初期出力は1 出力 コンペアマッチで0 出力&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//50rpm 30pulse/sec</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU24.TCNT = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU24.TGRC = 26040 ;</span>
<span>//周期 50rpm -&gt;33.3ms, 26040 * 1.28us = 33.3ms</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU24.TGRD = 13020 ;</span>
<span>//デューティ 50%</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU24.TMDR.BIT.MD = 2 ;</span>
<span>//PWM モード1&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU24.TIER.BIT.TGIEC = 1 ;</span>
<span>//1：TGFC ビットによる割り込み要求（TGIC）を許可</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//The following item is special to MTU24.</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2.TOER.BIT.OE4C = 1 ; //TIOC4C 端子の MTU2 出力を許可 これが重要！！</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//ポート機能設定</span>
 &nbsp;</p>
<p>&nbsp;<span>//E port --------------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>//テスト用クランクパルス出力</span>
 &nbsp;</p>
<p>&nbsp;<span>PFC.PECRL4.BIT.PE14MD = 6 ;</span>
<span>//PE14&nbsp; 110：TIOC4C 入出力（MTU2）クランクパルス出力</span>
 &nbsp;</p>
<p>&nbsp;<span>PFC.PEIORL.BIT.B14 = 1 ;</span>
<span>//PE14&nbsp; TIOC4C 出力</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-21">
<span>(2)&nbsp;Rotate.cpp</span>
</a>
</h2>
<p>&nbsp;<span>新規にファイル Rotate.cpp を作成します。</span>
 &nbsp;</p>
<p>&nbsp;<span>テストのため固定的に50rpmのパルスにしています。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Rotate.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//――――――――――――――――――――――――</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; FILE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : Rotate.cpp</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; DESCRIPTION : Rotational speed measurement</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; CPU TYPE&nbsp;&nbsp;&nbsp; : SH7286</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; DATE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : Nov 01, 2016</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; VERSION ：1.0&nbsp;&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//――――――――――――――――――――――――</span>
 &nbsp;</p>
<p>&nbsp;<span>#include &lt;stdlib.h&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "iodefine.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>extern "C" {</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "vect.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "common.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "proto.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>#define TEST</span>
<span>1</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>// ------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>// ------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>static short crankOut ;</span>
<span>//クランクパルス出力カウント用</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//初期化</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitRotate()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>crankOut = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2.TSTR.BIT.CST4 = 1 ;</span>
<span>//テスト用クランクパルス出力タイマースタート</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//クランクポジションパルス出力</span>
 &nbsp;</p>
<p>&nbsp;<span>//2歯欠歯のパルスとする</span>
 &nbsp;</p>
<p>&nbsp;<span>// 190 MTU2 MTU4 TGIC4</span>
 &nbsp;</p>
<p>&nbsp;<span>void INT_MTU2_MTU4_TGIC4(void)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( MTU24.TSR.BIT.TGFC == 1 )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU24.TSR.BIT.TGFC = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>crankOut++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( crankOut &gt;= 12 &amp;&amp; crankOut &lt;= 13 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU24.TGRC =&nbsp;26040;&nbsp;//50rpm</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU24.TGRD =&nbsp;13020;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU24.TIOR.BIT.IOC = 1 ;</span>
<span>//TIOC4C</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU24.TIOR.BIT.IOD = 1 ;</span>
<span>//TIOC4D</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( crankOut == 14 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU24.TIOR.BIT.IOC = 6 ;</span>
<span>//TIOC4C&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU24.TIOR.BIT.IOD = 5 ;</span>
<span>//TIOC4D&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( crankOut &gt;= 36 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>crankOut = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>(3) メイン関数から、InitRotate()を呼び出します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Main.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>void main(void)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>InitRotate();</span>
 &nbsp;</p>
<p>&nbsp;<span>set_imask(0);&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>while ( 1 )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-22">
<span>(3)&nbsp;パルス出力チェック</span>
</a>
</h2>
<p>&nbsp;<span>では、これで実行して下さい。PE14ポートから、下図のようなパルスが出力されましたか？　（パルス幅 33.3ms）</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000013.gif" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>また、欠歯も正しく出ていますか？　（1回転 1.2s）</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000011.gif" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>それは２歯の欠歯になっていますか？　（３歯時間 100ms）</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000009.gif" alt="" />
 &nbsp;</p>
<p>&nbsp;</p>
<div></div>
<br />
&nbsp;<h2><a id="calibre_link-49"></a>
<a id="calibre_link-23">
<span>(4) 回転数変更</span>
</a>
</h2>
<p>&nbsp;<span>前章で使用した回転数変更VR(P_Ai11)を使って、パルス出力速度を変えられるようにします。今回は、アナログ入力の値(val)の&nbsp;0から2700を50rpmから2750rpmに対応させますので、指示回転数(y)の計算は、単に</span>
 &nbsp;</p>
<p>&nbsp;<span>y&nbsp;= val + 50 ;</span>
<span>//rpm</span>
 &nbsp;</p>
<p>&nbsp;<span>です。</span>
 &nbsp;</p>
<p>&nbsp;<span>クランクは１回転で３６パルス（欠歯の無い時）です。</span>
 &nbsp;</p>
<p>&nbsp;<span>回転数N rpmの時の１パルスの周期は　10/(N*6) 秒です。</span>
 &nbsp;</p>
<p>&nbsp;<span>これを1.28usのクロックでカウントすると、</span>
 &nbsp;</p>
<p>&nbsp;<span>n = 1302083 / N ;</span>
 &nbsp;</p>
<p>&nbsp;<span>をPWMレジスタにセットします。</span>
 &nbsp;</p>
<p>&nbsp;<span>では、Rotate.cpp に機能を追加します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Rotate.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>#define NUMERATOR3</span>
<span>1302083L</span>
 &nbsp;</p>
<p>&nbsp;<span>static short newSet;</span>
<span>//回転数変更</span>
 &nbsp;</p>
<p>&nbsp;<span>static short oldSet;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitRotate()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>crankOut = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>newSet = NUMERATOR3 / 50 ;</span>
<span>//50rpm</span>
 &nbsp;</p>
<p>&nbsp;<span>oldSet = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2.TSTR.BIT.CST4 = 1 ;</span>
<span>//テスト用クランクパルス出力タイマースタート</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>回転数変更のファンクションを追加します。</span>
 &nbsp;</p>
<p>&nbsp;<span>引数のvalはアナログ値です。</span>
 &nbsp;</p>
<p>&nbsp;<span>外付けVRの微小な変化は無視するようにしています。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Rotate.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//回転数変更</span>
 &nbsp;</p>
<p>&nbsp;<span>void ChangeRotation(int val)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if (( oldSet &gt;&gt; 2 ) != ( val &gt;&gt; 2 ))</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>oldSet = val;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>int&nbsp;y = val + 50;</span>
<span>//rpm</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>newSet = NUMERATOR3 / y;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>クランクパルス出力割り込みで、この値を使います。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Rotate.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>void INT_MTU2_MTU4_TGIC4(void)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( crankOut &gt;= 12 &amp;&amp; crankOut &lt;= 13 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; modify &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU24.TGRC = newSet;</span>
<span>//Set new rotational speed</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU24.TGRD = newSet / 2;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU24.TIOR.BIT.IOC = 1 ;</span>
<span>//TIOC4C</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>アナログ入力部から、回転数変更を呼び出します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Analog.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>void Analog()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>adcVal[P_Ai11] = adcBuf[P_Ai11] / AVEMAX ;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>ChangeRotation(adcVal[P_Ai11]);</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-24">
<span>(5) 回転数の確認</span>
</a>
</h2>
<p>&nbsp;<span>では、実行して下さい。回転数の変化を観察出来ましたか？</span>
 &nbsp;</p>
<p>&nbsp;<span>(1) 800rpm (Pulse width 2.083ms)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000005.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>(2) 1500rpm (Pulse width&nbsp;1.075ms)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000004.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>(3) 2000rpm (Pulse width&nbsp;0.833ms)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000001.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;</p>
<div></div>
<br />
&nbsp;<h1><a id="calibre_link-50"></a>
<a id="calibre_link-25">
<span>[5]&nbsp;回転数の計測</span>
</a>
</h1>
<p>&nbsp;<span>マルチファンクションタイマーのインプットキャプチャ機能を使って、パルス周期(n)を計り、回転数(N)を算出します。その際に、欠歯を避けるようにします。</span>
 &nbsp;</p>
<p>&nbsp;<span>前の章で使った式</span>
 &nbsp;</p>
<p>&nbsp;<span>n = 1302083 / N ;</span>
<span>(n=レジスタ値,N=回転数rpm)</span>
 &nbsp;</p>
<p>&nbsp;<span>から回転数を計算します。</span>
 &nbsp;</p>
<p>&nbsp;<span>また、レジスタ値は刻々と変化するため、中央値を使い移動平均を取ります。</span>
 &nbsp;</p>
<p>&nbsp;<span>移動平均数を16、移動平均合計値を rpmSumとした場合は</span>
 &nbsp;</p>
<p>&nbsp;<span>N =&nbsp;20833328&nbsp;/&nbsp;rpmSum ;</span>
 &nbsp;</p>
<p>&nbsp;<span>の式で回転数を算出します。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>実機では、インプットキャプチャ端子には、エンジンからのクランクパルス信号を入力するようにハードウェアが作成されています。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000008.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>しかし、電圧レベルが違うため、前章の疑似クランクパルス信号をここに接続することは出来ません。</span>
 &nbsp;</p>
<p>&nbsp;<span>新たに、テスト用に疑似クランクパルス信号入力ポートを用意します。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000015.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2><a id="calibre_link-51"></a>
<a id="calibre_link-26">
<span>(1) インプットキャプチャ</span>
</a>
</h2>
<p>&nbsp;<span>割り込みレベルとインプットキャプチャ機能を追加します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;hwsetup.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//Interrupt priority</span>
 &nbsp;</p>
<p>&nbsp;<span>//-----------------------------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>INTC.IPR10.BIT._MTU22G =&nbsp;15&nbsp;;</span>
<span>//MTU22.TIER.BIT.TGIEA テスト用クランクポジションセンサー</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//マルチファンクションタイマー</span>
 &nbsp;</p>
<p>&nbsp;<span>//-----------------------------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>//MTU2 チャネル2をテスト用クランクポジションセンサーに使用 PE6/TIOC2A</span>
 &nbsp;</p>
<p>&nbsp;<span>//インプットキャプチャで回転数を計測する</span>
 &nbsp;</p>
<p>&nbsp;<span>//PE6/TIOC2A</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU22.TMDR.BYTE = 0 ;</span>
<span>//通常動作</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU22.TCR.BIT.CCLR = 1 ;</span>
<span>//TGRA のインプットキャプチャでTCNT クリア</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU22.TCR.BIT.CKEG = 1 ;</span>
<span>//01：立ち下がりエッジでカウント</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU22.TCR.BIT.TPSC = 3 ;</span>
<span>//周辺クロック：Pφ／64 でカウント 64/50MHz = 1.28us</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU22.TIOR.BIT.IOA = 9 ;</span>
<span>//TIOC1A 端子 01：立ち下がりエッジでカウント</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU22.TIER.BIT.TGIEA = 1 ;</span>
<span>//1：TGFAビットによる割り込み要求（TGIA）を許可</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//ポート機能設定</span>
 &nbsp;</p>
<p>&nbsp;<span>//E port --------------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>//テスト用クランクポジションセンサー</span>
 &nbsp;</p>
<p>&nbsp;<span>PFC.PEIORL.BIT.B6 = 0 ;</span>
<span>//PE6 TIOC2A 入力&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>PFC.PECRL2.BIT.PE6MD = 6 ;</span>
<span>//PE6 110：TIOC2A 入力（MTU2）クランクポジションセンサー</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Rotate.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>#define AVENUM</span>
<span>16</span>
<span>// 移動平均回数</span>
 &nbsp;</p>
<p>&nbsp;<span>#define NUMERATOR1</span>
<span>20833328L</span>
<span>//1302083 * AVENUM</span>
 &nbsp;</p>
<p>&nbsp;<span>#define NUMERATOR2</span>
<span>65535L</span>
<span>//最大値で初期化するために使う</span>
 &nbsp;</p>
<p>&nbsp;<span>#define RPMLOW</span>
<span>208320L</span>
<span>//100rpm相当のrpmSumの値　 13020 * AVENUM</span>
 &nbsp;</p>
<p>&nbsp;<span>#define RPMHIGH</span>
<span>6944L</span>
<span>//3000rpm相当のrpmSumの値　 434 * AVENUM</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>#define NUMERATOR3</span>
<span>1302083L</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>static unsigned long rpmAve[AVENUM] ;</span>
<span>// 移動平均バッファ</span>
 &nbsp;</p>
<p>&nbsp;<span>static unsigned short rpmPtr ;</span>
<span>// 移動平均ポインタ</span>
 &nbsp;</p>
<p>&nbsp;<span>static unsigned long rpmSum ;</span>
<span>// 入力データ積算バッファ</span>
 &nbsp;</p>
<p>&nbsp;<span>static unsigned short newCount ;</span>
<span>//キャプチャー値</span>
 &nbsp;</p>
<p>&nbsp;<span>static unsigned short center ;</span>
<span>//キャプチャー中央値</span>
 &nbsp;</p>
<p>&nbsp;<span>static unsigned short ctrBuf[3] ;</span>
<span>//中央値検出用</span>
 &nbsp;</p>
<p>&nbsp;<span>static short newCtr ;</span>
<span>//回転確認カウンター</span>
 &nbsp;</p>
<p>&nbsp;<span>static short nowRpm ;</span>
<span>//現在回転数</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitRotate()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>rpmSum = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>for (&nbsp;int&nbsp;n = 0 ; n &lt; AVENUM ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>rpmAve[n] = NUMERATOR2 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>rpmSum += NUMERATOR2 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>rpmPtr = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>newCount = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>for (&nbsp;int&nbsp;n = 0 ; n &lt; 3 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>ctrBuf[n] = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>center = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>newCtr = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>nowRpm = 0 ;</span>
<span>//0rpm</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>crankOut = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>newSet = NUMERATOR3 / 50 ;</span>
<span>//50rpm</span>
 &nbsp;</p>
<p>&nbsp;<span>oldSet = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2.TSTR.BIT.CST2 = 1 ;</span>
<span>//MTU2チャネル2タイマースタート</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2.TSTR.BIT.CST4 = 1 ;</span>
<span>//MTU2チャネル４タイマースタート</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//テスト用クランクポジションセンサー　MTU2チャネル2</span>
 &nbsp;</p>
<p>&nbsp;<span>// 172 MTU2 MTU2 TGIA2</span>
 &nbsp;</p>
<p>&nbsp;<span>void INT_MTU2_MTU2_TGIA2(void)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( MTU22.TSR.BIT.TGFA )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU22.TSR.BIT.TGFA = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU22.TCNT = 0 ;</span>
<span>//カウンタークリア</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>newCount = MTU22.TGRA ;</span>
<span>//キャプチャーした値</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//欠歯を判定する＝前回の値の２倍を越えているなら欠歯</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if (( ctrBuf[0] &gt; 0 ) &amp;&amp; ( newCount &gt;= ( ctrBuf[1] + ctrBuf[2] )) &amp;&amp; ( newCtr &gt;= 36 ))</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//中央値を求める</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>ctrBuf[0] = ctrBuf[1] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>ctrBuf[1] = ctrBuf[2] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>ctrBuf[2] = newCount ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( newCount &gt; ctrBuf[1] )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>if ( ctrBuf[1] &gt; ctrBuf[0] )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>center = ctrBuf[1] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>else if ( newCount &gt; ctrBuf[0] )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>center = ctrBuf[0] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>center = newCount ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>if ( newCount &gt; ctrBuf[0] )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>center = newCount ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>else if ( ctrBuf[1] &gt; ctrBuf[0] )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>center = ctrBuf[0] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>center = ctrBuf[1] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>// 総和から現在ポイント値を引く</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>rpmSum -= rpmAve[rpmPtr] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>// 入力値をポイント部へ入れる</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>rpmAve[rpmPtr] = center ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>// 総和に入力値を加える</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>rpmSum += center ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>// ポインタを次に進める</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ++rpmPtr &gt;= AVENUM )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>rpmPtr = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( newCtr &lt; 36 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>newCtr++;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-27">
<span>(2) 回転数の計算</span>
</a>
</h2>
<p>&nbsp;<span>クランクパルスから回転数を計算出来るようになったので、ステッピングモーター部で使っていた&nbsp;GetRpm()ファンクションを削除して、下記のように変更します。</span>
 &nbsp;</p>
<p>&nbsp;<span>100rpm以下と3000rpm以上は使用しないので、計算から除外します。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Rotate.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>int&nbsp;GetRpm()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( rpmSum &gt; RPMHIGH )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( rpmSum &lt; RPMLOW )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>nowRpm = (unsigned short)( NUMERATOR1 / rpmSum );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>nowRpm = 0 ;</span>
<span>//0rpm</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>nowRpm = 3000 ;</span>
<span>//3000rpm</span>
 &nbsp;</p>
<p>&nbsp;<span>return nowRpm;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2><a id="calibre_link-52"></a>
<a id="calibre_link-28">
<span>(3) LCD表示</span>
</a>
</h2>
<p>&nbsp;<span>内部の処理が、意図した通りに行われているかを調べるために、各種の情報をLCDに表示しましょう。</span>
 &nbsp;</p>
<p>&nbsp;<span>ここで表示する値は、</span>
 &nbsp;</p>
<p>&nbsp;<span>(1) キャプチャーした値</span>
 &nbsp;</p>
<p>&nbsp;<span>(2) 中央値計算バッファ</span>
 &nbsp;</p>
<p>&nbsp;<span>(3) 移動平均積算値</span>
 &nbsp;</p>
<p>&nbsp;<span>(4) 現在回転数</span>
 &nbsp;</p>
<p>&nbsp;<span>です。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Display.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>void DispLCD()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>switch ( nowPage ){</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>case D_Rotate :</span>
<span>//Rotation</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>DispFunc( GetRotation, GetRotMsg );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>selectLED = L_ROT ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>回転数の検出側でLCDに表示するデータを準備します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Rotate.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>#include &lt;string.h&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>static const char scRPM[][21] = {</span>
<span>//Rotation</span>
 &nbsp;</p>
<p>&nbsp;<span>{"Rot&nbsp; F=00&nbsp;&nbsp; rpm=0000"},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"[0]=0000&nbsp; [1]=0000&nbsp; "},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"[2]=0000&nbsp; Ctr=0000&nbsp; "},</span>
 &nbsp;</p>
<p>&nbsp;<span>{" hi=0000&nbsp;&nbsp; lo=0000 "}};</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetRotation( int val[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>val[0] = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>val[1] = GetRpm();</span>
 &nbsp;</p>
<p>&nbsp;<span>val[2] = ctrBuf[0];</span>
 &nbsp;</p>
<p>&nbsp;<span>val[3] = ctrBuf[1];</span>
 &nbsp;</p>
<p>&nbsp;<span>val[4] = ctrBuf[2];</span>
 &nbsp;</p>
<p>&nbsp;<span>val[5] = newCount;</span>
 &nbsp;</p>
<p>&nbsp;<span>val[6] = (int)( rpmSum &gt;&gt; 16 );</span>
 &nbsp;</p>
<p>&nbsp;<span>val[7] = (int)( rpmSum &amp; 0x0FFFF );</span>
 &nbsp;</p>
<p>&nbsp;<span>return 8 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//LCD</span>
 &nbsp;</p>
<p>&nbsp;<span>void GetRotMsg( int val[], char buff[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>char line[22], temp[8] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[0] = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>//1st line</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( line, scRPM[0], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[0], temp );</span>
<span>//speedFlag</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 2, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[7], temp, 2 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[1], temp );</span>
<span>//nowRpm</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 4, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[16], temp, 4 );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>//2nd line</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( line, scRPM[1], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[2], temp );</span>
<span>//ctrBuf[0]</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 4, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[4], temp, 4 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[3], temp );</span>
<span>//ctrBuf[1]</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 4, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[14], temp, 4 );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>//3rd line</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( line, scRPM[2], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[4], temp );</span>
<span>//ctrBuf[2]</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 4, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[4], temp, 4 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[5], temp );</span>
<span>//newCount</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 5, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[14], temp, 5 );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>//4th line</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( line, scRPM[3], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoh4( val[6], temp );</span>
<span>//rpmSum Hi</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[4], temp, 4 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoh4( val[7], temp );</span>
<span>//rpmSum Lo</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[15], temp, 4 );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>では、実行して下さい。</span>
 &nbsp;</p>
<p>&nbsp;<span>意図したように、回転数が表示されましたか？</span>
 &nbsp;</p>
<p>&nbsp;<span>内部計算値も、想定した範囲内の値が表示されていますか？</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;</p>
<div></div>
<br />
&nbsp;<h1>
<a id="calibre_link-29">
<span>[6]&nbsp;内部設定値表示</span>
</a>
</h1>
<p>&nbsp;<span>各種のテストを行っていると、現在の装置の内部設定値を確認したい時が生じます。</span>
 &nbsp;</p>
<p>&nbsp;<span>時間設定値と、制御定数設定値をLCD画面に表示出来ると好都合です。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Display.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>void DispLCD()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>case D_TimeVal :</span>
<span>//Timer setting</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>DispFunc( GetTimeVal_0,&nbsp; GetTimeMsg );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case D_TimeVal2:</span>
<span>// Timer setting</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>DispFunc( GetTimeVal_1,&nbsp; GetTimeMsg );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case D_CtrlVal:</span>
<span>// Control constant setting</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>DispFunc( GetCtrlVal,&nbsp; GetCtrlMsg );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-30">
<span>(1)&nbsp;時間設定値</span>
</a>
</h2>
<p>&nbsp;<span>LCD画面に表示する時間設定値を準備します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Timer.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>static const char scTimer[][21] = {</span>
 &nbsp;</p>
<p>&nbsp;<span>{"T0000 0004 0008 0012"},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"T0001 0005 0009 0013"},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"T0002 0006 0010 0014"},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"T0003 0007 0011 0015"}};</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//時間設定値(LCD用)</span>
 &nbsp;</p>
<p>&nbsp;<span>static int GetTimeVal( int select, int val[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( select == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( int n = TM00 ; n &lt;= TM15 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>val[n] = timeTbl[n].time ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return TM15 - TM00 + 1;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>int m, n ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( n = 0 ; n &lt; 16 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>val[n] = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( m = TM16 , n = 0; m &lt; TMRNUM ; m++, n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>val[n] = timeTbl[m].time ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return TMRNUM - TM16 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetTimeVal_0( int val[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>return GetTimeVal( 0, val );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetTimeVal_1( int val[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>return GetTimeVal( 1, val );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//LCD</span>
 &nbsp;</p>
<p>&nbsp;<span>void GetTimeMsg( int val[], char buff[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>char line[22], temp[8] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[0] = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int m = 0 ; m &lt; 4 ; m++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strncpy( line, scTimer[m], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( int n = 0 ; n &lt; 4 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>itoa2( val[m+n*4], temp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>adjust( temp, 4, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strncpy( &amp;line[1+ n*5], temp, 4 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-31">
<span>(2)&nbsp;制御定数設定値</span>
</a>
</h2>
<p>&nbsp;<span>LCD画面に表示する制御定数設定値を準備します。</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Eeprom.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>static const char scCtrl[][21] = {</span>
<span>//制御定数値</span>
 &nbsp;</p>
<p>&nbsp;<span>{"C0000 0004 0008 0012"},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"C0001 0005 0009 0013"},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"C0002 0006 0010 0014"},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"C0003 0007 0011 0015"}};</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//制御定数設定値(LCD用)</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetCtrlVal( int val[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = C00 ; n &lt;= C15 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>val[n] =ctrlTbl[n] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>return C15 - C00 + 1 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//LCD</span>
 &nbsp;</p>
<p>&nbsp;<span>void GetCtrlMsg( int val[], char buff[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>char line[22], temp[8] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[0] = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int m = 0 ; m &lt; 4 ; m++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strncpy( line, scCtrl[m], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( int n = 0 ; n &lt; 4 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>itoa2( val[m+n*4], temp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>adjust( temp, 4, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strncpy( &amp;line[1+ n*5], temp, 4 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>では、コンパイルして確認して下さい。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>さあ、ここまでで回転数の計測が出来るようになり、回転数を制御するために、スロットルを調整する知識を得ました。</span>
 &nbsp;</p>
<p>&nbsp;<span>以降の章では、運転制御と発電した電圧波形から周波数を計測し、電圧、電流、電力を求める部分を扱います。</span>
 &nbsp;</p>
<p>&nbsp;<span>さらに実用的な装置にするためのチューニングを行います。</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>------------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>「筆者のエピソード」</span>
 &nbsp;</p>
<p>&nbsp;<span>マイコントレーニングキットが市場を賑わせている頃に、日立の工業用マイコンボードを使って、工場で使う装置を作った。</span>
 &nbsp;</p>
<p>&nbsp;<span>工場内はノイズが激しいので、電子機器は使えないと言われていたので、手厚いノイズ対策をした。</span>
 &nbsp;</p>
<p>&nbsp;<span>この装置は周囲の期待に反して、問題なく長期間作動し、工場での製品の生産を助けた。</span>
 &nbsp;</p>
<p>&nbsp;<span>大都会から来たセールスマンが、小さな町でこんな装置が作られたのを驚いていたそうです。</span>
</p>
</div>
</div>


<script>function myFunction(){document.getElementById("tateyoko").classList.toggle("tateread")}</script></body></html>