<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Embedded System Advanced 2ã€€æ—¥æœ¬èªç‰ˆ: Training material for engineer Discover! How? (NGO TAMA)</title>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="/css/mainday.css" title="default">
<link rel="alternate stylesheet" href="/css/mainnight.css" title="alternate">
<script type="text/javascript" src="/js/styleswitcher.js"></script>
<script type="text/javascript" src="/js/global.js"></script>
</head>
<body>
<div class="novelpage">
<div class="novelbody">
<div id="tateyoko">
<div id="_top"></div>
<a href="/">ğŸ </a>&emsp;
<a href="#" onclick="setActiveStyleSheet('default'); return false;">æ—¥</a>&emsp;
<a href="#" onclick="setActiveStyleSheet('alternate'); return false;">æœˆ</a>&emsp;
<a href="#_top" onclick="myFunction()" style="cursor: pointer;">ç¸¦æ›¸ãï¼æ¨ªæ›¸ã</a>
<div id="calibre_link-32">
<div>
<div>
<table class="noveltitle">
<tr>
<td colspan="2"><i><span><i>Embedded System Advanced 2ã€€æ—¥æœ¬èªç‰ˆ: Training material for engineer Discover! How? (NGO TAMA)</i></span></i></td>
</tr>
<tr>
                    
                    
      </tr>
<tr>
<td colspan="2">NGO TAMA</td>
</tr>
<tr>
<td colspan="2">ENUJIHOH TAMA (2017)</td>
</tr>
<tr>
<td colspan="2"></td>
</tr>
</table>
<div></div>
</div>
<div></div>
</div>
</div>



<div id="calibre_link-0">
<div>
<p>&nbsp;<span>ç›®æ¬¡</span>
 &nbsp;</p>
<p>&nbsp;<a id="calibre_link-33"></a>
<a href="#calibre_link-1">
<span><u>[1]&nbsp;æ™‚åˆ»ã®è¨­å®š</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-2">
<span><u>(1) RTCã®è¨­å®š</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-3">
<span><u>(2) EEPROMã®èª­ã¿æ›¸ã</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-4">
<span><u>[2]&nbsp;é‹è»¢çŠ¶æ…‹ã®è¨˜éŒ²</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-5">
<span><u>(1)&nbsp;è¨˜éŒ²å†…å®¹ã®å®šç¾©</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-6">
<span><u>(2)&nbsp;ã‚³ãƒãƒ³ãƒ‰ã®å—ä¿¡</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-7">
<span><u>(3)&nbsp;è¨˜éŒ²æ›¸ãè¾¼ã¿</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-8">
<span><u>(4)&nbsp;è¨˜éŒ²èª­ã¿å‡ºã—</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-9">
<span><u>(5)&nbsp;é‹è»¢çŠ¶æ…‹ã®è¨˜éŒ²</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-10">
<span><u>(6) EEPROMå´</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-11">
<span><u>[3]&nbsp;ã‚¹ãƒ­ãƒƒãƒˆãƒ«åˆ¶å¾¡</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-12">
<span><u>(1)&nbsp;ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-13">
<span><u>(2)&nbsp;ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ </u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-14">
<span><u>(3) LCDè¡¨ç¤º</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-15">
<span><u>(4)&nbsp;åˆ¶å¾¡ã‚·ãƒ¼ã‚±ãƒ³ã‚¹</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-16">
<span><u>(5)&nbsp;ã‚·ãƒªã‚¢ãƒ«é€šä¿¡</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-17">
<span><u>(6)&nbsp;è‡ªå‹•åˆ¶å¾¡</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-18">
<span><u>(7)&nbsp;ãƒ•ã‚¡ã‚¸ãƒ¼è¨ˆç®—</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-19">
<span><u>[4]&nbsp;ã‚¯ãƒ©ãƒ³ã‚¯ãƒ‘ãƒ«ã‚¹å‡ºåŠ›</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-20">
<span><u>(1) PWM&nbsp;ãƒ¢ãƒ¼ãƒ‰</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-21">
<span><u>(2) Rotate.cpp</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-22">
<span><u>(3)&nbsp;ãƒ‘ãƒ«ã‚¹å‡ºåŠ›ãƒã‚§ãƒƒã‚¯</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-23">
<span><u>(4)&nbsp;å›è»¢æ•°å¤‰æ›´</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-24">
<span><u>(5)&nbsp;å›è»¢æ•°ã®ç¢ºèª</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-25">
<span><u>[5]&nbsp;å›è»¢æ•°ã®è¨ˆæ¸¬</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-26">
<span><u>(1)&nbsp;ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã‚­ãƒ£ãƒ—ãƒãƒ£</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-27">
<span><u>(2)&nbsp;å›è»¢æ•°ã®è¨ˆç®—</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-28">
<span><u>(3) LCDè¡¨ç¤º</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-29">
<span><u>[6]&nbsp;å†…éƒ¨è¨­å®šå€¤è¡¨ç¤º</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-30">
<span><u>(1)&nbsp;æ™‚é–“è¨­å®šå€¤</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;<a href="#calibre_link-31">
<span><u>(2)&nbsp;åˆ¶å¾¡å®šæ•°è¨­å®šå€¤</u></span>
</a>
 &nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<div></div>
<br />
&nbsp;<p>&nbsp;<a id="calibre_link-34">
<span>ã€Œæ¦‚è¦ã€</span>
</a>
 &nbsp;</p>
<p>&nbsp;<span>ã“ã‚Œã‹ã‚‰Book_1ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã«ã€å„ç¨®ã®æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¦è¡Œãã¾ã™ã€‚ã“ã®æœ¬ã§ã¯ã€ä¸»ã«ã‚¨ãƒ³ã‚¸ãƒ³å›è»¢æ•°ã®æ¸¬å®šã¨åˆ¶å¾¡ã‚’æ‰±ã„ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ç°¡å˜ãªã‚‚ã®ã‹ã‚‰ä½œæˆã—ã¦è¡Œãã¾ã—ã‚‡ã†ã€‚</span>
 &nbsp;</p>
<h1>
<a id="calibre_link-1">
<span>[1]&nbsp;æ™‚åˆ»ã®è¨­å®š</span>
</a>
</h1>
<p>&nbsp;<span>æœ€åˆã¯è£…ç½®ã®é‹è»¢è¨˜éŒ²ã€ç•°å¸¸ã‚„æ•…éšœãªã©ã®ç™ºç”Ÿæ™‚åˆ»ã®è¨˜éŒ²ã«å¿…è¦ãªãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¯ãƒ­ãƒƒã‚¯(RTC)ã§ã™ã€‚</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-2">
<span>(1)&nbsp;RTCã®è¨­å®š</span>
</a>
</h2>
<p>&nbsp;<span>åŸºç¤ç·¨ã§ã¯ã€å¤–éƒ¨ã®ãƒœã‚¿ãƒ³ã‚’ä½¿ã£ã¦ã€æ™‚åˆ»ã®è¨­å®šã‚’ã—ã¾ã—ãŸã€‚å®Ÿæ©Ÿã§ã¯ã€ãã®ã‚ˆã†ãªãƒœã‚¿ãƒ³ã¯ç„¡ã„ã®ã§ã€ã‚·ãƒªã‚¢ãƒ«é€šä¿¡ã‚’ä½¿ã„ã€ãƒ‘ã‚½ã‚³ãƒ³ã‹ã‚‰è¨­å®šã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ä¸‹è¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ãƒ‘ã‚½ã‚³ãƒ³ã‹ã‚‰é€ã‚Šè¾¼ã¿ã€æ™‚åˆ»ã®è¨­å®šã‚’ã—ã¾ã—ã‚‡ã†ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;[ãƒ˜ãƒƒãƒ€]RTC[å¹´],[æœˆ],[é€±],[æ—¥],[æ™‚],[åˆ†],[ç§’][ã‚¿ãƒ¼ãƒŸãƒã‚¿ãƒ¼][æ”¹è¡Œã‚³ãƒ¼ãƒ‰]</span>
 &nbsp;</p>
<p>&nbsp;<span>ä¾‹ã€€@RTC16,11,0,18,07,54,06*Â¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Sci_2.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private function</span>
 &nbsp;</p>
<p>&nbsp;<span>static void SetRTC(char *s );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//ãƒ‘ã‚½ã‚³ãƒ³ã¨ã®é€šä¿¡ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹</span>
 &nbsp;</p>
<p>&nbsp;<span>void CommPaso2()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_WAIT :</span>
<span>//å‘½ä»¤å—ä¿¡å¾…ã¡</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( Receive() == R_OK ) //æ­£å¸¸ãƒ–ãƒ­ãƒƒã‚¯ã‚’å—ä¿¡ã—ãŸã‚‰</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//[@LCDabc12345*Â¥r],[@RTC16,11,0,18,07,54,06*Â¥r]</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>s = &amp;rxBuf[1] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( strncmp( s, "LCD", 3 ) == 0 )</span>
<span>// LCDè¡¨ç¤ºå‘½ä»¤ãªã‚‰</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( strncmp( s, "RTC", 3 ) == 0 )&nbsp;</span>
<span>// RTCæ›¸ãè¾¼ã¿å‘½ä»¤ãªã‚‰</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>n = rxPtr - rxBuf ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>n&nbsp; -= 4&nbsp; ;</span>
<span>//except @RTC</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>if ( n &gt;= LCDBF )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>n = LCDBF - 1 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>strncpy( lcdBuf, s+3, n );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>lcdBuf[n] = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>dspOK = true ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>SetRTC( s+3 ) ;</span>
<span>//16,11,18,07,54,06</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>cStep++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if (( strncmp( s, "PWT", 3 ) == 0 ) || ( strncmp( s, "PWC", 3 ) == 0 ))</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//RTCæ™‚åˆ»è¨­å®š</span>
 &nbsp;</p>
<p>&nbsp;<span>// caleTbl[0] Seconds, VL=b7</span>
 &nbsp;</p>
<p>&nbsp;<span>// caleTbl[1] Minutes</span>
 &nbsp;</p>
<p>&nbsp;<span>// caleTbl[2] Hours</span>
 &nbsp;</p>
<p>&nbsp;<span>// caleTbl[3] Days</span>
 &nbsp;</p>
<p>&nbsp;<span>// caleTbl[4]&nbsp;Day of week</span>
 &nbsp;</p>
<p>&nbsp;<span>// caleTbl[5] Months</span>
 &nbsp;</p>
<p>&nbsp;<span>// caleTbl[6] Years</span>
 &nbsp;</p>
<p>&nbsp;<span>static void SetRTC(char *s )</span>
<span>//16,11,0,18,07,54,06</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>bool flag = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>char *tp = strtok( s, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( tp != NULL )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>caleTbl[6] = atoi( tp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>int n ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( n = 0 ; n &lt; 6; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>tp = strtok( NULL, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( tp == NULL )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>caleTbl[5-n] = atoi( tp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( n &gt;= 6 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( WriteTimeRTC( caleTbl ) == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>flag = true;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( flag == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcpy( txBuf, "WriteTimeRTC=OKÂ¥r" );</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcpy( txBuf, "SetRTC=ERRORÂ¥r" );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ãƒ‘ã‚½ã‚³ãƒ³ã‹ã‚‰ç¾åœ¨æ™‚åˆ»ã‚’é€ã‚Šè¾¼ã‚“ã§ã¿ã¾ã—ã‚‡ã†ã€‚æ­£ã—ãæ™‚åˆ»ãŒè¨­å®šã•ã‚ŒãŸã‹ã¯ã€LCDè¡¨ç¤ºã§ç¢ºèªã—ã¦ä¸‹ã•ã„ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-3">
<span>(2) EEPROMã®èª­ã¿æ›¸ã</span>
</a>
</h2>
<p>&nbsp;<span>ãƒ‘ã‚½ã‚³ãƒ³ã‹ã‚‰ã®EEPROMã®èª­å‡ºã—ã¨æ›¸ãè¾¼ã¿ã‚’ã“ã“ã«è¨˜è¼‰ã—ã¾ã—ãŸã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Sci_2.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//EEPROMãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‘ã‚½ã‚³ãƒ³ã«é€ã‚‹</span>
 &nbsp;</p>
<p>&nbsp;<span>//kind+adrs,size&nbsp;&nbsp;</span>
<span>//T8,1&nbsp; //C5,10</span>
 &nbsp;</p>
<p>&nbsp;<span>static void ReadProm( char *s )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>strcpy( txBuf,"R" );</span>
 &nbsp;</p>
<p>&nbsp;<span>int kind = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>int addr = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>if (*s == 'T' )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>kind = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, "T" );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>addr = EETIME ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>kind = 1 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, "C" );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>addr = EECTRL ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>s++;</span>
 &nbsp;</p>
<p>&nbsp;<span>char *tp = strtok( s, "," );</span>
<span>//addr</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( tp != NULL )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>int n = atoi( tp ) ;</span>
<span>//offset</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( kind == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( n &gt;= TMRNUM )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>strcat( txBuf, "Range over!Â¥r"&nbsp; );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>return;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( n &gt;= CTRLNUM )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>strcat( txBuf, "Range over!Â¥r"&nbsp; );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>return;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>addr += n * 2 ;</span>
<span>//short size</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>char buff[8];</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>itoa2( n, buff );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, buff );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>tp = strtok( NULL, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( tp != NULL )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>int size = atoi( tp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n = addr + size * 2 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( kind == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>if ( n &gt;= EECTRL )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>size = ( EECTRL - addr ) / 2 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>if ( n &gt;= EEID )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>size = ( EEID - addr ) / 2 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>unsigned char val[40];</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>ReadEEPROM( addr, val, size*2 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>short temp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( int k = 0 ; k &lt; size ; k++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>temp = val[k*2] &lt;&lt; 8 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>temp |= val[k*2+1];</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>itoa2( temp, buff );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>strcat( txBuf, buff );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>strcat( txBuf, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, " OK!"&nbsp; );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n = strlen( txBuf );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( n &gt;= LCDBF )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>n = LCDBF - 1 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strncpy( lcdBuf, txBuf, n );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>lcdBuf[n] = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>dspOK = true ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, " No size!Â¥r"&nbsp; );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, " No address!Â¥r"&nbsp; );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//ãƒ‘ã‚½ã‚³ãƒ³ã‹ã‚‰EEPROMã«ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ã</span>
 &nbsp;</p>
<p>&nbsp;<span>//kind+adrs,data1,data2,..,data10 = all integer</span>
 &nbsp;</p>
<p>&nbsp;<span>static void WriteProm( char *s )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>strcpy( txBuf,"W" );</span>
 &nbsp;</p>
<p>&nbsp;<span>int kind = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>int addr = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>int size = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>if (*s == 'T' )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>kind = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, "T" );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>addr = EETIME ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>size = TMRNUM;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>kind = 1 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, "C" );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>addr = EECTRL ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>size = CTRLNUM;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>s++;</span>
 &nbsp;</p>
<p>&nbsp;<span>char *tp = strtok( s, "," );</span>
<span>//addr</span>
 &nbsp;</p>
<p>&nbsp;<span>unsigned char val[40];</span>
 &nbsp;</p>
<p>&nbsp;<span>short temp;</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( tp != NULL )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>int k, offset;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>offset = atoi( tp ) ;</span>
<span>//offset</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( kind == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( offset &gt;= TMRNUM )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>strcat( txBuf, " Range over!Â¥r"&nbsp; );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>return;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( offset &gt;= CTRLNUM )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>strcat( txBuf, " Range over!Â¥r"&nbsp; );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>return;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>addr +=&nbsp; offset * 2;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>char buff[8];</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>itoa2( offset, buff );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, buff );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( k = 0 ; k &lt; size ; )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>tp = strtok( NULL, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( tp == NULL )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>temp = atoi( tp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>val[k*2] = temp &gt;&gt; 8 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>val[k*2+1] = temp &amp; 0x00FF ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>itoa2( temp, buff );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, buff );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>k++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( kind == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>if ( ++offset &gt;= TMRNUM )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>if ( ++offset &gt;= CTRLNUM )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( k &gt; 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( WriteValueEEPROM( addr, val, k*2 ) == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>strcat( txBuf, " OK!"&nbsp; );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>strcat( txBuf, " Error!"&nbsp; );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>int n = strlen( txBuf );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( n &gt;= LCDBF )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>n = LCDBF - 1 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strncpy( lcdBuf, txBuf, n );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>lcdBuf[n] = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>dspOK = true ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, " No data!Â¥r"&nbsp; );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, " No address!Â¥r"&nbsp; );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ã§ã¯ã€EEPROMã«å¯¾ã™ã‚‹èª­ã¿æ›¸ãæ©Ÿèƒ½ã®ç¢ºèªã‚’ã—ã¾ã—ã‚‡ã†ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>1)&nbsp;ä¾‹ãˆã°ã€ã‚¿ã‚¤ãƒãƒ¼å€¤ã‚’èª­ã¿å‡ºã—ã¦ã€ç´™ãªã©ã«æ›¸ãè¨˜ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>@PRT23,3*Â¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>2)&nbsp;åˆ¥ã®å€¤ã‚’åŒã˜ã‚¢ãƒ‰ãƒ¬ã‚¹ã«æ›¸ãè¾¼ã¿ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>@PWT23,10,20,30*Â¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>3)&nbsp;ãã‚Œã‹ã‚‰ã€MPUåŸºæ¿ã®é›»æºã‚’åˆ‡ã‚Šã€30ç§’å¾Œã«å†ã³é›»æºã‚’å…¥ã‚Œã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>4)&nbsp;åŒã˜ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰èª­ã¿å‡ºã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>@PRT23,3*Â¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>5)&nbsp;èª­ã¿å‡ºã—ãŸå€¤ãŒã€æ›¸ãè¾¼ã‚“ã å€¤ã¨åŒä¸€ãªã‚‰ã€EEPROMã®èª­ã¿æ›¸ãæ©Ÿèƒ½ã¯æ­£ã—ãæ©Ÿèƒ½ã—ã¦ã„ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>6)&nbsp;å¿˜ã‚Œãšã«ã€æœ€åˆã«èª­ã¿å‡ºã—ãŸå€¤ã§æ›¸ãæˆ»ã—ã¦ä¸‹ã•ã„ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>7) åˆ¶å¾¡å®šæ•°ã«ã«ã¤ã„ã¦ã‚‚åŒæ§˜ã«ç¢ºèªã—ã¦ä¸‹ã•ã„ã€‚</span>
 &nbsp;</p>
<p>&nbsp;</p>
<div></div>
<br />
&nbsp;<h1><a id="calibre_link-35"></a>
<a id="calibre_link-4">
<span>[2]&nbsp;é‹è»¢çŠ¶æ…‹ã®è¨˜éŒ²</span>
</a>
</h1>
<p>&nbsp;<span>æ¬¡ã¯ã€é‹è»¢çŠ¶æ…‹ã‚„ã€ç•°å¸¸ã®è¨˜éŒ²ã‚’EEPROMã«ä¿å­˜ã—ã€ã‚·ãƒªã‚¢ãƒ«é€šä¿¡ã§èª­ã¿å‡ºã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ã“ã‚Œã¯é–‹ç™ºä¸­ã®è£…ç½®ã§ã¯å¿…é ˆã®æ©Ÿèƒ½ã§ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ä¸‹è¨˜ã®ã‚ˆã†ãªæ§‹é€ ä½“ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>1</span>
<span>)</span>
<span>&nbsp;</span>
<span>å¹´ã€æœˆï¼ˆä¸Šä½ã€ä¸‹ä½ï¼‰</span>
 &nbsp;</p>
<p>&nbsp;<span>2</span>
<span>)</span>
<span>&nbsp;</span>
<span>æ—¥ã€æ™‚ï¼ˆä¸Šä½ã€ä¸‹ä½ï¼‰</span>
 &nbsp;</p>
<p>&nbsp;<span>3</span>
<span>)</span>
<span>&nbsp;</span>
<span>åˆ†ã€ç§’ï¼ˆä¸Šä½ã€ä¸‹ä½ï¼‰</span>
 &nbsp;</p>
<p>&nbsp;<span>4)&nbsp;è£…ç½®çŠ¶æ…‹ã€ç•°å¸¸ç•ªå·ï¼ˆä¸Šä½ã€ä¸‹ä½ï¼‰</span>
 &nbsp;</p>
<p>&nbsp;<span>5</span>
<span>)</span>
<span>&nbsp;</span>
<span>å›è»¢æ•°</span>
 &nbsp;</p>
<p>&nbsp;<span>6</span>
<span>)</span>
<span>&nbsp;</span>
<span>é‹è»¢ã‚¹ãƒ†ãƒ¼ã‚¸ã€é‹è»¢ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·ï¼ˆä¸Šä½ã€ä¸‹ä½ï¼‰</span>
 &nbsp;</p>
<p>&nbsp;<span>7</span>
<span>)</span>
<span>&nbsp;</span>
<span>ã‚¨ãƒ³ã‚¸ãƒ³çŠ¶æ…‹ã€ã‚¨ãƒ³ã‚¸ãƒ³åˆ¶å¾¡ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·ï¼ˆä¸Šä½ã€ä¸‹ä½ï¼‰</span>
 &nbsp;</p>
<p>&nbsp;<span>8)&nbsp;ã‚¹ãƒ†ãƒƒãƒ—ãƒ¢ãƒ¼ã‚¿ãƒ¼ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·ã€å†èµ·å‹•ãƒ•ãƒ©ã‚°ï¼ˆä¸Šä½ã€ä¸‹ä½ï¼‰</span>
 &nbsp;</p>
<p>&nbsp;<span>9)&nbsp;å®ŸåŠ¹é›»åœ§å€¤ï¼ˆä¸Šä½ï¼‰ï¼‹å®ŸåŠ¹é›»æµå€¤ï¼ˆä¸‹ä½ï¼‰</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ä¸‹å›³ã®ã‚ˆã†ã«ã€ã“ã®æ§‹é€ ä½“ã‚’EEPROMã®ä¸­ã«30å€‹é…ç½®ã—ã€ãƒªãƒ³ã‚°ãƒãƒƒãƒ•ã‚¡ã®ã‚ˆã†ã«æ‰±ã„ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000017.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ãƒ†ã‚¹ãƒˆç”¨ã«ã€ã‚·ãƒªã‚¢ãƒ«é€šä¿¡ã‹ã‚‰æ›¸ãè¾¼ã‚€æ™‚ã¯ã€ä¸‹è¨˜ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>[ãƒ˜ãƒƒãƒ€]ERW[è£…ç½®çŠ¶æ…‹],[ç•°å¸¸ç•ªå·],[å›è»¢æ•°],[é‹è»¢ã‚¹ãƒ†ãƒ¼ã‚¸],[é‹è»¢ã‚·ãƒ¼ã‚±ãƒ³ã‚¹],</span>
 &nbsp;</p>
<p>&nbsp;<span>[ã‚¨ãƒ³ã‚¸ãƒ³çŠ¶æ…‹],[ã‚¨ãƒ³ã‚¸ãƒ³åˆ¶å¾¡ã‚·ãƒ¼ã‚±ãƒ³ã‚¹],[ã‚¹ãƒ†ãƒƒãƒ—ãƒ¢ãƒ¼ã‚¿ãƒ¼ã‚·ãƒ¼ã‚±ãƒ³ã‚¹],</span>
 &nbsp;</p>
<p>&nbsp;<span>[å†èµ·å‹•ãƒ•ãƒ©ã‚°],[é›»åœ§],[é›»æµ][ã‚¿ãƒ¼ãƒŸãƒã‚¿ãƒ¼][æ”¹è¡Œã‚³ãƒ¼ãƒ‰]</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ä¾‹ã€€@ERW1,0,1500,1,2,2,5,5,1,220,50*Â¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>æ™‚åˆ»ã¯RTCã‹ã‚‰å–å¾—ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ã¾ãŸã€èª­å‡ºã—ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯</span>
 &nbsp;</p>
<p>&nbsp;<span>[ãƒ˜ãƒƒãƒ€]ERR[ã‚¿ãƒ¼ãƒŸãƒã‚¿ãƒ¼][æ”¹è¡Œã‚³ãƒ¼ãƒ‰]</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ä¾‹ã€€@ERR*Â¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ã§ã€è¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹å†…å®¹ã‚’æœ€å¤§30å€‹ã€å¤ã„é †ã«ã‚·ãƒªã‚¢ãƒ«å›ç·šã«é€ã‚Šå‡ºã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000019.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-5">
<span>(1) è¨˜éŒ²å†…å®¹ã®å®šç¾©</span>
</a>
</h2>
<p>&nbsp;<span>=====&nbsp;common.h&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp;ç•°å¸¸ã®è¨˜éŒ²</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>struct RECORD {</span>
 &nbsp;</p>
<p>&nbsp;<span>unsigned short yearMonth ;</span>
<span>//1) year(upper)+month(lower)</span>
 &nbsp;</p>
<p>&nbsp;<span>unsigned short dayHour ;</span>
<span>//2) day(upper)+hour(lower)</span>
 &nbsp;</p>
<p>&nbsp;<span>unsigned short minSec ;</span>
<span>//3) minute(upper)+second(lower)</span>
 &nbsp;</p>
<p>&nbsp;<span>short state ;</span>
<span>//4) state of equipment(upper)+error code(lower)</span>
 &nbsp;</p>
<p>&nbsp;<span>short value1 ;</span>
<span>//5) rotational speed</span>
 &nbsp;</p>
<p>&nbsp;<span>short stage ;</span>
<span>//6) run stage(upper)+run sequence(lower)</span>
 &nbsp;</p>
<p>&nbsp;<span>short engine ;</span>
<span>//7) state of engine(upper)+sequence of engine(lower)</span>
 &nbsp;</p>
<p>&nbsp;<span>short step ;</span>
<span>//8) sequence of motor(upper)+restart flag(lower)</span>
 &nbsp;</p>
<p>&nbsp;<span>short value2 ;</span>
<span>//9) effective voltage(upper)+ effective current(lower)</span>
 &nbsp;</p>
<p>&nbsp;<span>};</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>#define RECNUM</span>
<span>30</span>
<span>//ç•°å¸¸ã®è¨˜éŒ²æ•°</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2><a id="calibre_link-36"></a>
<a id="calibre_link-6">
<span>(2) ã‚³ãƒãƒ³ãƒ‰ã®å—ä¿¡</span>
</a>
</h2>
<p>&nbsp;<span>ã‚·ãƒªã‚¢ãƒ«é€šä¿¡éƒ¨ã«ã€è¨˜éŒ²ã®æ›¸ãè¾¼ã¿ã€èª­å‡ºã—ã®æŒ‡ç¤ºã‚’å—ã‘å–ã‚‹éƒ¨åˆ†ã‚’è¿½åŠ ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ã•ã‚‰ã«è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ã‚’é€£ç¶šã—ã¦é€ã‚Šå‡ºã™ãŸã‚ã«ã€ä¸€ã¤ã®é …ç›®ã‚’é€ã‚Šçµ‚ãˆãŸã‚‰ã€æ¬¡ã®é …ç›®ã‚’å–ã‚Šå‡ºã™æ©Ÿèƒ½ã‚’ä»˜ã‘åŠ ãˆã¦ã„ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Sci_2.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>//EEPROMã‹ã‚‰è¨˜éŒ²èª­ã¿å‡ºã—</span>
 &nbsp;</p>
<p>&nbsp;<span>static bool followed ;&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private function</span>
 &nbsp;</p>
<p>&nbsp;<span>static void WriteErrRec( char *s );</span>
 &nbsp;</p>
<p>&nbsp;<span>static void ReadErrRec(void);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitSci_2()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>followed = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>void CommPaso2()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_WAIT :</span>
<span>//å‘½ä»¤å—ä¿¡å¾…ã¡</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( Receive() == R_OK ) //æ­£å¸¸ãƒ–ãƒ­ãƒƒã‚¯ã‚’å—ä¿¡ã—ãŸã‚‰</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if (( strncmp( s, "PRT", 3 ) == 0 ) || ( strncmp( s, "PRC", 3 ) == 0 ))&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// EEPROMèª­ã¿å‡ºã—å‘½ä»¤ãªã‚‰</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( strncmp( s, "ERW", 3 ) == 0 )&nbsp;</span>
<span>// ç•°å¸¸è¨˜éŒ²æ›¸ãè¾¼ã¿å‘½ä»¤ãªã‚‰</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>if ( ChkInp( P_Di04 ) == ON )</span>
<span>//æ‰‹å‹•=ON</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>WriteErrRec( s+3 ) ;</span>
<span>//1,10,20,30*</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>cStep++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( strncmp( s, "ERR", 3 ) == 0 )&nbsp;</span>
<span>// ç•°å¸¸è¨˜éŒ²èª­ã¿å‡ºã—å‘½ä»¤ãªã‚‰</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>ReadErrRec() ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>cStep++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_REPLY2 :</span>
<span>//é€ä¿¡çµ‚äº†å¾…ã¡</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; modify &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( txBusy == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//é€ä¿¡çµ‚äº†ã—ãŸã‚‰</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( followed == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnTimer( TM02 );</span>
<span>//ç›£è¦–ã‚¿ã‚¤ãƒãƒ¼</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>cStep = S_NEXT ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>cStep = S_BEGIN ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( ChkTimer( TM02 ) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>cStep = S_BEGIN ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_NEXT :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkTimer( TM02 ) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( SendNext(txBuf) == false)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>followed = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>cStep = S_REPLY;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>default :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>cStep = S_BEGIN ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2><a id="calibre_link-37"></a>
<a id="calibre_link-7">
<span>(3)&nbsp;è¨˜éŒ²æ›¸ãè¾¼ã¿</span>
</a>
</h2>
<p>&nbsp;<span>===== Sci_2.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// ç•°å¸¸è¨˜éŒ²æ›¸ãè¾¼ã¿å‘½ä»¤</span>
 &nbsp;</p>
<p>&nbsp;<span>//æ—¥ä»˜ã¯RTCã‹ã‚‰èª­ã¿å‡ºã™</span>
 &nbsp;</p>
<p>&nbsp;<span>static void WriteErrRec( char *s )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ReadTimeRTC( caleTbl ) == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcpy( txBuf, "ReadTimeRTC()==ERRORÂ¥r" );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>RECORD record ;</span>
 &nbsp;</p>
<p>&nbsp;<span>RECORD *sp = &amp;record ;</span>
 &nbsp;</p>
<p>&nbsp;<span>int m = caleTbl[6] ;</span>
<span>//year</span>
 &nbsp;</p>
<p>&nbsp;<span>m &lt;&lt;= 8 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>int n = caleTbl[5] ;</span>
<span>//month</span>
 &nbsp;</p>
<p>&nbsp;<span>sp-&gt;yearMonth = m + n ;//1)&nbsp;year+month</span>
 &nbsp;</p>
<p>&nbsp;<span>//caleTbl[4]&nbsp;=Day of the week</span>
 &nbsp;</p>
<p>&nbsp;<span>m = caleTbl[3] ;</span>
<span>//day</span>
 &nbsp;</p>
<p>&nbsp;<span>m &lt;&lt;= 8 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>n = caleTbl[2] ;</span>
<span>//hour</span>
 &nbsp;</p>
<p>&nbsp;<span>sp-&gt;dayHour = m + n ;</span>
<span>//2)&nbsp;day+hour</span>
 &nbsp;</p>
<p>&nbsp;<span>m = caleTbl[1] ;</span>
<span>//min</span>
 &nbsp;</p>
<p>&nbsp;<span>m &lt;&lt;= 8 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>n = caleTbl[0] ;</span>
<span>//sec</span>
 &nbsp;</p>
<p>&nbsp;<span>sp-&gt;minSec = m + n ;</span>
<span>//3</span>
<span>)</span>
<span>&nbsp;</span>
<span>minute+second</span>
 &nbsp;</p>
<p>&nbsp;&nbsp;</p>
<p>&nbsp;<span>char *tp = strtok( s, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>int ptr = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>while ( tp != NULL &amp;&amp; ptr &lt; 11 )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>switch ( ptr )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 0:</span>
<span>//4) state</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>m = atoi( tp );</span>
<span>//çŠ¶æ…‹</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>m &lt;&lt;= 8 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>ptr++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 1:</span>
<span>//4) state</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>n = atoi( tp );</span>
<span>//ç•°å¸¸ç•ªå·</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sp-&gt;state = m + n ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>ptr++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 2:</span>
<span>//5) value1</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>m = atoi( tp );</span>
<span>//å›è»¢æ•°</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sp-&gt;value1 = m ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>ptr++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 3:</span>
<span>//6) stage</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>m = atoi( tp );</span>
<span>//é‹è»¢ã‚¹ãƒ†ãƒ¼ã‚¸</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>m &lt;&lt;= 8 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>ptr++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 4:</span>
<span>//6) stage</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>n = atoi( tp );</span>
<span>//é‹è»¢ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sp-&gt;stage = m + n ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>ptr++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 5:</span>
<span>//7) engine</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>m = atoi( tp );</span>
<span>//ã‚¨ãƒ³ã‚¸ãƒ³çŠ¶æ…‹</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>m &lt;&lt;= 8 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>ptr++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 6:</span>
<span>//7) engine</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>n = atoi( tp );</span>
<span>//ã‚¨ãƒ³ã‚¸ãƒ³åˆ¶å¾¡ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sp-&gt;engine = m + n ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>ptr++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 7:</span>
<span>//8) step</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>m = atoi( tp );</span>
<span>//ã‚¹ãƒ†ãƒƒãƒ—ãƒ¢ãƒ¼ã‚¿ãƒ¼ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>m &lt;&lt;= 8 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>ptr++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 8:</span>
<span>//8) step</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>n = atoi( tp );</span>
<span>//å†èµ·å‹•ãƒ•ãƒ©ã‚°</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sp-&gt;step = m + n ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>ptr++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 9:</span>
<span>//9) value2</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>m = atoi( tp );</span>
<span>//é›»åœ§</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>m &lt;&lt;= 8 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>ptr++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 10:</span>
<span>//9) value2</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>n = atoi( tp );</span>
<span>//é›»æµ</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sp-&gt;value2 = m + n ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>ptr++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>tp = strtok( NULL, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ptr &gt;= 11 )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//EEPROMã«æ›¸ãè¾¼ã‚€</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>bool flag = WriteRecordEEPROM(&amp;record);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( flag == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcpy( txBuf, "WriteErrRec()==OKÂ¥r" );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcpy( txBuf, "WriteErrRec()==ERRORÂ¥r" );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>char buff[8];</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>itoa2( ptr, buff );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcpy( txBuf, "WriteErrRec()==" );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, buff );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, "Â¥r" );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2><a id="calibre_link-38"></a>
<a id="calibre_link-8">
<span>(4)&nbsp;è¨˜éŒ²èª­ã¿å‡ºã—</span>
</a>
</h2>
<p>&nbsp;<span>===== Sci_2.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// ç•°å¸¸è¨˜éŒ²èª­ã¿å‡ºã—å‘½ä»¤ã€å…¨éƒ¨ã‚’å¤ã„é †ã«é€ã‚‹</span>
 &nbsp;</p>
<p>&nbsp;<span>static void ReadErrRec()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>int next ;</span>
 &nbsp;</p>
<p>&nbsp;<span>char buff[8];</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( BeginRecSend(&amp;next) == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>followed = true;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>itoa2( next, buff );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcpy( txBuf, "ReadErrRec()=" );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, buff );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, "Â¥r" );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>followed = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcpy( txBuf, "ReadErrRec()=ERRORÂ¥r" );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-9">
<span>(5)&nbsp;é‹è»¢çŠ¶æ…‹ã®è¨˜éŒ²</span>
</a>
</h2>
<p>&nbsp;<span>é‹è»¢çŠ¶æ…‹ã®è¨˜éŒ²ç”¨ã«æ–°è¦ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Record.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; FILE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : Record.cpp</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; DESCRIPTION : Record of the operation state&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; CPU TYPE&nbsp;&nbsp;&nbsp; : SH7286</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; DATE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : Nov 01, 2016</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; VERSION ï¼š1.0&nbsp;&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•</span>
 &nbsp;</p>
<p>&nbsp;<span>#include &lt;string.h&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>//#include &lt;machine.h&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "iodefine.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>extern "C" {</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "vect.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "common.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "proto.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>// ------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>// ------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>//ç•°å¸¸ã®è¨˜éŒ²</span>
 &nbsp;</p>
<p>&nbsp;<span>static short offset ;</span>
 &nbsp;</p>
<p>&nbsp;<span>static short next ;</span>
 &nbsp;</p>
<p>&nbsp;<span>static const char scRecInfo[][21] = {</span>
<span>// information of record</span>
 &nbsp;</p>
<p>&nbsp;<span>{"offset 000&nbsp;&nbsp; next 00"},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "}};</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//--------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private function</span>
 &nbsp;</p>
<p>&nbsp;<span>//--------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>static void SetRecData( int nx, RECORD *sp, char buff[] );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//--------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>// Functions</span>
 &nbsp;</p>
<p>&nbsp;<span>//--------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>//åˆæœŸåŒ–</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitRecord()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>offset = -1;</span>
 &nbsp;</p>
<p>&nbsp;<span>next = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//ç•°å¸¸ã®è¨˜éŒ²ã‚’EEPROMã«æ›¸ãè¾¼ã‚€ï¼ˆoffsetä½ç½®ã‚’èª­ã¿å‡ºã—ã¦ã‹ã‚‰ï¼‰</span>
 &nbsp;</p>
<p>&nbsp;<span>bool WriteRecordEEPROM(RECORD *sp)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>unsigned short buff[RECWIDE];</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ReadEEPROM(EEOFS, (unsigned char*)&amp;offset, 2) == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>#ifdef TEST</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>SendBuffSci_2( "WriteRecordEEPROM:Can't read EEOFS" );</span>
 &nbsp;</p>
<p>&nbsp;<span>#endif</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//æ›¸ãè¾¼ã¿ä½ç½®</span>
 &nbsp;</p>
<p>&nbsp;<span>unsigned short adrs = EERECD + RECWIDE * offset * 2 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>int m = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[m++] = sp-&gt;yearMonth;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[m++] = sp-&gt;dayHour;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[m++] = sp-&gt;minSec;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[m++] = sp-&gt;state;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[m++] = sp-&gt;value1;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[m++] = sp-&gt;stage;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[m++] = sp-&gt;engine;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[m++] = sp-&gt;step;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[m++] = sp-&gt;value2 ;&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>bool flag = WriteEEPROM(adrs, (unsigned char*)&amp;buff, RECWIDE*2);</span>
 &nbsp;</p>
<p>&nbsp;<span>//EEPROMã®æ›¸ãè¾¼ã¿æ™‚é–“ã ã‘å¾…ã¤</span>
 &nbsp;</p>
<p>&nbsp;<span>Wait( 10000 );</span>
<span>//10ms</span>
 &nbsp;</p>
<p>&nbsp;<span>//</span>
<span>DebugPrint( adrs, buff, RECWIDE, flag );</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( flag == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>#ifdef TEST</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>SendBuffSci_2( "WriteEEPROM:error" );</span>
 &nbsp;</p>
<p>&nbsp;<span>#endif</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ++offset &gt;= RECNUM )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>offset = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>flag = WriteEEPROM(EEOFS, (unsigned char*)&amp;offset, 2);</span>
 &nbsp;</p>
<p>&nbsp;<span>//EEPROMã®æ›¸ãè¾¼ã¿æ™‚é–“ã ã‘å¾…ã¤</span>
 &nbsp;</p>
<p>&nbsp;<span>Wait( 10000 );</span>
<span>//10ms</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( flag == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>#ifdef TEST</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>SendBuffSci_2( "WriteEEPROM:EEOFS error" );</span>
 &nbsp;</p>
<p>&nbsp;<span>#endif</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//è­˜åˆ¥ã‚³ãƒ¼ãƒ‰ã‚’è¨ˆç®—ã—ã¦æ›¸ãè¾¼ã‚€</span>
 &nbsp;</p>
<p>&nbsp;<span>return CalcEEPROM();</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//æŒ‡å®šã®ä½ç½®ã®ç•°å¸¸ã®è¨˜éŒ²ã‚’è¿”ã™</span>
 &nbsp;</p>
<p>&nbsp;<span>bool ReadRecordEEPROM(int offs, RECORD *sp)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>unsigned short buff[RECWIDE];</span>
 &nbsp;</p>
<p>&nbsp;<span>unsigned short adrs = EERECD + RECWIDE * offs * 2 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ReadEEPROM(adrs, (unsigned char*)&amp;buff, RECWIDE*2) == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>int m = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>sp-&gt;yearMonth = buff[m++];</span>
 &nbsp;</p>
<p>&nbsp;<span>sp-&gt;dayHour = buff[m++];</span>
 &nbsp;</p>
<p>&nbsp;<span>sp-&gt;minSec = buff[m++];</span>
 &nbsp;</p>
<p>&nbsp;<span>sp-&gt;state = buff[m++];</span>
 &nbsp;</p>
<p>&nbsp;<span>sp-&gt;value1 = buff[m++];</span>
 &nbsp;</p>
<p>&nbsp;<span>sp-&gt;stage = buff[m++];</span>
 &nbsp;</p>
<p>&nbsp;<span>sp-&gt;engine = buff[m++];</span>
 &nbsp;</p>
<p>&nbsp;<span>sp-&gt;step = buff[m++];</span>
 &nbsp;</p>
<p>&nbsp;<span>sp-&gt;value2 = buff[m++];</span>
 &nbsp;</p>
<p>&nbsp;<span>return true;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//ãƒ‘ã‚½ã‚³ãƒ³ã«ç•°å¸¸ã®è¨˜éŒ²ã‚’å…¨ã¦é€ã‚‹</span>
 &nbsp;</p>
<p>&nbsp;<span>bool BeginRecSend( int *p)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>//offsetä½ç½®ã‚’èª­ã¿å‡ºã™</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ReadEEPROM(EEOFS, (unsigned char*)&amp;offset, 2) == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>offset = -1;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>*p = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>next = offset;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>*p = next;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return true;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//ã²ã¨ã¤ã²ã¨ã¤é€ã‚Šå‡ºã™</span>
 &nbsp;</p>
<p>&nbsp;<span>bool SendNext(char buff[])</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>//offsetã®æ¬¡ã®é …ç›®ã‚’ãƒã‚¤ãƒ³ãƒˆã™ã‚‹</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt;&nbsp; RECNUM ; n++)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ++next &gt;= RECNUM )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>next = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( next == offset )</span>
<span>//çµ‚äº†</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcpy(buff, "Finish!!!");</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å‡ºã™</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>RECORD record ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ReadRecordEEPROM(next, &amp;record) == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( record.yearMonth == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>continue ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>//é€ä¿¡ã™ã‚‹</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>SetRecData( next, &amp;record, buff );</span>
<span>//buff[]ã«å…¥ã‚Œã‚‹</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>return true;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>char buff2[8];</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcpy(buff, "ReadRecordEEPROM fail=");</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>itoa2(next,buff2 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat(buff, buff2);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>return false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//é€ä¿¡ãƒ†ã‚­ã‚¹ãƒˆã«ã™ã‚‹</span>
 &nbsp;</p>
<p>&nbsp;<span>static void SetRecData( int nx, RECORD *sp, char buff[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>char temp[10];</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( nx, temp );</span>
<span>//next</span>
 &nbsp;</p>
<p>&nbsp;<span>strcpy((char*)buff, temp );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat((char*)buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>int n ;</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int m = 0 ; m &lt; 6 ; m++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>switch ( m )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 0 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n = sp-&gt;yearMonth &gt;&gt; 8;</span>
<span>//year</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n += 2000 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 1 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n = sp-&gt;yearMonth &amp; 0xFF;</span>
<span>//month</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 2 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n = sp-&gt;dayHour &gt;&gt; 8;</span>
<span>//day</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 3 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n = sp-&gt;dayHour &amp; 0xFF;</span>
<span>//Hour</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 4 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n = sp-&gt;minSec&nbsp; &gt;&gt; 8;</span>
<span>//min</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 5 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n = sp-&gt;minSec&nbsp; &amp; 0xFF;</span>
<span>//sec</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>itoa2( n, temp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat((char*)buff, temp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat((char*)buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int m = 0 ; m &lt; 6 ; m++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>switch ( m )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 0 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n = sp-&gt;state ;</span>
<span>//4)è£…ç½®çŠ¶æ…‹ï¼‹ç•°å¸¸ç•ªå·</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 1 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n = sp-&gt;value1 ;</span>
<span>//5) å›è»¢æ•°</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 2 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n = sp-&gt;stage ;</span>
<span>// 6)é‹è»¢ã‚¹ãƒ†ãƒ¼ã‚¸ï¼‹é‹è»¢ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 3 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n = sp-&gt;engine ;</span>
<span>// 7) ã‚¨ãƒ³ã‚¸ãƒ³çŠ¶æ…‹ï¼‹ã‚¨ãƒ³ã‚¸ãƒ³åˆ¶å¾¡ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 4 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n = sp-&gt;step ;</span>
<span>// 8) ã‚¹ãƒ†ãƒƒãƒ—ãƒ¢ãƒ¼ã‚¿ãƒ¼ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·ï¼‹å†èµ·å‹•ãƒ•ãƒ©ã‚°</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 5 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>n = sp-&gt;value2 ;</span>
<span>// 9) å®ŸåŠ¹é›»åœ§å€¤ï¼ˆä¸Šä½ï¼‰ï¼‹å®ŸåŠ¹é›»æµå€¤ï¼ˆä¸‹ä½ï¼‰</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( m == 1 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>itoa2( n, temp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat((char*)buff, temp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>itoa2( n &gt;&gt; 8, temp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat((char*)buff, temp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat((char*)buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>itoa2( n &amp; 0x00FF, temp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat((char*)buff, temp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( m &gt;= 0 &amp;&amp; m &lt;= 4 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat((char*)buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//å±¥æ­´ä¿å­˜æ•°</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetRecCount()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>//offsetä½ç½®ã‚’èª­ã¿å‡ºã™</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ReadEEPROM(EEOFS, (unsigned char*)&amp;offset, 2) == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return -1;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//offsetä½ç½®ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å‡ºã™</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>RECORD record ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ReadRecordEEPROM(offset, &amp;record) == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( record.yearMonth == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>return offset ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>return RECNUM ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return -1;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//å±¥æ­´èª­å‡ºã—ç•ªå·ã‚’ã‚»ãƒƒãƒˆã™ã‚‹</span>
 &nbsp;</p>
<p>&nbsp;<span>void SetHistory( int n )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( n &gt;= 1 &amp;&amp; n &lt;= RECNUM )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>next = n - 1 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//å±¥æ­´è©³ç´°=æŒ‡å®šä½ç½®ã®è¨˜éŒ²ã‚’è¿”ã™</span>
 &nbsp;</p>
<p>&nbsp;<span>bool GetRecord( int data[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>//æŒ‡å®šä½ç½®ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å‡ºã™</span>
 &nbsp;</p>
<p>&nbsp;<span>RECORD record ;</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ReadRecordEEPROM(next, &amp;record) == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( record.yearMonth == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>RECORD *sp = &amp;record ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>data[0] = sp-&gt;yearMonth ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>data[1] = sp-&gt;dayHour ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>data[2] = sp-&gt;minSec ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>data[3] = sp-&gt;state ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>data[4] = sp-&gt;value1 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>data[5] = sp-&gt;stage ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>data[6] = sp-&gt;engine ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>data[7] = sp-&gt;step ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>data[8] = sp-&gt;value2 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return true ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetOffset(int data[])</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>data[0] = offset ;</span>
 &nbsp;</p>
<p>&nbsp;<span>data[1] = next ;</span>
 &nbsp;</p>
<p>&nbsp;<span>return 2 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//LCD</span>
 &nbsp;</p>
<p>&nbsp;<span>void GetOffsetMsg( int val[], char buff[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>char line[22], temp[8] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[0] = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>//1st line</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( line, scRecInfo[0], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[0], temp );</span>
<span>//offset</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 3, ' ' );</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[7], temp, 3 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[1], temp );</span>
<span>//next</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 2, ' ' );</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[18], temp, 2 );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//2nd line</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( line, scRecInfo[1], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2><a id="calibre_link-39"></a>
<a id="calibre_link-10">
<span>(6) EEPROMå´</span>
</a>
</h2>
<p>&nbsp;<span>EEPROMã®åˆæœŸåŒ–æ™‚ã«ç•°å¸¸ã®è¨˜éŒ²éƒ¨ã®ã‚¯ãƒªã‚¢ã‚’è¿½åŠ ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Eeprom.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitEEPROM()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>//è­˜åˆ¥ã‚³ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ãªã„</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( WriteEEPROM( EECTRL, (unsigned char*)buff, CTRLNUM * 2 ) == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>alive = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//EEPROMã®æ›¸ãè¾¼ã¿æ™‚é–“ã ã‘å¾…ã¤</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>Wait( 10000 );</span>
<span>//10ms</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//ç•°å¸¸ã®è¨˜éŒ²éƒ¨ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ã€ã‚ªãƒ•ã‚»ãƒƒãƒˆéƒ¨ã‚’å«ã‚€</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( int n = 0 ; n &lt; RECSIZE+1 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>buff[n] = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( WriteEEPROM( EERECD, (unsigned char*)buff, (RECSIZE+1) * 2 ) == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>alive = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//EEPROMã®æ›¸ãè¾¼ã¿æ™‚é–“ã ã‘å¾…ã¤</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>Wait( 10000 );</span>
<span>//10ms</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//è­˜åˆ¥ã‚³ãƒ¼ãƒ‰ã‚’è¨ˆç®—ã—ã¦æ›¸ãè¾¼ã‚€</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>CRC16ã®è¨ˆç®—éƒ¨ã«ã€ç•°å¸¸è¨˜éŒ²éƒ¨ã‚’è¿½åŠ ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Eeprom.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//è­˜åˆ¥ã‚³ãƒ¼ãƒ‰ã‚’è¨ˆç®—ã™ã‚‹</span>
 &nbsp;</p>
<p>&nbsp;<span>static bool CalcAllCRC16( short *result, bool flag )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>crc = CalcCRC16( crc, (unsigned char*)buff, CTRLNUM * 2 );</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>//ã‚ªãƒ•ã‚»ãƒƒãƒˆéƒ¨ã‚’å«ã‚ã‚‹</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ReadEEPROM(EERECD, (unsigned char*)buff, (RECSIZE+1) * 2) == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>crc = CalcCRC16( crc, (unsigned char*)buff, (RECSIZE+1) * 2);</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>outcome[1] = crc ;</span>
 &nbsp;</p>
<p>&nbsp;<span>//CRCçµæœéƒ¨ã¾ã§å«ã‚ã¦è¨ˆç®—ã™ã‚‹</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Main.cpp&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>void main(void)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>InitEEPROM();</span>
 &nbsp;</p>
<p>&nbsp;<span>InitRecord();</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ã§ã¯ã€å®Ÿè¡Œã—ã¦ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>1)&nbsp;å…ˆãšã¯ã€æ›¸ãè¾¼ã¿ã§ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>@ERW0,1,2,3,4,5,6,7,8,9,10*Â¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>@ERW10,20,30,40,50,60,70,80,90,100,110*Â¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>ç­‰ã¨æ¬¡ã€…ã«æ›¸ãè¾¼ã¿ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>2)&nbsp;æ¬¡ã«ã€</span>
 &nbsp;</p>
<p>&nbsp;<span>@ERR*Â¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>ã“ã®ã‚³ãƒãƒ³ãƒ‰ã§ã€å…¨éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿å‡ºã•ã‚Œã¾ã—ãŸã‹ï¼Ÿ</span>
 &nbsp;</p>
<p>&nbsp;<span>ãƒã‚¤ã‚³ãƒ³ã‹ã‚‰ã¯ä¸Šä½ã¨ä¸‹ä½ãŒåˆæˆã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’åˆ†é›¢ã—ã¦ã€å€‹åˆ¥ã«PCã«é€ã‚Šå‡ºã•ã‚Œã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ä¾‹ãˆã°ã€ã‚·ãƒªã‚¢ãƒ«é€šä¿¡ãƒ¢ãƒ‹ã‚¿ãƒ¼ã§ã¯ã€ä¸‹è¨˜ã®ã‚ˆã†ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>---------------</span>
 &nbsp;</p>
<p>&nbsp;<span>Tx-&gt; @ERR*Â¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>-&gt;Rx:&nbsp;ReadErrRec()=0&lt;CR&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>-&gt;Rx:&nbsp;Finish!!!</span>
 &nbsp;</p>
<p>&nbsp;<span>Tx&nbsp;-&gt; @ERW0,1,2,3,4,5,6,7,8,9,10*Â¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>-&gt;Rx:&nbsp;WriteErrRec()==OK&lt;CR&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>Tx&nbsp;-&gt; @ERW10,20,30,40,50,60,70,80,90,100,110*Â¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>-&gt;Rx:&nbsp;WriteErrRec()==OK&lt;CR&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>Tx&nbsp;-&gt; @ERR*Â¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>-&gt;Rx:&nbsp;ReadErrRec()=2&lt;CR&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>-&gt;Rx:&nbsp;0,2016,12,18,10,39,24,0,1,2,3,4,5,6,7, 8,9,10</span>
 &nbsp;</p>
<p>&nbsp;<span>-&gt;Rx:&nbsp;1,2016,12,18,10,39,45,10,20,30,40,50,60,70,80,90,100,110</span>
 &nbsp;</p>
<p>&nbsp;<span>-&gt;Rx:&nbsp;Finish!!!</span>
 &nbsp;</p>
<p>&nbsp;<span>---------------</span>
 &nbsp;</p>
<p>&nbsp;</p>
<div></div>
<br />
&nbsp;<p>&nbsp;<span>(5) ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†</span>
 &nbsp;</p>
<p>&nbsp;<span>ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ã‚¿ã‚¤ãƒãƒ¼å€¤ã‚„åˆ¶å¾¡å®šæ•°ã‚’å¤‰æ›´ã—ã¦åŸºæ¿ã«æ›¸ãè¾¼ã‚“ã§ã‚‚ã€ãã®ã¾ã¾ã§ã¯å‹•ä½œã«åæ˜ ã•ã‚Œã¾ã›ã‚“ã€‚EEPROMã®åˆæœŸåŒ–ã§ã¯ã€ãƒã‚§ãƒƒã‚¯ã‚³ãƒ¼ãƒ‰ãŒä¸€è‡´ã™ã‚Œã°ã€èª­ã¿å‡ºã—ãŸå€¤ãŒä½¿ã‚ã‚Œã‚‹ã‹ã‚‰ã§ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ã‚‚ã¡ã‚ã‚“ã€ã‚·ãƒªã‚¢ãƒ«é€šä¿¡ã§å€¤ã‚’å¤‰æ›´ã™ã‚Œã°OKã§ã™ãŒã€ãƒœãƒ¼ãƒ‰ã«æ›¸ãè¾¼ã‚“ã ç›´å¾Œã‹ã‚‰åæ˜ ã—ãŸã„æ™‚ã¯ã€ãã®å¤‰æ›´ã‚’æ¤œçŸ¥ã™ã‚‹éƒ¨åˆ†ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ä¸€ã¤ã®æ–¹æ³•ã¨ã—ã¦ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã€EEPROMã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®é•ã„ã‚’åˆ¤æ–­ã™ã‚‹äº‹ã§ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ã“ã®æ–¹é‡ã§ä¸€éƒ¨ã‚’å¤‰æ›´ã—ã¾ã—ã‚‡ã†ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>EEPROMã®ãƒ‡ãƒ¼ã‚¿éƒ¨ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’è¿½åŠ ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;common.h&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>enum {</span>
<span>//short</span>
 &nbsp;</p>
<p>&nbsp;<span>EEVER=0,</span>
<span>//ROMãƒãƒ¼ã‚¸ãƒ§ãƒ³</span>
 &nbsp;</p>
<p>&nbsp;<span>EETIME=EEVER+2,</span>
<span>//ã‚¿ã‚¤ãƒãƒ¼å€¤å…ˆé ­ã‚¢ãƒ‰ãƒ¬ã‚¹</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>EEPROMã®åˆæœŸåŒ–éƒ¨ã‚’æ›¸ãæ›ãˆã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ã•ã‚‰ã«ã€å†…éƒ¨å‹•ä½œã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ã€å¤‰æ•°"history"ã‚’è¿½åŠ ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Eeprom.cpp&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>//ROMãƒãƒ¼ã‚¸ãƒ§ãƒ³</span>
 &nbsp;</p>
<p>&nbsp;<span>const&nbsp;short&nbsp;RomVer = 125;</span>
<span>//ã‚¿ã‚¤ãƒãƒ¼å€¤ã‚„åˆ¶å¾¡å®šæ•°ã‚’å¤‰æ›´ã—ãŸã‚‰æ›¸ãæ›ãˆã‚‹ã“ã¨ï¼ï¼</span>
 &nbsp;</p>
<p>&nbsp;<span>static short history ;</span>
<span>// Initialization status</span>
 &nbsp;</p>
<p>&nbsp;<span>static short romver ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitEEPROM()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt; 4 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>outcome[n] = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>unsigned short buff[RECSIZE+2] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>alive = true ;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>history = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>romver = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>//ROMãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’èª­ã¿å‡ºã™</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ReadEEPROM(EEVER, (unsigned char*)buff, 2) == false )</span>
<span>//EEPROMãŒèª­ã‚ãªã„</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>alive = false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>history = 0x01;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>romver = buff[0];</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>//è­˜åˆ¥ã‚³ãƒ¼ãƒ‰ã‚’è¨ˆç®—ã™ã‚‹</span>
 &nbsp;</p>
<p>&nbsp;<span>short result = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( CalcAllCRC16( &amp;result, true ) == false )</span>
<span>//EEPROMãŒèª­ã‚ãªã„</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>alive = false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>history = 0x02;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>outcome[0] = result;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; modify &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>//ROMãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒä¸€è‡´ã€ã‹ã¤è­˜åˆ¥ã‚³ãƒ¼ãƒ‰ã‚‚ä¸€è‡´ã®å ´åˆã¯ã€èª­å‡ºã—å¯èƒ½</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( romver == RomVer &amp;&amp; result == 0)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>history |= 0x10;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//ã‚¿ã‚¤ãƒãƒ¼å€¤ã‚’èª­ã¿å‡ºã™</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if (ReadEEPROM&nbsp;(EETIME, (unsigned char*)buff, TMRNUM&nbsp;*&nbsp;2) == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( int n = 0 ; n &lt; TMRNUM ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>PutTime( n, buff[n] );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; modify &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>alive = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>history |= 0x20;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//åˆ¶å¾¡å®šæ•°ã‚’èª­ã¿å‡ºã™</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ReadEEPROM(EECTRL, (unsigned char*)buff, CTRLNUM&nbsp;*&nbsp;2) == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( int n = 0 ; n &lt; CTRLNUM ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>ctrlTbl[n] = buff[n] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; modify &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>alive = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>history |= 0x40;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//ä¸€ã¤ã§ã‚‚ä¸€è‡´ã—ãªã‘ã‚Œã°ã€å†æ›¸ãè¾¼ã¿ã™ã‚‹</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; modify &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>history |= 0x100;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//ROMãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã‚¿ã‚¤ãƒãƒ¼å€¤ã‚’æ›¸ãè¾¼ã‚€</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>buff[0] = RomVer ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( int n = 0 ; n &lt; TMRNUM ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>buff[n+1] = GetTime( n );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( WriteEEPROM( EEVER, (unsigned char*)buff, (TMRNUM+1) * 2 ) == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>alive = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>history |= 0x200;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//EEPROMã®æ›¸ãè¾¼ã¿æ™‚é–“ã ã‘å¾…ã¤</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>Wait( 10000 );</span>
<span>//10ms</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//åˆ¶å¾¡å®šæ•°ã‚’æ›¸ãè¾¼ã‚€</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( int n = 0 ; n &lt; CTRLNUM ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>buff[n] = ctrlTbl[n];</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if (WriteEEPROM&nbsp;( EECTRL, (unsigned char*)buff, CTRLNUM&nbsp;*&nbsp;2 ) == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; modify &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>alive = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>history |= 0x400;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//EEPROMã®æ›¸ãè¾¼ã¿æ™‚é–“ã ã‘å¾…ã¤</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>Wait( 10000 );</span>
<span>//10ms</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//ç•°å¸¸ã®è¨˜éŒ²ã¨æ›¸ãè¾¼ã¿ä½ç½®ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( int n = 0 ; n &lt; RECSIZE+2 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>buff[n] = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if (WriteEEPROM&nbsp;( EERECD, (unsigned char*)buff, (RECSIZE+1)&nbsp;*&nbsp;2 ) == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>alive = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>history |= 0x800;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//EEPROMã®æ›¸ãè¾¼ã¿æ™‚é–“ã ã‘å¾…ã¤</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>Wait( 10000 );</span>
<span>//10ms</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//è­˜åˆ¥ã‚³ãƒ¼ãƒ‰ã‚’è¨ˆç®—ã—ã¦æ›¸ãè¾¼ã‚€</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; modify &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( CalcEEPROM() == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>alive = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>history |= 0x1000;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetEepResult( int val[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt; 4 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>val[n] = outcome[n];</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>val[4] = history ;</span>
 &nbsp;</p>
<p>&nbsp;<span>val[5] = romver ;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>val[6] = alive ;</span>
 &nbsp;</p>
<p>&nbsp;<span>return 7 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;</p>
<div></div>
<br />
&nbsp;<h1><a id="calibre_link-40"></a>
<a id="calibre_link-11">
<span>[3]&nbsp;ã‚¹ãƒ­ãƒƒãƒˆãƒ«åˆ¶å¾¡</span>
</a>
</h1>
<p>&nbsp;<span>å®Ÿæ©Ÿã§ã¯ã‚¨ãƒ³ã‚¸ãƒ³ã®å›è»¢æ•°ã¯ã€ã‚¹ãƒ­ãƒƒãƒˆãƒ«å¼ã§èª¿æ•´ã—ã¾ã™ã€‚ã‚¢ã‚¯ã‚»ãƒ«ãƒšãƒ€ãƒ«ã‚’è¸ã‚€ä»£ã‚ã‚Šã«ã€ã‚¹ãƒ­ãƒƒãƒˆãƒ«å¼ã«ç›´çµã—ãŸã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼ã‚’åˆ¶å¾¡ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼ãƒ‰ãƒ©ã‚¤ãƒãƒ¼åŸºæ¿ã«ã¯ã€å›è»¢æŒ‡ç¤ºã®ãƒ‘ãƒ«ã‚¹ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚é€Ÿåº¦ã¯200PPSã«ã—ã¦ã„ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000006.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000010.gif" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>æ‰€å®šã®ãƒ‘ãƒ«ã‚¹ä¿¡å·ã‚’å®šå‘¨æœŸã§å‡ºåŠ›ã™ã‚‹ãŸã‚ã«ã€ãƒãƒ«ãƒãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼MTU2ã®ãƒãƒ£ãƒãƒ«ï¼“ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>å…ˆãšã€hwsetupã§è¨­å®šã‚’ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;hwsetup.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//Interrupt priority</span>
 &nbsp;</p>
<p>&nbsp;<span>INTC.IPR10.BIT._MTU23G = 12&nbsp;;</span>
<span>//MTU23.TIER.BIT.TGIEA ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//ãƒãƒ«ãƒãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼</span>
 &nbsp;</p>
<p>&nbsp;<span>//-----------------------------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>//MTU2 ãƒãƒ£ãƒãƒ«3ã‚’ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼ãƒ‘ãƒ«ã‚¹å‡ºåŠ›ã«ä½¿ç”¨</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU23.TCR.BIT.CCLR = 1 ;</span>
<span>//TGRA ã®ã‚³ãƒ³ãƒšã‚¢ãƒãƒƒãƒï¼ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã‚­ãƒ£ãƒ—ãƒãƒ£ã§ TCNT ã‚¯ãƒªã‚¢&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU23.TCR.BIT.CKEG = 1 ;</span>
<span>//01ï¼šç«‹ã¡ä¸‹ãŒã‚Šã‚¨ãƒƒã‚¸ã§ã‚«ã‚¦ãƒ³ãƒˆ</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU23.TCR.BIT.TPSC = 3 ;</span>
<span>//å†…éƒ¨ã‚¯ãƒ­ãƒƒã‚¯ï¼šPÏ†ï¼64 ã§ã‚«ã‚¦ãƒ³ãƒˆ 64/50MHz = 1.28us</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU23.TMDR.BYTE = 0 ;</span>
<span>//é€šå¸¸å‹•ä½œ</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU23.TIOR.WORD = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU23.TGRA = 1953 ;</span>
<span>// 1.28us * 1953 = 2.5ms&nbsp; 200pps</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU23.TIER.BIT.TGIEA = 1 ;</span>
<span>//1ï¼šTGFA ãƒ“ãƒƒãƒˆã«ã‚ˆã‚‹å‰²ã‚Šè¾¼ã¿è¦æ±‚ã‚’è¨±å¯</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//ãƒãƒ¼ãƒˆæ©Ÿèƒ½è¨­å®š</span>
 &nbsp;</p>
<p>&nbsp;<span>//C port --------------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>//Stepping Motor</span>
 &nbsp;</p>
<p>&nbsp;<span>PC.DR.BIT.B11 = 0;</span>
<span>//PC11 ã‚¹ãƒ­ãƒƒãƒˆãƒ« CCW</span>
 &nbsp;</p>
<p>&nbsp;<span>PC.DR.BIT.B12 = 0;</span>
<span>//PC12 ã‚¹ãƒ­ãƒƒãƒˆãƒ« CW</span>
 &nbsp;</p>
<p>&nbsp;<span>PFC.PCCRL3.BIT.PC11MD = 0;</span>
<span>//å…¥å‡ºåŠ›ï¼ˆãƒãƒ¼ãƒˆï¼‰</span>
 &nbsp;</p>
<p>&nbsp;<span>PFC.PCCRL4.BIT.PC12MD = 0;</span>
<span>//å…¥å‡ºåŠ›ï¼ˆãƒãƒ¼ãƒˆï¼‰</span>
 &nbsp;</p>
<p>&nbsp;<span>PFC.PCIORL.BIT.B11 = 1;</span>
<span>//PC11ã€€å‡ºåŠ›</span>
 &nbsp;</p>
<p>&nbsp;<span>PFC.PCIORL.BIT.B12 = 1;</span>
<span>//PC12ã€€å‡ºåŠ›</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2><a id="calibre_link-41"></a>
<a id="calibre_link-12">
<span>(1) ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼</span>
</a>
</h2>
<p>&nbsp;<span>æ–°è¦ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ« Stepping.cpp ã‚’ä½œæˆã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Stepping.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; FILE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : Stepping.cpp</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; DESCRIPTION : Stepping Motor Control</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; CPU TYPE&nbsp;&nbsp;&nbsp; : SH7286</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; DATE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : Nov 01, 2016</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; VERSION ï¼š1.0&nbsp;&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•</span>
 &nbsp;</p>
<p>&nbsp;<span>#include &lt;string.h&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>#include &lt;machine.h&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "iodefine.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>extern "C" {</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "vect.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "common.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "proto.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>#define TEST</span>
<span>1</span>
 &nbsp;</p>
<p>&nbsp;<span>// ------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>// ------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>//ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼</span>
 &nbsp;</p>
<p>&nbsp;<span>//ãƒ‘ãƒ«ã‚¹å‡ºåŠ›éƒ¨åˆ†</span>
 &nbsp;</p>
<p>&nbsp;<span>enum { CW, CCW };</span>
<span>//å›è»¢æ–¹å‘</span>
 &nbsp;</p>
<p>&nbsp;<span>enum { S_LOW, S_HIGH };</span>
<span>//ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼è«–ç†</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>#define</span>
<span>P_SMCCW</span>
<span>PC.DR.BIT.B11</span>
<span>//ã‚¹ãƒ­ãƒƒãƒˆãƒ« CCW</span>
 &nbsp;</p>
<p>&nbsp;<span>#define</span>
<span>P_SMCW</span>
<span>PC.DR.BIT.B12</span>
<span>//ã‚¹ãƒ­ãƒƒãƒˆãƒ« CW</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>typedef struct {</span>
 &nbsp;</p>
<p>&nbsp;<span>short pulse ;</span>
<span>// å›è»¢æŒ‡ç¤ºãƒ‘ãƒ«ã‚¹æ•°ï¼ˆå›è»¢æ–¹å‘ã‚’å«ã‚€ï¼‰</span>
 &nbsp;</p>
<p>&nbsp;<span>short pos ;</span>
<span>// ç¾åœ¨ä½ç½®</span>
 &nbsp;</p>
<p>&nbsp;<span>bool onoff ;// true=åŠ±ç£ONä¸­,false=åŠ±ç£OFFä¸­</span>
 &nbsp;</p>
<p>&nbsp;<span>} STEPPING ;</span>
 &nbsp;</p>
<p>&nbsp;<span>static STEPPING stepValve ;</span>
 &nbsp;</p>
<p>&nbsp;<span>static short sequence ;</span>
<span>//åˆ¶å¾¡ã‚·ãƒ¼ã‚±ãƒ³ã‚¹</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//-------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private function</span>
 &nbsp;</p>
<p>&nbsp;<span>//-------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>static void MoveValve( int pulse );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//--------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>// Functions</span>
 &nbsp;</p>
<p>&nbsp;<span>//--------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>//åˆæœŸåŒ–</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitStepping()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>//ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼</span>
 &nbsp;</p>
<p>&nbsp;<span>//ãƒ‘ãƒ«ã‚¹å‡ºåŠ›éƒ¨åˆ†</span>
 &nbsp;</p>
<p>&nbsp;<span>STEPPING *sq = &amp;stepValve ;</span>
 &nbsp;</p>
<p>&nbsp;<span>sq-&gt;pulse = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>sq-&gt;pos = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>sq-&gt;onoff = false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>sequence =&nbsp;0&nbsp;;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2.TSTR.BIT.CST3 = 1 ;</span>
<span>//ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼ãƒ‘ãƒ«ã‚¹å‡ºåŠ›ã‚¿ã‚¤ãƒãƒ¼ã‚¹ã‚¿ãƒ¼ãƒˆ</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//å›è»¢æŒ‡ç¤ºï¼ˆå˜ã«ãƒ‘ãƒ«ã‚¹æ•°ã§ï¼‰</span>
 &nbsp;</p>
<p>&nbsp;<span>static void MoveValve( int pulse )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2.TSTR.BIT.CST3 = 0 ;</span>
<span>//ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼ãƒ‘ãƒ«ã‚¹å‡ºåŠ›ã‚¿ã‚¤ãƒãƒ¼ã‚¹ãƒˆãƒƒãƒ—</span>
 &nbsp;</p>
<p>&nbsp;<span>stepValve.pulse = pulse ;</span>
<span>// å›è»¢ãƒ‘ãƒ«ã‚¹æ•°ï¼ˆå›è»¢æ–¹å‘ã‚’å«ã‚€ï¼‰</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2.TSTR.BIT.CST3 = 1 ;</span>
<span>//ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼ãƒ‘ãƒ«ã‚¹å‡ºåŠ›ã‚¿ã‚¤ãƒãƒ¼ã‚¹ã‚¿ãƒ¼ãƒˆ</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//ãƒ‘ãƒ«ã‚¹å‡ºåŠ›çµ‚äº†ã‹ã‚’è¿”ã™</span>
 &nbsp;</p>
<p>&nbsp;<span>bool IsGiveOff()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( stepValve.pulse == 0 &amp;&amp; stepValve.onoff == false )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return true ;</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼ãƒ‘ãƒ«ã‚¹å‡ºåŠ›&nbsp;2.5ms(200pps)</span>
 &nbsp;</p>
<p>&nbsp;<span>// 180 MTU2 MTU3 TGIA3</span>
 &nbsp;</p>
<p>&nbsp;<span>void INT_MTU2_MTU3_TGIA3(void)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( MTU23.TSR.BIT.TGFA == 1 )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU23.TSR.BIT.TGFA = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>STEPPING *sp = &amp;stepValve ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//ã‚¹ãƒ­ãƒƒãƒˆãƒ«ã¯ï¼¯ï¼®ä¸­ã‹ï¼Ÿ</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( sp-&gt;onoff == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;onoff = false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>P_SMCW = S_LOW ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>P_SMCCW = S_LOW ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//ã‚¹ãƒ­ãƒƒãƒˆãƒ«ã«å‹•ä½œæŒ‡ç¤ºãƒ‘ãƒ«ã‚¹ãŒã‚ã‚‹ã‹ï¼Ÿ</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( sp-&gt;pulse &gt; 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>P_SMCW = S_HIGH ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;pulse-- ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;pos++ ;&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;onoff = true ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( sp-&gt;pulse &lt; 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>P_SMCCW = S_HIGH ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;pulse++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;pos-- ;&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp-&gt;onoff = true ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Main.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>void main(void)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>InitRTC();</span>
 &nbsp;</p>
<p>&nbsp;<span>InitStepping();</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>while ( 1 )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ä¸‹å›³ã®ã‚ˆã†ã«5msæ¯ã®å‰²ã‚Šè¾¼ã¿ã§ã€ãƒ‘ãƒ«ã‚¹ã‚’å‡ºåŠ›ã—ã¦ã„ã¾ã™ã€‚(100ppsã®å ´åˆ)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000007.gif" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2><a id="calibre_link-42"></a>
<a id="calibre_link-13">
<span>(2) ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ </span>
</a>
</h2>
<p>&nbsp;<span>ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼ã®å‹•ä½œã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ã€ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ç”¨æ„ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ãƒ‘ãƒãƒ«ã®èµ·å‹•ï¼åœæ­¢ãƒœã‚¿ãƒ³ã§å¾€å¾©å‹•ä½œã‚’ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Stepping.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼ãƒ†ã‚¹ãƒˆ</span>
 &nbsp;</p>
<p>&nbsp;<span>void TestStepping()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>switch ( sequence )</span>
<span>//åˆ¶å¾¡ã‚·ãƒ¼ã‚±ãƒ³ã‚¹</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>case 0 :</span>
<span>//</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkInp(P_Di00) == ON )</span>
<span>//èµ·å‹•ãƒœã‚¿ãƒ³</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>case&nbsp;1&nbsp;:</span>
<span>//</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MoveValve( 500 );</span>
<span>// CWæ–¹å‘ã«ç§»å‹•</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case&nbsp;2&nbsp;:</span>
<span>//ãƒ‘ãƒ«ã‚¹å‡ºåŠ›çµ‚äº†å¾…ã¡</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsGiveOff() == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnTimer( TM09 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case&nbsp;3&nbsp;:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkTimer( TM09 ) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MoveValve( -500 );</span>
<span>// CCWæ–¹å‘ã«ç§»å‹•</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case&nbsp;4&nbsp;:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsGiveOff() == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnTimer( TM09 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case&nbsp;5&nbsp;:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkTimer( TM09 ) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence =&nbsp;1&nbsp;;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>default :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ChkInp( P_Di01 ) == ON )</span>
<span>//åœæ­¢ãƒœã‚¿ãƒ³</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MoveValve( 0 );</span>
<span>//åœæ­¢</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffTimer( TM09 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ã“ã®ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ãƒ¡ã‚¤ãƒ³é–¢æ•°ã‹ã‚‰å‘¼ã³å‡ºã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Main.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>void main(void)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>InitStepping();</span>
 &nbsp;</p>
<p>&nbsp;<span>set_imask(0);</span>
 &nbsp;</p>
<p>&nbsp;<span>while ( 1 )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>TestStepping();</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ã§ã¯ã€å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼</span>
 &nbsp;</p>
<p>&nbsp;<span>æœŸå¾…ã—ãŸé€šã‚Šã«å‹•ä½œã—ã¾ã—ãŸã‹ï¼Ÿ</span>
 &nbsp;</p>
<p>&nbsp;<span>ä¸‹å›³ã¯ãƒ‘ãƒ«ã‚¹æ•°ã‚’ï¼•ã«ã—ã¦ã€æ™‚é–“ã‚’çŸ­ç¸®ã—ãŸã‚‚ã®ã§ã™ã€‚CWã¨CCWã‚’äº¤äº’ã«å‡ºåŠ›ã—ã¦ã„ã¾ã™ã€‚(100ppsã®å ´åˆ)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000012.gif" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2><a id="calibre_link-43"></a>
<a id="calibre_link-14">
<span>(3)&nbsp;LCDè¡¨ç¤º</span>
</a>
</h2>
<p>&nbsp;<span>ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼ã®ä½ç½®ã‚’LCDã«è¡¨ç¤ºã—ã¾ã—ã‚‡ã†ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ã¾ãŸã€å‹•ä½œã‚’ç¢ºèªã™ã‚‹ã®ã«ã€LEDã‚‚ä½¿ã„ã¾ã—ã‚‡ã†ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Display.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//ï¼¬ï¼£ï¼¤è¡¨ç¤º</span>
 &nbsp;</p>
<p>&nbsp;<span>void DispLCD()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>case D_Throttle :</span>
<span>//Throttle pulse</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>DispFunc( GetThrottle,&nbsp; GetThrotMsg );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>selectLED = L_STEP ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( oldSelect != selectLED )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>oldSelect = selectLED ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>ChangeSelectLED(selectLED);</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹ç”»é¢ã§ã¯ã€SW3ã®ä»£ã‚ã‚Šã«ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’ä½¿ã†ã‚ˆã†ã«ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>bool IsMsgDisp()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>bool flag = false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>switch ( nowPage )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>case D_ErrorMsg :</span>
<span>//Error contents</span>
 &nbsp;</p>
<p>&nbsp;<span>case D_EngineMsg :</span>
<span>//Engine Steps</span>
 &nbsp;</p>
<p>&nbsp;<span>case D_StartMsg :</span>
<span>//OPeration Start up</span>
 &nbsp;</p>
<p>&nbsp;<span>case D_MotorMsg :</span>
<span>//Stepping Motor</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>flag = true ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>return flag ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>LCDç”»é¢ã«è¡¨ç¤ºã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’Stepping.cppã§æº–å‚™ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Stepping.cpp&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>static short throttle ;</span>
<span>//throttle position (AD value)</span>
 &nbsp;</p>
<p>&nbsp;<span>static short oldThrot ;</span>
<span>//For returning the origin point</span>
 &nbsp;</p>
<p>&nbsp;<span>static short fuzValue ;</span>
<span>//Result value of Fuzzy calculation</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>static const char scThrottle[][21] = {</span>
<span>//Stepping Motor</span>
 &nbsp;</p>
<p>&nbsp;<span>{"seq&nbsp; 00&nbsp;&nbsp; rpm 0000&nbsp; "},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"pul&nbsp; 0000&nbsp; pos&nbsp; 0000"},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"throttle&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"fuzzy&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "}};</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitStepping()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>throttle = oldThrot = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>fuzValue = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetThrottle( int ctr[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>ctr[0] = sequence;</span>
 &nbsp;</p>
<p>&nbsp;<span>ctr[1] = GetRpm();</span>
 &nbsp;</p>
<p>&nbsp;<span>ctr[2] = stepValve.pulse;</span>
 &nbsp;</p>
<p>&nbsp;<span>ctr[3] = stepValve.pos;</span>
 &nbsp;</p>
<p>&nbsp;<span>ctr[4] = throttle;</span>
 &nbsp;</p>
<p>&nbsp;<span>ctr[5] = fuzValue;</span>
 &nbsp;</p>
<p>&nbsp;<span>return 6 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//LCD</span>
 &nbsp;</p>
<p>&nbsp;<span>void GetThrotMsg( int val[], char buff[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>char line[22], temp[8] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[0] = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>//1st line</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( line, scThrottle[0], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[0], temp );</span>
<span>//sequence</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 2, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[5], temp, 2 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[1], temp );</span>
<span>//nowRpm</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 4, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[14], temp, 4 );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>//2nd line</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( line, scThrottle[1], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[2], temp );</span>
<span>//stepValve.pulse</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 4, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[5], temp, 4 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[3], temp );</span>
<span>//stepValve.pos</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 4, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[16], temp, 4 );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>//3rd line</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( line, scThrottle[2], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[4], temp );</span>
<span>//throttle</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 4, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[10], temp, 4 );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>//4th line</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( line, scThrottle[3], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[5], temp );</span>
<span>//fuzzy</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 4, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[10], temp, 4 );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetRpm()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>return 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2><a id="calibre_link-44"></a>
<a id="calibre_link-15">
<span>(4)&nbsp;åˆ¶å¾¡ã‚·ãƒ¼ã‚±ãƒ³ã‚¹</span>
</a>
</h2>
<p>&nbsp;<span>é›»æºæŠ•å…¥æ™‚ã¯ã€ã‚¹ãƒ­ãƒƒãƒˆãƒ«ã®ä½ç½®ãŒä¸æ˜ç¢ºãªã®ã§ã€ä¸€èˆ¬çš„ã«ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼ã®åŸç‚¹å¾©å¸°ã‚’è¡Œã„ã€åŸç‚¹ä½ç½®ã‚’ç¢ºå®šã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ãã®å¾Œã€å„ç¨®ã®å‘½ä»¤ã‚’å—ã‘ä»˜ã‘ã‚‹çŠ¶æ…‹ã«ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ã‚¹ãƒ­ãƒƒãƒˆãƒ«ã®å€¤ï¼ãŒåŸç‚¹ä½ç½®ã¨ã¯é™ã‚‰ãªã„ã®ã§ã€å®Ÿæ©Ÿã§æ¸¬å®šã—ãŸã‚¹ãƒ­ãƒƒãƒˆãƒ«ã®å¯å‹•ç¯„å›²ã‚’åˆ¶å¾¡å®šæ•°ã§æŒ‡å®šã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>åˆ¶å¾¡ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã¨ã—ã¦ã¯</span>
 &nbsp;</p>
<p>&nbsp;<span>ï¼‘ï¼‰åŸç‚¹ä½ç½®ã®ç¢ºå®š</span>
 &nbsp;</p>
<p>&nbsp;<span>ï¼’ï¼‰å‘½ä»¤å¾…æ©Ÿ</span>
 &nbsp;</p>
<p>&nbsp;<span>ã€€ï¼ˆï¼‘ï¼‰æŒ‡å®šä½ç½®ç§»å‹•å‹•ä½œ</span>
 &nbsp;</p>
<p>&nbsp;<span>ã€€ï¼ˆï¼’ï¼‰è‡ªå‹•åˆ¶å¾¡å‹•ä½œ</span>
 &nbsp;</p>
<p>&nbsp;<span>ã€€ï¼ˆï¼“ï¼‰åŸç‚¹å¾©å¸°å‹•ä½œ</span>
 &nbsp;</p>
<p>&nbsp;<span>ã¨ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ã¾ãšã€ã“ã®åˆ¶å¾¡ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã§ã¯ã€ä¸‹å›³ã®ã‚ˆã†ãªæµã‚Œã«ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000003.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>æ‰‹é †ã¨ã—ã¦ã€ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼ãƒ†ã‚¹ãƒˆã‚’æ‹¡å¼µã—ã¦ã€åŸç‚¹å¾©å¸°ã®å‹•ä½œã‚’ç¢ºç«‹ã—ã¾ã—ã‚‡ã†ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>åˆ¶å¾¡å®šæ•°ã«ã‚¹ãƒ­ãƒƒãƒˆãƒ«ãƒã‚¸ã‚·ãƒ§ãƒ³ã®æœ€å°å€¤ã‚’ä»®ã«ã‚»ãƒƒãƒˆã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;common.h&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//ã‚¿ã‚¤ãƒãƒ¼</span>
 &nbsp;</p>
<p>&nbsp;<span>enum {</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>TM09,</span>
<span>//ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼ç§»å‹•ç›£è¦–</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>};</span>
 &nbsp;</p>
<p>&nbsp;<span>//åˆ¶å¾¡å®šæ•°</span>
 &nbsp;</p>
<p>&nbsp;<span>enum {</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>C02,</span>
<span>//ã‚¹ãƒ­ãƒƒãƒˆãƒ«ãƒã‚¸ã‚·ãƒ§ãƒ³æœ€å°å€¤ï¼ˆADå€¤ï¼‰</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>};</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;timer.h&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>const unsigned short timeBase[TMRNUM] = {</span>
<span>/* 100ms */</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>20,</span>
<span>//TM09</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>};</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;ctrl.h&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>const short ctrlBase[CTRLNUM] = {</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>100,</span>
<span>//C02&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>};</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>ä¸‹è¨˜ã®ã‚ˆã†ã«ã€TestStepping()ã‚’å¤‰æ›´ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼ã®ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚‚å¤‰ãˆã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ä½é€Ÿã§åŸç‚¹ä½ç½®ã‚’è¦‹ã¤ã‘ãŸå¾Œã¯é«˜é€Ÿã§ç§»å‹•ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Stepping.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>#define FLUCTUATION</span>
<span>&nbsp;20</span>
<span>//å€¤ã®ãƒãƒ©ãƒ„ã‚­</span>
 &nbsp;</p>
<p>&nbsp;<span>static bool first ;</span>
 &nbsp;</p>
<p>&nbsp;<span>static short point ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitStepping()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>first = true ;</span>
 &nbsp;</p>
<p>&nbsp;<span>point = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼ã®ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’å¤‰ãˆã‚‹</span>
 &nbsp;</p>
<p>&nbsp;<span>static void MotorSpeed( int speed )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2.TSTR.BIT.CST3 = 0 ;</span>
<span>//ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼ãƒ‘ãƒ«ã‚¹å‡ºåŠ›ã‚¿ã‚¤ãƒãƒ¼ã‚¹ãƒˆãƒƒãƒ—</span>
 &nbsp;</p>
<p>&nbsp;<span>switch ( speed )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 0 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU23.TGRA = 7813 ;</span>
<span>// 1.28us * 7813 = 10ms&nbsp; 50pps</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 1 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU23.TGRA = 3906 ;</span>
<span>// 1.28us * 3906 = 5ms&nbsp; 100pps</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>case 2 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU23.TGRA = 1953 ;</span>
<span>// 1.28us * 1953 = 2.5ms&nbsp; 200pps</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>default :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU23.TGRA = 7813 ;</span>
<span>// 1.28us * 7813 = 10ms&nbsp; 50pps</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2.TSTR.BIT.CST3 = 1 ;</span>
<span>//ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼ãƒ‘ãƒ«ã‚¹å‡ºåŠ›ã‚¿ã‚¤ãƒãƒ¼ã‚¹ã‚¿ãƒ¼ãƒˆ</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>void TestStepping()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; modify &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>throttle = GetAdcVal( P_Ai02 );</span>
 &nbsp;</p>
<p>&nbsp;<span>int min = GetCtrl(C02);</span>
<span>//ã‚¹ãƒ­ãƒƒãƒˆãƒ«ãƒã‚¸ã‚·ãƒ§ãƒ³æœ€å°å€¤ï¼ˆADå€¤ï¼‰</span>
 &nbsp;</p>
<p>&nbsp;<span>int max = GetCtrl( C11 );</span>
<span>//å¯å‹•ç¯„å›²ã®æœ€å¤§ãƒ‘ãƒ«ã‚¹æ•°</span>
 &nbsp;</p>
<p>&nbsp;<span>switch ( sequence )</span>
<span>//åˆ¶å¾¡ã‚·ãƒ¼ã‚±ãƒ³ã‚¹</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>case 0 :</span>
<span>//é–‹å§‹</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkInp(P_Di00) == ON )</span>
<span>//èµ·å‹•ãƒœã‚¿ãƒ³</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnOut( P_Do10 );</span>
<span>//é‹è»¢ä¸­è¡¨ç¤º</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>first = true ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>point = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MotorSpeed( 0 );</span>
<span>//50pps</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>case 1 :</span>
<span>//æ–¹å‘åˆ¤åˆ¥</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( first == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( throttle &lt;= min || ChkInp(P_Di06) == ON )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>MoveValve( max );</span>
<span>// CWæ–¹å‘</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do24);</span>
<span>//LED1</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sequence = 2 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>MoveValve( -max );</span>
<span>// CCWæ–¹å‘</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do25);</span>
<span>//LED2</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sequence = 6 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( throttle &lt;= min || ChkInp(P_Di06) == ON )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>MoveValve( point - stepValve.pos );</span>
<span>// CWæ–¹å‘</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do24);</span>
<span>//LED1</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sequence = 2 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>MoveValve( -stepValve.pos );</span>
<span>// CCWæ–¹å‘</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do25);</span>
<span>//LED2</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sequence = 6 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case 2 :</span>
<span>// CWæ–¹å‘</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( first == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( throttle &gt; ( min + FLUCTUATION ))</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do25);</span>
<span>//LED2</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>MoveValve( 0 );</span>
<span>//ä¸€æ—¦åœæ­¢</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnTimer( TM09 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>point = stepValve.pos ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsGiveOff() == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do25);</span>
<span>//LED2</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnTimer( TM09 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case 3 :</span>
<span>// CWæ–¹å‘</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkTimer( TM09 ) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do26);</span>
<span>//LED3</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MoveValve( 500 );</span>
<span>// ã•ã‚‰ã«CWæ–¹å‘ã«ç§»å‹•</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case 4 :</span>
<span>//ãƒ‘ãƒ«ã‚¹å‡ºåŠ›çµ‚äº†å¾…ã¡</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsGiveOff() == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do27);</span>
<span>//LED4</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnTimer( TM09 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case 5 :</span>
<span>// æˆ»ã‚‹</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkTimer( TM09 ) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do24);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do25);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do26);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do27);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence = 1 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case 6 :</span>
<span>// CCWæ–¹å‘ã€åŸç‚¹ã¸&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( first == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( throttle &lt;= min ||&nbsp; ChkInp(P_Di06) == ON )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>MoveValve( 0 );</span>
<span>//ãƒ‘ãƒ«ã‚¹å‡ºåŠ›åœæ­¢</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>stepValve.pos = 0;</span>
<span>// åŸç‚¹ä½ç½®ã‚’è¨˜æ†¶</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>first = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>MotorSpeed( 2 );</span>
<span>//200pps</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do26);</span>
<span>//LED3</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnTimer( TM09 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sequence = 5 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsGiveOff() == true&nbsp; ||&nbsp; ChkInp(P_Di06) == ON )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>MoveValve( 0 );</span>
<span>//ãƒ‘ãƒ«ã‚¹å‡ºåŠ›åœæ­¢</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>stepValve.pos = 0;</span>
<span>// åŸç‚¹ä½ç½®ã‚’è¨˜æ†¶</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do26);</span>
<span>//LED3</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnTimer( TM09 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sequence = 5 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>default :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ChkInp( P_Di01 ) == ON )</span>
<span>//åœæ­¢ãƒœã‚¿ãƒ³</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MoveValve( 0 );</span>
<span>//åœæ­¢</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffTimer( TM09 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffOut( P_Do10 );</span>
<span>//é‹è»¢ä¸­è¡¨ç¤º</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do24);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do25);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do26);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do27);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ã“ã‚Œã§å‹•ä½œã•ã›ã‚‹ã¨ã€</span>
 &nbsp;</p>
<p>&nbsp;<span>ï¼ˆï¼‘ï¼‰ã‚¹ãƒ­ãƒƒãƒˆãƒ«ãƒã‚¸ã‚·ãƒ§ãƒ³ãŒæœ€å°å€¤ã‚ˆã‚Šå°ã•ã„æ™‚ã¯ã€ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ãŒ1-&gt;2-&gt;3-&gt;4-&gt;5-&gt;1ã¨é€²ã¿ã€</span>
 &nbsp;</p>
<p>&nbsp;<span>(2)æœ€å°å€¤ã‚ˆã‚Šå¤§ãã„æ™‚ã¯ã€1-&gt;6-&gt;5-&gt;1</span>
 &nbsp;</p>
<p>&nbsp;<span>ã®ã‚ˆã†ã«ãªã‚‹ã®ãŒã€LCDè¡¨ç¤ºã§ç¢ºèªå‡ºæ¥ã‚‹ã¨æ€ã„ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ã§ã¯ã€åŸç‚¹å¾©å¸°ã‚’å«ã‚ãŸã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¿°ã—ã¾ã—ã‚‡ã†ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>è‡ªå‹•åˆ¶å¾¡ã¯ã€ç¾æ®µéšã§ã¯ä¸­èº«ã®ãªã„é–¢æ•°ã¨ã—ã¦ã€åŸç‚¹å¾©å¸°ã€æŒ‡å®šä½ç½®ç§»å‹•ã®å‹•ä½œã‚’å…ˆã«ç¢ºèªã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;common.h&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//å¤–éƒ¨ã‹ã‚‰ã®ã‚¹ãƒ­ãƒƒãƒˆãƒ«å‘½ä»¤ç¨®é¡</span>
 &nbsp;</p>
<p>&nbsp;<span>enum {&nbsp;V_NONE,V_HOME,V_FIX,V_AUTO&nbsp;};</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ç¹°ã‚Šè¿”ã—ã¦åŸç‚¹å¾©å¸°ãŒãƒã‚§ãƒƒã‚¯å‡ºæ¥ã‚‹ã‚ˆã†ã«ã€ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’æŒ¿å…¥ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Stepping.cpp&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>#include &lt;stdlib.h&gt;</span>
<span>//abs</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>typedef struct {</span>
 &nbsp;</p>
<p>&nbsp;<span>short kind;</span>
<span>//å‘½ä»¤ç¨®é¡</span>
 &nbsp;</p>
<p>&nbsp;<span>short value ;&nbsp; // æŒ‡ç¤ºå€¤ï¼ˆã‚¹ãƒ­ãƒƒãƒˆãƒ«ä½ç½®ï¼‰</span>
 &nbsp;</p>
<p>&nbsp;<span>bool flag ;&nbsp; // true=æŒ‡ç¤ºã‚ã‚Š,false=æŒ‡ç¤ºãªã—</span>
 &nbsp;</p>
<p>&nbsp;<span>} COMMAND ;</span>
 &nbsp;</p>
<p>&nbsp;<span>static COMMAND stepCommand ;</span>
 &nbsp;</p>
<p>&nbsp;<span>#define FLUCTUATION2</span>
<span>5</span>
 &nbsp;</p>
<p>&nbsp;<span>enum { S_BEGIN, S_STABLE, S_AWAY, S_HOME, S_REACH, S_COMMAND, S_FIX, S_AUTO, S_ERROR, S_ERROR2, S_TEST, S_TEST2&nbsp;};</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private function</span>
 &nbsp;</p>
<p>&nbsp;<span>static void AutoControl( bool flag );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitStepping()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>//å¤–éƒ¨ã‹ã‚‰ã®å‘½ä»¤</span>
 &nbsp;</p>
<p>&nbsp;<span>COMMAND *sp = &amp;stepCommand ;</span>
 &nbsp;</p>
<p>&nbsp;<span>sp-&gt;kind =&nbsp;V_NONE;</span>
 &nbsp;</p>
<p>&nbsp;<span>sp-&gt;value = 0;&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>sp-&gt;flag = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>throttle = oldThrot = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//æŒ‡å®šä½ç½®ç§»å‹•æŒ‡ç¤ºï¼ˆãƒ‘ãƒ«ã‚¹ä½ç½®ã§ï¼‰</span>
 &nbsp;</p>
<p>&nbsp;<span>void GoPosition( int position )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>int max = GetCtrl( C11 );</span>
<span>//å¯å‹•ç¯„å›²ã®æœ€å¤§ãƒ‘ãƒ«ã‚¹æ•°</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( position &lt; 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>position = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>else if ( position &gt; max )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>position = max ;</span>
 &nbsp;</p>
<p>&nbsp;<span>int pulse =&nbsp; position - stepValve.pos ;</span>
 &nbsp;</p>
<p>&nbsp;<span>MoveValve( pulse );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼åˆ¶å¾¡</span>
 &nbsp;</p>
<p>&nbsp;<span>void StepCtrl()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>COMMAND *sp ;</span>
 &nbsp;</p>
<p>&nbsp;<span>throttle = GetAdcVal( P_Ai02 );</span>
 &nbsp;</p>
<p>&nbsp;<span>int min = GetCtrl(C02);</span>
<span>//ã‚¹ãƒ­ãƒƒãƒˆãƒ«ãƒã‚¸ã‚·ãƒ§ãƒ³æœ€å°å€¤ï¼ˆADå€¤ï¼‰</span>
 &nbsp;</p>
<p>&nbsp;<span>int max = GetCtrl( C11 );</span>
<span>//å¯å‹•ç¯„å›²ã®æœ€å¤§ãƒ‘ãƒ«ã‚¹æ•°</span>
 &nbsp;</p>
<p>&nbsp;<span>switch ( sequence )&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_BEGIN :</span>
<span>//åŸç‚¹å¾©å¸°</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>PutTime( TM09, 10 );</span>
<span>//1sec</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnTimer( TM09 );</span>
<span>// ç§»å‹•ç›£è¦–ã‚¿ã‚¤ãƒãƒ¼</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>oldThrot = throttle ;</span>
<span>// ç¾åœ¨å€¤ã‚’è¨˜æ†¶</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MotorSpeed( 0 );</span>
<span>//50pps</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_STABLE :</span>
<span>//å€¤ã®å®‰å®šã‚’ç¢ºèªã™ã‚‹</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkTimer( TM09 ) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( abs( oldThrot - throttle ) &gt;= FLUCTUATION2 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>oldThrot = throttle ;&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnTimer( TM09 );&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>//å€¤ã®å®‰å®šã‚’ç¢ºèª</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>if ( throttle &lt;= min || ChkInp(P_Di06) == ON )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>MoveValve( max );</span>
<span>// åŸç‚¹ã‹ã‚‰é›¢ã‚Œã‚‹æ–¹å‘ã«ç§»å‹•</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>PutTime( TM09, 100 );</span>
<span>//10sec</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnTimer( TM09 );&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>MoveValve( -max );</span>
<span>// åŸç‚¹ã«å‘ã‹ã†æ–¹å‘ã«ç§»å‹•</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>PutTime( TM09, 200 );</span>
<span>//20sec</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnTimer( TM09 );&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sequence = S_REACH ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_AWAY :</span>
<span>//åŸç‚¹ã‹ã‚‰é›¢ã‚Œã‚‹æ–¹å‘ã«ç§»å‹•ã‚’ç¢ºèªã™ã‚‹</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( throttle &gt; ( min + FLUCTUATION ))</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//é›¢ã‚ŒãŸã®ã‚’ç¢ºèªã€å°‘ã—åœæ­¢</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MoveValve( 0 );</span>
<span>//ãƒ‘ãƒ«ã‚¹å‡ºåŠ›åœæ­¢</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>PutTime( TM09, 10 );</span>
<span>//1sec</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnTimer( TM09 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( ChkTimer( TM09 ) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//ç§»å‹•ã‚’ç¢ºèªå‡ºæ¥ãªã„ã€ä½•ã‹ã®ç•°å¸¸ã‚ã‚Šã€åœæ­¢ã™ã‚‹</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MoveValve( 0 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence = S_ERROR ;</span>
<span>//ç•°å¸¸åœæ­¢ã¸</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_HOME :</span>
<span>//åŸç‚¹ã«å‘ã‹ã†æ–¹å‘ã«å‹•ã‹ã™</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkTimer( TM09 ) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MoveValve( -max );</span>
<span>// åŸç‚¹ã«å‘ã‹ã†æ–¹å‘ã«ç§»å‹•</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>PutTime( TM09, 200 );</span>
<span>//20sec</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnTimer( TM09 );&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_REACH :</span>
<span>//ã‚¹ãƒ­ãƒƒãƒˆãƒ«ãƒã‚¸ã‚·ãƒ§ãƒ³æœ€å°å€¤ã‚’ç¢ºèªã™ã‚‹</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( throttle &lt;= min || ChkInp(P_Di06) == ON )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MoveValve( 0 );</span>
<span>//ãƒ‘ãƒ«ã‚¹å‡ºåŠ›åœæ­¢</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffTimer( TM09 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>stepValve.pos = 0;</span>
<span>// åŸç‚¹ä½ç½®ã‚’è¨˜æ†¶</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MotorSpeed( 2 );</span>
<span>//200pps</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do15);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( ChkTimer( TM09 ) == UP )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//ç§»å‹•ã‚’ç¢ºèªå‡ºæ¥ãªã„ã€ä½•ã‹ã®ç•°å¸¸ã‚ã‚Š</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MoveValve( 0 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence = S_ERROR ;&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_COMMAND:</span>
<span>//å‘½ä»¤å¾…æ©Ÿ</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp = &amp;stepCommand ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( sp-&gt;flag == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//åŸç‚¹å¾©å¸°æŒ‡ç¤ºãªã‚‰</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( sp-&gt;kind == V_HOME)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sp-&gt;flag = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do15);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do16);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sequence = S_BEGIN ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//æŒ‡å®šä½ç½®ç§»å‹•æŒ‡ç¤ºãªã‚‰</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if&nbsp; ( sp-&gt;kind == V_FIX )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sp-&gt;flag = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do15);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do17);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>GoPosition( sp-&gt;value );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sequence = S_FIX ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//è‡ªå‹•åˆ¶å¾¡æŒ‡ç¤ºãªã‚‰</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if&nbsp; ( sp-&gt;kind == V_AUTO )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sp-&gt;flag = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>AutoControl( true );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do15);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do18);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sequence = S_AUTO ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sp-&gt;flag = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_FIX :</span>
<span>//ãƒ‘ãƒ«ã‚¹å‡ºåŠ›çµ‚äº†å¾…ã¡</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsGiveOff() == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do17);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do15);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence&nbsp; = S_COMMAND ;&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_AUTO :</span>
<span>//è‡ªå‹•åˆ¶å¾¡</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sp = &amp;stepCommand ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//ä»–ã®å‘½ä»¤ãŒã‚ã‚Œã°</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( sp-&gt;flag == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//æŒ‡å®šä½ç½®ç§»å‹•æŒ‡ç¤ºãªã‚‰</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( sp-&gt;kind == V_FIX )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sp-&gt;flag = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>AutoControl( false );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do18);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do17);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>GoPosition( sp-&gt;value );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sequence = S_FIX ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>sp-&gt;flag = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_ERROR :</span>
<span>//ç•°å¸¸åœæ­¢</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffTimer( TM09 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do19);</span>
 &nbsp;</p>
<p>&nbsp;<span>//</span>
<span>&nbsp;</span>
<span>SetError(0x40);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break;</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_ERROR2 :</span>
<span>//ãƒªã‚»ãƒƒãƒˆå¾…ã¡</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsReset() == true&nbsp;&amp;&amp; IsMsgDisp() == false&nbsp;)</span>
<span>// Reset button</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do15);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do16);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do17);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do18);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do19);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>fuzValue = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence = S_BEGIN ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>#ifdef TEST</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_TEST :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ChkInp( P_Di00 ) == ON )</span>
<span>//Start button</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MotorSpeed( 2 );</span>
<span>//200pps</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MoveValve( max/4 );</span>
<span>//Move away from the origin</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do15);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do16);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OffLED(L_STEP,P_Do17);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence++;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_TEST2 :</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( IsGiveOff() == true &amp;&amp; ChkInp( P_Di00 ) == OFF)</span>
<span>//Start button</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do18);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do19);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence = S_ERROR ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>#endif</span>
 &nbsp;</p>
<p>&nbsp;<span>default:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence = S_BEGIN ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>#ifdef TEST</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ChkInp( P_Di01 ) == ON )</span>
<span>//Stop button</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MoveValve( 0 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do15);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do16);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>OnLED(L_STEP,P_Do17);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sequence = S_TEST ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>#endif</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼è‡ªå‹•åˆ¶å¾¡</span>
 &nbsp;</p>
<p>&nbsp;<span>static void AutoControl( bool flag )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ç¹°ã‚Šè¿”ã—ã®æ‰‹é †ã¯ã€</span>
 &nbsp;</p>
<p>&nbsp;<span>1)&nbsp;å‹•ä½œä¸­ã«åœæ­¢ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¾ã™ã€‚ãƒ¢ãƒ¼ã‚¿ãƒ¼ãŒåœæ­¢ã™ã‚‹ã¨LEDãŒç‚¹ç¯ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>2)&nbsp;ãã‚Œã‹ã‚‰é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€åŸç‚¹ã‹ã‚‰é›¢ã‚Œã‚‹æ–¹å‘ã«ç§»å‹•ã—ã¾ã™ã€‚ãƒ¢ãƒ¼ã‚¿ãƒ¼ãŒåœæ­¢ã™ã‚‹ã¨ã€ä»–ã®LEDãŒç‚¹ç¯ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>3)&nbsp;ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€åŸç‚¹å¾©å¸°ã‚’è¡Œã£ãŸå¾Œã«ã€ã‚³ãƒãƒ³ãƒ‰å¾…ã¡çŠ¶æ…‹ã«ãªã‚Šã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ãƒ¡ã‚¤ãƒ³é–¢æ•°ã‹ã‚‰ã€ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼ã®åˆ¶å¾¡ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Main.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>void main(void)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>while ( 1 )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>//</span>
<span>&nbsp;</span>
<span>TestStepping();</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>StepCtrl();</span>
<span>//ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼åˆ¶å¾¡éƒ¨</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’è¿”ã™é–¢æ•°ã‚’è¿½åŠ ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Input.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³</span>
 &nbsp;</p>
<p>&nbsp;<span>bool IsReset()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( ChkInp( P_Di02 ) == ON || ChkInp( P_Di14 ) == ON )</span>
<span>// 3 ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return true ;</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return false ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ã§ã¯ã€ã“ã®çŠ¶æ…‹ã§å‹•ä½œã•ã›ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼ãŒåŸç‚¹å¾©å¸°ã®å‹•ãã‚’ã—ã¾ã™ã‹ï¼Ÿ</span>
 &nbsp;</p>
<p>&nbsp;<span>ãƒ†ã‚¹ãƒˆãŒçµ‚ã‚ã£ãŸã‚‰ã€ä¸‹è¨˜ã®ã‚ˆã†ã«ã—ã¦é€šå¸¸ã«æˆ»ã—ã¦ãŠã„ã¦ä¸‹ã•ã„ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Stepping.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//#define TEST</span>
<span>1</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2><a id="calibre_link-45"></a>
<a id="calibre_link-16">
<span>(5) ã‚·ãƒªã‚¢ãƒ«é€šä¿¡</span>
</a>
</h2>
<p>&nbsp;<span>æ¬¡ã«ã€ã‚·ãƒªã‚¢ãƒ«é€šä¿¡ã§æŒ‡å®šã®ä½ç½®ã«ç§»å‹•ã•ã›ã¾ã—ã‚‡ã†ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>æ¬¡ã®ã‚ˆã†ãªã‚³ãƒãƒ³ãƒ‰ã‚’ç™ºè¡Œã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ä¾‹ï¼š</span>
 &nbsp;</p>
<p>&nbsp;<span>(1) @STM,FIX100*Â¥r&nbsp; (2) @STM,HOME*Â¥r&nbsp; (3) @STM,AUTO*Â¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>[ãƒ˜ãƒƒãƒ€]STM,[ç¨®é¡][ã‚¿ãƒ¼ãƒŸãƒã‚¿ãƒ¼][æ”¹è¡Œã‚³ãƒ¼ãƒ‰]</span>
 &nbsp;</p>
<p>&nbsp;<span>[ç¨®é¡]ã«ã¤ã„ã¦ã¯</span>
 &nbsp;</p>
<p>&nbsp;<span>ï¼ˆï¼‘ï¼‰æŒ‡å®šä½ç½®ç§»å‹•&nbsp;=&nbsp;FIX+position</span>
 &nbsp;</p>
<p>&nbsp;<span>ï¼ˆï¼’ï¼‰åŸç‚¹å¾©å¸°&nbsp;=&nbsp;HOME</span>
 &nbsp;</p>
<p>&nbsp;<span>ï¼ˆï¼“ï¼‰è‡ªå‹•åˆ¶å¾¡é–‹å§‹&nbsp;=&nbsp;AUTO</span>
 &nbsp;</p>
<p>&nbsp;<span>ã¨ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ã‚·ãƒªã‚¢ãƒ«é€šä¿¡éƒ¨ã«ã‚³ãƒãƒ³ãƒ‰å—ä¿¡ã®ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ã“ã‚Œã¯ã€è‡ªå‹•ï¼æ‰‹å‹•é¸æŠã‚¹ã‚¤ãƒƒãƒ(P_Di04)ãŒæ‰‹å‹•å´ã«ãªã£ã¦ã„ã‚‹æ™‚ã ã‘å‹•ä½œã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Sci_2.cpp&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private function</span>
 &nbsp;</p>
<p>&nbsp;<span>static void StepCommand( char *s );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>void CommPaso2()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>case S_WAIT :</span>
<span>//å‘½ä»¤å—ä¿¡å¾…ã¡</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( Receive() == R_OK ) //æ­£å¸¸ãƒ–ãƒ­ãƒƒã‚¯ã‚’å—ä¿¡ã—ãŸã‚‰</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( strncmp( s, "ERR", 3 ) == 0 )&nbsp;</span>
<span>// ç•°å¸¸è¨˜éŒ²èª­ã¿å‡ºã—å‘½ä»¤ãªã‚‰</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( strncmp( s, "STM", 3 ) == 0 )</span>
<span>// ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼æŒ‡ç¤ºå‘½ä»¤ãªã‚‰</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>if ( ChkInp( P_Di04 ) == ON )</span>
<span>//æ‰‹å‹•=ON</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>StepCommand( s ) ;</span>
<span>//STM,</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>cStep++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼æŒ‡ç¤ºå‘½ä»¤</span>
 &nbsp;</p>
<p>&nbsp;<span>//(STM,FIX100)(STM,HOME)(STM,AUTO)</span>
 &nbsp;</p>
<p>&nbsp;<span>static void StepCommand( char *s )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>char *tp = strtok( s, "," );</span>
<span>//STM</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( tp == NULL )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcpy( txBuf, "NO STM" );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>bool flag = false;</span>
 &nbsp;</p>
<p>&nbsp;<span>char buff[20];</span>
 &nbsp;</p>
<p>&nbsp;<span>tp = strtok( NULL, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( tp != NULL )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//åŸç‚¹å¾©å¸°æŒ‡ç¤ºãªã‚‰</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( strncmp( tp, "HOME", 4 ) == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( StepSetting(&nbsp;V_HOME, 0 ) == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>strcpy( buff, tp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>flag = true;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//æŒ‡å®šä½ç½®ç§»å‹•æŒ‡ç¤ºãªã‚‰</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( strncmp( tp, "FIX", 3 ) == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>int n = atoi( tp+3 ) ;</span>
<span>//position</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( StepSetting(&nbsp;V_FIX, n ) == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>strcpy( buff, tp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>flag = true;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//è‡ªå‹•åˆ¶å¾¡æŒ‡ç¤ºãªã‚‰</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( strncmp( tp, "AUTO", 4 ) == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( StepSetting(&nbsp;V_AUTO, 0 ) == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>strcpy( buff, tp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>flag = true;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( flag == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcpy( txBuf, buff );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, "=OK" );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcpy( txBuf, "StepSetting=ERROR " );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, s );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, " " );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( txBuf, tp );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼å´ã«ã€æŒ‡ç¤ºã®å—ã‘å–ã‚Šéƒ¨ã‚’è¿½åŠ ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Stepping.cpp&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//PCã‹ã‚‰ã®æŒ‡ç¤ºã‚’å—ã‘å–ã‚‹</span>
 &nbsp;</p>
<p>&nbsp;<span>bool StepSetting( int kind, int value )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>COMMAND *sq = &amp;stepCommand ;</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( sequence&nbsp; == S_COMMAND )</span>
<span>//å‘½ä»¤å¾…æ©Ÿ</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//åŸç‚¹å¾©å¸°æŒ‡ç¤ºãªã‚‰</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( kind ==&nbsp;V_HOME&nbsp;)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sq-&gt;kind =&nbsp;V_HOME&nbsp;;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sq-&gt;value = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sq-&gt;flag = true;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//æŒ‡å®šä½ç½®ç§»å‹•æŒ‡ç¤ºãªã‚‰</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( kind ==&nbsp;V_FIX&nbsp;)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sq-&gt;kind =&nbsp;V_FIX&nbsp;;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sq-&gt;value = value ;</span>
<span>//position</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sq-&gt;flag = true;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//è‡ªå‹•åˆ¶å¾¡æŒ‡ç¤ºãªã‚‰</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( kind ==&nbsp;V_AUTO&nbsp;)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sq-&gt;kind =&nbsp;V_AUTO&nbsp;;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sq-&gt;value = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sq-&gt;flag = true;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else if ( sequence == S_AUTO )</span>
<span>//è‡ªå‹•åˆ¶å¾¡</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//æŒ‡å®šä½ç½®ç§»å‹•æŒ‡ç¤ºãªã‚‰</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( kind ==&nbsp;V_FIX&nbsp;)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sq-&gt;kind =&nbsp;V_FIX&nbsp;;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sq-&gt;value = value ;</span>
<span>//position</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>sq-&gt;flag = true;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>return sq-&gt;flag ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ã§ã¯ã€å‹•ä½œã•ã›ã¦è¦‹ã¾ã—ã‚‡ã†ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>æŒ‡å®šä½ç½®ç§»å‹•ã‚³ãƒãƒ³ãƒ‰ã‚’é€ã£ã¦ä¸‹ã•ã„ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ä¾‹</span>
 &nbsp;</p>
<p>&nbsp;<span>ã€€@STM,FIX100*Â¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>ã€€@STM,FIX350*Â¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>åŸç‚¹å¾©å¸°ã‚³ãƒãƒ³ãƒ‰ã§ã¯ã€å¦‚ä½•ã§ã™ã‹ï¼Ÿ</span>
 &nbsp;</p>
<p>&nbsp;<span>ä¾‹ã€€@STM,HOME*Â¥r</span>
 &nbsp;</p>
<p>&nbsp;<span>æ€ã£ãŸã‚ˆã†ã«å‹•ãã¾ã—ãŸã‹ï¼Ÿ</span>
 &nbsp;</p>
<p>&nbsp;</p>
<div></div>
<br />
&nbsp;<h2><a id="calibre_link-46"></a>
<a id="calibre_link-17">
<span>(6)&nbsp;è‡ªå‹•åˆ¶å¾¡</span>
</a>
</h2>
<p>&nbsp;<span>å›è»¢æ•°ã‚’å¾—ã‚‹ã“ã¨ãŒå‡ºæ¥ã‚Œã°ã€è‡ªå‹•åˆ¶å¾¡ã®å‹•ä½œã‚’ç¢ºèªå‡ºæ¥ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>å®Ÿæ©Ÿã®ç™ºé›»æ©Ÿã¯ã€1500rpmã§50Helzã®äº¤æµã‚’å‡ºåŠ›ã—ã¾ã™ã‹ã‚‰ã€1500rpmãŒè‡ªå‹•åˆ¶å¾¡ã®ç›®æ¨™å›è»¢æ•°ã§ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>å›è»¢æ•°ã¯ã€å¾Œè¿°ã™ã‚‹ã‚¨ãƒ³ã‚¸ãƒ³ã®ã‚¯ãƒ©ãƒ³ã‚¯ãƒ‘ãƒ«ã‚¹ã‹ã‚‰å¾—ã¾ã™ãŒã€ã“ã“ã§ã¯ç–‘ä¼¼çš„ã«å¤–ä»˜ã‘ã®VRã‹ã‚‰å›è»¢æ•°ã‚’å…¥åŠ›ã—ã¾ã—ã‚‡ã†ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ã‚¢ãƒŠãƒ­ã‚°å…¥åŠ›ã®å›è»¢æ•°å¤‰æ›´VR&nbsp;(P_Ai11ï¼‰ã‚’ä½¿ã„ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>å›è»¢æ•°å¤‰æ›´VRã¯3.3Vã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã§ã€ã‚¢ãƒŠãƒ­ã‚°å…¥åŠ›å€¤ã¯0ã‹ã‚‰ç´„2700ã§ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ã“ã®å€¤ã‚’50rpmã‹ã‚‰2750rpmã«å¯¾å¿œã•ã›ã¾ã—ã‚‡ã†ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ã¾ãŸã€è‡ªå‹•åˆ¶å¾¡ã«ã¯ã€ã“ã“ã§ã¯ãƒ•ã‚¡ã‚¸ãƒ¼åˆ¶å¾¡ã‚’ä½¿ã„ã¾ã™ã€‚ãƒ•ã‚¡ã‚¸ãƒ¼åˆ¶å¾¡ã®è¨ˆç®—æ–¹æ³•ã¯ã€ã“ã®ã€ŒDiscover! How?ã€ã‚·ãƒªãƒ¼ã‚ºã®ã€ŒFuzzy+PID+Visual C#ã€ã«è©³ã—ãæ²è¼‰ã—ã¦ã„ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ã“ã“ã§ã¯ã€ãªã‚‹ã¹ãé«˜é€Ÿã§è¨ˆç®—ã—ãŸã„ã®ã§ã€å®Ÿæ•°ã§ã¯ãªãã€æ•´æ•°ã‚’ä½¿ã£ãŸè¨ˆç®—æ–¹æ³•ã§è¨˜è¿°ã—ã¦ã„ã¾ã™ã€‚100msã®ã‚¿ã‚¤ãƒãƒ¼å‰²ã‚Šè¾¼ã¿ã§ãƒ•ã‚¡ã‚¸ãƒ¼è¨ˆç®—ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>å…ˆãšã€ãƒãƒ«ãƒãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼ã®è¨­å®šã‚’ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;hwsetup.cpp&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//Interrupt priority</span>
 &nbsp;</p>
<p>&nbsp;<span>INTC.IPR12.BIT._MTU2S3G = 10 ;</span>
<span>//MTU2S3.TIER.BIT.TGIEA ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//ãƒãƒ«ãƒãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼</span>
 &nbsp;</p>
<p>&nbsp;<span>//-----------------------------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>//MTU2S ãƒãƒ£ãƒãƒ«3ã‚’ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼è‡ªå‹•åˆ¶å¾¡å‘¨æœŸã«ä½¿ç”¨</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2S3.TCR.BIT.CCLR = 1 ;</span>
<span>//TGRA ã®ã‚³ãƒ³ãƒšã‚¢ãƒãƒƒãƒï¼ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã‚­ãƒ£ãƒ—ãƒãƒ£ã§ TCNT ã‚¯ãƒªã‚¢</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2S3.TCR.BIT.CKEG = 0 ;</span>
<span>//00ï¼šç«‹ã¡ä¸ŠãŒã‚Šã‚¨ãƒƒã‚¸ã§ã‚«ã‚¦ãƒ³ãƒˆ</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2S3.TCR.BIT.TPSC = 5 ;</span>
<span>//MTU2S3ã‚¯ãƒ­ãƒƒã‚¯ï¼šPÏ†ï¼1024 ã§ã‚«ã‚¦ãƒ³ãƒˆ 1024/50MHz = 20.48us</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2S3.TMDR.BYTE = 0 ;</span>
<span>//é€šå¸¸å‹•ä½œ&nbsp;&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2S3.TIOR.WORD = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2S3.TGRA = 4883 ;</span>
<span>//4883 * 20.48us = 100ms</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2S3.TIER.BIT.TGIEA = 1 ;</span>
<span>//1ï¼šTGFA ãƒ“ãƒƒãƒˆã«ã‚ˆã‚‹å‰²ã‚Šè¾¼ã¿è¦æ±‚ï¼ˆTGIAï¼‰ã‚’è¨±å¯</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>100msã®ã‚¿ã‚¤ãƒãƒ¼å‰²ã‚Šè¾¼ã¿ã‚’Stepping.cppå†…ã«è¨˜è¿°ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Stepping.cpp&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>static short oldRpm ;</span>
<span>//Fuzzyè¨ˆç®—ç”¨æ—§å›è»¢æ•°</span>
 &nbsp;</p>
<p>&nbsp;<span>static short nowRpm ;</span>
<span>//Fuzzyè¨ˆç®—ç”¨ç¾åœ¨å›è»¢æ•°</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitStepping()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>oldRpm = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>nowRpm = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼è‡ªå‹•åˆ¶å¾¡</span>
 &nbsp;</p>
<p>&nbsp;<span>static void AutoControl( bool flag )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( flag == true )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>oldRpm = GetRpm() ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU2S.TSTR.BIT.CST3 = 1 ;</span>
<span>//ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼è‡ªå‹•åˆ¶å¾¡å‘¨æœŸã‚¿ã‚¤ãƒãƒ¼ã‚¹ã‚¿ãƒ¼ãƒˆ</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU2S.TSTR.BIT.CST3 = 0 ;</span>
<span>//ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼è‡ªå‹•åˆ¶å¾¡å‘¨æœŸã‚¿ã‚¤ãƒãƒ¼ã‚¹ãƒˆãƒƒãƒ—</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼è‡ªå‹•åˆ¶å¾¡å‘¨æœŸ 100ms</span>
 &nbsp;</p>
<p>&nbsp;<span>// 204 MTU2S MTU3S TGIA3</span>
 &nbsp;</p>
<p>&nbsp;<span>void INT_MTU2S_MTU3S_TGIA3(void)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( MTU2S3.TSR.BIT.TGFA == 1 )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU2S3.TSR.BIT.TGFA = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( sequence == S_AUTO )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>nowRpm = GetRpm() ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>fuzValue = Fuzzy( nowRpm, oldRpm );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>int position = stepValve.pos + fuzValue ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>int max = GetCtrl( C11 );</span>
<span>//å¯å‹•ç¯„å›²ã®æœ€å¤§ãƒ‘ãƒ«ã‚¹æ•°</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( position &lt; 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>position = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( position &gt; max )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>position = max ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>int pulse =&nbsp; position - stepValve.pos ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>stepValve.pulse = pulse ;</span>
<span>// å›è»¢ãƒ‘ãƒ«ã‚¹æ•°</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>oldRpm = nowRpm ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>FlashLED(L_STEP, P_Do19);</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>fuzValue = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//ã‚¯ãƒ©ãƒ³ã‚¯ãƒ‘ãƒ«ã‚¹å…¥åŠ›ãŒå‡ºæ¥ã‚‹ã¾ã§ã®ä»®ã®é–¢æ•°</span>
 &nbsp;</p>
<p>&nbsp;<span>int&nbsp;GetRpm()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; modify &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>return GetAdcVal( P_Ai11 ) + 50 ;</span>
<span>// 50...2750 rpm</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2><a id="calibre_link-47"></a>
<a id="calibre_link-18">
<span>(7) ãƒ•ã‚¡ã‚¸ãƒ¼è¨ˆç®—</span>
</a>
</h2>
<p>&nbsp;<span>ãƒ•ã‚¡ã‚¸ãƒ¼è¨ˆç®—ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ–°ãŸã«ä½œæˆã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Fuzzy.cpp&nbsp;======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; FILE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : Fuzzy.cpp</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; DESCRIPTION : Fuzzy Calculation</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; CPU TYPE&nbsp;&nbsp;&nbsp; : SH7286</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; DATE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : Nov 01, 2016</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; VERSION ï¼š1.0&nbsp;&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "iodefine.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>extern "C" {</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "vect.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "common.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "proto.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>// ------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>// ------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>#define VMAX</span>
<span>100</span>
 &nbsp;</p>
<p>&nbsp;<span>//ãƒ•ã‚¡ã‚¸ãƒ¼åˆ¶å¾¡ã§è¡Œã†</span>
 &nbsp;</p>
<p>&nbsp;<span>//æµ®å‹•å°æ•°ç‚¹ã¯ä½¿ã‚ãšã€100å€ã—ã¦æ•´æ•°ã§è¨ˆç®—ã™ã‚‹</span>
 &nbsp;</p>
<p>&nbsp;<span>static const long terget[] = { 1400, 1450, 1500, 1550, 1600 };</span>
 &nbsp;</p>
<p>&nbsp;<span>static const long differ[] = { -30, -15, 0, 15, 30 };</span>
 &nbsp;</p>
<p>&nbsp;<span>static const long fuzBase[] = { -60, -30, 0, 30, 60 };</span>
 &nbsp;</p>
<p>&nbsp;<span>static const short areaPB[6][2] = {{0,0},{0,1},{0,2},{1,0},{1,1},{2,0}};&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>static const short areaPS[4][2] = {{0,3},{1,2},{2,1},{3,0}};&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>static const short areaZO[5][2] = {{0,4},{1,3},{2,2},{3,1},{4,0}};&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>static const short areaNS[4][2] = {{1,4},{2,3},{3,2},{4,1}};&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>static const short areaNB[6][2] = {{2,4},{3,3},{3,4},{4,2},{4,3},{4,4}};&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>static long output[5] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//åˆæœŸè¨­å®š</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitFuzzy()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt; 5 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>output[n] = fuzBase[n];</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//å‡ºåŠ›å€¤ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å¤‰ãˆã‚‹</span>
 &nbsp;</p>
<p>&nbsp;<span>void ChangeBase( int val )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>output[0] = -val ;</span>
 &nbsp;</p>
<p>&nbsp;<span>output[1] = -val/ 2 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>output[2] = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>output[3] = val / 2 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>output[4] = val ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//Fuzzy calculation</span>
 &nbsp;</p>
<p>&nbsp;<span>int Fuzzy( int newVal, int oldVal )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>long value = newVal ;</span>
 &nbsp;</p>
<p>&nbsp;<span>long diff = newVal - oldVal ;</span>
<span>//rotational speed difference</span>
 &nbsp;</p>
<p>&nbsp;<span>long nume = 0;</span>
<span>//numerator</span>
 &nbsp;</p>
<p>&nbsp;<span>long deno = 0;</span>
<span>//denominator</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//The antecedent part 1</span>
 &nbsp;</p>
<p>&nbsp;<span>long data1[5] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt; 5 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>data1[n] = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>if (value &lt; terget[0])</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>data1[0]= VMAX ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else if (value &gt;= terget[4])</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>data1[4] = VMAX ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( int n = 0 ; n &lt; 4 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if (value &gt;= terget[n] &amp;&amp; value &lt; terget[n + 1])</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>nume = ( value - terget[n] ) * VMAX;</span>
<span>//Don't forget multiplay with VMAX</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>deno = terget[n + 1] - terget[n];</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>if ( deno &gt; 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>data1[n+1] = nume / deno ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>data1[n] = VMAX - data1[n+1] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//The antecedent part 2</span>
 &nbsp;</p>
<p>&nbsp;<span>long data2[5] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt; 5 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>data2[n] = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>if (diff &lt; differ[0])</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
<span>//-40</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>data2[0]= VMAX ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else if (diff &gt;= differ[4])</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
<span>//40</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>data2[4] = VMAX ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( int n = 0 ; n &lt; 4 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if (diff &gt;= differ[n] &amp;&amp; diff &lt; differ[n + 1])</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>nume = ( diff - differ[n] ) * VMAX;</span>
<span>//Don't forget multiplay with VMAX</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>deno = differ[n + 1] - differ[n];</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>if ( deno &gt; 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>data2[n+1] = nume / deno ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>data2[n] = VMAX - data2[n+1] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//AND operation</span>
 &nbsp;</p>
<p>&nbsp;<span>long result[5][5] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int m = 0 ; m &lt; 5 ; m++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( int n = 0 ; n &lt; 5 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>result[m][n] = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>long dA = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>long dB = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int m = 0 ; m &lt; 5 ; m++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>dA = data1[m] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( int n = 0 ; n &lt; 5 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>dB = data2[n] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( dA &lt;= dB )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>result[m][n] = dA ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>result[m][n] = dB ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//OR operation</span>
 &nbsp;</p>
<p>&nbsp;<span>long pNB = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>long pNS = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>long pZO = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>long pPS = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>long pPB = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>int j, k ;</span>
 &nbsp;</p>
<p>&nbsp;<span>//Max of pPB</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt; 6 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>j = areaPB[n][0] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>k = areaPB[n][1];</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( n == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>pPB = result[j][k] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( pPB &lt; result[j][k] )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>pPB = result[j][k] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//Max of pPS</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt; 4 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>j = areaPS[n][0] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>k = areaPS[n][1];</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( n == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>pPS = result[j][k] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( pPS &lt; result[j][k] )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>pPS = result[j][k] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//Max of pZO</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt; 5 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>j = areaZO[n][0] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>k = areaZO[n][1];</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( n == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>pZO = result[j][k] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( pZO &lt; result[j][k] )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>pZO = result[j][k] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//Max of pNS</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt; 4 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>j = areaNS[n][0] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>k = areaNS[n][1];</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( n == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>pNS = result[j][k] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( pNS &lt; result[j][k] )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>pNS = result[j][k] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//Max of pNB</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = 0 ; n &lt; 6 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>j = areaNB[n][0] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>k = areaNB[n][1];</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( n == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>pNB = result[j][k] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( pNB &lt; result[j][k] )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>pNB = result[j][k] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//Gravity</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>long gravity = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>deno = pNB + pNS + pZO + pPS + pPB;</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( deno &gt; 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>gravity = pNB * output[0] + pNS * output[1] + pZO * output[2] + pPS * output[3] + pPB * output[4] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>gravity /= deno;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>return&nbsp; (int)( gravity / 10 );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>Mainé–¢æ•°ã‹ã‚‰ãƒ•ã‚¡ã‚¸ãƒ¼ã®åˆæœŸåŒ–ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Main.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>void main(void)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>InitStepping();</span>
 &nbsp;</p>
<p>&nbsp;<span>InitFuzzy();</span>
 &nbsp;</p>
<p>&nbsp;<span>set_imask(0);</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ã§ã¯ã€å‹•ä½œã•ã›ã¦è¦‹ã¾ã—ã‚‡ã†ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ç¢ºèªã®æ‰‹é †ã¯</span>
 &nbsp;</p>
<p>&nbsp;<span>ï¼‘ï¼‰LCDç”»é¢ã§å›è»¢æ•°å¤‰æ›´VR(P_Ai11)ã‚’ã»ã¼ä¸­é–“ã®1350rpmä½ã«åˆã‚ã›ã¦ãŠãã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ï¼’ï¼‰ã‚·ãƒªã‚¢ãƒ«é€šä¿¡ã§FIXã‚³ãƒãƒ³ãƒ‰ã‚’é€ã£ã¦åŸç‚¹ã‹ã‚‰é›¢ã‚ŒãŸä½ç½®ã«ã‚»ãƒƒãƒˆã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ï¼“ï¼‰ã‚·ãƒªã‚¢ãƒ«é€šä¿¡ã§AUTOã‚³ãƒãƒ³ãƒ‰ã‚’é€ã‚Šã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ï¼”ï¼‰VRã‚’å‰å¾Œã«å‹•ã‹ã™ã¨ã€ç›®æ¨™ã®1500rpmã«åˆã‚ã›ã‚ˆã†ã¨ã€ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼ãŒå‹•ä½œã™ã‚‹ç­ˆã§ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ç›®æ¨™ã‹ã‚‰å¤§ããå¤–ã‚Œã¦ã„ã‚‹æ™‚ã¯ã€æ—©ãå‹•ä½œã—ã€ç›®æ¨™ã®è¿‘å‚ã§ã¯å°åˆ»ã¿ã«å‹•ãç­ˆã§ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>å¦‚ä½•ã§ã™ã‹ï¼Ÿã€€æ€ã£ãŸã‚ˆã†ã«å‹•ä½œã—ã¦ã„ã¾ã™ã‹ï¼Ÿ</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>å†…éƒ¨ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ä½¿ã£ã¦ã€ãƒ•ã‚¡ã‚¸ãƒ¼è¨ˆç®—æ™‚é–“ã‚’è¨ˆæ¸¬ã™ã‚‹ã¨ã€ç´„12.8usã§ã—ãŸã€‚</span>
 &nbsp;</p>
<p>&nbsp;</p>
<div></div>
<br />
&nbsp;<h1><a id="calibre_link-48"></a>
<a id="calibre_link-19">
<span>[4]&nbsp;ã‚¯ãƒ©ãƒ³ã‚¯ãƒ‘ãƒ«ã‚¹å‡ºåŠ›</span>
</a>
</h1>
<p>&nbsp;<span>ç™ºé›»æ©Ÿã®å‡ºåŠ›ã¯ã€ãã®ã¾ã¾è² è·ã®é›»æºã«ãªã‚Šã¾ã™ã®ã§ã€ç™ºé›»æ©Ÿã«ç›´çµã—ãŸã‚¨ãƒ³ã‚¸ãƒ³ã®å›è»¢æ•°ã‚’è¦å®šå€¤ã«ç¶­æŒã™ã‚‹ã“ã¨ãŒå¤§åˆ‡ã§ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ã‚¨ãƒ³ã‚¸ãƒ³ã‹ã‚‰ã¯ä¸‹å›³ã®ã‚ˆã†ã«ã‚¯ãƒ©ãƒ³ã‚¯ãƒ‘ãƒ«ã‚¹ã¨ã‚«ãƒ ãƒ‘ãƒ«ã‚¹ãŒå‡ºã¦ã„ã¾ã™ãŒã€å›è»¢æ•°ã¯ã‚¯ãƒ©ãƒ³ã‚¯ãƒ‘ãƒ«ã‚¹ã‹ã‚‰å–å¾—ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ç¾åœ¨ã®æ®µéšã§ã¯ã‚¨ãƒ³ã‚¸ãƒ³ã¯å‹•ã‹ã›ãªã„ã®ã§ã€ã‚¯ãƒ©ãƒ³ã‚¯ãƒ‘ãƒ«ã‚¹ã‚’æ¨¡æ“¬ã—ã¦å‡ºåŠ›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000002.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000014.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000018.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>(From Toyota service manual)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ã“ã“ã§ä½¿ç”¨ã™ã‚‹ç™ºé›»æ©Ÿã®ã‚¨ãƒ³ã‚¸ãƒ³ã¯4ã‚µã‚¤ã‚¯ãƒ«ã‚¨ãƒ³ã‚¸ãƒ³ã§ã™ã‹ã‚‰ã€ã‚«ãƒ ãŒï¼‘å›è»¢ã™ã‚‹é–“ã«ã‚¯ãƒ©ãƒ³ã‚¯ã¯2å›è»¢ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ã¾ãŸã€å›³ã®ã‚ˆã†ã«ã€ã‚¯ãƒ©ãƒ³ã‚¯ãƒ‘ãƒ«ã‚¹ã¯é€£ç¶šã—ãŸãƒ‘ãƒ«ã‚¹ã§ã¯ãªãã¦ã€ãƒ”ã‚¹ãƒˆãƒ³ä½ç½®ã‚’æ¤œå‡ºã™ã‚‹ãŸã‚ã«ï¼’æ­¯ãŒæ¬ æ­¯ã—ãŸãƒ‘ãƒ«ã‚¹ã«ãªã£ã¦ã„ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>æ¬ æ­¯ãŒç„¡ã„ã¨ã™ã‚Œã°ã€1å›è»¢ã§36ãƒ‘ãƒ«ã‚¹ã§ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>å…ˆãšã¯ã€ç©ºããƒãƒ¼ãƒˆã‚’ä½¿ã£ã¦ã€æ¨¡æ“¬ã‚¯ãƒ©ãƒ³ã‚¯ãƒ‘ãƒ«ã‚¹ã‚’å‡ºåŠ›ã—ã¾ã—ã‚‡ã†ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-20">
<span>(1)&nbsp;PWM ãƒ¢ãƒ¼ãƒ‰</span>
</a>
</h2>
<p>&nbsp;<span>MTU24ã‚’PWM ãƒ¢ãƒ¼ãƒ‰ã§ãƒ†ã‚¹ãƒˆç”¨ã‚¯ãƒ©ãƒ³ã‚¯ãƒ‘ãƒ«ã‚¹å‡ºåŠ›ã«ä½¿ç”¨ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>æœ€åˆã¯50rpmã®ãƒ‘ãƒ«ã‚¹ã‚’TIOC4Cç«¯å­ã‹ã‚‰å‡ºåŠ›ã—ã¾ã—ã‚‡ã†ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>50rpmã®æ™‚ã®ãƒ‘ãƒ«ã‚¹å¹…ã¯ã€33.3msã§ã™ã€‚1.28usã®ã‚¯ãƒ­ãƒƒã‚¯ã‚’ä½¿ã†ã®ã§ã€PWMã®ãƒ¬ã‚¸ã‚¹ã‚¿ã«ã¯33.3ms/1.28us=26040ã‚’ã‚»ãƒƒãƒˆã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000016.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;hwsetup.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//Interrupt priority</span>
 &nbsp;</p>
<p>&nbsp;<span>//-----------------------------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>INTC.IPR11.BIT._MTU24G =&nbsp;9&nbsp;;</span>
<span>//MTU24.TIER.BIT.TGIEA ãƒ†ã‚¹ãƒˆç”¨ã‚¯ãƒ©ãƒ³ã‚¯ãƒ‘ãƒ«ã‚¹å‡ºåŠ›</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//ãƒãƒ«ãƒãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼</span>
 &nbsp;</p>
<p>&nbsp;<span>//-----------------------------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>//MTU2 ãƒãƒ£ãƒãƒ«4ã‚’ãƒ†ã‚¹ãƒˆç”¨ã‚¯ãƒ©ãƒ³ã‚¯ãƒ‘ãƒ«ã‚¹å‡ºåŠ›ã«ä½¿ç”¨ PE14/TIOC4C</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU24.TCR.BIT.CCLR = 5 ;</span>
<span>//TGRC ã®ã‚³ãƒ³ãƒšã‚¢ãƒãƒƒãƒï¼ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã‚­ãƒ£ãƒ—ãƒãƒ£ã§TCNT ã‚¯ãƒªã‚¢</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU24.TCR.BIT.CKEG = 0 ;</span>
<span>//00ï¼šç«‹ã¡ä¸ŠãŒã‚Šã‚¨ãƒƒã‚¸ã§ã‚«ã‚¦ãƒ³ãƒˆ</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU24.TCR.BIT.TPSC = 3 ;</span>
<span>//MTU24ã‚¯ãƒ­ãƒƒã‚¯ï¼šPÏ†ï¼64 ã§ã‚«ã‚¦ãƒ³ãƒˆ 64/50MHz = 1.28us</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU24.TIOR.BIT.IOC = 6 ;</span>
<span>//TIOC4C åˆæœŸå‡ºåŠ›ã¯1 å‡ºåŠ› ã‚³ãƒ³ãƒšã‚¢ãƒãƒƒãƒã§1 å‡ºåŠ›&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU24.TIOR.BIT.IOD = 5 ;</span>
<span>//TIOC4D åˆæœŸå‡ºåŠ›ã¯1 å‡ºåŠ› ã‚³ãƒ³ãƒšã‚¢ãƒãƒƒãƒã§0 å‡ºåŠ›&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//50rpm 30pulse/sec</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU24.TCNT = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU24.TGRC = 26040 ;</span>
<span>//å‘¨æœŸ 50rpm -&gt;33.3ms, 26040 * 1.28us = 33.3ms</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU24.TGRD = 13020 ;</span>
<span>//ãƒ‡ãƒ¥ãƒ¼ãƒ†ã‚£ 50%</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU24.TMDR.BIT.MD = 2 ;</span>
<span>//PWM ãƒ¢ãƒ¼ãƒ‰1&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU24.TIER.BIT.TGIEC = 1 ;</span>
<span>//1ï¼šTGFC ãƒ“ãƒƒãƒˆã«ã‚ˆã‚‹å‰²ã‚Šè¾¼ã¿è¦æ±‚ï¼ˆTGICï¼‰ã‚’è¨±å¯</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//The following item is special to MTU24.</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2.TOER.BIT.OE4C = 1 ; //TIOC4C ç«¯å­ã® MTU2 å‡ºåŠ›ã‚’è¨±å¯ ã“ã‚ŒãŒé‡è¦ï¼ï¼</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//ãƒãƒ¼ãƒˆæ©Ÿèƒ½è¨­å®š</span>
 &nbsp;</p>
<p>&nbsp;<span>//E port --------------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>//ãƒ†ã‚¹ãƒˆç”¨ã‚¯ãƒ©ãƒ³ã‚¯ãƒ‘ãƒ«ã‚¹å‡ºåŠ›</span>
 &nbsp;</p>
<p>&nbsp;<span>PFC.PECRL4.BIT.PE14MD = 6 ;</span>
<span>//PE14&nbsp; 110ï¼šTIOC4C å…¥å‡ºåŠ›ï¼ˆMTU2ï¼‰ã‚¯ãƒ©ãƒ³ã‚¯ãƒ‘ãƒ«ã‚¹å‡ºåŠ›</span>
 &nbsp;</p>
<p>&nbsp;<span>PFC.PEIORL.BIT.B14 = 1 ;</span>
<span>//PE14&nbsp; TIOC4C å‡ºåŠ›</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-21">
<span>(2)&nbsp;Rotate.cpp</span>
</a>
</h2>
<p>&nbsp;<span>æ–°è¦ã«ãƒ•ã‚¡ã‚¤ãƒ« Rotate.cpp ã‚’ä½œæˆã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ãƒ†ã‚¹ãƒˆã®ãŸã‚å›ºå®šçš„ã«50rpmã®ãƒ‘ãƒ«ã‚¹ã«ã—ã¦ã„ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Rotate.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; FILE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : Rotate.cpp</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; DESCRIPTION : Rotational speed measurement</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; CPU TYPE&nbsp;&nbsp;&nbsp; : SH7286</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; DATE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : Nov 01, 2016</span>
 &nbsp;</p>
<p>&nbsp;<span>//&nbsp; VERSION ï¼š1.0&nbsp;&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•</span>
 &nbsp;</p>
<p>&nbsp;<span>#include &lt;stdlib.h&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "iodefine.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>extern "C" {</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "vect.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "common.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>#include "proto.h"</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>#define TEST</span>
<span>1</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>// ------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>// ------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>static short crankOut ;</span>
<span>//ã‚¯ãƒ©ãƒ³ã‚¯ãƒ‘ãƒ«ã‚¹å‡ºåŠ›ã‚«ã‚¦ãƒ³ãƒˆç”¨</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//åˆæœŸåŒ–</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitRotate()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>crankOut = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2.TSTR.BIT.CST4 = 1 ;</span>
<span>//ãƒ†ã‚¹ãƒˆç”¨ã‚¯ãƒ©ãƒ³ã‚¯ãƒ‘ãƒ«ã‚¹å‡ºåŠ›ã‚¿ã‚¤ãƒãƒ¼ã‚¹ã‚¿ãƒ¼ãƒˆ</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//ã‚¯ãƒ©ãƒ³ã‚¯ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒ‘ãƒ«ã‚¹å‡ºåŠ›</span>
 &nbsp;</p>
<p>&nbsp;<span>//2æ­¯æ¬ æ­¯ã®ãƒ‘ãƒ«ã‚¹ã¨ã™ã‚‹</span>
 &nbsp;</p>
<p>&nbsp;<span>// 190 MTU2 MTU4 TGIC4</span>
 &nbsp;</p>
<p>&nbsp;<span>void INT_MTU2_MTU4_TGIC4(void)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( MTU24.TSR.BIT.TGFC == 1 )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU24.TSR.BIT.TGFC = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>crankOut++ ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( crankOut &gt;= 12 &amp;&amp; crankOut &lt;= 13 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU24.TGRC =&nbsp;26040;&nbsp;//50rpm</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU24.TGRD =&nbsp;13020;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU24.TIOR.BIT.IOC = 1 ;</span>
<span>//TIOC4C</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU24.TIOR.BIT.IOD = 1 ;</span>
<span>//TIOC4D</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( crankOut == 14 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU24.TIOR.BIT.IOC = 6 ;</span>
<span>//TIOC4C&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU24.TIOR.BIT.IOD = 5 ;</span>
<span>//TIOC4D&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else if ( crankOut &gt;= 36 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>crankOut = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>(3) ãƒ¡ã‚¤ãƒ³é–¢æ•°ã‹ã‚‰ã€InitRotate()ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Main.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>void main(void)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>InitRotate();</span>
 &nbsp;</p>
<p>&nbsp;<span>set_imask(0);&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>while ( 1 )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-22">
<span>(3)&nbsp;ãƒ‘ãƒ«ã‚¹å‡ºåŠ›ãƒã‚§ãƒƒã‚¯</span>
</a>
</h2>
<p>&nbsp;<span>ã§ã¯ã€ã“ã‚Œã§å®Ÿè¡Œã—ã¦ä¸‹ã•ã„ã€‚PE14ãƒãƒ¼ãƒˆã‹ã‚‰ã€ä¸‹å›³ã®ã‚ˆã†ãªãƒ‘ãƒ«ã‚¹ãŒå‡ºåŠ›ã•ã‚Œã¾ã—ãŸã‹ï¼Ÿã€€ï¼ˆãƒ‘ãƒ«ã‚¹å¹… 33.3msï¼‰</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000013.gif" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ã¾ãŸã€æ¬ æ­¯ã‚‚æ­£ã—ãå‡ºã¦ã„ã¾ã™ã‹ï¼Ÿã€€ï¼ˆ1å›è»¢ 1.2sï¼‰</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000011.gif" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ãã‚Œã¯ï¼’æ­¯ã®æ¬ æ­¯ã«ãªã£ã¦ã„ã¾ã™ã‹ï¼Ÿã€€ï¼ˆï¼“æ­¯æ™‚é–“ 100msï¼‰</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000009.gif" alt="" />
 &nbsp;</p>
<p>&nbsp;</p>
<div></div>
<br />
&nbsp;<h2><a id="calibre_link-49"></a>
<a id="calibre_link-23">
<span>(4) å›è»¢æ•°å¤‰æ›´</span>
</a>
</h2>
<p>&nbsp;<span>å‰ç« ã§ä½¿ç”¨ã—ãŸå›è»¢æ•°å¤‰æ›´VR(P_Ai11)ã‚’ä½¿ã£ã¦ã€ãƒ‘ãƒ«ã‚¹å‡ºåŠ›é€Ÿåº¦ã‚’å¤‰ãˆã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ä»Šå›ã¯ã€ã‚¢ãƒŠãƒ­ã‚°å…¥åŠ›ã®å€¤(val)ã®&nbsp;0ã‹ã‚‰2700ã‚’50rpmã‹ã‚‰2750rpmã«å¯¾å¿œã•ã›ã¾ã™ã®ã§ã€æŒ‡ç¤ºå›è»¢æ•°(y)ã®è¨ˆç®—ã¯ã€å˜ã«</span>
 &nbsp;</p>
<p>&nbsp;<span>y&nbsp;= val + 50 ;</span>
<span>//rpm</span>
 &nbsp;</p>
<p>&nbsp;<span>ã§ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ã‚¯ãƒ©ãƒ³ã‚¯ã¯ï¼‘å›è»¢ã§ï¼“ï¼–ãƒ‘ãƒ«ã‚¹ï¼ˆæ¬ æ­¯ã®ç„¡ã„æ™‚ï¼‰ã§ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>å›è»¢æ•°N rpmã®æ™‚ã®ï¼‘ãƒ‘ãƒ«ã‚¹ã®å‘¨æœŸã¯ã€€10/(N*6) ç§’ã§ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ã“ã‚Œã‚’1.28usã®ã‚¯ãƒ­ãƒƒã‚¯ã§ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹ã¨ã€</span>
 &nbsp;</p>
<p>&nbsp;<span>n = 1302083 / N ;</span>
 &nbsp;</p>
<p>&nbsp;<span>ã‚’PWMãƒ¬ã‚¸ã‚¹ã‚¿ã«ã‚»ãƒƒãƒˆã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ã§ã¯ã€Rotate.cpp ã«æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Rotate.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>#define NUMERATOR3</span>
<span>1302083L</span>
 &nbsp;</p>
<p>&nbsp;<span>static short newSet;</span>
<span>//å›è»¢æ•°å¤‰æ›´</span>
 &nbsp;</p>
<p>&nbsp;<span>static short oldSet;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitRotate()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>crankOut = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>newSet = NUMERATOR3 / 50 ;</span>
<span>//50rpm</span>
 &nbsp;</p>
<p>&nbsp;<span>oldSet = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2.TSTR.BIT.CST4 = 1 ;</span>
<span>//ãƒ†ã‚¹ãƒˆç”¨ã‚¯ãƒ©ãƒ³ã‚¯ãƒ‘ãƒ«ã‚¹å‡ºåŠ›ã‚¿ã‚¤ãƒãƒ¼ã‚¹ã‚¿ãƒ¼ãƒˆ</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>å›è»¢æ•°å¤‰æ›´ã®ãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>å¼•æ•°ã®valã¯ã‚¢ãƒŠãƒ­ã‚°å€¤ã§ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>å¤–ä»˜ã‘VRã®å¾®å°ãªå¤‰åŒ–ã¯ç„¡è¦–ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Rotate.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//å›è»¢æ•°å¤‰æ›´</span>
 &nbsp;</p>
<p>&nbsp;<span>void ChangeRotation(int val)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if (( oldSet &gt;&gt; 2 ) != ( val &gt;&gt; 2 ))</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>oldSet = val;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>int&nbsp;y = val + 50;</span>
<span>//rpm</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>newSet = NUMERATOR3 / y;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ã‚¯ãƒ©ãƒ³ã‚¯ãƒ‘ãƒ«ã‚¹å‡ºåŠ›å‰²ã‚Šè¾¼ã¿ã§ã€ã“ã®å€¤ã‚’ä½¿ã„ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Rotate.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>void INT_MTU2_MTU4_TGIC4(void)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( crankOut &gt;= 12 &amp;&amp; crankOut &lt;= 13 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; modify &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU24.TGRC = newSet;</span>
<span>//Set new rotational speed</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU24.TGRD = newSet / 2;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU24.TIOR.BIT.IOC = 1 ;</span>
<span>//TIOC4C</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ã‚¢ãƒŠãƒ­ã‚°å…¥åŠ›éƒ¨ã‹ã‚‰ã€å›è»¢æ•°å¤‰æ›´ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Analog.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>void Analog()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>adcVal[P_Ai11] = adcBuf[P_Ai11] / AVEMAX ;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>ChangeRotation(adcVal[P_Ai11]);</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-24">
<span>(5) å›è»¢æ•°ã®ç¢ºèª</span>
</a>
</h2>
<p>&nbsp;<span>ã§ã¯ã€å®Ÿè¡Œã—ã¦ä¸‹ã•ã„ã€‚å›è»¢æ•°ã®å¤‰åŒ–ã‚’è¦³å¯Ÿå‡ºæ¥ã¾ã—ãŸã‹ï¼Ÿ</span>
 &nbsp;</p>
<p>&nbsp;<span>(1) 800rpm (Pulse width 2.083ms)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000005.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>(2) 1500rpm (Pulse width&nbsp;1.075ms)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000004.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>(3) 2000rpm (Pulse width&nbsp;0.833ms)</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000001.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;</p>
<div></div>
<br />
&nbsp;<h1><a id="calibre_link-50"></a>
<a id="calibre_link-25">
<span>[5]&nbsp;å›è»¢æ•°ã®è¨ˆæ¸¬</span>
</a>
</h1>
<p>&nbsp;<span>ãƒãƒ«ãƒãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼ã®ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã‚­ãƒ£ãƒ—ãƒãƒ£æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ã€ãƒ‘ãƒ«ã‚¹å‘¨æœŸ(n)ã‚’è¨ˆã‚Šã€å›è»¢æ•°(N)ã‚’ç®—å‡ºã—ã¾ã™ã€‚ãã®éš›ã«ã€æ¬ æ­¯ã‚’é¿ã‘ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>å‰ã®ç« ã§ä½¿ã£ãŸå¼</span>
 &nbsp;</p>
<p>&nbsp;<span>n = 1302083 / N ;</span>
<span>(n=ãƒ¬ã‚¸ã‚¹ã‚¿å€¤,N=å›è»¢æ•°rpm)</span>
 &nbsp;</p>
<p>&nbsp;<span>ã‹ã‚‰å›è»¢æ•°ã‚’è¨ˆç®—ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ã¾ãŸã€ãƒ¬ã‚¸ã‚¹ã‚¿å€¤ã¯åˆ»ã€…ã¨å¤‰åŒ–ã™ã‚‹ãŸã‚ã€ä¸­å¤®å€¤ã‚’ä½¿ã„ç§»å‹•å¹³å‡ã‚’å–ã‚Šã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ç§»å‹•å¹³å‡æ•°ã‚’16ã€ç§»å‹•å¹³å‡åˆè¨ˆå€¤ã‚’ rpmSumã¨ã—ãŸå ´åˆã¯</span>
 &nbsp;</p>
<p>&nbsp;<span>N =&nbsp;20833328&nbsp;/&nbsp;rpmSum ;</span>
 &nbsp;</p>
<p>&nbsp;<span>ã®å¼ã§å›è»¢æ•°ã‚’ç®—å‡ºã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>å®Ÿæ©Ÿã§ã¯ã€ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã‚­ãƒ£ãƒ—ãƒãƒ£ç«¯å­ã«ã¯ã€ã‚¨ãƒ³ã‚¸ãƒ³ã‹ã‚‰ã®ã‚¯ãƒ©ãƒ³ã‚¯ãƒ‘ãƒ«ã‚¹ä¿¡å·ã‚’å…¥åŠ›ã™ã‚‹ã‚ˆã†ã«ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000008.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ã—ã‹ã—ã€é›»åœ§ãƒ¬ãƒ™ãƒ«ãŒé•ã†ãŸã‚ã€å‰ç« ã®ç–‘ä¼¼ã‚¯ãƒ©ãƒ³ã‚¯ãƒ‘ãƒ«ã‚¹ä¿¡å·ã‚’ã“ã“ã«æ¥ç¶šã™ã‚‹ã“ã¨ã¯å‡ºæ¥ã¾ã›ã‚“ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>æ–°ãŸã«ã€ãƒ†ã‚¹ãƒˆç”¨ã«ç–‘ä¼¼ã‚¯ãƒ©ãƒ³ã‚¯ãƒ‘ãƒ«ã‚¹ä¿¡å·å…¥åŠ›ãƒãƒ¼ãƒˆã‚’ç”¨æ„ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<img src="images/000015.jpg" alt="" />
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2><a id="calibre_link-51"></a>
<a id="calibre_link-26">
<span>(1) ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã‚­ãƒ£ãƒ—ãƒãƒ£</span>
</a>
</h2>
<p>&nbsp;<span>å‰²ã‚Šè¾¼ã¿ãƒ¬ãƒ™ãƒ«ã¨ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã‚­ãƒ£ãƒ—ãƒãƒ£æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;hwsetup.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>//Interrupt priority</span>
 &nbsp;</p>
<p>&nbsp;<span>//-----------------------------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>INTC.IPR10.BIT._MTU22G =&nbsp;15&nbsp;;</span>
<span>//MTU22.TIER.BIT.TGIEA ãƒ†ã‚¹ãƒˆç”¨ã‚¯ãƒ©ãƒ³ã‚¯ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚»ãƒ³ã‚µãƒ¼</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//ãƒãƒ«ãƒãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼</span>
 &nbsp;</p>
<p>&nbsp;<span>//-----------------------------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>//MTU2 ãƒãƒ£ãƒãƒ«2ã‚’ãƒ†ã‚¹ãƒˆç”¨ã‚¯ãƒ©ãƒ³ã‚¯ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚»ãƒ³ã‚µãƒ¼ã«ä½¿ç”¨ PE6/TIOC2A</span>
 &nbsp;</p>
<p>&nbsp;<span>//ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã‚­ãƒ£ãƒ—ãƒãƒ£ã§å›è»¢æ•°ã‚’è¨ˆæ¸¬ã™ã‚‹</span>
 &nbsp;</p>
<p>&nbsp;<span>//PE6/TIOC2A</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU22.TMDR.BYTE = 0 ;</span>
<span>//é€šå¸¸å‹•ä½œ</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU22.TCR.BIT.CCLR = 1 ;</span>
<span>//TGRA ã®ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã‚­ãƒ£ãƒ—ãƒãƒ£ã§TCNT ã‚¯ãƒªã‚¢</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU22.TCR.BIT.CKEG = 1 ;</span>
<span>//01ï¼šç«‹ã¡ä¸‹ãŒã‚Šã‚¨ãƒƒã‚¸ã§ã‚«ã‚¦ãƒ³ãƒˆ</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU22.TCR.BIT.TPSC = 3 ;</span>
<span>//å‘¨è¾ºã‚¯ãƒ­ãƒƒã‚¯ï¼šPÏ†ï¼64 ã§ã‚«ã‚¦ãƒ³ãƒˆ 64/50MHz = 1.28us</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU22.TIOR.BIT.IOA = 9 ;</span>
<span>//TIOC1A ç«¯å­ 01ï¼šç«‹ã¡ä¸‹ãŒã‚Šã‚¨ãƒƒã‚¸ã§ã‚«ã‚¦ãƒ³ãƒˆ</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU22.TIER.BIT.TGIEA = 1 ;</span>
<span>//1ï¼šTGFAãƒ“ãƒƒãƒˆã«ã‚ˆã‚‹å‰²ã‚Šè¾¼ã¿è¦æ±‚ï¼ˆTGIAï¼‰ã‚’è¨±å¯</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//ãƒãƒ¼ãƒˆæ©Ÿèƒ½è¨­å®š</span>
 &nbsp;</p>
<p>&nbsp;<span>//E port --------------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>//ãƒ†ã‚¹ãƒˆç”¨ã‚¯ãƒ©ãƒ³ã‚¯ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚»ãƒ³ã‚µãƒ¼</span>
 &nbsp;</p>
<p>&nbsp;<span>PFC.PEIORL.BIT.B6 = 0 ;</span>
<span>//PE6 TIOC2A å…¥åŠ›&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>PFC.PECRL2.BIT.PE6MD = 6 ;</span>
<span>//PE6 110ï¼šTIOC2A å…¥åŠ›ï¼ˆMTU2ï¼‰ã‚¯ãƒ©ãƒ³ã‚¯ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚»ãƒ³ã‚µãƒ¼</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Rotate.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>#define AVENUM</span>
<span>16</span>
<span>// ç§»å‹•å¹³å‡å›æ•°</span>
 &nbsp;</p>
<p>&nbsp;<span>#define NUMERATOR1</span>
<span>20833328L</span>
<span>//1302083 * AVENUM</span>
 &nbsp;</p>
<p>&nbsp;<span>#define NUMERATOR2</span>
<span>65535L</span>
<span>//æœ€å¤§å€¤ã§åˆæœŸåŒ–ã™ã‚‹ãŸã‚ã«ä½¿ã†</span>
 &nbsp;</p>
<p>&nbsp;<span>#define RPMLOW</span>
<span>208320L</span>
<span>//100rpmç›¸å½“ã®rpmSumã®å€¤ã€€ 13020 * AVENUM</span>
 &nbsp;</p>
<p>&nbsp;<span>#define RPMHIGH</span>
<span>6944L</span>
<span>//3000rpmç›¸å½“ã®rpmSumã®å€¤ã€€ 434 * AVENUM</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>#define NUMERATOR3</span>
<span>1302083L</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>static unsigned long rpmAve[AVENUM] ;</span>
<span>// ç§»å‹•å¹³å‡ãƒãƒƒãƒ•ã‚¡</span>
 &nbsp;</p>
<p>&nbsp;<span>static unsigned short rpmPtr ;</span>
<span>// ç§»å‹•å¹³å‡ãƒã‚¤ãƒ³ã‚¿</span>
 &nbsp;</p>
<p>&nbsp;<span>static unsigned long rpmSum ;</span>
<span>// å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ç©ç®—ãƒãƒƒãƒ•ã‚¡</span>
 &nbsp;</p>
<p>&nbsp;<span>static unsigned short newCount ;</span>
<span>//ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼å€¤</span>
 &nbsp;</p>
<p>&nbsp;<span>static unsigned short center ;</span>
<span>//ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼ä¸­å¤®å€¤</span>
 &nbsp;</p>
<p>&nbsp;<span>static unsigned short ctrBuf[3] ;</span>
<span>//ä¸­å¤®å€¤æ¤œå‡ºç”¨</span>
 &nbsp;</p>
<p>&nbsp;<span>static short newCtr ;</span>
<span>//å›è»¢ç¢ºèªã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</span>
 &nbsp;</p>
<p>&nbsp;<span>static short nowRpm ;</span>
<span>//ç¾åœ¨å›è»¢æ•°</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>void InitRotate()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>rpmSum = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>for (&nbsp;int&nbsp;n = 0 ; n &lt; AVENUM ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>rpmAve[n] = NUMERATOR2 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>rpmSum += NUMERATOR2 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>rpmPtr = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>newCount = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>for (&nbsp;int&nbsp;n = 0 ; n &lt; 3 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>ctrBuf[n] = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>center = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>newCtr = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>nowRpm = 0 ;</span>
<span>//0rpm</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>crankOut = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>newSet = NUMERATOR3 / 50 ;</span>
<span>//50rpm</span>
 &nbsp;</p>
<p>&nbsp;<span>oldSet = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>//&gt;&gt;&gt; add &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2.TSTR.BIT.CST2 = 1 ;</span>
<span>//MTU2ãƒãƒ£ãƒãƒ«2ã‚¿ã‚¤ãƒãƒ¼ã‚¹ã‚¿ãƒ¼ãƒˆ</span>
 &nbsp;</p>
<p>&nbsp;<span>//&lt;&lt;&lt; end &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
 &nbsp;</p>
<p>&nbsp;<span>MTU2.TSTR.BIT.CST4 = 1 ;</span>
<span>//MTU2ãƒãƒ£ãƒãƒ«ï¼”ã‚¿ã‚¤ãƒãƒ¼ã‚¹ã‚¿ãƒ¼ãƒˆ</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//ãƒ†ã‚¹ãƒˆç”¨ã‚¯ãƒ©ãƒ³ã‚¯ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚»ãƒ³ã‚µãƒ¼ã€€MTU2ãƒãƒ£ãƒãƒ«2</span>
 &nbsp;</p>
<p>&nbsp;<span>// 172 MTU2 MTU2 TGIA2</span>
 &nbsp;</p>
<p>&nbsp;<span>void INT_MTU2_MTU2_TGIA2(void)</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( MTU22.TSR.BIT.TGFA )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU22.TSR.BIT.TGFA = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>MTU22.TCNT = 0 ;</span>
<span>//ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚¯ãƒªã‚¢</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>newCount = MTU22.TGRA ;</span>
<span>//ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼ã—ãŸå€¤</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//æ¬ æ­¯ã‚’åˆ¤å®šã™ã‚‹ï¼å‰å›ã®å€¤ã®ï¼’å€ã‚’è¶Šãˆã¦ã„ã‚‹ãªã‚‰æ¬ æ­¯</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if (( ctrBuf[0] &gt; 0 ) &amp;&amp; ( newCount &gt;= ( ctrBuf[1] + ctrBuf[2] )) &amp;&amp; ( newCtr &gt;= 36 ))</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>//ä¸­å¤®å€¤ã‚’æ±‚ã‚ã‚‹</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>ctrBuf[0] = ctrBuf[1] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>ctrBuf[1] = ctrBuf[2] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>ctrBuf[2] = newCount ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( newCount &gt; ctrBuf[1] )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>if ( ctrBuf[1] &gt; ctrBuf[0] )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>center = ctrBuf[1] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>else if ( newCount &gt; ctrBuf[0] )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>center = ctrBuf[0] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>center = newCount ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>if ( newCount &gt; ctrBuf[0] )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>center = newCount ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>else if ( ctrBuf[1] &gt; ctrBuf[0] )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>center = ctrBuf[0] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>center = ctrBuf[1] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>// ç·å’Œã‹ã‚‰ç¾åœ¨ãƒã‚¤ãƒ³ãƒˆå€¤ã‚’å¼•ã</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>rpmSum -= rpmAve[rpmPtr] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>// å…¥åŠ›å€¤ã‚’ãƒã‚¤ãƒ³ãƒˆéƒ¨ã¸å…¥ã‚Œã‚‹</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>rpmAve[rpmPtr] = center ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>// ç·å’Œã«å…¥åŠ›å€¤ã‚’åŠ ãˆã‚‹</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>rpmSum += center ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>// ãƒã‚¤ãƒ³ã‚¿ã‚’æ¬¡ã«é€²ã‚ã‚‹</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( ++rpmPtr &gt;= AVENUM )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>&nbsp;</span>
<span>rpmPtr = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( newCtr &lt; 36 )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>newCtr++;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-27">
<span>(2) å›è»¢æ•°ã®è¨ˆç®—</span>
</a>
</h2>
<p>&nbsp;<span>ã‚¯ãƒ©ãƒ³ã‚¯ãƒ‘ãƒ«ã‚¹ã‹ã‚‰å›è»¢æ•°ã‚’è¨ˆç®—å‡ºæ¥ã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§ã€ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼éƒ¨ã§ä½¿ã£ã¦ã„ãŸ&nbsp;GetRpm()ãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¦ã€ä¸‹è¨˜ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>100rpmä»¥ä¸‹ã¨3000rpmä»¥ä¸Šã¯ä½¿ç”¨ã—ãªã„ã®ã§ã€è¨ˆç®—ã‹ã‚‰é™¤å¤–ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Rotate.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>int&nbsp;GetRpm()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( rpmSum &gt; RPMHIGH )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>if ( rpmSum &lt; RPMLOW )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>nowRpm = (unsigned short)( NUMERATOR1 / rpmSum );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>nowRpm = 0 ;</span>
<span>//0rpm</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>nowRpm = 3000 ;</span>
<span>//3000rpm</span>
 &nbsp;</p>
<p>&nbsp;<span>return nowRpm;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2><a id="calibre_link-52"></a>
<a id="calibre_link-28">
<span>(3) LCDè¡¨ç¤º</span>
</a>
</h2>
<p>&nbsp;<span>å†…éƒ¨ã®å‡¦ç†ãŒã€æ„å›³ã—ãŸé€šã‚Šã«è¡Œã‚ã‚Œã¦ã„ã‚‹ã‹ã‚’èª¿ã¹ã‚‹ãŸã‚ã«ã€å„ç¨®ã®æƒ…å ±ã‚’LCDã«è¡¨ç¤ºã—ã¾ã—ã‚‡ã†ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ã“ã“ã§è¡¨ç¤ºã™ã‚‹å€¤ã¯ã€</span>
 &nbsp;</p>
<p>&nbsp;<span>(1) ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼ã—ãŸå€¤</span>
 &nbsp;</p>
<p>&nbsp;<span>(2) ä¸­å¤®å€¤è¨ˆç®—ãƒãƒƒãƒ•ã‚¡</span>
 &nbsp;</p>
<p>&nbsp;<span>(3) ç§»å‹•å¹³å‡ç©ç®—å€¤</span>
 &nbsp;</p>
<p>&nbsp;<span>(4) ç¾åœ¨å›è»¢æ•°</span>
 &nbsp;</p>
<p>&nbsp;<span>ã§ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Display.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>void DispLCD()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>switch ( nowPage ){</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>case D_Rotate :</span>
<span>//Rotation</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>DispFunc( GetRotation, GetRotMsg );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>selectLED = L_ROT ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>å›è»¢æ•°ã®æ¤œå‡ºå´ã§LCDã«è¡¨ç¤ºã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Rotate.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>#include &lt;string.h&gt;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>static const char scRPM[][21] = {</span>
<span>//Rotation</span>
 &nbsp;</p>
<p>&nbsp;<span>{"Rot&nbsp; F=00&nbsp;&nbsp; rpm=0000"},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"[0]=0000&nbsp; [1]=0000&nbsp; "},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"[2]=0000&nbsp; Ctr=0000&nbsp; "},</span>
 &nbsp;</p>
<p>&nbsp;<span>{" hi=0000&nbsp;&nbsp; lo=0000 "}};</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetRotation( int val[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>val[0] = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>val[1] = GetRpm();</span>
 &nbsp;</p>
<p>&nbsp;<span>val[2] = ctrBuf[0];</span>
 &nbsp;</p>
<p>&nbsp;<span>val[3] = ctrBuf[1];</span>
 &nbsp;</p>
<p>&nbsp;<span>val[4] = ctrBuf[2];</span>
 &nbsp;</p>
<p>&nbsp;<span>val[5] = newCount;</span>
 &nbsp;</p>
<p>&nbsp;<span>val[6] = (int)( rpmSum &gt;&gt; 16 );</span>
 &nbsp;</p>
<p>&nbsp;<span>val[7] = (int)( rpmSum &amp; 0x0FFFF );</span>
 &nbsp;</p>
<p>&nbsp;<span>return 8 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//LCD</span>
 &nbsp;</p>
<p>&nbsp;<span>void GetRotMsg( int val[], char buff[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>char line[22], temp[8] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[0] = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>//1st line</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( line, scRPM[0], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[0], temp );</span>
<span>//speedFlag</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 2, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[7], temp, 2 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[1], temp );</span>
<span>//nowRpm</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 4, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[16], temp, 4 );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>//2nd line</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( line, scRPM[1], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[2], temp );</span>
<span>//ctrBuf[0]</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 4, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[4], temp, 4 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[3], temp );</span>
<span>//ctrBuf[1]</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 4, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[14], temp, 4 );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>//3rd line</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( line, scRPM[2], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[4], temp );</span>
<span>//ctrBuf[2]</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 4, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[4], temp, 4 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoa2( val[5], temp );</span>
<span>//newCount</span>
 &nbsp;</p>
<p>&nbsp;<span>adjust( temp, 5, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[14], temp, 5 );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>//4th line</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( line, scRPM[3], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoh4( val[6], temp );</span>
<span>//rpmSum Hi</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[4], temp, 4 );</span>
 &nbsp;</p>
<p>&nbsp;<span>itoh4( val[7], temp );</span>
<span>//rpmSum Lo</span>
 &nbsp;</p>
<p>&nbsp;<span>strncpy( &amp;line[15], temp, 4 );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ã§ã¯ã€å®Ÿè¡Œã—ã¦ä¸‹ã•ã„ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>æ„å›³ã—ãŸã‚ˆã†ã«ã€å›è»¢æ•°ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã‹ï¼Ÿ</span>
 &nbsp;</p>
<p>&nbsp;<span>å†…éƒ¨è¨ˆç®—å€¤ã‚‚ã€æƒ³å®šã—ãŸç¯„å›²å†…ã®å€¤ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;</p>
<div></div>
<br />
&nbsp;<h1>
<a id="calibre_link-29">
<span>[6]&nbsp;å†…éƒ¨è¨­å®šå€¤è¡¨ç¤º</span>
</a>
</h1>
<p>&nbsp;<span>å„ç¨®ã®ãƒ†ã‚¹ãƒˆã‚’è¡Œã£ã¦ã„ã‚‹ã¨ã€ç¾åœ¨ã®è£…ç½®ã®å†…éƒ¨è¨­å®šå€¤ã‚’ç¢ºèªã—ãŸã„æ™‚ãŒç”Ÿã˜ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>æ™‚é–“è¨­å®šå€¤ã¨ã€åˆ¶å¾¡å®šæ•°è¨­å®šå€¤ã‚’LCDç”»é¢ã«è¡¨ç¤ºå‡ºæ¥ã‚‹ã¨å¥½éƒ½åˆã§ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>===== Display.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>void DispLCD()</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>case D_TimeVal :</span>
<span>//Timer setting</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>DispFunc( GetTimeVal_0,&nbsp; GetTimeMsg );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case D_TimeVal2:</span>
<span>// Timer setting</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>DispFunc( GetTimeVal_1,&nbsp; GetTimeMsg );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>case D_CtrlVal:</span>
<span>// Control constant setting</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>DispFunc( GetCtrlVal,&nbsp; GetCtrlMsg );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>break ;</span>
 &nbsp;</p>
<p>&nbsp;<span>:</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-30">
<span>(1)&nbsp;æ™‚é–“è¨­å®šå€¤</span>
</a>
</h2>
<p>&nbsp;<span>LCDç”»é¢ã«è¡¨ç¤ºã™ã‚‹æ™‚é–“è¨­å®šå€¤ã‚’æº–å‚™ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Timer.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>static const char scTimer[][21] = {</span>
 &nbsp;</p>
<p>&nbsp;<span>{"T0000 0004 0008 0012"},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"T0001 0005 0009 0013"},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"T0002 0006 0010 0014"},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"T0003 0007 0011 0015"}};</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//æ™‚é–“è¨­å®šå€¤(LCDç”¨)</span>
 &nbsp;</p>
<p>&nbsp;<span>static int GetTimeVal( int select, int val[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>if ( select == 0 )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( int n = TM00 ; n &lt;= TM15 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>val[n] = timeTbl[n].time ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return TM15 - TM00 + 1;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>else</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>int m, n ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( n = 0 ; n &lt; 16 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>val[n] = 0 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( m = TM16 , n = 0; m &lt; TMRNUM ; m++, n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>val[n] = timeTbl[m].time ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>return TMRNUM - TM16 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetTimeVal_0( int val[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>return GetTimeVal( 0, val );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetTimeVal_1( int val[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>return GetTimeVal( 1, val );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//LCD</span>
 &nbsp;</p>
<p>&nbsp;<span>void GetTimeMsg( int val[], char buff[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>char line[22], temp[8] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[0] = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int m = 0 ; m &lt; 4 ; m++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strncpy( line, scTimer[m], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( int n = 0 ; n &lt; 4 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>itoa2( val[m+n*4], temp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>adjust( temp, 4, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strncpy( &amp;line[1+ n*5], temp, 4 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<h2>
<a id="calibre_link-31">
<span>(2)&nbsp;åˆ¶å¾¡å®šæ•°è¨­å®šå€¤</span>
</a>
</h2>
<p>&nbsp;<span>LCDç”»é¢ã«è¡¨ç¤ºã™ã‚‹åˆ¶å¾¡å®šæ•°è¨­å®šå€¤ã‚’æº–å‚™ã—ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>=====&nbsp;Eeprom.cpp ======================</span>
 &nbsp;</p>
<p>&nbsp;<span>// Private data</span>
 &nbsp;</p>
<p>&nbsp;<span>static const char scCtrl[][21] = {</span>
<span>//åˆ¶å¾¡å®šæ•°å€¤</span>
 &nbsp;</p>
<p>&nbsp;<span>{"C0000 0004 0008 0012"},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"C0001 0005 0009 0013"},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"C0002 0006 0010 0014"},</span>
 &nbsp;</p>
<p>&nbsp;<span>{"C0003 0007 0011 0015"}};</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>//åˆ¶å¾¡å®šæ•°è¨­å®šå€¤(LCDç”¨)</span>
 &nbsp;</p>
<p>&nbsp;<span>int GetCtrlVal( int val[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int n = C00 ; n &lt;= C15 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>val[n] =ctrlTbl[n] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>return C15 - C00 + 1 ;</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>//LCD</span>
 &nbsp;</p>
<p>&nbsp;<span>void GetCtrlMsg( int val[], char buff[] )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>char line[22], temp[8] ;</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>buff[0] = 0;</span>
 &nbsp;</p>
<p>&nbsp;<span>for ( int m = 0 ; m &lt; 4 ; m++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strncpy( line, scCtrl[m], 20 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>for ( int n = 0 ; n &lt; 4 ; n++ )</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>{</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>itoa2( val[m+n*4], temp );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>adjust( temp, 4, ' ');</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strncpy( &amp;line[1+ n*5], temp, 4 );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( buff, line );</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
<span>strcat( buff, "," );</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>}</span>
 &nbsp;</p>
<p>&nbsp;<span>===========================</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ã§ã¯ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦ç¢ºèªã—ã¦ä¸‹ã•ã„ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>ã•ã‚ã€ã“ã“ã¾ã§ã§å›è»¢æ•°ã®è¨ˆæ¸¬ãŒå‡ºæ¥ã‚‹ã‚ˆã†ã«ãªã‚Šã€å›è»¢æ•°ã‚’åˆ¶å¾¡ã™ã‚‹ãŸã‚ã«ã€ã‚¹ãƒ­ãƒƒãƒˆãƒ«ã‚’èª¿æ•´ã™ã‚‹çŸ¥è­˜ã‚’å¾—ã¾ã—ãŸã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ä»¥é™ã®ç« ã§ã¯ã€é‹è»¢åˆ¶å¾¡ã¨ç™ºé›»ã—ãŸé›»åœ§æ³¢å½¢ã‹ã‚‰å‘¨æ³¢æ•°ã‚’è¨ˆæ¸¬ã—ã€é›»åœ§ã€é›»æµã€é›»åŠ›ã‚’æ±‚ã‚ã‚‹éƒ¨åˆ†ã‚’æ‰±ã„ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ã•ã‚‰ã«å®Ÿç”¨çš„ãªè£…ç½®ã«ã™ã‚‹ãŸã‚ã®ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’è¡Œã„ã¾ã™ã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>&nbsp;</span>
 &nbsp;</p>
<p>&nbsp;<span>------------------------------</span>
 &nbsp;</p>
<p>&nbsp;<span>ã€Œç­†è€…ã®ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã€</span>
 &nbsp;</p>
<p>&nbsp;<span>ãƒã‚¤ã‚³ãƒ³ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚­ãƒƒãƒˆãŒå¸‚å ´ã‚’è³‘ã‚ã›ã¦ã„ã‚‹é ƒã«ã€æ—¥ç«‹ã®å·¥æ¥­ç”¨ãƒã‚¤ã‚³ãƒ³ãƒœãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦ã€å·¥å ´ã§ä½¿ã†è£…ç½®ã‚’ä½œã£ãŸã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>å·¥å ´å†…ã¯ãƒã‚¤ã‚ºãŒæ¿€ã—ã„ã®ã§ã€é›»å­æ©Ÿå™¨ã¯ä½¿ãˆãªã„ã¨è¨€ã‚ã‚Œã¦ã„ãŸã®ã§ã€æ‰‹åšã„ãƒã‚¤ã‚ºå¯¾ç­–ã‚’ã—ãŸã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>ã“ã®è£…ç½®ã¯å‘¨å›²ã®æœŸå¾…ã«åã—ã¦ã€å•é¡Œãªãé•·æœŸé–“ä½œå‹•ã—ã€å·¥å ´ã§ã®è£½å“ã®ç”Ÿç”£ã‚’åŠ©ã‘ãŸã€‚</span>
 &nbsp;</p>
<p>&nbsp;<span>å¤§éƒ½ä¼šã‹ã‚‰æ¥ãŸã‚»ãƒ¼ãƒ«ã‚¹ãƒãƒ³ãŒã€å°ã•ãªç”ºã§ã“ã‚“ãªè£…ç½®ãŒä½œã‚‰ã‚ŒãŸã®ã‚’é©šã„ã¦ã„ãŸãã†ã§ã™ã€‚</span>
</p>
</div>
</div>


<script>function myFunction(){document.getElementById("tateyoko").classList.toggle("tateread")}</script></body></html>